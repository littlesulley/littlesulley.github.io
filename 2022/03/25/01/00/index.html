<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.1.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/radahn-medium.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/radahn-medium.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/radahn-small.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="code-2oysa9iikh">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/black/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"sulley.cc","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="图形学中的旋转（Rotation）非常重要，用欧拉角（Euler Angle）旋转非常简单，但是却存在 万向锁（Gimbal Lock） 的问题；同时，用欧拉角插值也不尽方便。基于四元数（Quaternion）的旋转既解决了万向锁的问题，又能非常便利地插值。本文将从概念出发，对四元数的定义、推导、性质、应用，以及它与欧拉角之间的联系进行介绍。本文主要参考了Krasjet的《四元数与三维旋转》1">
<meta property="og:type" content="article">
<meta property="og:title" content="四元数与旋转">
<meta property="og:url" content="http://sulley.cc/2022/03/25/01/00/index.html">
<meta property="og:site_name" content="Sulley">
<meta property="og:description" content="图形学中的旋转（Rotation）非常重要，用欧拉角（Euler Angle）旋转非常简单，但是却存在 万向锁（Gimbal Lock） 的问题；同时，用欧拉角插值也不尽方便。基于四元数（Quaternion）的旋转既解决了万向锁的问题，又能非常便利地插值。本文将从概念出发，对四元数的定义、推导、性质、应用，以及它与欧拉角之间的联系进行介绍。本文主要参考了Krasjet的《四元数与三维旋转》1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://sulley.cc/images/quaternion/0_1.gif">
<meta property="og:image" content="http://sulley.cc/images/quaternion/0_2.gif">
<meta property="og:image" content="http://sulley.cc/images/quaternion/0_3.gif">
<meta property="og:image" content="http://sulley.cc/images/quaternion/2.gif">
<meta property="og:image" content="http://sulley.cc/images/quaternion/1.png">
<meta property="og:image" content="http://sulley.cc/images/quaternion/2.png">
<meta property="og:image" content="http://sulley.cc/images/quaternion/9.png">
<meta property="og:image" content="http://sulley.cc/images/quaternion/3.png">
<meta property="og:image" content="http://sulley.cc/images/quaternion/4.png">
<meta property="og:image" content="http://sulley.cc/images/quaternion/5.png">
<meta property="og:image" content="http://sulley.cc/images/quaternion/6.png">
<meta property="og:image" content="http://sulley.cc/images/quaternion/7.png">
<meta property="og:image" content="http://sulley.cc/images/quaternion/8.png">
<meta property="article:published_time" content="2022-03-24T17:00:33.000Z">
<meta property="article:modified_time" content="2022-10-08T07:13:43.119Z">
<meta property="article:author" content="Sulley">
<meta property="article:tag" content="计算机">
<meta property="article:tag" content="随笔">
<meta property="article:tag" content="数学">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://sulley.cc/images/quaternion/0_1.gif">


<link rel="canonical" href="http://sulley.cc/2022/03/25/01/00/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://sulley.cc/2022/03/25/01/00/","path":"2022/03/25/01/00/","title":"四元数与旋转"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>四元数与旋转 | Sulley</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Sulley</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Never Betray Yourself.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">19</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">11</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">25</span></a></li>
        
            
  <li class="menu-item menu-item-相册"><a href="/photos/" rel="section"><i class="fa fa-camera fa-fw"></i>相册</a></li>


      
        <li class="menu-item menu-item-资源"><a href="/resources/" rel="section"><i class="fa fa-book fa-fw"></i>资源</a></li>
        <li class="menu-item menu-item-留言"><a href="/comments/" rel="section"><i class="fa fa-comment fa-fw"></i>留言</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%8D%E6%95%B0%E4%B8%8E%E4%BA%8C%E7%BB%B4%E6%97%8B%E8%BD%AC"><span class="nav-number">1.</span> <span class="nav-text">复数与二维旋转</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89"><span class="nav-number">1.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E6%95%B0%E7%9A%84%E5%8A%A0%E6%B3%95%E4%B8%8E%E4%B9%98%E6%B3%95"><span class="nav-number">1.2.</span> <span class="nav-text">复数的加法与乘法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E6%95%B0%E7%9A%84%E5%8A%A0%E6%B3%95"><span class="nav-number">1.2.1.</span> <span class="nav-text">复数的加法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E6%95%B0%E7%9A%84%E4%B9%98%E6%B3%95"><span class="nav-number">1.2.2.</span> <span class="nav-text">复数的乘法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E6%95%B0%E7%9A%84%E6%A8%A1%E9%95%BF"><span class="nav-number">1.3.</span> <span class="nav-text">复数的模长</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E6%95%B0%E4%B8%8E%E4%BA%8C%E7%BB%B4%E6%97%8B%E8%BD%AC-1"><span class="nav-number">1.4.</span> <span class="nav-text">复数与二维旋转</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E5%A4%8D%E6%95%B0%E7%9F%A9%E9%98%B5%E5%BD%A2%E5%BC%8F%E5%AF%BC%E5%87%BA%E6%97%8B%E8%BD%AC%E5%85%B3%E7%B3%BB"><span class="nav-number">1.4.1.</span> <span class="nav-text">从复数矩阵形式导出旋转关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E6%95%B0%E7%9A%84%E6%9E%81%E5%9D%90%E6%A0%87%E5%BD%A2%E5%BC%8F"><span class="nav-number">1.4.2.</span> <span class="nav-text">复数的极坐标形式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E6%95%B0%E7%9A%84%E5%87%A0%E7%A7%8D%E8%A1%A8%E7%A4%BA%E5%BD%A2%E5%BC%8F%E6%80%BB%E7%BB%93"><span class="nav-number">1.4.3.</span> <span class="nav-text">复数的几种表示形式总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%8B%E8%BD%AC%E5%A4%8D%E5%90%88"><span class="nav-number">1.5.</span> <span class="nav-text">旋转复合</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Eaxis-angle%E7%9A%84%E6%97%8B%E8%BD%AC"><span class="nav-number">2.</span> <span class="nav-text">基于Axis Angle的旋转</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AC%A7%E6%8B%89%E8%A7%92%E4%B8%8E%E4%B8%87%E5%90%91%E9%94%81gimbal-lock%E9%97%AE%E9%A2%98"><span class="nav-number">3.</span> <span class="nav-text">欧拉角与万向锁（Gimbal
Lock）问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#unity%E4%B8%AD%E7%9A%84gimbal-lock%E7%8E%B0%E8%B1%A1"><span class="nav-number">3.1.</span> <span class="nav-text">Unity中的Gimbal Lock现象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AC%A7%E6%8B%89%E8%A7%92%E5%9D%90%E6%A0%87%E7%B3%BB%E4%B8%8E%E6%97%8B%E8%BD%AC%E9%A1%BA%E5%BA%8F"><span class="nav-number">3.2.</span> <span class="nav-text">欧拉角、坐标系与旋转顺序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unity%E4%B8%AD%E7%9A%84%E6%AC%A7%E6%8B%89%E8%A7%92"><span class="nav-number">3.3.</span> <span class="nav-text">Unity中的欧拉角</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unity%E4%B8%AD%E7%9A%84gimbal-lock%E9%97%AE%E9%A2%98"><span class="nav-number">3.4.</span> <span class="nav-text">Unity中的Gimbal Lock问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E5%85%83%E6%95%B0"><span class="nav-number">4.</span> <span class="nav-text">四元数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89-1"><span class="nav-number">4.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E6%B3%95%E4%B9%98%E6%B3%95%E6%A8%A1%E9%95%BF"><span class="nav-number">4.2.</span> <span class="nav-text">加法、乘法、模长</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E6%B3%95"><span class="nav-number">4.2.1.</span> <span class="nav-text">加法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B9%98%E6%B3%95"><span class="nav-number">4.2.2.</span> <span class="nav-text">乘法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gra%C3%9Fmann%E7%A7%AF"><span class="nav-number">4.2.3.</span> <span class="nav-text">Graßmann积</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E9%95%BF"><span class="nav-number">4.2.4.</span> <span class="nav-text">模长</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%AF%E5%9B%9B%E5%85%83%E6%95%B0"><span class="nav-number">4.3.</span> <span class="nav-text">纯四元数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B1%E8%BD%AD"><span class="nav-number">4.4.</span> <span class="nav-text">共轭</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%86"><span class="nav-number">4.5.</span> <span class="nav-text">逆</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E5%85%83%E6%95%B0%E4%B8%8E%E4%B8%89%E7%BB%B4%E6%97%8B%E8%BD%AC"><span class="nav-number">5.</span> <span class="nav-text">四元数与三维旋转</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E%E4%B8%89%E7%BB%B4%E6%97%8B%E8%BD%AC%E5%85%AC%E5%BC%8F%E5%88%B0%E5%9B%9B%E5%85%83%E6%95%B0%E8%A1%A8%E7%A4%BA"><span class="nav-number">5.1.</span> <span class="nav-text">从三维旋转公式到四元数表示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E5%85%83%E6%95%B0%E6%97%8B%E8%BD%AC%E5%85%AC%E5%BC%8F%E7%9A%84%E7%AE%80%E5%8C%96"><span class="nav-number">5.2.</span> <span class="nav-text">四元数旋转公式的简化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E7%90%86%E4%B8%80"><span class="nav-number">5.2.1.</span> <span class="nav-text">引理一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E7%90%86%E4%BA%8C"><span class="nav-number">5.2.2.</span> <span class="nav-text">引理二</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E7%90%86%E4%B8%89"><span class="nav-number">5.2.3.</span> <span class="nav-text">引理三</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E7%BB%B4%E6%97%8B%E8%BD%AC%E5%AE%9A%E7%90%86%E5%9B%9B%E5%85%83%E6%95%B0%E5%9E%8B"><span class="nav-number">5.3.</span> <span class="nav-text">三维旋转定理（四元数型）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E5%85%83%E6%95%B0%E4%B9%98%E7%A7%AF%E7%9A%84%E6%80%A7%E8%B4%A8"><span class="nav-number">5.4.</span> <span class="nav-text">四元数乘积的性质</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E7%BB%B4%E6%97%8B%E8%BD%AC%E5%AE%9A%E7%90%86%E7%9F%A9%E9%98%B5%E5%9E%8B"><span class="nav-number">5.5.</span> <span class="nav-text">三维旋转定理（矩阵型）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E7%BB%B4%E6%97%8B%E8%BD%AC%E5%AE%9A%E7%90%86%E6%8C%87%E6%95%B0%E5%9E%8B"><span class="nav-number">5.6.</span> <span class="nav-text">三维旋转定理（指数型）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%8B%E8%BD%AC%E5%A4%8D%E5%90%88-1"><span class="nav-number">5.7.</span> <span class="nav-text">旋转复合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8C%E5%80%8D%E8%A6%86%E7%9B%96"><span class="nav-number">5.8.</span> <span class="nav-text">双倍覆盖</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E5%85%83%E6%95%B0%E6%8F%92%E5%80%BC"><span class="nav-number">6.</span> <span class="nav-text">四元数插值</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E5%B9%82%E8%BF%90%E7%AE%97%E7%9A%84%E6%8F%92%E5%80%BC"><span class="nav-number">6.1.</span> <span class="nav-text">基于幂运算的插值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E5%85%83%E6%95%B0%E5%9C%A8%E5%9B%9B%E7%BB%B4%E7%A9%BA%E9%97%B4%E5%86%85%E7%9A%84%E5%A4%B9%E8%A7%92"><span class="nav-number">6.2.</span> <span class="nav-text">四元数在四维空间内的夹角</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lerp-nlerp-slerp"><span class="nav-number">6.3.</span> <span class="nav-text">Lerp, Nlerp, Slerp</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lerp"><span class="nav-number">6.3.1.</span> <span class="nav-text">Lerp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nlerp"><span class="nav-number">6.3.2.</span> <span class="nav-text">Nlerp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#slerp"><span class="nav-number">6.3.3.</span> <span class="nav-text">Slerp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8C%E5%80%8D%E8%A6%86%E7%9B%96%E9%97%AE%E9%A2%98"><span class="nav-number">6.4.</span> <span class="nav-text">双倍覆盖问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#squad"><span class="nav-number">7.</span> <span class="nav-text">Squad</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#b%C3%A9zier%E6%9B%B2%E7%BA%BF"><span class="nav-number">7.1.</span> <span class="nav-text">Bézier曲线</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E6%AC%A1b%C3%A9zier%E6%9B%B2%E7%BA%BF"><span class="nav-number">7.2.</span> <span class="nav-text">三次Bézier曲线</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#de-casteljau%E7%AE%97%E6%B3%95"><span class="nav-number">7.3.</span> <span class="nav-text">de Casteljau算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#squad-1"><span class="nav-number">7.4.</span> <span class="nav-text">Squad</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#squad%E5%BA%94%E7%94%A8"><span class="nav-number">7.5.</span> <span class="nav-text">Squad应用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#angleeulermatrixquaternion%E4%B9%8B%E9%97%B4%E7%9A%84%E7%9B%B8%E4%BA%92%E8%BD%AC%E6%8D%A2"><span class="nav-number">8.</span> <span class="nav-text">Angle、Euler、Matrix、Quaternion之间的相互转换</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#angle%E8%BD%AC%E5%8C%96%E4%B8%BA%E5%85%B6%E4%BB%96%E5%BD%A2%E5%BC%8F"><span class="nav-number">8.1.</span> <span class="nav-text">Angle转化为其他形式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#angle%E8%BD%AC%E5%8C%96%E4%B8%BAeuler"><span class="nav-number">8.1.1.</span> <span class="nav-text">Angle转化为Euler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#angle%E8%BD%AC%E5%8C%96%E4%B8%BAmatrix"><span class="nav-number">8.1.2.</span> <span class="nav-text">Angle转化为Matrix</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#angle%E8%BD%AC%E5%8C%96%E4%B8%BAquaternion"><span class="nav-number">8.1.3.</span> <span class="nav-text">Angle转化为Quaternion</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#euler%E8%BD%AC%E5%8C%96%E4%B8%BA%E5%85%B6%E4%BB%96%E5%BD%A2%E5%BC%8F"><span class="nav-number">8.2.</span> <span class="nav-text">Euler转化为其他形式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#euler%E8%BD%AC%E5%8C%96%E4%B8%BAangle"><span class="nav-number">8.2.1.</span> <span class="nav-text">Euler转化为Angle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#euler%E8%BD%AC%E5%8C%96%E4%B8%BAmatrix"><span class="nav-number">8.2.2.</span> <span class="nav-text">Euler转化为Matrix</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#euler%E8%BD%AC%E5%8C%96%E4%B8%BAquaternion"><span class="nav-number">8.2.3.</span> <span class="nav-text">Euler转化为Quaternion</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#matrix%E8%BD%AC%E5%8C%96%E4%B8%BA%E5%85%B6%E4%BB%96%E5%BD%A2%E5%BC%8F"><span class="nav-number">8.3.</span> <span class="nav-text">Matrix转化为其他形式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#matrix%E8%BD%AC%E5%8C%96%E4%B8%BAangle"><span class="nav-number">8.3.1.</span> <span class="nav-text">Matrix转化为Angle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#matrix%E8%BD%AC%E5%8C%96%E4%B8%BAeuler"><span class="nav-number">8.3.2.</span> <span class="nav-text">Matrix转化为Euler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#matrix%E8%BD%AC%E5%8C%96%E4%B8%BAquaternion"><span class="nav-number">8.3.3.</span> <span class="nav-text">Matrix转化为Quaternion</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#quaternion%E8%BD%AC%E5%8C%96%E4%B8%BA%E5%85%B6%E4%BB%96%E5%BD%A2%E5%BC%8F"><span class="nav-number">8.4.</span> <span class="nav-text">Quaternion转化为其他形式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#quaternion%E8%BD%AC%E5%8C%96%E4%B8%BAangle"><span class="nav-number">8.4.1.</span> <span class="nav-text">Quaternion转化为Angle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#quaternion%E8%BD%AC%E5%8C%96%E4%B8%BAeuler"><span class="nav-number">8.4.2.</span> <span class="nav-text">Quaternion转化为Euler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#quaternion%E8%BD%AC%E5%8C%96%E4%B8%BAmatrix"><span class="nav-number">8.4.3.</span> <span class="nav-text">Quaternion转化为Matrix</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sulley"
      src="/images/radahn-avatar.png">
  <p class="site-author-name" itemprop="name">Sulley</p>
  <div class="site-description" itemprop="description">珍惜眼前人</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/littlesulley" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;littlesulley" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:qinghonghan97@gmail.com" title="E-Mail → mailto:qinghonghan97@gmail.com" rel="noopener" target="_blank"><i class="fa-solid fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/1631723" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;1631723" rel="noopener" target="_blank"><i class="fab fa-bilibili fa-fw"></i>Bilibili</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://steamcommunity.com/id/beingaway/" title="Steam → https:&#x2F;&#x2F;steamcommunity.com&#x2F;id&#x2F;beingaway&#x2F;" rel="noopener" target="_blank"><i class="fab fa-steam fa-fw"></i>Steam</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/han-qing-hong-33" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;han-qing-hong-33" rel="noopener" target="_blank"><i class="fab fa-zhihu fa-fw"></i>Zhihu</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://kungtalon.github.io/" title="https:&#x2F;&#x2F;kungtalon.github.io&#x2F;" rel="noopener" target="_blank">Kungtalon</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://kaesenudeln.github.io/" title="https:&#x2F;&#x2F;kaesenudeln.github.io&#x2F;" rel="noopener" target="_blank">Zecx</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://sulley.cc/2022/03/25/01/00/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/radahn-avatar.png">
      <meta itemprop="name" content="Sulley">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sulley">
      <meta itemprop="description" content="珍惜眼前人">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="四元数与旋转 | Sulley">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          四元数与旋转
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-25 01:00:33" itemprop="dateCreated datePublished" datetime="2022-03-25T01:00:33+08:00">2022-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-10-08 15:13:43" itemprop="dateModified" datetime="2022-10-08T15:13:43+08:00">2022-10-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E5%AD%A6-%E5%9B%BE%E5%BD%A2%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">数学 - 图形学</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2022/03/25/01/00/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/03/25/01/00/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>49k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>45 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>图形学中的旋转（Rotation）非常重要，用欧拉角（Euler
Angle）旋转非常简单，但是却存在 <strong>万向锁（Gimbal Lock）</strong>
的问题；同时，用欧拉角插值也不尽方便。基于四元数（Quaternion）的旋转既解决了万向锁的问题，又能非常便利地插值。本文将从概念出发，对四元数的定义、推导、性质、应用，以及它与欧拉角之间的联系进行介绍。本文主要参考了Krasjet的《四元数与三维旋转》<a
href="#fn1" class="footnote-ref" id="fnref1"
role="doc-noteref"><sup>1</sup></a>，其他参考内容包括<a href="#fn2"
class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a><a
href="#fn3" class="footnote-ref" id="fnref3"
role="doc-noteref"><sup>3</sup></a><a href="#fn4" class="footnote-ref"
id="fnref4" role="doc-noteref"><sup>4</sup></a><a href="#fn5"
class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a><a
href="#fn6" class="footnote-ref" id="fnref6"
role="doc-noteref"><sup>6</sup></a><a href="#fn7" class="footnote-ref"
id="fnref7" role="doc-noteref"><sup>7</sup></a><a href="#fn8"
class="footnote-ref" id="fnref8"
role="doc-noteref"><sup>8</sup></a>。</p>
<span id="more"></span>
<h1 id="复数与二维旋转">复数与二维旋转</h1>
<p>首先我们将简要介绍复数及它与二维旋转的关系，从而可以更加自然地过度到四元数及其与三维旋转的关系。</p>
<h2 id="定义">定义</h2>
<p>复空间<span
class="math inline">\(\mathbb{C}\)</span>中的任一复数<span
class="math inline">\(z\in\mathbb{C}\)</span>都可以表示为<span
class="math inline">\(z=a+bi\
(a,b\in\mathbb{R})\)</span>的形式，且满足<span
class="math inline">\(i^2=-1\)</span>。此时<span
class="math inline">\(a\)</span>称为复数<span
class="math inline">\(z\)</span>的实部 (Real Part)，表达为<span
class="math inline">\(a=\text{Re}(z)\)</span>；<span
class="math inline">\(b\)</span>称为复数的虚部 (Imaginary
Part)，表达为<span class="math inline">\(b=\text{Im}(z)\)</span>。</p>
<p>从线性代数的角度来看，复数<span
class="math inline">\(z=a+bi\)</span>可以看成是基 (Basis) <span
class="math inline">\(\{1,i\}\)</span>上的线性组合，因此也可以把复数<span
class="math inline">\(z\)</span>写成一个向量：</p>
<p><span class="math display">\[z=\begin{bmatrix}a\\b
\end{bmatrix}\]</span></p>
<h2 id="复数的加法与乘法">复数的加法与乘法</h2>
<h3 id="复数的加法">复数的加法</h3>
<p>复数的加法很简单，分别把实部和虚部相加即可。减法类似，不多赘述。</p>
<h3 id="复数的乘法">复数的乘法</h3>
<p>对复数<span
class="math inline">\(z_1=a+bi,z_2=c+di\)</span>，它们相乘的结果为：</p>
<p><span
class="math display">\[z_1z_2=(a+bi)(c+di)=(ac-bd)+(bc+ad)i\]</span></p>
<p>利用上面讲过的复数的向量形式，可以把上式写成矩阵乘向量的形式：</p>
<p><span class="math display">\[z_1z_2=(ac-bd)+(bc+ad)i=
\begin{bmatrix}
ac-bd\\
bc+ad
\end{bmatrix}=
\begin{bmatrix}
a &amp; -b\\
b &amp; a
\end{bmatrix}
\begin{bmatrix}
c\\
d
\end{bmatrix}\]</span></p>
<p>右侧的向量<span
class="math inline">\(\begin{bmatrix}c\\d\end{bmatrix}\)</span>就是向量形式下的<span
class="math inline">\(z_2\)</span>，而左侧的矩阵<span
class="math inline">\(\begin{bmatrix}a&amp;-b\\b&amp;a\end{bmatrix}\)</span>则是<span
class="math inline">\(z_1\)</span>在乘法时的<strong>矩阵形式</strong>，矩阵的第一列就是自身的向量形式，而第二列进行了交换并对虚部取负。</p>
<p>所以，我们可以把<span
class="math inline">\(z_2\)</span>也写成矩阵形式，然后与<span
class="math inline">\(z_1\)</span>相乘：</p>
<p><span class="math display">\[z_1z_2=
\begin{bmatrix}
a &amp; -b\\
b &amp; a
\end{bmatrix}
\begin{bmatrix}
c &amp; -d\\
d &amp; c
\end{bmatrix}=
\begin{bmatrix}
ac-bd &amp; -(bc+ad)\\
bc+ad &amp; ac-bd
\end{bmatrix}\]</span></p>
<p>所以，我们现在可以用至少三种形式去表达一个复数了（具体用哪种形式取决于我们的需要）：</p>
<ul>
<li>代数形式：<span class="math inline">\(z=a+bi\)</span>;</li>
<li>向量形式：<span
class="math inline">\(z=\begin{bmatrix}a\\b\end{bmatrix}\)</span>;</li>
<li>矩阵形式：<span class="math inline">\(z=\begin{bmatrix}a &amp; -b\\b
&amp; a\end{bmatrix}\)</span>.</li>
</ul>
<p>有两个特殊的复数<span
class="math inline">\(1,i\)</span>，它们的矩阵形式不难得到是：</p>
<p><span class="math display">\[1=\begin{bmatrix}
1 &amp; 0\\
0 &amp; 1
\end{bmatrix}=I\;(a=1, b=0)\]</span></p>
<p><span class="math display">\[i=\begin{bmatrix}
0 &amp; -1\\
1 &amp; 0
\end{bmatrix}\;(a=0, b=1)\]</span></p>
<p>对复数<span
class="math inline">\(i\)</span>的矩阵形式进行平方，发现它就是<span
class="math inline">\(-I\)</span>，从代数形式来看，就等价于<span
class="math inline">\(i^2=-1\)</span>。这说明复数的矩阵形式是良定义的。</p>
<h2 id="复数的模长">复数的模长</h2>
<p>复数<span
class="math inline">\(z=a+bi\)</span>的模长（Magnitude）定义为:</p>
<p><span class="math display">\[\|z\| =\sqrt{a^2+b^2}\]</span></p>
<p>这可以用它的共轭（Conjugate）表示：</p>
<p><span class="math display">\[\|z\| =\sqrt{z\bar{z}},\;
\bar{z}=a-bi\]</span></p>
<h2 id="复数与二维旋转-1">复数与二维旋转</h2>
<h3 id="从复数矩阵形式导出旋转关系">从复数矩阵形式导出旋转关系</h3>
<p>下面将重点引出复数与二维旋转的关系。</p>
<p>注意观察复数<span class="math inline">\(z\)</span>的矩阵形式<span
class="math inline">\(\begin{bmatrix}a &amp; -b\\b &amp;
a\end{bmatrix}\)</span>，我们可以把它变换为下述形式：</p>
<p><span class="math display">\[\begin{bmatrix}
a &amp; -b\\
b &amp; a
\end{bmatrix}=\sqrt{a^2+b^2}
\begin{bmatrix}
\frac{a}{\sqrt{a^2+b^2}} &amp; \frac{-b}{\sqrt{a^2+b^2}}\\
\frac{b}{\sqrt{a^2+b^2}} &amp; \frac{a}{\sqrt{a^2+b^2}}
\end{bmatrix}\]</span></p>
<p>矩阵中的每一项都被模长<span
class="math inline">\(\|z\|\)</span>缩放了，此时注意到<span
class="math inline">\(\frac{a}{\sqrt{a^2+b^2}}\)</span>就是复数<span
class="math inline">\(z\)</span>在复平面与实轴形成夹角<span
class="math inline">\(\theta\)</span>的余弦值<span
class="math inline">\(\cos(\theta)\)</span>，而<span
class="math inline">\(\frac{b}{\sqrt{a^2+b^2}}\)</span>正好对应了正弦值<span
class="math inline">\(\sin(\theta)\)</span>，而这个夹角<span
class="math inline">\(\theta\)</span>就是<span
class="math inline">\(\arctan(b/a)\)</span>。</p>
<p>这样一来，我们就可以把上式写成：</p>
<p><span class="math display">\[
\begin{align}
\begin{bmatrix}
a &amp; -b\\
b &amp; a
\end{bmatrix}&amp;=\|z\|
\begin{bmatrix}
\cos(\theta) &amp; -\sin(\theta)\\
\sin(\theta) &amp; \cos(\theta)
\end{bmatrix}=
\begin{bmatrix}
\|z\| &amp; 0\\
0 &amp; \|z\|
\end{bmatrix}
\begin{bmatrix}
\cos(\theta) &amp; -\sin(\theta)\\
\sin(\theta) &amp; \cos(\theta)
\end{bmatrix}
\label{eq1}
\end{align}
\]</span></p>
<p>这样一来，任意复数<span
class="math inline">\(z=a+bi\)</span>都可以表示为两个矩阵的乘积，一个缩放矩阵<span
class="math inline">\(\begin{bmatrix}\|z\| &amp; 0\\0 &amp;
\|z\|\end{bmatrix}\)</span>和一个（我们熟悉的）旋转矩阵<span
class="math inline">\(\begin{bmatrix}\cos(\theta) &amp;
-\sin(\theta)\\\sin(\theta) &amp;
\cos(\theta)\end{bmatrix}\)</span>的复合。换句话说，<strong>复数的几何意义就是进行旋转与缩放，旋转角度为<span
class="math inline">\(\theta=\arctan(b/a)\)</span>，缩放大小为复数的模长。</strong>
如果复数的模长为1，那么它的几何意义就只有旋转。</p>
<p>所以，对复数<span class="math inline">\(p\)</span>的旋转：</p>
<p><span class="math display">\[p&#39;=\begin{bmatrix}
\cos(\theta) &amp; -\sin(\theta)\\
\sin(\theta) &amp; \cos(\theta)
\end{bmatrix}p\]</span></p>
<p>我们可以构造一个复数<span
class="math inline">\(z=\cos(\theta)+i\sin(\theta)\)</span>，把它与<span
class="math inline">\(p\)</span>相乘表示旋转：</p>
<p><span
class="math display">\[p&#39;=zp=(\cos(\theta)+i\sin(\theta))p\]</span></p>
<h3 id="复数的极坐标形式">复数的极坐标形式</h3>
<p>当我们看到<span
class="math inline">\(\eqref{eq1}\)</span>式的时候，我们立马可以得到复数的另一种代数形式：</p>
<p><span
class="math display">\[z=\|z\|(\cos(\theta)+i\sin(\theta))\]</span></p>
<p>再根据欧拉公式（Euler's Formula）：</p>
<p><span
class="math display">\[\cos(\theta)+i\sin(\theta)=\mathrm{e}^{i\theta}\]</span></p>
<p>可以立得复数的<strong>极坐标形式</strong>：</p>
<p><span
class="math display">\[z=\|z\|\mathrm{e}^{i\theta}=r\mathrm{e}^{i\theta},\;
r=\|z\|\]</span></p>
<p>现在，复数<span
class="math inline">\(z\)</span>不再通过它的实部和虚部表示，而且通过一个旋转角<span
class="math inline">\(\theta\)</span>与缩放因子<span
class="math inline">\(r\)</span>去表示了，它对任意一个复数<span
class="math inline">\(p\)</span>的旋转，都可以表示为：</p>
<p><span
class="math display">\[p&#39;=r\mathrm{e}^{i\theta}p\]</span></p>
<p>如果仅需表示旋转，则令<span
class="math inline">\(r=1\)</span>即可。</p>
<details class="note success no-icon"><summary><p>Proof of Euler's Formula</p>
</summary>
<p>令<span
class="math inline">\(f(\theta)=\frac{\cos(\theta)+i\sin(\theta)}{\mathrm{e}^{i\theta}}=\mathrm{e}^{-i\theta}(\cos(\theta)+i\sin(\theta))\)</span>，对实数<span
class="math inline">\(\theta\)</span>，对<span
class="math inline">\(f(\theta)\)</span>求导，得到<span
class="math inline">\(f&#39;(\theta)=\mathrm{e}^{-i\theta}(i\cos(\theta)-\sin(\theta))-i\mathrm{e}^{-i\theta}(\cos(\theta)+i\sin(\theta))=0\)</span>，因此<span
class="math inline">\(f(\theta)\)</span>是常数。又因为<span
class="math inline">\(f(0)=1\)</span>，所以<span
class="math inline">\(f(\theta)\equiv 1\)</span>。欧拉公式得证。</p>

</details>
<h3 id="复数的几种表示形式总结">复数的几种表示形式总结</h3>
<p>现在我们已经得到了如下几种复数<span
class="math inline">\(z=a+bi\)</span>的表示形式：</p>
<ul>
<li>代数形式一：<span class="math inline">\(z=a+bi\)</span>;</li>
<li>向量形式：<span
class="math inline">\(z=\begin{bmatrix}a\\b\end{bmatrix}\)</span>;</li>
<li>矩阵形式一：<span class="math inline">\(z=\begin{bmatrix}a &amp;
-b\\b &amp; a\end{bmatrix}\)</span>;</li>
<li>矩阵形式二：<span class="math inline">\(z=\begin{bmatrix}\|z\| &amp;
0\\0 &amp; \|z\|\end{bmatrix}\begin{bmatrix}\cos(\theta) &amp;
-\sin(\theta)\\\sin(\theta) &amp;
\cos(\theta)\end{bmatrix}\)</span>;</li>
<li>代数形式二：<span
class="math inline">\(z=r(\cos(\theta)+i\sin(\theta))\)</span>;</li>
<li>极坐标形式：<span
class="math inline">\(z=r\mathrm{e}^{i\theta}\)</span>.</li>
</ul>
<p>这几种形式是完全等价的。</p>
<h2 id="旋转复合">旋转复合</h2>
<p>假设我们现在有两个仅表示旋转的复数<span
class="math inline">\(z_1=\cos(\theta)+i\sin(\theta),z_2=\cos(\phi)+i\sin(\phi)\)</span>，相继用它们对一个复数<span
class="math inline">\(p\)</span>旋转：</p>
<p><span
class="math display">\[p&#39;=z_2z_1p=(z_2z_1)p=(z_1z_2)p=(\cos(\theta+\phi)+i\sin(\theta+\phi))p\]</span></p>
<p>所以，用两个复数进行旋转时，所得到的结果仍然是一个旋转，且旋转的角度是两次旋转角度之和。</p>
<h1 id="基于axis-angle的旋转">基于Axis Angle的旋转</h1>
<p>在<a
href="https://sulley.cc/2021/06/07/%E5%90%91%E9%87%8F%E7%BB%95%E4%BB%BB%E6%84%8F%E8%BD%B4%E6%97%8B%E8%BD%AC%E7%9A%84%E7%AE%80%E5%8D%95%E6%8E%A8%E5%AF%BC/">这篇博客</a>中，我们已经介绍了三维空间中一个向量绕任意轴旋转的公式（被称为<a
target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Rodrigues%27_rotation_formula">Rodrigues'
formula</a>）。因为下文会涉及大量此公式，因此把结论在此重新记述，推导过程请参考原文。</p>
<p>记<span
class="math inline">\(\mathbf{p}\)</span>是待旋转的向量，<span
class="math inline">\(\mathbf{n}\)</span>是被围绕旋转的轴，是一个单位向量，<span
class="math inline">\(\theta\)</span>是要旋转的角度，<span
class="math inline">\(\mathbf{p}&#39;\)</span>是旋转后的向量。我们有：</p>
<p><span
class="math display">\[\mathbf{p}&#39;=\cos(\theta)\mathbf{p}+(1-\cos(\theta))(\mathbf{n}\cdot\mathbf{p})\mathbf{n}+\sin(\theta)(\mathbf{n}\times\mathbf{p})\]</span></p>
<p>或者矩阵形式：</p>
<p><span class="math display">\[
\mathbf{p}&#39;=\mathbf{R}\mathbf{p},\;\mathbf{R}=\mathbf{I}+(1-\cos(\theta))\mathbf{N}^2+\sin(\theta)\mathbf{N},
\mathbf{N}=
\begin{bmatrix}
  0 &amp; -n_z &amp; n_y\\
  n_z &amp; 0 &amp; -n_x\\
  -n_y &amp; n_x &amp; 0
\end{bmatrix}
\]</span></p>
<p>因为这种旋转方式是通过一个旋转轴和一个旋转角度定义的，所以我们称之为Axis
Angle旋转。 请记住此公式，我们将看到它与四元数之间紧密的联系。</p>
<h1 id="欧拉角与万向锁gimbal-lock问题">欧拉角与万向锁（Gimbal
Lock）问题</h1>
<h2 id="unity中的gimbal-lock现象">Unity中的Gimbal Lock现象</h2>
<p>在正式进入四元数之前，我们先介绍欧拉角及其引发的万向锁问题。网上有很多关于Gimbal
Lock的文章，但是找了一通发现大都表述得非常抽象。下面我把这个现象放到Unity中可视化展示，读者应该就能立刻知道问题所在。</p>
<video src="/images/quaternion/1.mp4" preload="metadata" controlslist="nodownload" controls playsinline poster=""></video>
<p>注意左上角红框圈出的部分，X/Y/Z=1表示这个Cube正在绕<strong>世界坐标系</strong>的x/y/z轴旋转，在我们一开始就把Cube绕x轴旋转90度时，我们惊异地发现，旋转y轴或者z轴的效果都是一样的！显然这不是我们想要的结果。</p>
<details class="note default"><summary><p>Codeblock for rotation</p>
</summary>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Rotation</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">float</span> rotationSpeed = <span class="number">45</span>;</span><br><span class="line">    Vector3 currentEulgerAngles = <span class="keyword">new</span> Vector3 (<span class="number">90</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// Rotating 90 degree</span></span><br><span class="line">    <span class="built_in">float</span> x, y, z;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Input.GetKeyDown (KeyCode.X)) x = <span class="number">1</span> - x;</span><br><span class="line">        <span class="keyword">if</span> (Input.GetKeyDown (KeyCode.Y)) y = <span class="number">1</span> - y;</span><br><span class="line">        <span class="keyword">if</span> (Input.GetKeyDown (KeyCode.Z)) z = <span class="number">1</span> - z;</span><br><span class="line"></span><br><span class="line">        currentEulgerAngles += <span class="keyword">new</span> Vector3 (x, y, z) * Time.deltaTime * rotationSpeed;</span><br><span class="line"></span><br><span class="line">        transform.eulerAngles = currentEulgerAngles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        GUIStyle style = <span class="keyword">new</span> GUIStyle ();</span><br><span class="line">        style.fontSize = <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">        GUI.Label (<span class="keyword">new</span> Rect (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="string">&quot;Rotating on X: &quot;</span> + x + <span class="string">&quot; Y: &quot;</span> + y + <span class="string">&quot; Z: &quot;</span> + z, style);</span><br><span class="line">        GUI.Label (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="string">&quot;Transform.eulerAngle: &quot;</span> + transform.eulerAngles, style);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>
<p>那么为什么会出现Gimbal
Lock现象呢？核心原因在于欧拉角旋转顺序是被<strong>固定的</strong>。要理解这句话，我们就要首先知道什么是欧拉角，什么叫固定顺序旋转。</p>
<h2 id="欧拉角坐标系与旋转顺序">欧拉角、坐标系与旋转顺序</h2>
<p>如果你没有任何基础知识取看Wikipedia的<a
target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Euler_angles">Euler
Angles</a>页面，你一定会感到一脸懵逼。从严格的定义来看，Wikipedia的介绍比较准确，但是在这里我们只需要简单地把欧拉角理解为<strong>点</strong>绕着<strong>世界坐标轴</strong>旋转的角度即可。</p>
<p>欧拉证明了三维空间中的任意旋转都可以拆分为沿着<strong>自身</strong>的三个坐标轴的旋转，欧拉角就是这三次旋转的角度。但是在这里我们使用相对于<strong>世界坐标系</strong>的旋转角度，这是因为<u><strong>相对自身坐标系的旋转与相对世界坐标系的旋转是可以互相转换的，只需要把旋转矩阵按照相反顺序相乘即可</strong></u>。</p>
<p>我们把绕着自身坐标系旋转称为<em>intrinsic
rotation</em>，把绕着世界坐标系旋转称为<em>extrinsic rotation</em>。</p>
<details class="note success"><summary><p>Intrinsic rotations and extrinsic rotations</p>
</summary>
<p>假定点<span class="math inline">\(P(x,y,z)\)</span>绕世界坐标轴<span
class="math inline">\(x\to y\to z\)</span>分别旋转<span
class="math inline">\(\theta/\phi/\tau\)</span>度，则旋转后的位置<span
class="math inline">\(P(x&#39;,y&#39;,z&#39;)\)</span>等价于绕自身坐标轴<span
class="math inline">\(z\to y\to x\)</span>分别旋转<span
class="math inline">\(\tau/\phi/\theta\)</span>度。</p>
<p><strong>证明</strong>：</p>
<p>我们知道在世界坐标系中绕<span
class="math inline">\(x/y/z\)</span>轴旋转的旋转矩阵分别为：</p>
<p><span class="math display">\[R_x(\theta)=
\begin{bmatrix}
  1 &amp; 0 &amp; 0\\
  0 &amp; \cos(\theta) &amp; -\sin(\theta)\\
  0 &amp; \sin(\theta) &amp; \cos(\theta)
\end{bmatrix},
R_y(\phi)=
\begin{bmatrix}
  \cos(\phi) &amp; 0 &amp; \sin(\phi)\\
  0 &amp; 1 &amp; 0 \\
  -\sin(\phi) &amp; 0 &amp; \cos(\phi)
\end{bmatrix},
R_z(\tau)=
\begin{bmatrix}
  \cos(\tau) &amp; -\sin(\tau) &amp; 0 \\
  \sin(\tau) &amp; \cos(\tau) &amp; 0 \\
  0 &amp; 0 &amp; 1
\end{bmatrix}\]</span></p>
<p>用<span class="math inline">\(x\to y\to
z\)</span>的顺序进行旋转，得到复合旋转矩阵： <span
class="math display">\[
R_\text{global}=R_z(\tau)R_y(\phi)R_x(\theta)=
\begin{bmatrix}
\cos(\phi)\cos(\tau) &amp;
\sin(\theta)\sin(\phi)\cos(\tau)-\cos(\theta)\sin(\tau) &amp;
\cos(\theta)\sin(\phi)\cos(\tau)+\sin(\theta)\sin(\tau)\\
\cos(\phi)\sin(\tau) &amp;
\sin(\theta)\sin(\phi)\sin(\tau)+\cos(\theta)\cos(\tau) &amp;
\cos(\theta)\sin(\phi)\sin(\tau)-\sin(\theta)\cos(\tau)\\
-\sin(\phi) &amp; \sin(\theta)\cos(\phi) &amp; \cos(\theta)\cos(\phi)
\end{bmatrix}
\]</span></p>
<p>现在考虑在点<span
class="math inline">\(P\)</span>的局部坐标系上按照<span
class="math inline">\(z\to y\to
x\)</span>的顺序旋转，注意，因为是局部坐标系，所以每次旋转都会同等地旋转每个局部坐标轴。旋转之前的局部坐标系与世界坐标系重合。我们能够得到上述绕自身局部坐标系旋转的旋转矩阵<span
class="math inline">\(R_\text{local}\)</span>：</p>
<p><span class="math display">\[
\begin{aligned}
  R_\text{local}&amp;={\color{pink}((R_z(\tau)R_y(\phi))R_x(\theta)(R_z(\tau)R_y(\phi))^{-1})}{\color{teal}(R_z(\tau)R_y(\phi)R_z^{-1}(\tau))}{\color{violet}R_z(\tau)}\\
  &amp;=R_z(\tau)R_y(\phi)R_x(\theta)\\
  &amp;=R_\text{global}
\end{aligned}
\]</span></p>
<p>这里要稍微做一些解释。粉色的<span
class="math inline">\({\color{violet}R_z(\tau)}\)</span>就是最开始基于<span
class="math inline">\(z\)</span>轴的变换，在这个变换之后，局部坐标系也跟着进行了变换，如下图所示：</p>
<p><img data-src="/images/quaternion/0_1.gif" /></p>
<p>可以看到在绕<span
class="math inline">\(z\)</span>轴旋转的过程中，自身局部的<span
class="math inline">\(x/y\)</span>轴也在随之旋转。接下来我们想要绕着自身的<span
class="math inline">\(y\)</span>轴旋转，我们先看看直接操作旋转是怎样的效果：</p>
<p><img data-src="/images/quaternion/0_2.gif" /></p>
<p>可以看到上图进行了两次旋转操作，第一次是绕着自身（其实也是世界坐标系）的<span
class="math inline">\(z\)</span>轴旋转了约<span
class="math inline">\(45\)</span>度，第二次是绕着自身的<span
class="math inline">\(y\)</span>轴（绿色轴）旋转了约<span
class="math inline">\(45\)</span>度，得到了一个倾斜的正方体。</p>
<p>那么，绕自身<span
class="math inline">\(y\)</span>轴旋转这个过程该怎么用数学形式表示呢？其实我们可以这么想：无论局部坐标系怎么变，绕自身的<span
class="math inline">\(y\)</span>轴旋转这个操作都是相对不变的，也就是说，无论有没有第一步的绕<span
class="math inline">\(z\)</span>轴旋转，绕<span
class="math inline">\(y\)</span>轴旋转前后所得到的位置相对自身坐标系而言都是相同的。如此一来，我们就可以<strong>先把绕<span
class="math inline">\(z\)</span>轴旋转这个操作还原回去，进行绕<span
class="math inline">\(y\)</span>轴旋转的操作，然后再恢复到绕<span
class="math inline">\(z\)</span>轴旋转后的状态</strong>，这样就求出了我们原本期望的旋转，也就是绿色部分<span
class="math inline">\({\color{teal}(R_z(\tau)R_y(\phi)R_z^{-1}(\tau))}\)</span>进行的操作。</p>
<p>这个过程可以用下图表示：</p>
<p><img data-src="/images/quaternion/0_3.gif" /></p>
<p>首先我们绕<span class="math inline">\(z\)</span>轴旋转了<span
class="math inline">\(45\)</span>度，然后又还原了回去绕<span
class="math inline">\(y\)</span>轴旋转<span
class="math inline">\(45\)</span>度，最后再恢复到第一步操作后的状态。这里要特别注意的是，最后"恢复到初始状态"这个操作，是针对世界坐标系而言的，而不是当前的局部坐标系，这是因为我们第一步绕<span
class="math inline">\(z\)</span>轴旋转<span
class="math inline">\(45\)</span>度本质上就是在世界坐标系中进行的。</p>
<p>如果你还不理解，我们再来看一下最后公式的粉色部分<span
class="math inline">\({\color{pink}((R_z(\tau)R_y(\phi))R_x(\theta)(R_z(\tau)R_y(\phi))^{-1})}\)</span>，这里的<span
class="math inline">\({\color{pink}R_z(\tau)R_y(\phi)}\)</span>就是前两步旋转的结果，而<span
class="math inline">\({\color{pink}(R_z(\tau)R_y(\phi))^{-1}}\)</span>就是对这个旋转<strong>整体</strong>取反向操作，回复到最开始的没有旋转的状态。所以这时候你应该明白，应该把<span
class="math inline">\({\color{pink}R_z(\tau)R_y(\phi)}\)</span>看作一个整体，而这个整体表示的旋转就是<strong>相对于世界坐标系</strong>而言的。无论之后是否还有更多的旋转，都可以采用这种思路套娃下去。</p>

</details>
<p>有了上述结论，我们在这里就不再关心是局部坐标系还是全局坐标系了，我们默认使用全局坐标系。</p>
<p>此外，<strong>顺序</strong>对基于欧拉角的旋转来说至关重要，这是因为矩阵往往不具备交换律，即<span
class="math inline">\(AB\not=BA\)</span>。所以在实际应用的时候，我们会固定采用一个顺序进行旋转，比如<span
class="math inline">\(x\to y\to
z\)</span>。这种按照固定顺序旋转的做法就导致了Gimbal Lock的产生。</p>
<h2 id="unity中的欧拉角">Unity中的欧拉角</h2>
<p>Unity中的欧拉角是采用<span class="math inline">\(z\to x\to
y\)</span>的顺序进行旋转的。采用<span class="math inline">\(z\to x\to
y\)</span>顺序旋转的直接结果是：当我们固定了<span
class="math inline">\(x\)</span>和<span
class="math inline">\(y\)</span>轴旋转后再增量基于<span
class="math inline">\(z\)</span>轴旋转，会发现物体是在绕着<strong>自身</strong>的<span
class="math inline">\(z\)</span>轴旋转而不是绕着世界坐标系的<span
class="math inline">\(z\)</span>轴旋转。如下图所示：</p>
<p><img data-src="/images/quaternion/2.gif" /></p>
<p>这是因为当我们变动欧拉角的时候，Unity会<strong>重新</strong>按照<span
class="math inline">\(z\to x\to
y\)</span>的顺序计算旋转。如果我们固定了<span
class="math inline">\(x\)</span>轴和<span
class="math inline">\(y\)</span>轴的旋转角，不断地变动<span
class="math inline">\(z\)</span>轴旋转角的时候，Unity会首先对<span
class="math inline">\(z\)</span>轴进行旋转，然后才是对<span
class="math inline">\(x\)</span>和<span
class="math inline">\(y\)</span>轴，然而在对<span
class="math inline">\(x/y\)</span>轴旋转的过程中，物体的局部坐标系也在随之变动。既然我们已经固定了<span
class="math inline">\(x/y\)</span>轴的旋转角度，变换的只有<span
class="math inline">\(z\)</span>轴，所以最终呈现出来就是物体在绕自身局部坐标系的<span
class="math inline">\(z\)</span>轴旋转。</p>
<h2 id="unity中的gimbal-lock问题">Unity中的Gimbal Lock问题</h2>
<p>有了上面的铺垫，我们就知道为什么会出现开头那样的Gimbal
Lock现象了。当我们固定<span
class="math inline">\(x\)</span>轴的旋转角度为<span
class="math inline">\(\theta=90\)</span>度时，再设绕<span
class="math inline">\(y\)</span>轴和<span
class="math inline">\(z\)</span>轴的旋转角度为<span
class="math inline">\(\phi,\tau\)</span>，我们可以把以<span
class="math inline">\(z\to x\to y\)</span>为顺序的复合旋转矩阵写为：</p>
<p><span class="math display">\[
\begin{aligned}
  R_{zxy}&amp;=R_y(\phi)R_x(\tfrac{\pi}{2})R_z(\tau)\\
  &amp;=
  \begin{bmatrix}
    \cos(\phi)\cos(\tau)+\sin(\phi)\sin(\tau) &amp;
-\cos(\phi)\sin(\tau)+\sin(\phi)\cos(\tau) &amp; 0\\
    0 &amp; 0 &amp; -1\\
    -\sin(\phi)\cos(\tau)+\cos(\phi)\sin(\tau) &amp;
\sin(\phi)\sin(\tau)+\cos(\phi)\cos(\tau) &amp; 0
  \end{bmatrix}\\
  &amp;=\begin{bmatrix}
    \cos(\phi-\tau) &amp; \sin(\phi-\tau) &amp; 0\\
    0 &amp; 0 &amp; -1\\
    -\sin(\phi-\tau) &amp; \cos(\phi-\tau) &amp; 0
  \end{bmatrix}\\
  &amp;=R_x(\tfrac{\pi}{2})R_z(\tau-\phi)
\end{aligned}
\]</span></p>
<p>我们发现，这个旋转矩阵竟然仅仅是旋转了<span
class="math inline">\(z\)</span>和<span
class="math inline">\(x\)</span>轴，它并没有对物体本身的<span
class="math inline">\(y\)</span>轴做旋转（可以看本节最开始的视频，正方体围绕蓝色的轴，也即自身的<span
class="math inline">\(z\)</span>轴在旋转），而是把两个变换合并为了一个变换。还记得我们上一小节讲到的固定<span
class="math inline">\(x/y\)</span>轴只变动<span
class="math inline">\(z\)</span>轴时物体围绕自身的<span
class="math inline">\(z\)</span>轴旋转的现象吗？在这个地方，我们固定了<span
class="math inline">\(x\)</span>轴的旋转为<span
class="math inline">\(90\)</span>度，对<span
class="math inline">\(y\)</span>轴和对<span
class="math inline">\(z\)</span>轴的变换都作用到了<span
class="math inline">\(z\)</span>轴上，所以最终呈现的效果就是物体绕了<span
class="math inline">\(x\)</span>轴旋转<span
class="math inline">\(90\)</span>度之后<strong>只能围绕自身的<span
class="math inline">\(z\)</span>轴旋转</strong>。我们再也没有机会对物体原本的<span
class="math inline">\(y\)</span>轴进行变换了，这就是所谓的Gimbal
Lock问题。</p>
<p>所以，由此可见，Gimbal
Lock产生的根本原因在于采用固定的旋转顺序，因为旋转顺序固定，所以就会在某些情况（如此处<span
class="math inline">\(x\)</span>轴恒定旋转为<span
class="math inline">\(90\)</span>度）下失去一个轴的自由度。采用欧拉角就意味着旋转顺序有先后，就必然会出现Gimbal
Lock问题。</p>
<p>除了Gimbal Lock之外，Euler
Angles还存在插值困难和歧义性（与旋转矩阵之间的对应关系复杂）等问题。</p>
<h1 id="四元数">四元数</h1>
<h2 id="定义-1">定义</h2>
<p>四元数可以定义为如下形式：</p>
<p><span class="math display">\[q=a+bi+cj+dk
\;(a,b,c,d\in\mathbb{R})\]</span></p>
<p>这个定义和复数非常相似，只不过四元数有三个“虚部” (<span
class="math inline">\(i,j,k\)</span>)，而复数只有一个“虚部” (<span
class="math inline">\(i\)</span>)。</p>
<p>上述的<span class="math inline">\(i,j,k\)</span>满足如下性质：</p>
<p><span class="math display">\[i^2=j^2=k^2=ijk=-1\]</span></p>
<p>如果把上式称为四元数的<strong>代数形式</strong>，那么同样地，它也可以有对应的<strong>向量形式一</strong>：</p>
<p><span class="math display">\[q=\begin{bmatrix}
  a\\b\\c\\d
\end{bmatrix}\]</span></p>
<p>如果把四元数<span
class="math inline">\(q\)</span>的“实部”和“虚部”拆开，那么四元数还可以表示为下述的<strong>向量形式二</strong>：</p>
<p><span class="math display">\[q=[s,\mathbf{v}],\;
(\mathbf{v}=\begin{bmatrix}
  x\\
  y\\
  z
\end{bmatrix},s,x,y,z\in\mathbb{R})\]</span></p>
<p>所以，仅仅从定义来看，四元数就有如下三种等价的形式：</p>
<ul>
<li><strong>代数形式</strong>：<span
class="math inline">\(q=a+bi+cj+dk\)</span>;</li>
<li><strong>向量形式一</strong>：<span
class="math inline">\(q=\begin{bmatrix}a\\b\\c\\d\end{bmatrix}\)</span>;</li>
<li><strong>向量形式二</strong>：<span
class="math inline">\(q=[s,\mathbf{v}]\)</span>.</li>
</ul>
<h2 id="加法乘法模长">加法、乘法、模长</h2>
<h3 id="加法">加法</h3>
<p>给定两个四元数<span
class="math inline">\(q_1=a_1+b_1i+c_1j+d_1k\)</span>与<span
class="math inline">\(q_2=a_2+b_2i+c_2j+d_2k\)</span>，定义四元数的加法为：</p>
<p><span
class="math display">\[q_1+q_2=(a_1+a_2)+(b_1+b_2)i+(c_1+c_2)j+(d_1+d_2)k\]</span></p>
<p>用四元数的向量形式<span
class="math inline">\(q_1=[a_1,\mathbf{v}_1],q_2=[a_2,\mathbf{v}_2]\)</span>，可以把上式简化为：</p>
<p><span class="math display">\[q_1\pm q_2=[a_1\pm a_2, \mathbf{v}_1\pm
\mathbf{v}_2]\]</span></p>
<h3 id="乘法">乘法</h3>
<p>四元数的标量乘法和实数、复数一样，可以定义为：</p>
<p><span class="math display">\[sq=s(a+bi+cj+dk)\]</span></p>
<p>然而四元数之间的乘积可以通过如下步骤定义：</p>
<p><span class="math display">\[
\begin{equation}
  \begin{aligned}
  q_1q_2=&amp;(a_1+b_1i+c_1j+d_1k)(a_2+b_2i+c_2j+d_2k)\\
        =&amp;a_1a_2+a_1b_2i+a_1c_2j+a_1d_2k+\\
        &amp;b_1a_2i+b_1b_2i^2+b_1c_2ij+b_1d_2ik+\\
        &amp;c_1a_2j+c_1b_2ji+c_1c_2j^2+c_1d_2jk+\\
        &amp;d_1a_2k+d_1b_2ki+d_1c_2kj+d_1d_2k^2
  \end{aligned}
\end{equation}
\]</span></p>
<p>我们可以从性质<span
class="math inline">\(i^2=j^2=k^2=ijk=-1\)</span>推导出如下的性质：</p>
<p><span class="math inline">\(jk=i\)</span>, <span
class="math inline">\(ij=k\)</span>, <span
class="math inline">\(ki=j\)</span>, <span
class="math inline">\(kj=-i\)</span>, <span
class="math inline">\(ji=-k\)</span>, <span
class="math inline">\(ik=-j\)</span></p>
<p>于是能够得到下表：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;"><span
class="math inline">\(\times\)</span></th>
<th style="text-align: center;"><span
class="math inline">\(1\)</span></th>
<th style="text-align: center;"><span
class="math inline">\(i\)</span></th>
<th style="text-align: center;"><span
class="math inline">\(j\)</span></th>
<th style="text-align: center;"><span
class="math inline">\(k\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span
class="math inline">\(1\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(1\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(i\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(j\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(k\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span
class="math inline">\(i\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(i\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(-1\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(k\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(-j\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span
class="math inline">\(j\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(j\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(-k\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(-1\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(i\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span
class="math inline">\(k\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(k\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(j\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(-i\)</span></td>
<td style="text-align: center;"><span
class="math inline">\(-1\)</span></td>
</tr>
</tbody>
</table>
<p>容易观察到交换律并不成立，即<span class="math inline">\(ij\neq
ji\)</span>。利用这个表格，我们能够对四元数之间的乘法进行归纳简化：</p>
<p><span class="math display">\[
\begin{equation}
  \begin{aligned}
  q_1q_2=&amp;(a_1+b_1i+c_1j+d_1k)(a_2+b_2i+c_2j+d_2k)\\
        =&amp;(a_1a_2-b_1b_2-c_1c_2-d_1d_2)+\\
        &amp;(a_1b_2+b_1a_2+c_1d_2-d_1c_2)i+\\
        &amp;(a_1c_2-b_1d_2+c_1a_2+d_1b_2)j+\\
        &amp;(a_1d_2+b_1c_2-c_1b_2+d_1a_2)k
  \end{aligned}
\end{equation}
\]</span></p>
<p>现在，得到的这个新四元数<span
class="math inline">\(q_0=q_1q_2\)</span>的四个分量都表示了出来，即：</p>
<p><span class="math display">\[q_0=a_0+b_0i+c_0j+d_0k,\; \begin{cases}
  a_0=a_1a_2-b_1b_2-c_1c_2-d_1d_2\\
  b_0=a_1b_2+b_1a_2+c_1d_2-d_1c_2\\
  c_0=a_1c_2-b_1d_2+c_1a_2+d_1b_2\\
  d_0=a_1d_2+b_1c_2-c_1b_2+d_1a_2
\end{cases}\]</span></p>
<p>或者可以写成下述的<strong>矩阵形式</strong>：</p>
<p><span class="math display">\[q_0=q_1q_2=\begin{bmatrix}
  a_0\\
  b_0\\
  c_0\\
  d_0
\end{bmatrix}=\begin{bmatrix}
  a_2 &amp; -b_2 &amp; -c_2 &amp; -d_2\\
  b_2 &amp; a_2 &amp; d_2 &amp; -c_2\\
  c_2 &amp; -d_2 &amp; a_2 &amp; b_2\\
  d_2 &amp; c_2 &amp; -b_2 &amp; a_2
\end{bmatrix}\begin{bmatrix}
  a_1\\
  b_1\\
  c_1\\
  d_1
\end{bmatrix}\]</span></p>
<p>这样一来，我们就把两个四元数的乘积写成了矩阵与向量的乘积，并且由于四元数的乘法不可交换，<span
class="math inline">\(q_0=q_1q_2\)</span>代表的仅仅是<span
class="math inline">\(q_1\)</span>为左乘数、<span
class="math inline">\(q_2\)</span>为右乘数时的结果。我们把矩阵<span
class="math inline">\(\begin{bmatrix}a_2 &amp; -b_2 &amp; -c_2 &amp;
-d_2\\b_2 &amp; a_2 &amp; d_2 &amp; -c_2\\c_2 &amp; -d_2 &amp; a_2 &amp;
b_2\\d_2 &amp; c_2 &amp; -b_2 &amp;
a_2\end{bmatrix}\)</span>称为四元数<span
class="math inline">\(q_2\)</span>当右乘子时的变换矩阵，或<strong>矩阵形式</strong>。</p>
<h3 id="graßmann积">Graßmann积</h3>
<p>显然矩阵形式又臭又长，我们希望用一种更简单的形式——Graßmann积——去表示四元数乘法。</p>
<p>重新整理之前的乘法结果：</p>
<p><span class="math display">\[
\begin{equation}
  \begin{aligned}
q_0=q_1q_2=&amp;(a_1a_2-(b_1b_2+c_1c_2+d_1d_2))+\\
          &amp;({\color{pink}{a_1}}b_2+{\color{teal}{a_2}}b_1+{\color{violet}{c_1d_2-d_1c_2}})i+\\
          &amp;({\color{pink}{a_1}}c_2+{\color{teal}{a_2}}c_1+{\color{violet}{d_1b_2-b_1d_2}})j\\
          &amp;({\color{pink}{a_1}}d_2+{\color{teal}{a_2}}d_1+{\color{violet}{b_1c_2-c_1b_2}})k
  \end{aligned}
\end{equation}
\]</span></p>
<p>如果令<span
class="math inline">\(q_1=[a_1,\mathbf{v}_1],q_2=[a_2,\mathbf{v}_2]\)</span>，则有：</p>
<p><span class="math display">\[
\begin{aligned}
  \mathbf{v}_1\cdot \mathbf{v}_2&amp;=b_1b_2+c_1c_2+d_1d_2\\
  \mathbf{v}_1\times\mathbf{v}_2&amp;=\begin{bmatrix}
    \mathbf{i} &amp; \mathbf{j} &amp; \mathbf{k}\\
    b_1 &amp; c_1 &amp; d_1\\
    b_2 &amp; c_2 &amp; d_2
  \end{bmatrix}=({\color{violet}{c_1d_2-d_1c_2}})\mathbf{i}+({\color{violet}{d_1b_2-b_1d_2}})\mathbf{j}+({\color{violet}{b_1c_2-c_1b_2}})\mathbf{k}
\end{aligned}
\]</span></p>
<p>这样一来，我们就可以用点乘和叉乘的形式表示四元数的乘积：</p>
<p><span class="math display">\[\begin{aligned}
  q_0=q_1q_2=[a_1a_2-\mathbf{v}_1\cdot\mathbf{v}_2,a_1\mathbf{v}_2+a_2\mathbf{v}_1+\mathbf{v}_1\times\mathbf{v}_2]
\end{aligned}\]</span></p>
<p>这就是所谓的Graßmann积（Graßmann
Product）。所以，从Graßmann积也可能看到两个四元数的乘积一般是不可交换的，因为叉乘一般不可交换。</p>
<h3 id="模长">模长</h3>
<p>四元数的模长和向量的模长定义一样：</p>
<p><span class="math display">\[\|q\|
=\sqrt{a^2+b^2+c^2+d^2}=\sqrt{a^2+\mathbf{v}\cdot
\mathbf{v}}\]</span></p>
<h2 id="纯四元数">纯四元数</h2>
<p>定义“实部”为零的四元数为<strong>纯四元数</strong>，即：</p>
<p><span class="math display">\[q=[0,\mathbf{v}]\]</span></p>
<p>对于两个纯四元数<span
class="math inline">\(q_1=[0,\mathbf{v}_1],q_2=[0,\mathbf{v}_2]\)</span>，它们的乘积为：</p>
<p><span
class="math display">\[q_1q_2=[-\mathbf{v}_1\cdot\mathbf{v}_2,\mathbf{v}_1\times
\mathbf{v}_2]\]</span></p>
<h2 id="共轭">共轭</h2>
<p>四元数的共轭（Conjugation）与复数的共轭类似，可以定义为：</p>
<p><span
class="math display">\[q^*=[a,-\mathbf{v}]=[a,-b,-c,-d]=a-bi-cj-dk\]</span></p>
<p>四元数与它自己的共轭相乘可以得到一个标量：</p>
<p><span
class="math display">\[qq^*=[a^2+\mathbf{v}\cdot\mathbf{v},-a\mathbf{v}+a\mathbf{v}+\mathbf{v}\times(-\mathbf{v})]=[a^2+\mathbf{v}\cdot\mathbf{v},0]=\|q\|^2\]</span></p>
<p>正好是四元数模长的平方。同时：</p>
<p><span
class="math display">\[q^*q=(q^*)(q^*)^*=\|q^*\|^2=\|q\|^2\]</span></p>
<p>这表明四元数与它共轭的乘法是可交换的。这是一个非常好的性质。</p>
<h2 id="逆">逆</h2>
<p>有了共轭，我们最后就可以来定义四元数的逆（Inverse）了。记四元数<span
class="math inline">\(q\)</span>的逆为<span
class="math inline">\(q^{-1}\)</span>，则<span
class="math inline">\(q^{-1}\)</span>是满足下述性质的四元数：</p>
<p><span class="math display">\[qq^{-1}=q^{-1}q=1,\; (q\neq
0)\]</span></p>
<p>利用共轭，我们可以进行如下推导：</p>
<p><span class="math display">\[
\begin{aligned}
  qq^{-1}&amp;=1\\
  q^*qq^{-1}&amp;=q^*\\
  \|q\|^2q^{-1}&amp;=q^*\\
  q^{-1}&amp;=\frac{q^*}{\|q\|^2}
\end{aligned}
\]</span></p>
<p>所以，四元数的逆就是它的共轭除以它模长的平方。如果<span
class="math inline">\(\|q\|=1\)</span>，那么它的逆就是它的共轭，此时称<span
class="math inline">\(q\)</span>为一个<strong>单位四元数</strong> (Unit
Quaternion)。</p>
<h1 id="四元数与三维旋转">四元数与三维旋转</h1>
<h2 id="从三维旋转公式到四元数表示">从三维旋转公式到四元数表示</h2>
<p>现在我们正式考察四元数与三维旋转之间的关系。首先，让我们回忆一下普通3D旋转的推导过程：</p>
<details class="note success"><summary><p>A sketch derivation of Rodrigues' formula</p>
</summary>
<p>记<span
class="math inline">\(\mathbf{p}\)</span>是待旋转的向量，<span
class="math inline">\(\mathbf{n}\)</span>是被围绕旋转的轴，是一个单位向量，<span
class="math inline">\(\theta\)</span>是要旋转的角度，<span
class="math inline">\(\mathbf{p}&#39;\)</span>是旋转后的向量。则：</p>
<p><span class="math display">\[
\begin{aligned}
  \mathbf{p}&#39;&amp;=\mathbf{p}&#39;_\parallel+\mathbf{p}&#39;_\perp\\
             &amp;=\mathbf{p}_\parallel+\cos(\theta)\mathbf{p}_\perp+\sin(\theta)(\mathbf{n}\times\mathbf{p}_\perp)\\
             &amp;(=\cos(\theta)\mathbf{p}+(1-\cos(\theta))(\mathbf{n}\cdot\mathbf{p})\mathbf{n}+\sin(\theta)(\mathbf{n}\times\mathbf{p}))\;(\text{omit
this line)}
\end{aligned}
\]</span></p>

</details>
<p>现在我们想要找到四元数与上式的关系，我们自然地想到能不能像推导四元数乘法的<strong>矩阵形式</strong>那样，把上面所有的向量都用四元数去表示。于是我们可以定义：</p>
<p><span class="math display">\[p&#39;=[0,\mathbf{p}&#39;],\
p&#39;_\parallel=[0, \mathbf{p}&#39;_\parallel],\ p&#39;_\perp=[0,
\mathbf{p}&#39;_\perp],\ p=[0, \mathbf{p}], p_\parallel=[0,
\mathbf{p}_\parallel],\ p_\perp=[0, \mathbf{p}_\perp],\ n=[0,
\mathbf{n}]\]</span></p>
<p>从而我们有：</p>
<p><span class="math display">\[
\begin{equation}
\label{eq2}
  p&#39;=p_\parallel+\cos(\theta)p_\perp+\sin(\theta)(\mathbf{n}\times
\mathbf{p}_\perp)
\end{equation}
\]</span></p>
<p>前面两项我们已经顺利地用四元数表示出来了，但是第三项的叉乘怎么办？我们先尝试一下用对应的四元数相乘看看：</p>
<p><span
class="math display">\[np_\perp=[0,\mathbf{n}]\cdot[0,\mathbf{p}_\perp]=[0,\mathbf{n}\times\mathbf{p}_\perp]=\mathbf{n}\times\mathbf{p}_\perp\]</span></p>
<p>这里就用到了纯四元数的概念。不管怎样，我们很“幸运”地用四元数的乘法把最后的叉乘表示了出来，代入<span
class="math inline">\(\eqref{eq2}\)</span>中，就有：</p>
<p><span class="math display">\[
p&#39;=p_\parallel+\cos(\theta)p_\perp+\sin(\theta)np_\perp=p_\parallel+qp_\perp,\;
(q=\cos(\theta)+\sin(\theta)n)
\]</span></p>
<p>这里的<span
class="math inline">\(q\)</span>用四元数的向量就可以表示为<span
class="math inline">\(q=[\cos(\theta),\sin(\theta)\mathbf{n}]\)</span>，而且还可以验证它是一个单位四元数（模长为1）！</p>
<h2 id="四元数旋转公式的简化">四元数旋转公式的简化</h2>
<p>现在我们也可以像之前那样，分别把<span
class="math inline">\(p_\parallel,p_\perp,q\)</span>代入，但是我们想要更好的形式。为了进一步化简上式，我们需要证明三个引理。</p>
<h3 id="引理一">引理一</h3>
<details class="note primary"><summary><p>Lemma 1</p>
</summary>
<p>如果<span
class="math inline">\(q=[\cos(\theta),\sin(\theta)\mathbf{n}]\)</span>，且<span
class="math inline">\(\mathbf{n}\)</span>为单位向量，则<span
class="math inline">\(q^2=qq=[\cos(2\theta),\sin(2\theta)\mathbf{n}]\)</span>.</p>

</details>
<p>证明从略。</p>
<p>现在我们引入一个新的四元数<span
class="math inline">\(w=[\cos(\frac{1}{2}\theta),\sin(\frac{1}{2}\theta)\mathbf{n}]\)</span>，根据引理一，我们显然有<span
class="math inline">\(w^2=q\)</span>，并且<span
class="math inline">\(w\)</span>也是单位四元数，从而<span
class="math inline">\(w^{-1}=w^*\)</span>。</p>
<p>所以，之前的结果现在就可以重写为：</p>
<p><span
class="math display">\[p&#39;=p_\parallel+qp_\perp=ww^*p_\parallel+wwp_\perp\]</span></p>
<p>这里用<span
class="math inline">\(w\)</span>的原因就是要把两项都表示为三个因子的乘积。<span
class="math inline">\(ww^*\)</span>实际上是一个恒等变换，它并不对<span
class="math inline">\(p_\parallel\)</span>产生作用，真正起作用的是<span
class="math inline">\(w^2\)</span>，它对<span
class="math inline">\(p_\perp\)</span>旋转了<span
class="math inline">\(\theta\)</span>度，使得相加后能得到正确的结果。</p>
<p>但是这种形式还是不能简化右式，我们需要下面的<strong>引理二</strong>。</p>
<h3 id="引理二">引理二</h3>
<details class="note primary"><summary><p>Lemma 2</p>
</summary>
<p>如果<span
class="math inline">\(p_\parallel=[0,\mathbf{p}_\parallel]\)</span>是一个纯四元数，<span
class="math inline">\(w=[\alpha,\beta \mathbf{n}]\)</span>，其中<span
class="math inline">\(\mathbf{n}\)</span>是单位向量，<span
class="math inline">\(\alpha,\beta\in\mathbb{R}\)</span>。若<span
class="math inline">\(\mathbf{p}_\parallel\)</span>平行于<span
class="math inline">\(\mathbf{n}\)</span>，则<span
class="math inline">\(p_\parallel w=wp_\parallel\)</span>.</p>

</details>
<p>该引理证明如下：</p>
<p><span class="math display">\[
\begin{aligned}
  \text{LHS}&amp;=[0,\mathbf{p}_\parallel]\cdot[\alpha,\beta
\mathbf{n}]\\
  &amp;=[-\beta \mathbf{p}_\parallel\cdot \mathbf{n},\alpha
\mathbf{p}_\parallel]
\end{aligned}
\]</span></p>
<p><span class="math display">\[
\begin{aligned}
  \text{RHS}&amp;=[\alpha,\beta
\mathbf{n}]\cdot[0,\mathbf{p}_\parallel]\\
  &amp;=[-\beta \mathbf{p}_\parallel\cdot \mathbf{n}, \alpha
\mathbf{p}_\parallel]\\
  &amp;=\text{LHS}
\end{aligned}
\]</span></p>
<p>根据引理二，我们就可以把上式的第一项最后两个因子交换，得到：</p>
<p><span class="math display">\[p&#39;=wp_\parallel
w^*+wwp_\perp\]</span></p>
<p>我们再使用<strong>引理三</strong>进行最后的化简。</p>
<h3 id="引理三">引理三</h3>
<details class="note primary"><summary><p>Lemma 3</p>
</summary>
<p>如果<span
class="math inline">\(p_\perp=[0,\mathbf{p}_\perp]\)</span>是一个纯四元数，<span
class="math inline">\(w=[\alpha,\beta \mathbf{n}]\)</span>，其中<span
class="math inline">\(\mathbf{n}\)</span>是单位向量，<span
class="math inline">\(\alpha,\beta\in\mathbb{R}\)</span>。若<span
class="math inline">\(\mathbf{p}_\perp\)</span>正交于<span
class="math inline">\(\mathbf{n}\)</span>，则<span
class="math inline">\(wp_\perp=p_\perp w^*\)</span>.</p>

</details>
<p>证明与引理二过程类似，不多赘述。根据这个引理，我们就能对原式做最后的化简：</p>
<p><span class="math display">\[
\begin{aligned}
  p&#39;&amp;=wp_\parallel w^*+wwp_\perp\\
  &amp;=wp_\parallel w^*+wp_\perp w^*\\
  &amp;=w(p_\parallel+p_\perp)w^*\\
  &amp;=wpw^*
\end{aligned}
\]</span></p>
<p>最后我们得到了一个非常优美的结果，在这个公式中，我们不再把待旋转向量拆分为两个分量，而是直接通过四元数之间的乘法实现了旋转。该结论可以总结为一个定理：</p>
<h2 id="三维旋转定理四元数型">三维旋转定理（四元数型）</h2>
<details class="note success"><summary><p>3D Rotation Theorem (Quaternion)</p>
</summary>
<p>任意三维向量<span
class="math inline">\(\mathbf{p}\)</span>绕着单位向量<span
class="math inline">\(\mathbf{n}\)</span>旋转<span
class="math inline">\(\theta\)</span>度之后的向量<span
class="math inline">\(\mathbf{p}&#39;\)</span>可以用下式表示：</p>
<p><span class="math display">\[p&#39;=wpw^*,\;
(p=[0,\mathbf{p}],w=[\cos(\tfrac{1}{2}\theta),\sin(\tfrac{1}{2}\theta)\mathbf{n}])\]</span></p>

</details>
<p>现在我们进行验证：</p>
<p><span class="math display">\[
\begin{aligned}
  wpw^*&amp;=(wp)w^*\\
  &amp;=([\cos(\tfrac{1}{2}\theta),\sin(\tfrac{1}{2}\theta)\mathbf{n}]\cdot[0,\mathbf{p}])\cdot
[\cos(\tfrac{1}{2}\theta),-\sin(\tfrac{1}{2}\theta)\mathbf{n}]\\
  &amp;=[-\sin(\tfrac{1}{2}\theta)\mathbf{n}\cdot\mathbf{p},
\cos(\tfrac{1}{2}\theta)\mathbf{p}+\sin(\tfrac{1}{2}\theta)\mathbf{n}\times\mathbf{p}]\cdot
[\cos(\tfrac{1}{2}\theta),-\sin(\tfrac{1}{2}\theta)\mathbf{n}]\\
  &amp;=[0,\cos(\theta)\mathbf{p}+(1-\cos(\theta))(\mathbf{n}\cdot\mathbf{p})\mathbf{n}+\sin(\theta)(\mathbf{n}\times\mathbf{p})]
\end{aligned}
\]</span></p>
<p>正好就是Rodrigues' formula！</p>
<p>并且，从上面的推导我们还知道：<strong>所有的单位四元数都对应了一个三维旋转（但这二者之间并非双射）</strong>。那么给定单位四元数<span
class="math inline">\(w=[a,\mathbf{b}]\)</span>，我们就能得到它对应的旋转角<span
class="math inline">\(\theta\)</span>和旋转轴<span
class="math inline">\(\mathbf{n}\)</span>：</p>
<p><span
class="math display">\[\color{violet}\frac{\theta}{2}=\arccos(a),\;\mathbf{n}=\frac{\mathbf{b}}{\sin(\arccos(a))}\]</span></p>
<p>因此，我们得到了：</p>
<p><span
class="math display">\[w=[a,\mathbf{b}]=[\cos(\tfrac{\theta}{2}),\sin(\tfrac{\theta}{2})\mathbf{n}]\]</span></p>
<h2 id="四元数乘积的性质">四元数乘积的性质</h2>
<p>下面我们介绍几个关于四元数乘积的性质，这些性质与我们的主题没有直接关联，但对我们深入理解四元数大有帮助，供感兴趣的读者参考。</p>
<details class="note primary"><summary><p>Property 1</p>
</summary>
<p>令<span class="math inline">\(w\)</span>为单位四元数，<span
class="math inline">\(p=[a,\mathbf{b}]\)</span>，则<span
class="math inline">\(p&#39;=wpw^*\)</span>满足<span
class="math inline">\(p=[a,\mathbf{b}&#39;]\)</span>且<span
class="math inline">\(\|\mathbf{b&#39;}\|=\|\mathbf{b}\|\)</span>。</p>
<p><strong>证明</strong>：</p>
<p><span class="math display">\[
\begin{aligned}
  p&#39;&amp;=wpw^*\\
  &amp;=w([a,\mathbf{0}]+[0,\mathbf{b}])w^*\\
  &amp;=w[a,\mathbf{0}]w^*+w[0,\mathbf{b}]w^*\\
  &amp;=[a,\mathbf{0}]ww^*+[0,\mathbf{b}&#39;]\\
  &amp;=[a,\mathbf{b}&#39;]
\end{aligned}
\]</span></p>
<p>此外，还有<span
class="math inline">\(\|p&#39;\|=\|wpw^*\|=\|w\|\|p\|\|w^*\|=\|p\|\)</span>，从而推得<span
class="math inline">\(\|\mathbf{b&#39;}\|=\|\mathbf{b}\|\)</span>。</p>

</details>
<p>Property
1告诉我们：对四元数的旋转不改变标量和向量的模长。这与四元数表示旋转的本质是符合的。</p>
<details class="note primary"><summary><p>Property 2</p>
</summary>
<p>令<span class="math inline">\(w,p\)</span>都为单位四元数，<span
class="math inline">\(p=[\cos(\theta),\sin(\theta)\mathbf{n}]\)</span>，对<span
class="math inline">\(t\in\mathbb{R}\)</span>有<span
class="math inline">\(wp^tw^*=(wpw^*)^t\)</span>。</p>
<p><strong>证明</strong>：</p>
<p><span class="math display">\[
\begin{aligned}
  wp^tw^*&amp;=w(\exp(t\log(p)))w^*\\
  &amp;=w(\exp[0,t\theta\mathbf{n}])w^*\\
  &amp;=w[\cos(t\theta),\sin(t\theta)\mathbf{n}]w^*\\
  &amp;=[\cos(t\theta),\sin(t\theta)\mathbf{n}&#39;]\\
  &amp;=\exp(t[0,\theta\mathbf{n}&#39;])\\
  &amp;=\exp(t\log[\cos(\theta),\sin(\theta)\mathbf{n}&#39;])\\
  &amp;=\exp(t\log(wpw^*))\\
  &amp;=(wpw^*)^t
\end{aligned}
\]</span></p>
<p>其中第四个等号和第七个等号可以通过Property 1推知。</p>

</details>
<p>Property 2告诉我们：对一个单位四元数的<span
class="math inline">\(t\)</span>次幂旋转，等价于对单位四元数旋转的<span
class="math inline">\(t\)</span>次幂。</p>
<p>接下来的四个性质与单位四元数的求导有关。</p>
<details class="note primary"><summary><p>Property 3 (Derivative of exponential)</p>
</summary>
<p>令<span
class="math inline">\(p=[\cos(\theta),\sin(\theta)\mathbf{n}]\)</span>为单位四元数，<span
class="math inline">\(t\in\mathbb{R}\)</span>，则有：</p>
<p><span
class="math display">\[\frac{\mathrm{d}}{\mathrm{d}t}p^t=p^t\log(p)\]</span></p>
<p><strong>证明</strong>：</p>
<p><span class="math display">\[
  \frac{\mathrm{d}}{\mathrm{d}t}q^t=\frac{\mathrm{d}}{\mathrm{d}t}\exp(t\log(p))=\exp(t\log(p))\frac{\mathrm{d}}{\mathrm{d}t}(t\log(p))=p^t\log(p)
\]</span></p>

</details>
<details class="note primary"><summary><p>Property 4 (Product rule)</p>
</summary>
<p>设<span class="math inline">\(f,g\in
C^1(\mathbb{R},Q)\)</span>是将实数映射为四元数的<span
class="math inline">\(C^1\)</span>连续函数，从而有： <span
class="math display">\[\frac{\mathrm{d}}{\mathrm{d}t}(f(t)g(t))=\left(\frac{\mathrm{d}}{\mathrm{d}t}f(t)\right)g(t)+f(t)\left(\frac{\mathrm{d}}{\mathrm{d}t}g(t)\right)\]</span></p>
<p><strong>证明</strong>： <span class="math display">\[
\begin{aligned}
  \frac{\mathrm{d}}{\mathrm{d}t}(f(t)g(t))&amp;=\lim_{\delta\to
0}\frac{f(t+\delta)g(t+\delta)-f(t)g(t)}{\delta}\\
  &amp;=\lim_{\delta\to
0}\frac{f(t+\delta)g(t+\delta)-f(t+\delta)g(t)+f(t+\delta)g(t)-f(t)g(t)}{\delta}\\
  &amp;=\lim_{\delta\to
0}\left(f(t+\delta)\frac{g(t+\delta)-g(t)}{\delta}+\frac{f(t+\delta)-f(t)}{\delta}g(t)\right)\\
  &amp;=f(t)\left(\frac{\mathrm{d}}{\mathrm{d}t}g(t)\right)+\left(\frac{\mathrm{d}}{\mathrm{d}t}f(t)\right)g(t)
\end{aligned}
\]</span></p>

</details>
<details class="note primary"><summary><p>Property 5 (Chain rule)</p>
</summary>
<p>设<span class="math inline">\(f\in
C^1(Q,Q)\)</span>是将四元数映射为四元数的<span
class="math inline">\(C^1\)</span>连续函数，<span
class="math inline">\(g\in
C^1(\mathbb{R},Q)\)</span>是将实数映射为四元数的<span
class="math inline">\(C^1\)</span>连续函数，则有： <span
class="math display">\[\frac{\mathrm{d}}{\mathrm{d}t}f(g(t))=f&#39;(g(t))g&#39;(t)\]</span></p>
<p><strong>证明</strong>：</p>
<p><span class="math display">\[
\begin{aligned}
  \frac{\mathrm{d}}{\mathrm{d}t}f(g(t))&amp;=\lim_{x\to
t}\frac{f(g(x))-f(g(t))}{x-t}\\
  &amp;=\lim_{x\to
t}\frac{(f(g(x))-f(g(t)))(g(x)-g(t))}{(g(x)-g(t))(x-t)}\\
  &amp;=\lim_{x\to
t}\left(\frac{f(g(x))-f(g(t))}{g(x)-g(t)}\frac{g(x)-g(t)}{x-t}\right)\\
  &amp;=f&#39;(g(t))g&#39;(t)
\end{aligned}
\]</span></p>

</details>
<details class="note primary"><summary><p>Property 6</p>
</summary>
<p>设<span class="math inline">\(q\in
C^1(\mathbb{R},Q)\)</span>是将实数映射为四元数的<span
class="math inline">\(C^1\)</span>连续函数，<span
class="math inline">\(r\in
C^1(\mathbb{R},\mathbb{R})\)</span>是将实数映射到实数的<span
class="math inline">\(C^1\)</span>连续函数，再设<span
class="math inline">\(q(t)=[\cos(\theta_t),\sin(\theta_t)\mathbf{n}_t]\)</span>。我们有：
<span class="math display">\[
\begin{aligned}
\frac{\mathrm{d}}{\mathrm{d}t}q(t)^{r(t)}&amp;={\Large[}-\sin(r(t)\theta_t)(r&#39;(t)\theta_t+r(t)\theta_t&#39;),\\
&amp;~~~~~~~~~~~\cos(r(t)\theta_t)(r&#39;(t)\theta_t+r(t)\theta_t&#39;)\mathbf{n}_t+\sin(r(t)\theta_t)\mathbf{n}&#39;_t{\Large]}
\end{aligned}
\]</span></p>
<p><strong>证明</strong>：</p>
<p><span class="math display">\[
\begin{aligned}
  \frac{\mathrm{d}}{\mathrm{d}t}q(t)^{r(t)}&amp;=\frac{\mathrm{d}}{\mathrm{d}t}\exp(r(t)\log(q(t)))\\
  &amp;=\frac{\mathrm{d}}{\mathrm{d}t}\exp(r(t)[0,\theta_t\mathbf{n}_t])\\
  &amp;=\frac{\mathrm{d}}{\mathrm{d}t}\exp([0,(r(t)\theta_t)\mathbf{n}_t])\\
  &amp;=\frac{\mathrm{d}}{\mathrm{d}t}[\cos(r(t)\theta_t),\sin(r(t)\theta_t)\mathbf{n}_t]\\
  &amp;={\Large[}-\sin(r(t)\theta_t)(r&#39;(t)\theta_t+r(t)\theta_t&#39;),\\
  &amp;~~~~~~~~~~~\cos(r(t)\theta_t)(r&#39;(t)\theta_t+r(t)\theta_t&#39;)\mathbf{n}_t+\sin(r(t)\theta_t)\mathbf{n}&#39;_t{\Large]}
\end{aligned}
\]</span></p>

</details>
<p>最后一个Property联系了四元数的乘积与点乘。</p>
<details class="note primary"><summary><p>Property 7</p>
</summary>
<p>设<span
class="math inline">\(p=[a,\mathbf{b}],q_1=[a_1,(x_1,y_1,z_1)]=[a_1,\mathbf{b}_1],q_2=[a_2,(x_2,y_2,z_2)]=[a_2,\mathbf{b}_2]\)</span>是三个四元数，则有<span
class="math inline">\((pq_1)\cdot(pq_2)=\|p\|^2(q_1\cdot
q_2)\)</span>。</p>
<p><strong>证明</strong>：</p>
<p><span class="math display">\[
\begin{aligned}
  (pq_1)\cdot(pq_2)&amp;=[aa_1-\mathbf{b}\cdot\mathbf{b}_1,a\mathbf{b}_1+a_1\mathbf{b}+\mathbf{b}\times\mathbf{b}_1]\cdot
[aa_2-\mathbf{b}\cdot\mathbf{b}_2,a\mathbf{b}_2+a_2\mathbf{b}+\mathbf{b}\times\mathbf{b}_2]\\
  &amp;=a^2a_1a_2+(\mathbf{b}\cdot\mathbf{b}_1)(\mathbf{b}\cdot\mathbf{b}_2)+\\
  &amp;~~~~~a^2\mathbf{b}_1\cdot\mathbf{b}_2+a\mathbf{b}_1\cdot(\mathbf{b}\times\mathbf{b}_2)+a_1a_2\mathbf{b}\cdot\mathbf{b}+\\
  &amp;~~~~~a(\mathbf{b}\times\mathbf{b}_1)\cdot\mathbf{b}_2+(\mathbf{b}\times\mathbf{b}_1)\cdot(\mathbf{b}\times
\mathbf{b}_2)
\end{aligned}
\]</span></p>
<p>使用恒等式<span
class="math inline">\((\mathbf{b}\times\mathbf{b}_1)\cdot(\mathbf{b}\times
\mathbf{b}_2)=(\mathbf{b}\cdot\mathbf{b})(\mathbf{b}_1\cdot\mathbf{b}_2)-(\mathbf{b}\cdot\mathbf{b}_2)(\mathbf{b}_1\cdot\mathbf{b})\)</span>，我们有：</p>
<p><span class="math display">\[
\begin{aligned}
  (pq_1)\cdot(pq_2)&amp;=a^2a_1a_2+(\mathbf{b}\cdot\mathbf{b}_1)(\mathbf{b}\cdot\mathbf{b}_2)+\\
  &amp;~~~~~a^2\mathbf{b}_1\cdot\mathbf{b}_2+a\mathbf{b}_1\cdot(\mathbf{b}\times\mathbf{b}_2)+a_1a_2\mathbf{b}\cdot\mathbf{b}+\\
  &amp;~~~~~a(\mathbf{b}\times\mathbf{b}_1)\cdot\mathbf{b}_2+(\mathbf{b}\cdot\mathbf{b})(\mathbf{b}_1\cdot\mathbf{b}_2)-(\mathbf{b}\cdot\mathbf{b}_2)(\mathbf{b}_1\cdot\mathbf{b})\\
  &amp;=(a^2+\mathbf{b}\cdot\mathbf{b})(a_1a_2+\mathbf{b}_1\cdot\mathbf{b}_2)+a\mathbf{b}_1\cdot(\mathbf{b}\times\mathbf{b}_2)+a(\mathbf{b}\times\mathbf{b}_1)\cdot\mathbf{b}_2\\
  &amp;=\|p\|^2(q_1\cdot
q_2)+a\mathbf{b}_1\cdot(\mathbf{b}\times\mathbf{b}_2)+a(\mathbf{b}\times\mathbf{b}_1)\cdot\mathbf{b}_2
\end{aligned}
\]</span></p>
<p>最后，我们使用下述等式：</p>
<p><span class="math display">\[\mathbf{b}\cdot(\mathbf{b}_1\times
\mathbf{b}_2)=
\begin{vmatrix}
  x &amp; y &amp; z\\
  x_1 &amp; y_1 &amp; z_1\\
  x_2 &amp; y_2 &amp; z_2
\end{vmatrix}
\]</span></p>
<p>现在我们有：</p>
<p><span class="math display">\[
\begin{aligned}
  (pq_1)\cdot(pq_2)&amp;=\|p\|^2(q_1\cdot
q_2)+a\mathbf{b}_1\cdot(\mathbf{b}\times\mathbf{b}_2)+a(\mathbf{b}\times\mathbf{b}_1)\cdot\mathbf{b}_2\\
  &amp;=\|p\|^2(q_1\cdot q_2)+a\left(\begin{vmatrix}
  x_1 &amp; y_1 &amp; z_1\\
  x &amp; y &amp; z\\
  x_2 &amp; y_2 &amp; z_2
\end{vmatrix}+
\begin{vmatrix}
  x_2 &amp; y_2 &amp; z_2\\
  x &amp; y &amp; z\\
  x_1 &amp; y_1 &amp; z_1
\end{vmatrix}\right)\\
&amp;=\|p\|^2(q_1\cdot q_2)
\end{aligned}
\]</span></p>

</details>
<h2 id="三维旋转定理矩阵型">三维旋转定理（矩阵型）</h2>
<p>通过之前的讨论（尽管不完全相同，但可以类似推导）我们知道左乘一个四元数<span
class="math inline">\(w=a+bi+cj+dk\)</span>等同于下面的矩阵</p>
<p><span class="math display">\[
L(w)=
\begin{bmatrix}
  a &amp; -b &amp; -c &amp; -d\\
  b &amp; a &amp; -d &amp; c\\
  c &amp; d &amp; a &amp; -b\\
  d &amp; -c &amp; b &amp; a
\end{bmatrix}
\]</span></p>
<p>而右乘<span class="math inline">\(w\)</span>等同于</p>
<p><span class="math display">\[
R(w)=
\begin{bmatrix}
  a &amp; -b &amp; -c &amp; -d\\
  b &amp; a &amp; d &amp; -c\\
  c &amp; -d &amp; a &amp; b\\
  d &amp; c &amp; -b &amp; a
\end{bmatrix}
\]</span></p>
<p>现在我们就可以利用这个结论把<span
class="math inline">\(p&#39;=wpw^*\)</span>写成矩阵形式。假定<span
class="math inline">\(a=\cos(\tfrac{1}{2}\theta),b=\sin(\tfrac{1}{2}\theta)n_x,c=\sin(\tfrac{1}{2}\theta)n_y,d=\sin(\tfrac{1}{2}\theta)n_z,w=a+bi+cj+dk\)</span>，我们就有：</p>
<p><span class="math display">\[
\begin{aligned}
  wpw^*&amp;=L(w)R(w^*)p\\
  &amp;=\begin{bmatrix}
  a &amp; -b &amp; -c &amp; -d\\
  b &amp; a &amp; -d &amp; c\\
  c &amp; d &amp; a &amp; -b\\
  d &amp; -c &amp; b &amp; a
\end{bmatrix}
\begin{bmatrix}
  a &amp; b &amp; c &amp; d\\
  -b &amp; a &amp; -d &amp; c\\
  -c &amp; d &amp; a &amp; -b\\
  -d &amp; c &amp; b &amp; a
\end{bmatrix}p\\
&amp;=\begin{bmatrix}
  a^2+b^2+c^2+d^2 &amp; ab-ab-cd+cd &amp; ac+bd-ac-bd &amp;
ad-bc+bc-ad\\
  ab-ab+cd-cd &amp; b^2+a^2-d^2-c^2 &amp; bc-ad-ad+bc &amp;
bd+ac+bd+ac\\
  ac-bd-ac+bd &amp; bc+ad+ad+bc &amp; c^2-d^2+a^2-b^2 &amp;
cd+cd-ab-ab\\
  ad+bc-bc-ad &amp; bd-ac+bd-ac &amp; cd+cd+ab+ab &amp; d^2-c^2-b^2+a^2
\end{bmatrix}p\\
&amp;=\begin{bmatrix}
  1 &amp; 0 &amp; 0 &amp; 0\\
  0 &amp; 1-2c^2-2d^2 &amp; 2bc-2ad &amp; 2ac+2bd\\
  0 &amp; 2bc+2ad &amp; 1-2b^2-2d^2 &amp; 2cd-2ab\\
  0 &amp; 2bd-2ac &amp; 2ab+2cd &amp; 1-2b^2-2c^2
\end{bmatrix}p
\end{aligned}
\]</span></p>
<p>实际上我们不需要存这个完整的<span class="math inline">\(4\times
4\)</span>的矩阵，只需要存右下角的<span class="math inline">\(3\times
3\)</span>矩阵即可。如此一来，我们就得到旋转定理的矩阵形式：</p>
<details class="note success"><summary><p>3D Rotation Theorem (Matrix)</p>
</summary>
<p>任意三维向量<span
class="math inline">\(\mathbf{p}\)</span>绕着单位向量<span
class="math inline">\(\mathbf{n}\)</span>旋转<span
class="math inline">\(\theta\)</span>度之后的向量<span
class="math inline">\(\mathbf{p}&#39;\)</span>可以用下面的矩阵表示：</p>
<p><span class="math display">\[
\mathbf{p}&#39;=\begin{bmatrix}
  1-2c^2-2d^2 &amp; 2bc-2ad &amp; 2ac+2bd\\
  2bc+2ad &amp; 1-2b^2-2d^2 &amp; 2cd-2ab\\
  2bd-2ac &amp; 2ab+2cd &amp; 1-2b^2-2c^2
\end{bmatrix}\mathbf{p}
\]</span></p>
<p>其中<span
class="math inline">\(a=\cos(\tfrac{1}{2}\theta),b=\sin(\tfrac{1}{2}\theta)n_x,c=\sin(\tfrac{1}{2}\theta)n_y,d=\sin(\tfrac{1}{2}\theta)n_z\)</span>.</p>

</details>
<p>尽管看起来比较复杂，但是在实际中如果旋转轴<span
class="math inline">\(\mathbf{n}\)</span>和旋转角度<span
class="math inline">\(\theta\)</span>固定了之后，该矩阵就可以预先计算下来，在需要旋转很多<span
class="math inline">\(\mathbf{p}\)</span>时提高效率。</p>
<h2 id="三维旋转定理指数型">三维旋转定理（指数型）</h2>
<p>类似复数，我们也可以把四元数写成指数的形式。如果<span
class="math inline">\(\mathbf{n}\)</span>是一个单位向量，对于单位四元数<span
class="math inline">\(n=[0,\mathbf{n}]\)</span>，我们有:</p>
<p><span
class="math display">\[\mathrm{e}^{n\theta}=\cos(\theta)+n\sin(\theta)=\cos(\theta)+\mathbf{n}\sin(\theta)\]</span></p>
<p>也就是说，<span
class="math inline">\(w=[\cos(\theta),\sin(\theta)\mathbf{n}]=\cos(\theta)+n\sin(\theta)\)</span>可以写为<span
class="math inline">\(\mathrm{e}^{n\theta}\)</span>。你还可以注意到<span
class="math inline">\(n^2=[-\mathbf{n}\cdot\mathbf{n},0]=-1\)</span>，这与复数中的<span
class="math inline">\(i\)</span>是非常类似的。</p>
<details class="note success"><summary><p>3D Rotation Theorem (Exponential)</p>
</summary>
<p>任意三维向量<span
class="math inline">\(\mathbf{p}\)</span>绕着单位向量<span
class="math inline">\(\mathbf{n}\)</span>旋转<span
class="math inline">\(\theta\)</span>度之后的向量<span
class="math inline">\(\mathbf{p}&#39;\)</span>可以用下面的指数表示：</p>
<p><span class="math display">\[
p&#39;=\mathrm{e}^{n\frac{\theta}{2}}p\mathrm{e}^{-n\frac{\theta}{2}}
\]</span></p>
<p>其中<span
class="math inline">\(p=[0,\mathbf{p}],n=[0,\mathbf{n}]\)</span>.</p>

</details>
<p>有了指数形式，我们就可以很自然地运用关于指数的一些运算了。比如对单位四元数<span
class="math inline">\(w=[\cos(\theta),\sin(\theta)\mathbf{n}],
n=[0,\mathbf{n}]\)</span>，<span
class="math inline">\(w\)</span>的对数是：</p>
<p><span
class="math display">\[\log(w)=\log(\mathrm{e}^{n\theta})=n\theta=[0,\mathbf{n}\theta]\]</span></p>
<p>下面是幂运算；</p>
<p><span
class="math display">\[w^t=(\mathrm{e}^{n\theta})^t=\mathrm{e}^{n(t\theta)}=[\cos(t\theta),\sin(t\theta)\mathbf{n}]\]</span></p>
<p>即一个单位四元数的<span
class="math inline">\(t\)</span>次幂等同于旋转角缩放到原来的<span
class="math inline">\(t\)</span>倍，且不会改变旋转轴。</p>
<h2 id="旋转复合-1">旋转复合</h2>
<p>现在来考虑基于四元数的旋转复合，假设分别在四元数<span
class="math inline">\(w_1,w_2\)</span>上进行旋转，则有：</p>
<p><span
class="math display">\[p&#39;&#39;=w_2p&#39;w_2^*=w_2w_1pw_1^*w_2^*=wpw^*\;(w=w_2w_1)\]</span></p>
<p>上式隐含了<span
class="math inline">\((w_2w_1)^*=w_1^*w_2^*\)</span>，它的证明不多赘述。</p>
<p>需要注意的是，复合后旋转<span
class="math inline">\(w=w_2w_1\)</span>是绕着一个新的旋转轴旋转某个角度，尽管结果是相同的，但是过程完全不同。</p>
<h2 id="双倍覆盖">双倍覆盖</h2>
<p>单位四元数与三维旋转并不是双射（一对一）的，一个单位四元数对应一个三维旋转，但是一个三维旋转可以找到两个单位四元数去对应它，这就是所谓的<strong>2对1满射同态</strong>，或者说单位四元数<strong>双倍覆盖</strong>了三维旋转。</p>
<p>具体来说，<span class="math inline">\(w\)</span>与<span
class="math inline">\(-w\)</span>代表了同一个旋转：</p>
<p><span
class="math display">\[-w=[-\cos(\tfrac{1}{2}\theta),-\sin(\tfrac{1}{2}\theta)\mathbf{n}]=[\cos(\pi-\tfrac{1}{2}\theta),\sin(\pi-\tfrac{1}{2}\theta)(\mathbf{-n})]\]</span></p>
<p>即<span class="math inline">\(-w\)</span>是绕着轴<span
class="math inline">\(-\mathbf{n}\)</span>旋转了<span
class="math inline">\(2\pi-\theta\)</span>度，正好是<span
class="math inline">\(w\)</span>代表的旋转。这个结果也可以从四元数旋转公式得到：</p>
<p><span
class="math display">\[(-w)p(-w)^*=(-1)^2wpw^*=wpw^*\]</span></p>
<p>现在我们已经知道四元数相比欧拉角而言的优点了：</p>
<ul>
<li>插值非常简单（将在下一节介绍）；</li>
<li>几何意义明显，双倍覆盖三维旋转；</li>
<li>与旋转的顺序无关，一次四元数乘法即可完成旋转；</li>
<li>约束少，仅要求为单位四元数；</li>
<li>不存在Gimbal lock；</li>
<li>复合旋转简单。</li>
</ul>
<h1 id="四元数插值">四元数插值</h1>
<h2 id="基于幂运算的插值">基于幂运算的插值</h2>
<p>假设有两个旋转变换<span
class="math inline">\(w_0=[\cos(\theta_0),\sin(\theta_0)\mathbf{n}_0],w_1=[\cos(\theta_1),\sin(\theta_1)\mathbf{n}_1]\)</span>，我们希望能够通过<span
class="math inline">\(w_0,w_1\)</span>得到它们的中间旋转变换<span
class="math inline">\(w_t (t\in[0,1])\)</span>。</p>
<p>然而直接求这个中间旋转似乎比较困难，我们不妨从结果出发，期望原始向量<span
class="math inline">\(p\)</span>在经过<span
class="math inline">\(w_t\)</span>旋转之后得到的向量<span
class="math inline">\(p_t=w_tpw_t^*\)</span>，它能够位于<span
class="math inline">\(p_0=w_0pw_0^*\)</span>和<span
class="math inline">\(p_1=w_1pw_1^*\)</span>之间。所以，对于向量<span
class="math inline">\(p\)</span>而言，它是先变换到<span
class="math inline">\(p_0\)</span>，再进行<span
class="math inline">\(\Delta_t w\)</span>的变换到<span
class="math inline">\(p_t\)</span>。特殊地，当<span
class="math inline">\(t=1\)</span>的时候，就变换到了<span
class="math inline">\(p_1\)</span>的位置，这可以表示为：</p>
<p><span class="math display">\[
\begin{aligned}
  \Delta_1ww_0&amp;=w_1\\
  \Delta_1ww_0w_0^{-1}&amp;=w_1w_0^{-q}\\
  \Delta_1w&amp;=w_1w_0^*
\end{aligned}
\]</span></p>
<p>根据旋转定理的指数型，我们只要对<span
class="math inline">\(\Delta_1w\)</span>取<span
class="math inline">\(t(0\le t\le
1)\)</span>次方，就能得到插值对应的旋转了。所以：</p>
<p><span class="math display">\[
\begin{equation}
\label{eq3}
  w_t=\text{Slerp}(w_0,w_1;t)=(w_1w_0^*)^tw_0
\end{equation}
\]</span></p>
<p>这个插值方法称为<em>Slerp</em>，但它涉及到多个四元数的乘法，而且还包含幂运算，实际应用中效率很低。我们一般的插值都是使用线性组合，而不是幂运算。</p>
<h2 id="四元数在四维空间内的夹角">四元数在四维空间内的夹角</h2>
<p>公式<span
class="math inline">\(\eqref{eq3}\)</span>低效的根本原因在于我们把插值旋转<span
class="math inline">\(w_t\)</span>直接用<span
class="math inline">\(w_0,w_1\)</span>的乘积表示出来了，但我们真正关心的是<strong>对角度和旋转轴进行插值</strong>。为此，我们需要首先研究下公式<span
class="math inline">\(\eqref{eq3}\)</span>如何表示旋转角的。</p>
<p>我们有；</p>
<p><span class="math display">\[
\begin{aligned}
  \Delta_1w&amp;=w_1w_0^*\\
  &amp;=[\cos(\theta_1),\sin(\theta_1)\mathbf{n}_1]\cdot[\cos(\theta_0),\sin(\theta_0)\mathbf{n}_0]\\&amp;
  =[\cos(\theta_1)\cos(\theta_0)+(\sin(\theta_1)\mathbf{n}_1)\cdot(\sin(\theta_0)\mathbf{n}_0),\cdots]
\end{aligned}
\]</span></p>
<p>如果我们把<span
class="math inline">\(w_0,w_1\)</span>看作两个<strong>四维向量</strong>，我们发现，<span
class="math inline">\(\Delta_1w\)</span>的实部正好就是<span
class="math inline">\(w_0,w_1\)</span>点乘的结果<span
class="math inline">\(w_0\cdot w_1\)</span>。同时，又因为<span
class="math inline">\(w_0,w_1\)</span>是两个单位向量，所以它们点乘的结果就是它们夹角的余弦，记为<span
class="math inline">\(\theta\)</span>。所以我们有<span
class="math inline">\(w_0\cdot w_1=\cos(\theta)\)</span>。</p>
<p>与此同时，我们又知道<span
class="math inline">\(\Delta_1w\)</span>也代表的是一个旋转，记旋转角为<span
class="math inline">\(\phi\)</span>，它的实部为<span
class="math inline">\(\cos(\phi)\)</span>，从而有<span
class="math inline">\(\cos(\phi)=w_0\cdot
w_1=\cos(\theta)\)</span>。在区间<span
class="math inline">\([0,\pi]\)</span>上当且只有一个解<span
class="math inline">\(\phi=\theta\)</span>。这也就意味着，<span
class="math inline">\(w_0,w_1\)</span>在四维空间中的夹角<span
class="math inline">\(\theta\)</span>，正好是它们作为四元数时旋转变化量<span
class="math inline">\(\Delta_1w\)</span>所代表旋转角度的一半，即<span
class="math inline">\(\theta=\tfrac{1}{2}(2\phi)\)</span>。基于这个事实，我们套用向量的插值公式对四元数进行插值。</p>
<h2 id="lerp-nlerp-slerp">Lerp, Nlerp, Slerp</h2>
<p>前文已经提到，我们希望对四元数进行<strong>线性插值</strong>，即表示为<span
class="math inline">\(w_t=\alpha w_0+\beta
w_1\)</span>的形式。下面介绍三种线性插值方法。</p>
<h3 id="lerp">Lerp</h3>
<p>第一种是我们熟知的线性插值<em>Lerp</em>：</p>
<p><span
class="math display">\[w_t=\text{Lerp}(w_0,w_1;t)=(1-t)w_0+tw_1\]</span></p>
<p>但是，这种插值方法得到的四元数并不是单位四元数，也就是并不能真正表示三维旋转。现在我们来验证一下：</p>
<p><span class="math display">\[
\begin{aligned}
  \|w_t\|^2&amp;=((1-t)\cos(\theta_0)+t\cos(\theta_1))^2+((1-t)\sin(\theta_0)\mathbf{n}_0+t\sin(\theta_1)\mathbf{n}_1)^2\\
  &amp;=(1-t)^2\cos^2(\theta_0)+t^2\cos^2(\theta_1)+2t(1-t)\cos(\theta_0)\cos(\theta_1)\\
  &amp;+(1-t)^2\sin^2(\theta_0)+t^2\sin^2(\theta_1)+2t(1-t)\sin(\theta_0)\sin(\theta_1)\mathbf{n}_0\cdot\mathbf{n}_1\\
  &amp;=(1-t)^2+t^2+2t(1-t)(\cos(\theta_0)\cos(\theta_1)+\sin(\theta_0)\sin(\theta_1)\mathbf{n}_0\cdot\mathbf{n}_1)
\end{aligned}
\]</span></p>
<p>显然，当<span
class="math inline">\(t\in(0,1)\)</span>时，上式不等于1，这也就意味着<em>Lerp</em>插值的结果并不是一个单位四元数。</p>
<h3 id="nlerp">Nlerp</h3>
<p>既然<em>Lerp</em>的结果不是一个单位四元数，那么除以它的模长不就可以变成单位四元数了吗？这就是所谓的<em>Nlerp</em>（Normalized
Lerp）：</p>
<p><span
class="math display">\[w_t=\text{Nlerp}(w_0,w_1;t)=\frac{(1-t)w_0+tw_1}{\|(1-t)w_0+tw_1\|}\]</span></p>
<p>但是<em>Nlerp</em>的问题在于，随着<span
class="math inline">\(t\)</span>的增大，<span
class="math inline">\(w_t\)</span>的旋转角变化幅度会发生变化，或者说，<span
class="math inline">\(w_t\)</span>的旋转角变化<strong>不是线性</strong>的。</p>
<p>如下图所示，<span class="math inline">\(t\)</span>从<span
class="math inline">\(0\)</span>变换到<span
class="math inline">\(0.25\)</span>与从<span
class="math inline">\(0.25\)</span>变化到<span
class="math inline">\(0.5\)</span>旋转角的变化幅度不一样；同样地，从<span
class="math inline">\(0.5\)</span>到<span
class="math inline">\(0.75\)</span>与从<span
class="math inline">\(0.75\)</span>到<span
class="math inline">\(1\)</span>旋转角的变化幅度也不一样。我们希望<span
class="math inline">\(w_t\)</span>能够<strong>线性地</strong>改变旋转角。</p>
<p><img data-src="/images/quaternion/1.png" /></p>
<h3 id="slerp">Slerp</h3>
<p>所以，我们想要直接对角度插值。如果<span
class="math inline">\(w_0,w_1\)</span>之间的夹角为0，那么：</p>
<p><span class="math display">\[\theta_t=(1-\theta)\cdot
0+t\theta=t\theta\]</span></p>
<p>因为对角度线性插值相当于是让向量在球面上的一个弧上旋转，所以这种插值被称为球面线性插值<em>Slerp</em>（Spherical
Lerp）。我们最开始说到的基于幂运算的插值就是我们接下来要介绍的Slerp的一种等价形式。</p>
<p>对于向量<span
class="math inline">\(\mathbf{n}_0,\mathbf{n}_1\)</span>，我们希望<span
class="math inline">\(\mathbf{n}_t\)</span>能够直接表示为二者的线性组合：</p>
<p><span
class="math display">\[\mathbf{n}_t=\alpha\mathbf{n}_0+\beta\mathbf{n}_1\]</span></p>
<p>为了求解<span
class="math inline">\(\alpha,\beta\)</span>，我们对上式两边同乘<span
class="math inline">\(\mathbf{n}_0\)</span>（设<span
class="math inline">\(\mathbf{n}_0,\mathbf{n}_1\)</span>之间的夹角为<span
class="math inline">\(\theta\)</span>）：</p>
<p><span class="math display">\[
\begin{aligned}
  \mathbf{n}_0\cdot\mathbf{n}_t&amp;=\mathbf{n}_0\cdot(\alpha\mathbf{n}_0+\beta\mathbf{n}_1)\\
  \mathbf{n}_0\cdot\mathbf{n}_t&amp;=\alpha+\beta\mathbf{n}_0\cdot\mathbf{n}_1\\
  \cos(t\theta)&amp;=\alpha+\beta\cos(\theta)
\end{aligned}
\]</span></p>
<p>同样地，对两边同乘<span
class="math inline">\(\mathbf{n}_1\)</span>：</p>
<p><span
class="math display">\[\cos((1-t)\theta)=\alpha\cos(\theta)+\beta\]</span></p>
<p>现在，把<span
class="math inline">\(\alpha=\cos(t\theta)-\beta\cos(\theta)\)</span>代入上式，我们就有：</p>
<p><span class="math display">\[
\begin{aligned}
  \cos((1-t)\theta)&amp;=(\cos(t\theta)-\beta\cos(\theta))\cos(\theta)+\beta\\
  \cos((1-t)\theta)&amp;=\cos(t\theta)\cos(\theta)-\beta\cos^2(\theta)+\beta\\
  \beta(1-\cos^2(\theta))&amp;=\cos((1-t)\theta)-\cos(t\theta)\cos(\theta)\\
  \beta&amp;=\frac{\cos(\theta-t\theta)-\cos(t\theta)\cos(\theta)}{\sin^2(\theta)}\\
  \beta&amp;=\frac{\cos(\theta)\cos(t\theta)+\sin(\theta)\sin(t\theta)-\cos(t\theta)\cos(\theta)}{\sin^2(\theta)}\\
  \beta&amp;=\frac{\sin(t\theta)}{\sin(\theta)}
\end{aligned}
\]</span></p>
<p>把<span class="math inline">\(\beta\)</span>代回去，就能解得<span
class="math inline">\(\alpha\)</span>：</p>
<p><span
class="math display">\[\alpha=\frac{\sin((1-t)\theta)}{\sin(\theta)}\]</span></p>
<p>于是，我们能就得到最终<em>Slerp</em>的公式：</p>
<p><span class="math display">\[
w_t=\text{Slerp}(w_0,w_1;t)=\frac{\sin((1-t)\theta)}{\sin(\theta)}w_0+\frac{\sin(t\theta)}{\sin(\theta)}w_1\quad
(\theta=\arccos(w_0\cdot w_1))
\]</span></p>
<p>现在的<em>Slerp</em>已经比最开始介绍的基于幂运算的<em>Slerp</em>快很多，但是由于它涉及了三个三角函数、一个反三角函数和一次点乘，所以效率仍然比<em>Nlerp</em>低一些。此外，如果夹角<span
class="math inline">\(\theta\)</span>很小，<span
class="math inline">\(\sin(\theta)\)</span>可能因浮点精度问题被近似为<span
class="math inline">\(0\)</span>，导致运算错误。所以在实际使用<em>Slerp</em>时，要首先判断夹角<span
class="math inline">\(\theta\)</span>是否较小，若是，则改用<em>Nlerp</em>，而由于夹角很小，<em>Nlerp</em>与<em>Slerp</em>的误差可以忽略。</p>
<p>需要注意的是，<em>Slerp</em>并不是一个“万能答案”，它的运行效率显著低于<em>Nlerp</em>。此外，<em>Nlerp</em>的角速度变化不一致并不一定是个坏处，在不同的情景下可能有不同的用处。所以，在使用插值方法的时候要根据实际情况选择，大多数时候<em>Nlerp</em>已经足够了。</p>
<h2 id="双倍覆盖问题">双倍覆盖问题</h2>
<p>之前我们介绍过，四元数<span class="math inline">\(-w\)</span>与<span
class="math inline">\(w\)</span>代表的是同一个旋转，这就导致对两个四元数的插值会有效率差距。</p>
<p>如下图所示，虽然可以从<span class="math inline">\(q_0\)</span>到<span
class="math inline">\(q_1\)</span>方向插值，但是由于<span
class="math inline">\(q_1\)</span>与<span
class="math inline">\(-q_1\)</span>代表的是同一个旋转，而<span
class="math inline">\(q_0\)</span>与<span
class="math inline">\(-q_1\)</span>的夹角更小，插值造成的误差更小，所以我们这时会选择从<span
class="math inline">\(q_0\)</span>插值到<span
class="math inline">\(-q_1\)</span>。</p>
<p><img data-src="/images/quaternion/2.png" /></p>
<p>这告诉我们，在对四元数插值之前，要检查<span
class="math inline">\(w_0,w_1\)</span>之间的夹角是否是钝角，即检查它们的点积结果是否是负数，如果是负数，就对其中一个四元数取负号，然后在新的四元数间插值。</p>
<h1 id="squad">Squad</h1>
<p><em>Slerp</em>已经是我们理想中的插值方式了：它直接对角度插值，插值角度匀速变化，运算效率尚可。但是它还有一个小问题：角度变化的速率等于夹角，即<span
class="math inline">\(\tfrac{\mathrm{d}\theta_t}{\mathrm{d}t}=\tfrac{\mathrm{d}}{\mathrm{d}t}(t\theta)=\theta\)</span>，这就意味着，当我们在多个角速度之间插值的时候，当在不同的四元数之间插值的时候，速率会发生突变，或者说在切断点处<strong>不可导</strong>。从数学上讲，函数<span
class="math inline">\(f\)</span>连续并不意味着函数的一阶导连续（前者称为<span
class="math inline">\(C^0\)</span>连续，后者称为<span
class="math inline">\(C^1\)</span>连续）。</p>
<p>为此，我们希望插值的曲线能够在高阶导处也连续，下面介绍的Squad（Spherical
and quadrangle）就是一种解决方法。</p>
<p>下图是<em>Slerp</em>和<em>Squad</em>的插值结果比较，曲线是每个四元数插值结果的角速度。可以看到：<em>Slerp</em>在四元数切换时角速度会发生突变，而<em>Squad</em>的角速度则是光滑变化的。</p>
<p><img data-src="/images/quaternion/9.png" /></p>
<h2 id="bézier曲线">Bézier曲线</h2>
<p>假设我们有一个向量序列<span
class="math inline">\(\mathbf{v}_0,\mathbf{v}_1,\cdots,\mathbf{v}_n\)</span>，我们可以分别对每一对向量<span
class="math inline">\(\mathbf{v}_i,\mathbf{v}_{i+1}\)</span>插值。如果我们使用最简单的<em>Lerp</em>插值，就会得到如下图的结果：</p>
<p><img data-src="/images/quaternion/3.png" /></p>
<p>显然这个曲线是<span class="math inline">\(C^0\)</span>连续但<span
class="math inline">\(C^1\)</span>不连续，为此，我们可以使用一个四次Bézier曲线，将中间的<span
class="math inline">\(\mathbf{v}_1,\mathbf{v}_2,\mathbf{v}_3\)</span>作为控制点来生成连续曲线。然而这种方法得到的曲线一般不会经过控制点：</p>
<p><img data-src="/images/quaternion/4.png" /></p>
<p>关于Bézier曲线的相关知识可以在<a
target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/B%C3%A9zier_curve">Wikipedia</a>上找到介绍。</p>
<h2 id="三次bézier曲线">三次Bézier曲线</h2>
<p>为了解决这个问题，我们想让生成的曲线（1）经过每个点和（2）一阶导数连续。因此，我们可以分段对每两个向量<span
class="math inline">\(\mathbf{v}_i,\mathbf{v}_{i+1}\)</span>使用Bézier曲线，其中我们要使用前一个向量<span
class="math inline">\(\mathbf{v}_{i-1}\)</span>和后一个向量<span
class="math inline">\(\mathbf{v}_{i+2}\)</span>生成两个控制点<span
class="math inline">\(\mathbf{s}_i,\mathbf{s}_{i+1}\)</span>去控制曲线的走势。使用<span
class="math inline">\(\mathbf{s}_i,\mathbf{v}_i,\mathbf{v}_{i+1},\mathbf{s}_{i+1}\)</span>（<span
class="math inline">\(\mathbf{v}_i,\mathbf{v}_{i+1}\)</span>是端点，<span
class="math inline">\(\mathbf{s}_i,\mathbf{s}_{i+1}\)</span>是中间的控制点），就能通过一个三次Bézier曲线来插值。</p>
<p>上述做法可以保证曲线经过每个点，但是不能保证曲线在每个点处都是<span
class="math inline">\(C^1\)</span>连续的。实际上，对于三次Bézier曲线，只要保证前一个Spline（一对向量生成的曲线）在<span
class="math inline">\(\mathbf{v}_i\)</span>的控制点与当前Spline在<span
class="math inline">\(\mathbf{v}_i\)</span>的控制点分别处于最终曲线在<span
class="math inline">\(\mathbf{v}_i\)</span>处切线<strong>对等的两侧</strong>：</p>
<p><img data-src="/images/quaternion/5.png" /></p>
<p>蓝色的线就是曲线在点<span
class="math inline">\(\mathbf{v}_i\)</span>处的切线，红色的点就是控制点，每一对控制点分别处于切线对等的两侧。</p>
<p>下面我们来具体了解如何构造一个三次Bézier曲线。</p>
<h2 id="de-casteljau算法">de Casteljau算法</h2>
<p>de
Casteljau算法可以非常直观简单地构造Bézier曲线，在这里我们只关注三次Bézier曲线的情况。</p>
<p>假设我们有四个向量<span
class="math inline">\(\mathbf{v}_0,\mathbf{v}_1,\mathbf{v}_2,\mathbf{v}_3\)</span>，de
Casteljau算法首先对每一对向量<span
class="math inline">\(\mathbf{v}_0\mathbf{v}_1,\mathbf{v}_1\mathbf{v}_2,\mathbf{v}_2\mathbf{v}_3\)</span>进行线性插值，得到<span
class="math inline">\(\mathbf{v}_{01},\mathbf{v}_{12},\mathbf{v}_{23}\)</span>这三个向量：</p>
<p><span class="math display">\[
\begin{aligned}
  \mathbf{v}_{01}&amp;=\text{Lerp}(\mathbf{v}_0,\mathbf{v}_1;t)\\
  \mathbf{v}_{12}&amp;=\text{Lerp}(\mathbf{v}_1,\mathbf{v}_2;t)\\
  \mathbf{v}_{23}&amp;=\text{Lerp}(\mathbf{v}_2,\mathbf{v}_3;t)
\end{aligned}
\]</span></p>
<p>之后，我们对<span
class="math inline">\(\mathbf{v}_{01}\mathbf{v}_{12},\mathbf{v}_{12}\mathbf{v}_{23}\)</span>这两对向量进行线性插值，得到<span
class="math inline">\(\mathbf{v}_{012},\mathbf{v}_{123}\)</span>：</p>
<p><span class="math display">\[
\begin{aligned}
  \mathbf{v}_{012}&amp;=\text{Lerp}(\mathbf{v}_{01},\mathbf{v}_{12};t)\\
  \mathbf{v}_{123}&amp;=\text{Lerp}(\mathbf{v}_{12},\mathbf{v}_{23};t)\\
\end{aligned}
\]</span></p>
<p>最后，我们对<span
class="math inline">\(\mathbf{v}_{012},\mathbf{v}_{123}\)</span>进行线性插值得到<span
class="math inline">\(\mathbf{v}_{0123}\)</span>，这就是我们想要的结果（插值为<span
class="math inline">\(t\)</span>时）：</p>
<p><span
class="math display">\[\mathbf{v}_{0123}=\text{Lerp}(\mathbf{v}_{012},\mathbf{v}_{123};t)\]</span></p>
<p>整个过程可以总结为下图（<span
class="math inline">\(t=0.4\)</span>）：</p>
<p><img data-src="/images/quaternion/6.png" /></p>
<p>当我们把<span class="math inline">\(t\)</span>从<span
class="math inline">\(0\)</span>变换到<span
class="math inline">\(1\)</span>时，我们就能得到黑色的曲线。</p>
<p>三次Bézier曲线的过程可以表述为：</p>
<p><span class="math display">\[
\begin{aligned}
  \text{Bézier}(\mathbf{v}_{0},\mathbf{v}_{1},\mathbf{v}_{2},\mathbf{v}_{3};t)&amp;=f(f(f(\mathbf{v}_{0},\mathbf{v}_{1};t),f(\mathbf{v}_{1},\mathbf{v}_{2};t);t),f(f(\mathbf{v}_{1},\mathbf{v}_{2};t),f(\mathbf{v}_{2},\mathbf{v}_{3};t);t);t)\\
  &amp;=(1-t)^3\mathbf{v}_{0}+3(1-t)^2t\mathbf{v}_{1}+3(1-t)t^2\mathbf{v}_{2}+t^3\mathbf{v}_{3}\;(f=\text{Lerp})
\end{aligned}
\]</span></p>
<p>这里的<span
class="math inline">\(f\)</span>对于上面的过程来说是线性插值<em>Lerp</em>，对四元数来说则是<em>Slerp</em>。但是由于一个<em>Slerp</em>涉及四个三角函数与除法运算，上式包含了<span
class="math inline">\(7\)</span>个<em>Slerp</em>，这就会导致极大的效率问题。</p>
<h2 id="squad-1">Squad</h2>
<p>三次Bézier曲线实际上是嵌套了三层一次（one-order）插值，而Squad则使用的是一层二次插值嵌套了一层一次插值。</p>
<p>我们首先是分别对<span
class="math inline">\(\mathbf{v}_{0}\mathbf{v}_{3}\)</span>和<span
class="math inline">\(\mathbf{v}_{1}\mathbf{v}_{2}\)</span>进行插值，得到<span
class="math inline">\(\mathbf{v}_{03}\)</span>和<span
class="math inline">\(\mathbf{v}_{12}\)</span>：</p>
<p><span class="math display">\[
\begin{aligned}
  \mathbf{v}_{03}&amp;=\text{Lerp}(\mathbf{v}_{0},\mathbf{v}_{3};t)\\
  \mathbf{v}_{12}&amp;=\text{Lerp}(\mathbf{v}_{1},\mathbf{v}_{2};t)
\end{aligned}
\]</span></p>
<p>之后，我们使用<span
class="math inline">\(2t(1-t)\)</span>为参数，对<span
class="math inline">\(\mathbf{v}_{03}\mathbf{v}_{12}\)</span>进行二次插值，得到最终的<span
class="math inline">\(\mathbf{v}_{0312}\)</span>：</p>
<p><span
class="math display">\[\mathbf{v}_{0312}=\text{Lerp}(\mathbf{v}_{03},\mathbf{v}_{12};2t(1-t))\]</span></p>
<p>上述过程可以通过下图阐明（<span
class="math inline">\(t=0.4\)</span>），黑色曲线就是生成的插值曲线：</p>
<p><img data-src="/images/quaternion/7.png" /></p>
<p>当然，我们也可以把它写成递归形式：</p>
<p><span
class="math display">\[\text{Squad}(\mathbf{v}_{0},\mathbf{v}_{1},\mathbf{v}_{2},\mathbf{v}_{3};t)=\text{Lerp}(\text{Lerp}(\mathbf{v}_{0},\mathbf{v}_{3};t),\text{Lerp}(\mathbf{v}_{1},\mathbf{v}_{2};t);2t(1-t))\]</span></p>
<p>我们成功地将原先的七次<em>Lerp</em>减少到了三次，且生成的曲线与原先的曲线差别也不大，可以看下图的两个对比（左边为Bézier曲线，右边为Squad曲线：</p>
<p><img data-src="/images/quaternion/8.png" /></p>
<p>按照<em>Lerp</em>的定义对上式展开，就能得到：</p>
<p><span
class="math display">\[\text{Squad}(\mathbf{v}_{0},\mathbf{v}_{1},\mathbf{v}_{2},\mathbf{v}_{3};t)=(2t^2-2t+1)(1-t)\mathbf{v}_{0}+2(1-t)^2t\mathbf{v}_{1}+2(1-t)t^2\mathbf{v}_{2}+t(2t^2-2t+1)\mathbf{v}_{3}\]</span></p>
<p>它仍然是一个三次曲线，只不过系数不同。</p>
<p>把它应用到四元数，就能得到我们想要的四元数插值版本：</p>
<p><span
class="math display">\[\text{Squad}(q_{0},q_{1},q_{2},q_{3};t)=\text{Slerp}(\text{Slerp}(q_0,q_3;t),\text{Slerp}(q_1,q_2;t);2t(1-t))\]</span></p>
<p>我们又知道<span
class="math inline">\(\text{Slerp}(q_i,q_{i+1};t)=(q_{i+1}q_i^*)^tq_i\)</span>，所以我们又可以把上式写成指数形式：</p>
<p><span
class="math display">\[\text{Squad}(q_0,q_1,q_2,q_3;t)=(\text{Slerp}(q_1,q_2;t)\text{Slerp}(q_0,q_3;t)^*)^{2t(1-t)}\text{Slerp}(q_0,q_3;t)\]</span></p>
<p>这个形式对我们后面解出控制点非常有帮助。</p>
<h2 id="squad应用">Squad应用</h2>
<p>现在我们可以使用上式对多个单位四元数进行插值了。假设我们有一个四元数序列<span
class="math inline">\(q_0,q_1,\cdots,q_n\)</span>，我们希望对每一对四元数<span
class="math inline">\(q_i,q_{i+1}\)</span>都使用<em>Squad</em>进行插值：</p>
<p><span
class="math display">\[\text{Squad}(q_i,s_i,s_{i+1},q_{i+1};t)=\text{Slerp}(\text{Slerp}(q_i,q_{i+1};t),\text{Slerp}(s_i,s_{i+1};t);2t(1-t))\]</span></p>
<p>接下来就是要找出控制点<span
class="math inline">\(s_i,s_{i+1}\)</span>，为此我们需要前一个四元数<span
class="math inline">\(q_{i-1}\)</span>和后一个四元数<span
class="math inline">\(q_{i+2}\)</span>。</p>
<p>找出<span
class="math inline">\(s_i\)</span>的基本思路是：让<em>Squad</em>在每个点处都可导，也就是说，我们希望<span
class="math inline">\(q_{i-1}q_i\)</span>插值时在<span
class="math inline">\(t=1\)</span>处的导数，与<span
class="math inline">\(q_{i}q_{i+1}\)</span>插值时在<span
class="math inline">\(t=0\)</span>处的导数相等：</p>
<p><span
class="math display">\[\text{Squad}&#39;(q_{i-1},s_{i-1},s_i,q_i;1)=\text{Squad}&#39;(q_i,s_i,s_{i+1},q_{i+1};0)\]</span></p>
<p>注意到上面的<span class="math inline">\(s_i\)</span>在对<span
class="math inline">\(q_{i-1}q_i\)</span>和对<span
class="math inline">\(q_iq_{i+1}\)</span>插值时都是一样的，与我们之前说的位于切线两端的向量不同，因为它们并非是同一个<span
class="math inline">\(s_i\)</span>。在这里，我们假定这样的<span
class="math inline">\(s_i\)</span>只有一个，我们只需要通过代数方法求出即可。</p>
<p>通过上面的等式，我们可以求出<span
class="math inline">\(s_i\)</span>：</p>
<p><span
class="math display">\[s_i=q_i\exp\left(-\frac{\log(q^*_iq_{i-1})+\log(q^*_iq_{i+1})}{4}\right)\]</span></p>
<p>下面是上述结果的推导过程，篇幅较长，不感兴趣的读者粗看即可。所以，和原始版本的三次贝塞尔曲线（包含<span
class="math inline">\(7\)</span>次<em>Slerp</em>、每次<em>Slerp</em>包含四个三角函数）相比，<em>Squad</em>仅包含<span
class="math inline">\(3\)</span>次<em>Slerp</em>、每次<em>Slerp</em>包含四个三角函数，二者都需求出两个控制点<span
class="math inline">\(s_i,s_{i+1}\)</span>。总的来说，<em>Squad</em>效率显著高于三次Bézier曲线。</p>
<details class="note success"><summary><p>A derivation of control point <span
class="math inline">\(s_i\)</span></p>
</summary>
<p>为方便起见，我们记<span
class="math inline">\(g_i(t)=\text{Slerp}(s_i,s_{i+1};t)\text{Slerp}(q_i,q_{i+1};t)^*\)</span>，我们有：</p>
<p><span class="math display">\[
\begin{aligned}
  \frac{\mathrm{d}}{\mathrm{d}t}\text{Squad}(q_i,s_i,s_{i+1},q_{i+1};t)&amp;=\frac{\mathrm{d}}{\mathrm{d}t}\text{Slerp}(\text{Slerp}(q_i,q_{i+1};t),\text{Slerp}(s_i,s_{i+1};t);2t(1-t))\\
  &amp;=\frac{\mathrm{d}}{\mathrm{d}t}\left(g_i(t)^{2t(1-t)}\text{Slerp}(q_i,q_{i+1};t)\right)\\
  &amp;=\left(\frac{\mathrm{d}}{\mathrm{d}t}g_i(t)^{2t(1-t)}\right)\text{Slerp}(q_i,q_{i+1};t)\\
  &amp;+g_i(t)^{2t(1-t)}\left(\frac{\mathrm{d}}{\mathrm{d}t}\text{Slerp}(q_i,q_{i+1};t)\right)\\
  &amp;=\left(\frac{\mathrm{d}}{\mathrm{d}t}g_i(t)^{2t(1-t)}\right)\text{Slerp}(q_i,q_{i+1};t)+\\
  &amp;+g_i(t)^{2t(1-t)}\text{Slerp}(q_i,q_{i+1};t)\log(q_{i+1}q_i^*)
\end{aligned}
\]</span></p>
<p>因为<span
class="math inline">\(g_i(t)\)</span>仍然是个单位四元数，所以可以写成：</p>
<p><span
class="math display">\[g_i(t)=[\cos(\theta_{g_i(t)}),\sin(\theta_{g_i(t)})\mathbf{n}_{g_i(t)}]\]</span></p>
<p>所以我们就能求出<span
class="math inline">\(g_i(t)^{2t(1-t)}\)</span>的导数：</p>
<p><span class="math display">\[
\begin{aligned}
  \frac{\mathrm{d}}{\mathrm{d}t}g_i(t)^{2t(1-t)}&amp;=\frac{\mathrm{d}}{\mathrm{d}t}\mathrm{e}^{2t(1-t)\log(g_i(t))}\\
  &amp;=\frac{\mathrm{d}}{\mathrm{d}t}\mathrm{e}^{2t(1-t)[0,\mathbf{n}_{g_i(t)}\theta_{g_i(t)}]}\\
  &amp;=\frac{\mathrm{d}}{\mathrm{d}t}\mathrm{e}^{[0,2t(1-t)\mathbf{n}_{g_i(t)}\theta_{g_i(t)}]}\\
  &amp;=\frac{\mathrm{d}}{\mathrm{d}t}[\cos(2t(1-t)\theta_{g_i(t)}),\sin(2t(1-t)\theta_{g_i(t)})\mathbf{n}_{g_i(t)}]\\
  &amp;={\Large[}-\sin\left(2t(1-t)\theta_{g_i(t)}\right)\left((2-4t)\theta_{g_i(t)}+2t(1-t)\theta&#39;_{g_i(t)}\right),\\
  &amp;~~~~~~~~~~~\cos\left(2t(1-t)\theta_{g_i(t)}\right)\left((2-4t)\theta_{g_i(t)}+2t(1-t)\theta&#39;_{g_i(t)}\right)\mathbf{n}_{g_i(t)}+\\
  &amp;~~~~~~~~~~~\sin\left(2t(1-t)\theta_{g_i(t)}\right)\mathbf{n}&#39;_{g_i(t)}{\Large]}
\end{aligned}
\]</span></p>
<p>从而，我们把<span class="math inline">\(t=0\)</span>代入，有：</p>
<p><span
class="math display">\[\frac{\mathrm{d}}{\mathrm{d}t}g_i(t)^{2t(1-t)}{\LARGE|}_{t=0}=[0,
2\theta_{g_i(0)}\mathbf{n}_{g_i(0)}]=2\log(s_iq_i^*)\]</span></p>
<p>我们再把这个结果代回<span
class="math inline">\(\frac{\mathrm{d}}{\mathrm{d}t}\text{Squad}(q_i,s_i,s_{i+1},q_{i+1};t)\)</span>：</p>
<p><span class="math display">\[
\begin{aligned}
  \frac{\mathrm{d}}{\mathrm{d}t}\text{Squad}(q_i,s_i,s_{i+1},q_{i+1};t){\LARGE|}_{t=0}&amp;=q_i[0,
2\theta_{g_i(0)}\mathbf{n}_{g_i(0)}]+q_i\log(q_{i+1}q_i^*)\\
  &amp;=q_i(2\log(s_iq_i^*)+\log(q_{i+1}q_i^*))
\end{aligned}
\]</span></p>
<p>同样地，我们可以求出<span
class="math inline">\(\frac{\mathrm{d}}{\mathrm{d}t}\text{Squad}(q_{i-1},s_{i-1},s_{i},q_{i};t)|_{t=1}\)</span>：</p>
<p><span
class="math display">\[\frac{\mathrm{d}}{\mathrm{d}t}\text{Squad}(q_{i-1},s_{i-1},s_{i},q_{i};t){\LARGE|}_{t=1}=q_i(-2\log(s_iq_i^*)+\log(q_iq_{i-1}^*))\]</span></p>
<p>我们令两式相等，即得：</p>
<p><span class="math display">\[
\begin{aligned}
  q_i(-2\log(s_iq_i^*)+\log(q_iq_{i-1}^*))&amp;=q_i(2\log(s_iq_i^*)+\log(q_{i+1}q_i^*))\\
  4\log(s_iq_i^*)&amp;=\log(q_iq_{i-1}^*)-\log(q_{i+1}q_i^*)\\
  s_i&amp;=\exp\left(\frac{\log(q_iq_{i-1}^*)-\log(q_{i+1}q_i^*)}{4}\right)q_i
\end{aligned}
\]</span></p>
<p>最后我们再根据<span
class="math inline">\((q_1q_2)^*=q_2^*q_1^*\)</span>，单位四元数<span
class="math inline">\(q^*=q^{-1}\)</span>和<span
class="math inline">\(\log(q^*)=-\log(q)\)</span>，得到最开始提出的结果：</p>
<p><span
class="math display">\[s_i=\exp\left(-\frac{\log(q_{i-1}q^*_i)+\log(q_{i+1}q_i^*)}{4}\right)q_i=q_i\exp\left(-\frac{\log(q^*_iq_{i-1})+\log(q^*_iq_{i+1})}{4}\right)\]</span></p>

</details>
<p>你可以验证最后一个等式的正确性。</p>
<p>与两个四元数插值一样，Squad在多个四元数插值时仍然会有双重覆盖的影响，在计算控制点和插值之前，需要先选中一个四元数，检测它与其他三个四元数之间的夹角，如果是钝角就翻转。</p>
<h1
id="angleeulermatrixquaternion之间的相互转换">Angle、Euler、Matrix、Quaternion之间的相互转换</h1>
<p>我们首先总结一下表示旋转的四种方法：</p>
<ul>
<li>Angle Axis（简称为Angle）：任何一个旋转都可以表示为绕一个轴<span
class="math inline">\(\mathbf{n}\)</span>旋转<span
class="math inline">\(\theta\)</span>度，这里的旋转轴<span
class="math inline">\(\mathbf{n}\)</span>并不一定是坐标轴。</li>
<li>Euler
Angles（简称为Euler）：任何一个旋转都可以表示为绕标准坐标系的旋转，旋转顺序可以自定。</li>
<li>Matrix
Multiplication（简称为Matrix）：任何一个旋转都可以用矩阵乘法表示。</li>
<li>Quaternion
Rotation（简称为Quaternion)：任何一个旋转都可以用四元数的乘法表示。</li>
</ul>
<p>这几种表示方法实际上可以相互转化，下面将进行介绍。</p>
<h2 id="angle转化为其他形式">Angle转化为其他形式</h2>
<h3 id="angle转化为euler">Angle转化为Euler</h3>
<p>我们可以将四元数作为中间媒介进行转换，即先使用<a
href="#angle转化为quaternion">Angle转化为Quaternion</a>将Axis
Angle转化为四元数：</p>
<p><span class="math display">\[
w=[\cos(\omega/2),\sin(\omega/2)n_x,\sin(\omega/2)n_y,\sin(\omega/2)n_z]
\]</span></p>
<p>然后再通过<a
href="#quaternion转化为angle">Quaternion转化为Angle</a>将四元数转化为Euler
Angles：</p>
<p><span class="math display">\[
\begin{aligned}
  \theta&amp;=\text{atan2}\left(\frac{2ab+2cd}{\cos(\phi)},\frac{1-2b^2-2c^2}{\cos(\phi)}\right)\\
  \phi&amp;=\arcsin(-(2bd-2ac))\\
  \tau&amp;=\text{atan2}\left(\frac{2bc+2ad}{\cos(\phi)},\frac{1-2c^2-2d^2}{\cos(\phi)}\right)
\end{aligned}
\]</span></p>
<p>其中<span
class="math inline">\(a=\cos(\omega/2),b=\sin(\omega/2)n_x,c=\sin(\omega/2)n_y,d=\sin(\omega/2)n_z\)</span>。</p>
<h3 id="angle转化为matrix">Angle转化为Matrix</h3>
<p>在<a
href="https://sulley.cc/2021/06/07/%E5%90%91%E9%87%8F%E7%BB%95%E4%BB%BB%E6%84%8F%E8%BD%B4%E6%97%8B%E8%BD%AC%E7%9A%84%E7%AE%80%E5%8D%95%E6%8E%A8%E5%AF%BC/">向量绕任意轴旋转的简单推导</a>这篇文章中，我们已经推导出了AngleAxis对应的矩阵形式：</p>
<p><span
class="math display">\[\mathbf{R}=\mathbf{I}+\sin(\theta)\mathbf{N}+(1-\cos(\theta))\mathbf{N}^2,\;
\mathbf{N}=\begin{bmatrix}0&amp;-n_z&amp;n_y\\n_z&amp;0&amp;-n_x\\-n_y&amp;n_x&amp;0\end{bmatrix}\]</span></p>
<h3 id="angle转化为quaternion">Angle转化为Quaternion</h3>
<p>Angle与Quaternion在本质上是一致的，我们在<a
href="#三维旋转定理四元数型">三维旋转定理（四元数型）</a>一节中已经证明过了。所以，对于轴为<span
class="math inline">\(\mathbf{n}\)</span>，旋转角为<span
class="math inline">\(\theta\)</span>的Angle表示来说，只需要构造四元数<span
class="math inline">\(w=[\cos(\theta/2),\sin(\theta/2)\mathbf{n}]\)</span>即可。</p>
<h2 id="euler转化为其他形式">Euler转化为其他形式</h2>
<h3 id="euler转化为angle">Euler转化为Angle</h3>
<p>首先通过<a
href="#euler转化为matrix">Euler转化为Matrix</a>把欧拉角转化为对应的矩阵<span
class="math inline">\(R\)</span>：</p>
<p><span class="math display">\[
R=
\begin{bmatrix}
\cos(\phi)\cos(\tau) &amp;
\sin(\theta)\sin(\phi)\cos(\tau)-\cos(\theta)\sin(\tau) &amp;
\cos(\theta)\sin(\phi)\cos(\tau)+\sin(\theta)\sin(\tau)\\
\cos(\phi)\sin(\tau) &amp;
\sin(\theta)\sin(\phi)\sin(\tau)+\cos(\theta)\cos(\tau) &amp;
\cos(\theta)\sin(\phi)\sin(\tau)-\sin(\theta)\cos(\tau)\\
-\sin(\phi) &amp; \sin(\theta)\cos(\phi) &amp; \cos(\theta)\cos(\phi)
\end{bmatrix}
\]</span></p>
<p>然后再通过<a
href="#matrix转化为angle">Matrix转化为Angle</a>求解对应的（unnormalized）旋转轴<span
class="math inline">\(\mathbf{u}\)</span>与旋转角<span
class="math inline">\(\omega\)</span>：</p>
<p><span class="math display">\[\mathbf{u}=
\begin{bmatrix}
  \sin(\theta)\cos(\phi)-\cos(\theta)\sin(\phi)\sin(\tau)+\sin(\theta)\cos(\tau)\\
  \cos(\theta)\sin(\phi)\cos(\tau)+\sin(\theta)\sin(\tau)+\sin(\phi)\\
  \cos(\phi)\sin(\tau)-\sin(\theta)\sin(\phi)\cos(\tau)+\cos(\theta)\sin(\tau)
\end{bmatrix},\;
\omega=\arccos\left(\frac{\text{tr}(R)-1}{2}\right)
\]</span></p>
<h3 id="euler转化为matrix">Euler转化为Matrix</h3>
<p>在<a
href="#欧拉角坐标系与旋转顺序">欧拉角、坐标系与旋转顺序</a>一节中我们已经证明了：对于以<span
class="math inline">\(x\to y\to
z\)</span>为顺序的欧拉角旋转，旋转矩阵是：</p>
<p><span class="math display">\[
R=R_z(\tau)R_y(\phi)R_x(\theta)=
\begin{bmatrix}
\cos(\phi)\cos(\tau) &amp;
\sin(\theta)\sin(\phi)\cos(\tau)-\cos(\theta)\sin(\tau) &amp;
\cos(\theta)\sin(\phi)\cos(\tau)+\sin(\theta)\sin(\tau)\\
\cos(\phi)\sin(\tau) &amp;
\sin(\theta)\sin(\phi)\sin(\tau)+\cos(\theta)\cos(\tau) &amp;
\cos(\theta)\sin(\phi)\sin(\tau)-\sin(\theta)\cos(\tau)\\
-\sin(\phi) &amp; \sin(\theta)\cos(\phi) &amp; \cos(\theta)\cos(\phi)
\end{bmatrix}
\]</span></p>
<h3 id="euler转化为quaternion">Euler转化为Quaternion</h3>
<p>我们知道，Euler角的旋转是有顺序的，且每一次旋转都是绕标准坐标轴的旋转，所以，我们可以相应地构造出三个四元数去表示这些旋转（旋转顺序为<span
class="math inline">\(x\to y\to z\)</span>，对应角度为<span
class="math inline">\(\theta,\phi,\tau\)</span>）：</p>
<p><span class="math display">\[
\begin{aligned}
  w_x&amp;=[\cos(\theta/2),\sin(\theta/2)(1,0,0)]=[\cos(\theta/2),\sin(\theta/2),0,0]\\
  w_y&amp;=[\cos(\phi/2),\sin(\phi/2)(0,1,0)]=[\cos(\phi/2),0,\sin(\phi/2),0]\\
  w_z&amp;=[\cos(\tau/2),\sin(\tau/2)(0,0,1)]=[\cos(\tau/2),0,0,\sin(\tau/2)]
\end{aligned}
\]</span></p>
<p>将这三个四元数相乘，即得到结果：</p>
<p><span class="math display">\[
\begin{aligned}
  w&amp;=w_zw_yw_x\\
   &amp;=
   \begin{bmatrix}
     \cos(\tau/2)\\
     0\\
     0\\
     \sin(\tau/2)
   \end{bmatrix}
   \begin{bmatrix}
     \cos(\phi/2)\\
     0\\
     \sin(\phi/2)\\
     0
   \end{bmatrix}
   \begin{bmatrix}
     \cos(\theta/2)\\
     \sin(\theta/2)\\
     0\\
     0
   \end{bmatrix}\\
   &amp;=\begin{bmatrix}
     \cos(\theta/2)\cos(\phi/2)\cos(\tau/2)+\sin(\theta/2)\sin(\phi/2)\sin(\tau/2)\\
     \sin(\theta/2)\cos(\phi/2)\cos(\tau/2)-\cos(\theta/2)\sin(\phi/2)\sin(\tau/2)\\
     \cos(\theta/2)\sin(\phi/2)\cos(\tau/2)+\sin(\theta/2)\cos(\phi/2)\sin(\tau/2)\\
     \cos(\theta/2)\cos(\phi/2)\sin(\tau/2)-\sin(\theta/2)\sin(\phi/2)\cos(\tau/2)
   \end{bmatrix}
\end{aligned}
\]</span></p>
<h2 id="matrix转化为其他形式">Matrix转化为其他形式</h2>
<h3 id="matrix转化为angle">Matrix转化为Angle</h3>
<p>给定旋转矩阵<span
class="math inline">\(R=\begin{bmatrix}R_{11}&amp;R_{12}&amp;R_{13}\\R_{21}&amp;R_{22}&amp;R_{23}\\R_{31}&amp;R_{32}&amp;R_{33}\end{bmatrix}\)</span>，并假设对应的旋转轴是<span
class="math inline">\(\mathbf{n}\)</span>、旋转角度是<span
class="math inline">\(\omega\)</span>。显然，如果一个向量<span
class="math inline">\(\mathbf{u}\)</span>平行于<span
class="math inline">\(\mathbf{n}\)</span>，则<span
class="math inline">\(R\mathbf{u}=\mathbf{u}\)</span>，从而<span
class="math inline">\((R-I)\mathbf{u}=0\)</span>。</p>
<p>从特征向量的角度来看，<span
class="math inline">\(\mathbf{u}\)</span>是<span
class="math inline">\(R\)</span>的一个特征向量，它对应的特征值为<span
class="math inline">\(\lambda=1\)</span>。从而我们知道：每个旋转矩阵就有一个特征值为<span
class="math inline">\(1\)</span>。为了求出旋转轴，我们有：</p>
<p><span class="math display">\[\begin{aligned}
  0&amp;=R^\top 0+0\\
  &amp;=R^\top(R-I)\mathbf{u}+(R-I)\mathbf{u}\\
  &amp;=(R^\top R-R^\top+R-I)\mathbf{u}\\
  &amp;=(I-R^\top+R-I)\mathbf{u}\\
  &amp;=(R-R^\top)\mathbf{u}
\end{aligned}\]</span></p>
<p>从而我们有：</p>
<p><span class="math display">\[
\begin{cases}
  0=u_y(R_{12}-R_{21})+u_z(R_{13}-R_{31})\\
  0=u_x(R_{21}-R_{12})+u_z(R_{23}-R_{32})\\
  0=u_x(R_{31}-R_{13})+u_y(R_{32}-R_{23})
\end{cases}\Rightarrow
\mathbf{u}=\begin{bmatrix}
  R_{32}-R_{23}\\
  R_{13}-R_{31}\\
  R_{21}-R_{12}
\end{bmatrix}
\]</span></p>
<p>所以<span
class="math inline">\(\mathbf{n}=\mathbf{u}/\|\mathbf{n}\|\)</span>。注意到上面的推导过程在<span
class="math inline">\(R\)</span>为对称矩阵时不成立，这时候就要按照常规的求特征向量的步骤去求<span
class="math inline">\(\mathbf{u}\)</span>了。</p>
<p>既然我们已经知道了旋转轴<span
class="math inline">\(\mathbf{n}\)</span>，这时只需要找一个垂直于<span
class="math inline">\(\mathbf{n}\)</span>的向量<span
class="math inline">\(\mathbf{v}\)</span>，旋转轴就是<span
class="math inline">\(\mathbf{v}\)</span>和<span
class="math inline">\(R\mathbf{v}\)</span>的夹角。</p>
<p>我们也可以从特征值的角度出发。在三维空间内，旋转矩阵的三个特征值分别为<span
class="math inline">\(\lambda=1,\mathrm{e}^{i\omega},\mathrm{e}^{-i\omega}\)</span>，三者之和为<span
class="math inline">\(1+\mathrm{e}^{i\omega}+\mathrm{e}^{-i\omega}=1+2\cos(\omega)=\text{tr}(R)=R_{11}+R_{22}+R_{33}\)</span>，于是：</p>
<p><span
class="math display">\[\omega=\arccos\left(\frac{\text{tr}(R)-1}{2}\right)\]</span></p>
<h3 id="matrix转化为euler">Matrix转化为Euler</h3>
<p>对于旋转矩阵<span
class="math inline">\(R=\begin{bmatrix}R_{11}&amp;R_{12}&amp;R_{13}\\R_{21}&amp;R_{22}&amp;R_{23}\\R_{31}&amp;R_{32}&amp;R_{33}\end{bmatrix}\)</span>，通过上面<a
href="#euler转化为matrix">Euler到Matrix的转换</a>，我们知道<span
class="math inline">\(\sin(\phi)=-R_{31}\Rightarrow
\phi=\arcsin(R_{31})\)</span>。从而有：</p>
<p><span class="math display">\[
\begin{aligned}
  \phi&amp;=\arcsin(-R_{31})\\
  \theta&amp;=\text{atan2}\left(\frac{R_{32}}{\cos(\phi)},\frac{R_{33}}{\cos(\phi)}\right)\\
  \tau&amp;=\text{atan2}\left(\frac{R_{21}}{\cos(\phi)},\frac{R_{11}}{\cos(\phi)}\right)
\end{aligned}
\]</span></p>
<p>上式仅在<span class="math inline">\(\cos(\phi)\neq
0\)</span>，也即<span class="math inline">\(R_{31}\neq \pm
1\)</span>时才成立。当<span class="math inline">\(R_{31}=\pm
1\)</span>时，原矩阵退化为Gimbal
Lock，因此无法转化为对应的Euler角。从上面的过程来看，对一个旋转矩阵，至少有两组Euler角与它对应，在某些情况下甚至有无穷解。</p>
<h3 id="matrix转化为quaternion">Matrix转化为Quaternion</h3>
<p>给定矩阵<span
class="math inline">\(R=\begin{bmatrix}R_{11}&amp;R_{12}&amp;R_{13}\\R_{21}&amp;R_{22}&amp;R_{23}\\R_{31}&amp;R_{32}&amp;R_{33}\end{bmatrix}\)</span>，我们不难通过<a
href="#quaternion转化为matrix">Quaternion转化为Matrix</a>得到下述关系成立：</p>
<p><span class="math display">\[
\begin{aligned}
  1+R_{11}+R_{22}+R_{33}&amp;=4-4(b^2+c^2+d^2)\\
  &amp;=4-4(1-a^2)\\
  &amp;=4a^2
\end{aligned}
\]</span></p>
<p>所以我们就能解出<span class="math inline">\(a,b,c,d\)</span>：</p>
<p><span class="math display">\[
\begin{aligned}
  a&amp;=\pm\frac{1}{2}\sqrt{1+R_{11}+R_{22}+R_{33}}\\
  b&amp;=\frac{R_{32}-R_{23}}{4a}\\
  c&amp;=\frac{R_{13}-R_{31}}{4a}\\
  d&amp;=\frac{R_{21}-R_{12}}{4a}
\end{aligned}
\]</span></p>
<p>从而得到四元数<span class="math inline">\(w=[a,b,c,d]\)</span>。</p>
<h2 id="quaternion转化为其他形式">Quaternion转化为其他形式</h2>
<h3 id="quaternion转化为angle">Quaternion转化为Angle</h3>
<p>Quaternion转化为Axis Angle的结果我们已经在<a
href="#三维旋转定理四元数型">三维旋转定理（四元数型）</a>一节中给出。给定单位四元数<span
class="math inline">\(w=[a,\mathbf{b}]\)</span>，我们可以通过变换：</p>
<p><span
class="math display">\[\frac{\theta}{2}=\arccos(a),\;\mathbf{n}=\frac{\mathbf{b}}{\sin(\arccos(a))}\]</span></p>
<p>得到它的等价形式<span
class="math inline">\(w=[a,\mathbf{b}]=[\cos(\tfrac{\theta}{2}),\sin(\tfrac{\theta}{2})\mathbf{n}]\)</span>，从而，<span
class="math inline">\(\theta\)</span>即为旋转角，<span
class="math inline">\(\mathbf{n}\)</span>即为旋转轴。</p>
<h3 id="quaternion转化为euler">Quaternion转化为Euler</h3>
<p>使用<a href="#quaternion转化为matrix">Quaternion转化为Matrix</a>和<a
href="#matrix转化为euler">Matrix转化为Euler</a>的结果，我们能求出以<span
class="math inline">\(x\to y\to z\)</span>为顺序的欧拉角<span
class="math inline">\(\theta/\phi/\tau\)</span>：</p>
<p><span class="math display">\[
\begin{aligned}
  \theta&amp;=\text{atan2}\left(\frac{2ab+2cd}{\cos(\phi)},\frac{1-2b^2-2c^2}{\cos(\phi)}\right)\\
  \phi&amp;=\arcsin(-(2bd-2ac))\\
  \tau&amp;=\text{atan2}\left(\frac{2bc+2ad}{\cos(\phi)},\frac{1-2c^2-2d^2}{\cos(\phi)}\right)
\end{aligned}
\]</span></p>
<h3 id="quaternion转化为matrix">Quaternion转化为Matrix</h3>
<p>结果已经由<a
href="#三维旋转定理矩阵型">三维旋转定理（矩阵型）</a>一节给出，结果是：</p>
<p><span class="math display">\[
R=\begin{bmatrix}
  1 &amp; 0 &amp; 0 &amp; 0\\
  0 &amp; 1-2c^2-2d^2 &amp; 2bc-2ad &amp; 2ac+2bd\\
  0 &amp; 2bc+2ad &amp; 1-2b^2-2d^2 &amp; 2cd-2ab\\
  0 &amp; 2bd-2ac &amp; 2ab+2cd &amp; 1-2b^2-2c^2
\end{bmatrix}
\]</span></p>
<p>其中<span
class="math inline">\(a=\cos(\tfrac{1}{2}\theta),b=\sin(\tfrac{1}{2}\theta)n_x,c=\sin(\tfrac{1}{2}\theta)n_y,d=\sin(\tfrac{1}{2}\theta)n_z\)</span>。</p>
<section class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"
role="doc-endnote"><p>https://krasjet.github.io/quaternion/quaternion.pdf<a
href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"
role="doc-endnote"><p>https://en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles<a
href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"
role="doc-endnote"><p>http://www.euclideanspace.com/maths/geometry/rotations/conversions/index.htm<a
href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"
role="doc-endnote"><p>http://number-none.com/product/Hacking%20Quaternions/index.html<a
href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"
role="doc-endnote"><p>http://number-none.com/product/Understanding%20Slerp,%20Then%20Not%20Using%20It/<a
href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"
role="doc-endnote"><p>https://web.mit.edu/2.998/www/QuaternionReport1.pdf<a
href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"
role="doc-endnote"><p>https://www.geometrictools.com/Documentation/RotationRepresentations.pdf<a
href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"
role="doc-endnote"><p>https://en.wikipedia.org/wiki/Rotation_formalisms_in_three_dimensions#Rotation_matrix_%E2%86%94_Euler_axis/angle<a
href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
        <div class="popular-posts-date">2021-06-07</div>
      <div class="popular-posts-title"><a href="/2021/06/07/08/38/" rel="bookmark">向量绕任意轴旋转的简单推导</a></div>
        <div class="popular-posts-excerpt"><p><p>图形学中有关旋转的一个问题是，一个（三维空间的）向量绕一个任意轴旋转若干角度后的角度是什么。本文简单进行推导，给出显式结果。</p></p></div>
    </li>
    <li class="popular-posts-item">
        <div class="popular-posts-date">2022-10-12</div>
      <div class="popular-posts-title"><a href="/2022/10/12/18/39/" rel="bookmark">Bump Mapping, Normal Mapping and Displacement Mapping</a></div>
        <div class="popular-posts-excerpt"><p><p>凹凸贴图（Bump
mapping）是图形学中一种常用的用于改变物体视觉凹凸性的方法，但是网上很多介绍对它的原理和变体都非常模糊，甚至包含一些关键概念的错误。本文将详细介绍凹凸贴图及其变体（Normal
Mapping和Displacement
Mapping）的原理，并在代码上加以实现，以便让读者更好地理解这项技术。</p></p></div>
    </li>
    <li class="popular-posts-item">
        <div class="popular-posts-date">2022-10-08</div>
      <div class="popular-posts-title"><a href="/2022/10/08/11/01/" rel="bookmark">GAMES101疑难点及作业详解</a></div>
        <div class="popular-posts-excerpt"><p><p>很早之前就想跟着做完GAMES101，但是拖延症一直让我拖到了现在，我决定不再鸽下去！本篇Blog主要记录在GAMES101学习中遇到的疑难问题，整理Bonus
Material，以及详解每一课的作业（含提高题）。如有任何错误、遗漏，欢迎读者指出赐教！</p></p></div>
    </li>
    <li class="popular-posts-item">
        <div class="popular-posts-date">2021-08-14</div>
      <div class="popular-posts-title"><a href="/2021/08/14/23/31/" rel="bookmark">矫正透视投影插值及属性插值详解</a></div>
        <div class="popular-posts-excerpt"><p><p>三角形是图形学的基本几何形状，空间中的三角形<span
class="math inline">\(ABC\)</span>投射到屏幕空间中为<span
class="math inline">\(A&#39;B&#39;C&#39;\)</span>。在<span
class="math inline">\(A&#39;B&#39;C&#39;\)</span>内存在一点<span
class="math inline">\(P&#39;\)</span>，它的某个属性<span
class="math inline">\(S_{P&#39;}\)</span>常常用三个顶点的属性<span
class="math inline">\(S_{A&#39;}, S_{B&#39;},
S_{C&#39;}\)</span>的插值表示，即<strong>重心坐标</strong>（Barycentric
coordinates）。然而，在屏幕空间中计算得出的<span
class="math inline">\(P&#39;\)</span>点在三角形<span
class="math inline">\(A&#39;B&#39;C&#39;\)</span>内的重心坐标<span
class="math inline">\((x_{P&#39;},y_{P&#39;},z_{P&#39;})\)</span>却不一定等于投影前三维空间内<span
class="math inline">\(P&#39;\)</span>对应点<span
class="math inline">\(P\)</span>在三角形<span
class="math inline">\(ABC\)</span>内的重心坐标<span
class="math inline">\((x_{P},y_{P},z_{P})\)</span>。这是因为从三维空间到屏幕空间需要执行<strong>透视投影</strong>（Perspective
Projection），这个投影是非线性的，因此变换前的重心坐标并不能和变换后的重心坐标保持线性关系，从而对三角形顶点的属性插值也不是线性关系。这就需要对透视投影下的重心坐标插值进行修正。本文从透视投影本身出发，说明其非线性性，并根据论文《Perspective-Correct
Interpolation》<a href="#fn1" class="footnote-ref" id="fnref1"
role="doc-noteref"><sup>1</sup></a> 给出修正插值。</p></p></div>
    </li>
    <li class="popular-posts-item">
        <div class="popular-posts-date">2020-09-09</div>
      <div class="popular-posts-title"><a href="/2020/09/09/18/52/" rel="bookmark">无穷连根式求极限的充要条件</a></div>
        <div class="popular-posts-excerpt"><p><p>在刷习题集或者考试的时候我们经常会遇到诸如<span
class="math inline">\(\sqrt{1+\sqrt{2+\sqrt{3+\cdots}}}\)</span>或者<span
class="math inline">\(\sqrt{2+\sqrt{2+\sqrt{2+\cdots}}}\)</span>的极限求解或极限存在性证明。解决此类问题的方法有很多，但都可以归结为一点：缩放。要么是两端缩放然后夹逼定理，要么是证明有界然后两边取极限。本文记录此类问题极限存在的一个充要条件，以供参阅。</p></p></div>
    </li>
  </ul>


    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>原作者： </strong>Sulley
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://sulley.cc/2022/03/25/01/00/" title="四元数与旋转">http://sulley.cc/2022/03/25/01/00/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" rel="tag"># 计算机</a>
              <a href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag"># 随笔</a>
              <a href="/tags/%E6%95%B0%E5%AD%A6/" rel="tag"># 数学</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/09/22/08/52/" rel="prev" title="浅谈Hades最终BOSS的AI设计">
                  <i class="fa fa-chevron-left"></i> 浅谈Hades最终BOSS的AI设计
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/03/27/08/38/" rel="next" title="Motion Matching -- 概念与发展">
                  Motion Matching -- 概念与发展 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sulley</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">273k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:08</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdn.jsdelivr.net/npm/pdfobject@2.2.7/pdfobject.min.js","integrity":"sha256-ph3Dk89VmuTVXG6x/RDzk53SU9LPdAh1tpv0UvnDZ2I="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>


  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"littlesulley","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
